import{_ as a,c as n,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const F=JSON.parse('{"title":"WASM 快速开始","description":"","frontmatter":{},"headers":[{"level":2,"title":"什么是 WebAssembly？","slug":"什么是-webassembly","link":"#什么是-webassembly","children":[]},{"level":2,"title":"核心概念","slug":"核心概念","link":"#核心概念","children":[{"level":3,"title":"模块与内存","slug":"模块与内存","link":"#模块与内存","children":[]},{"level":3,"title":"执行模型","slug":"执行模型","link":"#执行模型","children":[]}]},{"level":2,"title":"开发环境搭建","slug":"开发环境搭建","link":"#开发环境搭建","children":[{"level":3,"title":"安装 Emscripten 工具链","slug":"安装-emscripten-工具链","link":"#安装-emscripten-工具链","children":[]},{"level":3,"title":"验证安装","slug":"验证安装","link":"#验证安装","children":[]}]},{"level":2,"title":"第一个 WASM 程序","slug":"第一个-wasm-程序","link":"#第一个-wasm-程序","children":[{"level":3,"title":"C 代码示例 (hello.c)","slug":"c-代码示例-hello-c","link":"#c-代码示例-hello-c","children":[]},{"level":3,"title":"编译为 WASM","slug":"编译为-wasm","link":"#编译为-wasm","children":[]},{"level":3,"title":"在 HTML 中使用","slug":"在-html-中使用","link":"#在-html-中使用","children":[]}]},{"level":2,"title":"内存管理与数据交换","slug":"内存管理与数据交换","link":"#内存管理与数据交换","children":[{"level":3,"title":"JavaScript 与 WASM 数据传递","slug":"javascript-与-wasm-数据传递","link":"#javascript-与-wasm-数据传递","children":[]},{"level":3,"title":"在 C 中处理内存","slug":"在-c-中处理内存","link":"#在-c-中处理内存","children":[]}]},{"level":2,"title":"常用开源库及 API","slug":"常用开源库及-api","link":"#常用开源库及-api","children":[{"level":3,"title":"Emscripten 常用 API","slug":"emscripten-常用-api","link":"#emscripten-常用-api","children":[]},{"level":3,"title":"Wasmer 运行时","slug":"wasmer-运行时","link":"#wasmer-运行时","children":[]},{"level":3,"title":"as-wasi (AssemblyScript)","slug":"as-wasi-assemblyscript","link":"#as-wasi-assemblyscript","children":[]}]},{"level":2,"title":"WASI (WebAssembly 系统接口)","slug":"wasi-webassembly-系统接口","link":"#wasi-webassembly-系统接口","children":[{"level":3,"title":"C 中使用 WASI","slug":"c-中使用-wasi","link":"#c-中使用-wasi","children":[]}]},{"level":2,"title":"性能优化技巧","slug":"性能优化技巧","link":"#性能优化技巧","children":[{"level":3,"title":"编译优化选项","slug":"编译优化选项","link":"#编译优化选项","children":[]},{"level":3,"title":"内存使用最佳实践","slug":"内存使用最佳实践","link":"#内存使用最佳实践","children":[]}]},{"level":2,"title":"调试与测试","slug":"调试与测试","link":"#调试与测试","children":[{"level":3,"title":"浏览器开发者工具","slug":"浏览器开发者工具","link":"#浏览器开发者工具","children":[]},{"level":3,"title":"添加调试信息","slug":"添加调试信息","link":"#添加调试信息","children":[]}]},{"level":2,"title":"常见应用场景","slug":"常见应用场景","link":"#常见应用场景","children":[{"level":3,"title":"图像处理","slug":"图像处理","link":"#图像处理","children":[]},{"level":3,"title":"加密计算","slug":"加密计算","link":"#加密计算","children":[]}]}],"relativePath":"leading/webassembly/start.md","filePath":"leading/webassembly/start.md"}'),o={name:"leading/webassembly/start.md"};function e(t,s,c,r,E,y){return l(),n("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /leading/webassembly/start.md for this page in Markdown format</div><h1 id="wasm-快速开始" tabindex="-1">WASM 快速开始 <a class="header-anchor" href="#wasm-快速开始" aria-label="Permalink to &quot;WASM 快速开始&quot;">​</a></h1><h2 id="什么是-webassembly" tabindex="-1">什么是 WebAssembly？ <a class="header-anchor" href="#什么是-webassembly" aria-label="Permalink to &quot;什么是 WebAssembly？&quot;">​</a></h2><p>WebAssembly (WASM) 是一种为 Web 设计的<strong>二进制指令格式</strong>，它提供了一种新的代码执行方式。其主要设计目标包括<strong>高效执行</strong>、<strong>安全沙箱</strong>和<strong>跨平台可移植</strong>。</p><p>核心特点：</p><ul><li><strong>紧凑的二进制格式</strong>：比等效 JavaScript 文本更小，加载更快</li><li><strong>接近原生性能</strong>：采用底层指令集，适合性能敏感任务</li><li><strong>内存安全</strong>：在严格沙箱环境中运行，无法直接访问系统资源</li><li><strong>语言无关</strong>：支持 C/C++、Rust、AssemblyScript 等多种语言</li></ul><h2 id="核心概念" tabindex="-1">核心概念 <a class="header-anchor" href="#核心概念" aria-label="Permalink to &quot;核心概念&quot;">​</a></h2><h3 id="模块与内存" tabindex="-1">模块与内存 <a class="header-anchor" href="#模块与内存" aria-label="Permalink to &quot;模块与内存&quot;">​</a></h3><p>WASM 程序的基本单元是<strong>模块</strong> (Module)，包含代码、数据结构和内存定义：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>源代码 (C/Rust/等)</span></span>
<span class="line"><span>    ↓ 编译</span></span>
<span class="line"><span>WASM 模块</span></span>
<span class="line"><span>    ├── 类型段 (函数签名)</span></span>
<span class="line"><span>    ├── 函数段 (代码逻辑)  </span></span>
<span class="line"><span>    ├── 内存段 (线性内存)</span></span>
<span class="line"><span>    ├── 表段 (函数引用)</span></span>
<span class="line"><span>    └── 导入/导出段 (接口)</span></span></code></pre></div><p><strong>线性内存</strong>是 WASM 与外部环境交互的核心机制：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>内存布局示例：</span></span>
<span class="line"><span>[0x0000: 代码和数据]</span></span>
<span class="line"><span>[0x1000: 堆空间 ← 可动态增长]</span></span>
<span class="line"><span>[0x2000: 栈空间]</span></span></code></pre></div><h3 id="执行模型" tabindex="-1">执行模型 <a class="header-anchor" href="#执行模型" aria-label="Permalink to &quot;执行模型&quot;">​</a></h3><p>WASM 采用<strong>基于栈的虚拟机</strong>模型：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>指令序列: i32.const 5 → i32.const 3 → i32.add</span></span>
<span class="line"><span>栈状态变化:</span></span>
<span class="line"><span>[] → [5] → [5,3] → [8] (结果)</span></span></code></pre></div><h2 id="开发环境搭建" tabindex="-1">开发环境搭建 <a class="header-anchor" href="#开发环境搭建" aria-label="Permalink to &quot;开发环境搭建&quot;">​</a></h2><h3 id="安装-emscripten-工具链" tabindex="-1">安装 Emscripten 工具链 <a class="header-anchor" href="#安装-emscripten-工具链" aria-label="Permalink to &quot;安装 Emscripten 工具链&quot;">​</a></h3><p>Emscripten 是将 C/C++ 代码编译为 WASM 的主要工具：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 获取 emsdk</span></span>
<span class="line"><span style="color:#B392F0;">git</span><span style="color:#9ECBFF;"> clone</span><span style="color:#9ECBFF;"> https://github.com/emscripten-core/emsdk.git</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#9ECBFF;"> emsdk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 安装最新版本</span></span>
<span class="line"><span style="color:#B392F0;">./emsdk</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> latest</span></span>
<span class="line"><span style="color:#B392F0;">./emsdk</span><span style="color:#9ECBFF;"> activate</span><span style="color:#9ECBFF;"> latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 配置环境变量</span></span>
<span class="line"><span style="color:#79B8FF;">source</span><span style="color:#9ECBFF;"> ./emsdk_env.sh</span></span></code></pre></div><h3 id="验证安装" tabindex="-1">验证安装 <a class="header-anchor" href="#验证安装" aria-label="Permalink to &quot;验证安装&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#79B8FF;"> --version</span></span>
<span class="line"><span style="color:#6A737D;"># 应输出 Emscripten 版本信息</span></span></code></pre></div><h2 id="第一个-wasm-程序" tabindex="-1">第一个 WASM 程序 <a class="header-anchor" href="#第一个-wasm-程序" aria-label="Permalink to &quot;第一个 WASM 程序&quot;">​</a></h2><h3 id="c-代码示例-hello-c" tabindex="-1">C 代码示例 (hello.c) <a class="header-anchor" href="#c-代码示例-hello-c" aria-label="Permalink to &quot;C 代码示例 (hello.c)&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#B392F0;"> main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#B392F0;">  printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Hello, WebAssembly!</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 导出自定义函数</span></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#B392F0;"> add</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> a</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> b</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="编译为-wasm" tabindex="-1">编译为 WASM <a class="header-anchor" href="#编译为-wasm" aria-label="Permalink to &quot;编译为 WASM&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 基础编译</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> hello.c</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> hello.html</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 仅生成 WASM 和 JS 胶水代码</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> hello.c</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> hello.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 优化编译（减小体积）</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> hello.c</span><span style="color:#79B8FF;"> -Os</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> hello.js</span></span></code></pre></div><h3 id="在-html-中使用" tabindex="-1">在 HTML 中使用 <a class="header-anchor" href="#在-html-中使用" aria-label="Permalink to &quot;在 HTML 中使用&quot;">​</a></h3><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;!</span><span style="color:#85E89D;">DOCTYPE</span><span style="color:#B392F0;"> html</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">html</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">head</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">title</span><span style="color:#E1E4E8;">&gt;WASM 示例&lt;/</span><span style="color:#85E89D;">title</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">head</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">body</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">script</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;">        // 加载并实例化 WASM 模块</span></span>
<span class="line"><span style="color:#E1E4E8;">        WebAssembly.</span><span style="color:#B392F0;">instantiateStreaming</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">fetch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hello.wasm&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">            .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">obj</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">                // 调用导出的函数</span></span>
<span class="line"><span style="color:#E1E4E8;">                console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(obj.instance.exports.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)); </span><span style="color:#6A737D;">// 输出 5</span></span>
<span class="line"><span style="color:#E1E4E8;">            });</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;/</span><span style="color:#85E89D;">script</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">body</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">html</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre></div><h2 id="内存管理与数据交换" tabindex="-1">内存管理与数据交换 <a class="header-anchor" href="#内存管理与数据交换" aria-label="Permalink to &quot;内存管理与数据交换&quot;">​</a></h2><h3 id="javascript-与-wasm-数据传递" tabindex="-1">JavaScript 与 WASM 数据传递 <a class="header-anchor" href="#javascript-与-wasm-数据传递" aria-label="Permalink to &quot;JavaScript 与 WASM 数据传递&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 在 JavaScript 中分配内存并传递数据给 WASM</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> allocateMemoryForWasm</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">module</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    // 将字符串转换为字节数组</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> bytes</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> TextEncoder</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">encode</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 在 WASM 内存中分配空间</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> ptr</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> module</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">_malloc</span><span style="color:#E1E4E8;">(bytes.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 将数据复制到 WASM 内存</span></span>
<span class="line"><span style="color:#79B8FF;">    module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">HEAPU8</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(bytes, ptr);</span></span>
<span class="line"><span style="color:#79B8FF;">    module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">HEAPU8</span><span style="color:#E1E4E8;">[ptr </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> bytes.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 添加 null 终止符</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> ptr;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 调用示例</span></span>
<span class="line"><span style="color:#E1E4E8;">WebAssembly.</span><span style="color:#B392F0;">instantiateStreaming</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">fetch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;module.wasm&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">obj</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> module</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> obj.instance.exports;</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> ptr</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> allocateMemoryForWasm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Hello WASM&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#6A737D;">        // 调用 WASM 函数处理数据</span></span>
<span class="line"><span style="color:#79B8FF;">        module</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">process_string</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#6A737D;">        // 释放内存</span></span>
<span class="line"><span style="color:#79B8FF;">        module</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">_free</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span></code></pre></div><h3 id="在-c-中处理内存" tabindex="-1">在 C 中处理内存 <a class="header-anchor" href="#在-c-中处理内存" aria-label="Permalink to &quot;在 C 中处理内存&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;stdlib.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;string.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 处理字符串的函数</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> process_string</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">char*</span><span style="color:#FFAB70;"> str</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // 处理逻辑...</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 内存分配函数导出</span></span>
<span class="line"><span style="color:#F97583;">void*</span><span style="color:#B392F0;"> malloc_size</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> size</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> malloc</span><span style="color:#E1E4E8;">(size);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> free_ptr</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">void*</span><span style="color:#FFAB70;"> ptr</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">    free</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="常用开源库及-api" tabindex="-1">常用开源库及 API <a class="header-anchor" href="#常用开源库及-api" aria-label="Permalink to &quot;常用开源库及 API&quot;">​</a></h2><h3 id="emscripten-常用-api" tabindex="-1">Emscripten 常用 API <a class="header-anchor" href="#emscripten-常用-api" aria-label="Permalink to &quot;Emscripten 常用 API&quot;">​</a></h3><p>Emscripten 提供了丰富的 API 来连接 JavaScript 和 WASM：</p><h4 id="文件系统操作" tabindex="-1">文件系统操作 <a class="header-anchor" href="#文件系统操作" aria-label="Permalink to &quot;文件系统操作&quot;">​</a></h4><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;emscripten.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 同步文件写入</span></span>
<span class="line"><span style="color:#E1E4E8;">EMSCRIPTEN_KEEPALIVE</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> write_file</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#F97583;"> char*</span><span style="color:#FFAB70;"> filename</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">const</span><span style="color:#F97583;"> char*</span><span style="color:#FFAB70;"> content</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    FILE</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> file </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> fopen</span><span style="color:#E1E4E8;">(filename, </span><span style="color:#9ECBFF;">&quot;w&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (file) {</span></span>
<span class="line"><span style="color:#B392F0;">        fputs</span><span style="color:#E1E4E8;">(content, file);</span></span>
<span class="line"><span style="color:#B392F0;">        fclose</span><span style="color:#E1E4E8;">(file);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 异步文件读取</span></span>
<span class="line"><span style="color:#E1E4E8;">EMSCRIPTEN_KEEPALIVE</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> read_file_async</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#F97583;"> char*</span><span style="color:#FFAB70;"> filename</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">    emscripten_async_wget_data</span><span style="color:#E1E4E8;">(filename, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#6A737D;">        // 成功回调</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)(</span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">[]</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> userdata, </span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> data, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> size) {</span></span>
<span class="line"><span style="color:#F97583;">            if</span><span style="color:#E1E4E8;"> (data) {</span></span>
<span class="line"><span style="color:#B392F0;">                printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;读取到 </span><span style="color:#79B8FF;">%d</span><span style="color:#9ECBFF;"> 字节数据</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, size);</span></span>
<span class="line"><span style="color:#B392F0;">                free</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }, </span></span>
<span class="line"><span style="color:#6A737D;">        // 失败回调</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)(</span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">const</span><span style="color:#F97583;"> char*</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">[]</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> userdata, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> error, </span><span style="color:#F97583;">const</span><span style="color:#F97583;"> char*</span><span style="color:#E1E4E8;"> desc) {</span></span>
<span class="line"><span style="color:#B392F0;">            printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;读取失败: </span><span style="color:#79B8FF;">%s\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, desc);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h4 id="动态链接-api" tabindex="-1">动态链接 API <a class="header-anchor" href="#动态链接-api" aria-label="Permalink to &quot;动态链接 API&quot;">​</a></h4><p>Emscripten 2.0+ 支持动态链接，大幅提升大型应用性能：</p><p><strong>主模块编译：</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> main.c</span><span style="color:#79B8FF;"> -s</span><span style="color:#9ECBFF;"> MAIN_MODULE=</span><span style="color:#79B8FF;">1</span><span style="color:#79B8FF;"> -s</span><span style="color:#9ECBFF;"> EXPORT_ALL=</span><span style="color:#79B8FF;">1</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> main.js</span></span></code></pre></div><p><strong>侧模块编译：</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> side.c</span><span style="color:#79B8FF;"> -s</span><span style="color:#9ECBFF;"> SIDE_MODULE=</span><span style="color:#79B8FF;">1</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> side.wasm</span></span></code></pre></div><p><strong>动态加载使用：</strong></p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 同步加载侧模块</span></span>
<span class="line"><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> handle </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> dlopen</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;side_module.wasm&quot;</span><span style="color:#E1E4E8;">, RTLD_LAZY);</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (handle) {</span></span>
<span class="line"><span style="color:#6A737D;">    // 解析符号</span></span>
<span class="line"><span style="color:#F97583;">    typedef</span><span style="color:#F97583;"> int</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">AddFunc)(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    AddFunc add </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (AddFunc)</span><span style="color:#B392F0;">dlsym</span><span style="color:#E1E4E8;">(handle, </span><span style="color:#9ECBFF;">&quot;add&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 调用函数</span></span>
<span class="line"><span style="color:#F97583;">    int</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> add</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">);</span><span style="color:#6A737D;"> // 结果为 5</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">    dlclose</span><span style="color:#E1E4E8;">(handle);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 异步加载（避免阻塞主线程）</span></span>
<span class="line"><span style="color:#79B8FF;">em_promise_t</span><span style="color:#E1E4E8;"> promise </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> emscripten_dlopen_promise</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;side_module.wasm&quot;</span><span style="color:#E1E4E8;">, RTLD_NOW);</span></span>
<span class="line"><span style="color:#B392F0;">emscripten_promise_then</span><span style="color:#E1E4E8;">(promise, </span></span>
<span class="line"><span style="color:#6A737D;">    // 成功回调</span></span>
<span class="line"><span style="color:#F97583;">    []</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> handle) {</span></span>
<span class="line"><span style="color:#F97583;">        int</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">multiply)(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> dlsym</span><span style="color:#E1E4E8;">(handle, </span><span style="color:#9ECBFF;">&quot;multiply&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        int</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> multiply</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">);</span><span style="color:#6A737D;"> // 结果为 12</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#6A737D;">    // 失败回调</span></span>
<span class="line"><span style="color:#F97583;">    []</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#B392F0;">        emscripten_errf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;异步加载失败&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">);</span></span></code></pre></div><h3 id="wasmer-运行时" tabindex="-1">Wasmer 运行时 <a class="header-anchor" href="#wasmer-运行时" aria-label="Permalink to &quot;Wasmer 运行时&quot;">​</a></h3><p>Wasmer 是在浏览器外执行 WASM 的流行运行时：</p><h4 id="go-中使用示例" tabindex="-1">Go 中使用示例 <a class="header-anchor" href="#go-中使用示例" aria-label="Permalink to &quot;Go 中使用示例&quot;">​</a></h4><div class="language-go"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#B392F0;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;</span><span style="color:#B392F0;">github.com/wasmerio/wasmer-go/wasmer</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#B392F0;"> main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // 读取 WASM 字节码</span></span>
<span class="line"><span style="color:#E1E4E8;">    bytes, _ </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> wasmBytes.</span><span style="color:#B392F0;">ReadFile</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;module.wasm&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 创建引擎和存储</span></span>
<span class="line"><span style="color:#E1E4E8;">    engine </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> wasmer.</span><span style="color:#B392F0;">NewEngine</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    store </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> wasmer.</span><span style="color:#B392F0;">NewStore</span><span style="color:#E1E4E8;">(engine)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 编译模块</span></span>
<span class="line"><span style="color:#E1E4E8;">    module, _ </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> wasmer.</span><span style="color:#B392F0;">NewModule</span><span style="color:#E1E4E8;">(store, bytes)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 创建导入对象（可为空）</span></span>
<span class="line"><span style="color:#E1E4E8;">    importObject </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> wasmer.</span><span style="color:#B392F0;">NewImportObject</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 实例化模块</span></span>
<span class="line"><span style="color:#E1E4E8;">    instance, _ </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> wasmer.</span><span style="color:#B392F0;">NewInstance</span><span style="color:#E1E4E8;">(module, importObject)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 获取导出函数</span></span>
<span class="line"><span style="color:#E1E4E8;">    add, _ </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> instance.Exports.</span><span style="color:#B392F0;">GetFunction</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;add&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 调用函数</span></span>
<span class="line"><span style="color:#E1E4E8;">    result, _ </span><span style="color:#F97583;">:=</span><span style="color:#B392F0;"> add</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    fmt.</span><span style="color:#B392F0;">Println</span><span style="color:#E1E4E8;">(result) </span><span style="color:#6A737D;">// 输出 5</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="as-wasi-assemblyscript" tabindex="-1">as-wasi (AssemblyScript) <a class="header-anchor" href="#as-wasi-assemblyscript" aria-label="Permalink to &quot;as-wasi (AssemblyScript)&quot;">​</a></h3><p>as-wasi 为 AssemblyScript 提供了高级的 WASI API 封装：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 导入 as-wasi</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { Console, FileSystem, Environ } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &quot;as-wasi&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 控制台输出</span></span>
<span class="line"><span style="color:#E1E4E8;">Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Hello from AssemblyScript!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 文件系统操作</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (FileSystem.</span><span style="color:#B392F0;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;data.txt&quot;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> FileSystem.</span><span style="color:#B392F0;">open</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;data.txt&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;r&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> content </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> file.</span><span style="color:#B392F0;">readString</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;文件内容: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> content);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 环境变量访问</span></span>
<span class="line"><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> env </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Environ</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> path </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;PATH&quot;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;PATH: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> path);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 命令行参数</span></span>
<span class="line"><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> args </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Environ.args;</span></span>
<span class="line"><span style="color:#E1E4E8;">Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;参数数量: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> args.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">());</span></span></code></pre></div><h2 id="wasi-webassembly-系统接口" tabindex="-1">WASI (WebAssembly 系统接口) <a class="header-anchor" href="#wasi-webassembly-系统接口" aria-label="Permalink to &quot;WASI (WebAssembly 系统接口)&quot;">​</a></h2><p>WASI 让 WASM 能够安全地访问系统资源：</p><h3 id="c-中使用-wasi" tabindex="-1">C 中使用 WASI <a class="header-anchor" href="#c-中使用-wasi" aria-label="Permalink to &quot;C 中使用 WASI&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;unistd.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#B392F0;"> main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // 读取命令行参数</span></span>
<span class="line"><span style="color:#F97583;">    char</span><span style="color:#FFAB70;"> buffer</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">    ssize_t</span><span style="color:#E1E4E8;"> count </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> read</span><span style="color:#E1E4E8;">(STDIN_FILENO, buffer, </span><span style="color:#F97583;">sizeof</span><span style="color:#E1E4E8;">(buffer)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (count </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#FFAB70;">        buffer</span><span style="color:#E1E4E8;">[count] </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;</span><span style="color:#79B8FF;">\\0</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">        printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;输入: </span><span style="color:#79B8FF;">%s\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, buffer);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 写入标准输出</span></span>
<span class="line"><span style="color:#B392F0;">    write</span><span style="color:#E1E4E8;">(STDOUT_FILENO, </span><span style="color:#9ECBFF;">&quot;Hello WASI!</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>编译命令：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">clang</span><span style="color:#79B8FF;"> --target=wasm32-wasi</span><span style="color:#9ECBFF;"> hello.c</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> hello.wasm</span></span></code></pre></div><h2 id="性能优化技巧" tabindex="-1">性能优化技巧 <a class="header-anchor" href="#性能优化技巧" aria-label="Permalink to &quot;性能优化技巧&quot;">​</a></h2><h3 id="编译优化选项" tabindex="-1">编译优化选项 <a class="header-anchor" href="#编译优化选项" aria-label="Permalink to &quot;编译优化选项&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 优化级别选择</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -O1</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">    # 基础优化</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -O2</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">    # 中等优化  </span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -O3</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">    # 激进优化</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -Os</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">    # 侧重体积优化</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -Oz</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">    # 极致体积优化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 特定优化选项</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -s</span><span style="color:#9ECBFF;"> WASM=</span><span style="color:#79B8FF;">1</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">                    # 仅 WASM，无 asm.js 回退</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -s</span><span style="color:#9ECBFF;"> ALLOW_MEMORY_GROWTH=</span><span style="color:#79B8FF;">1</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">     # 允许内存增长</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#9ECBFF;"> code.c</span><span style="color:#79B8FF;"> -s</span><span style="color:#9ECBFF;"> INITIAL_MEMORY=</span><span style="color:#79B8FF;">16777216</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> code.js</span><span style="color:#6A737D;">   # 设置初始内存 16MB</span></span></code></pre></div><h3 id="内存使用最佳实践" tabindex="-1">内存使用最佳实践 <a class="header-anchor" href="#内存使用最佳实践" aria-label="Permalink to &quot;内存使用最佳实践&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;emscripten.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 使用内存视图而非频繁复制</span></span>
<span class="line"><span style="color:#E1E4E8;">EMSCRIPTEN_KEEPALIVE</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> process_data</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">uint8_t*</span><span style="color:#FFAB70;"> data</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> length</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // 直接操作内存，避免复制</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> length; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#FFAB70;">        data</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> data</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">;</span><span style="color:#6A737D;"> // 原地处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 批量操作减少 JavaScript-WASM 调用开销</span></span>
<span class="line"><span style="color:#E1E4E8;">EMSCRIPTEN_KEEPALIVE  </span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> process_batch</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">float*</span><span style="color:#FFAB70;"> inputs</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">float*</span><span style="color:#FFAB70;"> outputs</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> count</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> count; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#FFAB70;">        outputs</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> inputs</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 2.0</span><span style="color:#F97583;">f</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="调试与测试" tabindex="-1">调试与测试 <a class="header-anchor" href="#调试与测试" aria-label="Permalink to &quot;调试与测试&quot;">​</a></h2><h3 id="浏览器开发者工具" tabindex="-1">浏览器开发者工具 <a class="header-anchor" href="#浏览器开发者工具" aria-label="Permalink to &quot;浏览器开发者工具&quot;">​</a></h3><p>现代浏览器提供了完善的 WASM 调试支持：</p><ul><li><strong>源码映射</strong>：将 WASM 二进制映射到原始源代码</li><li><strong>单步调试</strong>：在开发者工具中设置断点和单步执行</li><li><strong>内存检查</strong>：查看和编辑 WASM 线性内存</li></ul><h3 id="添加调试信息" tabindex="-1">添加调试信息 <a class="header-anchor" href="#添加调试信息" aria-label="Permalink to &quot;添加调试信息&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 包含调试信息</span></span>
<span class="line"><span style="color:#B392F0;">emcc</span><span style="color:#79B8FF;"> -g4</span><span style="color:#9ECBFF;"> hello.c</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> hello.js</span></span>
<span class="line"><span style="color:#6A737D;"># -g4 包含最大调试信息，包括 DWARF 信息</span></span></code></pre></div><h2 id="常见应用场景" tabindex="-1">常见应用场景 <a class="header-anchor" href="#常见应用场景" aria-label="Permalink to &quot;常见应用场景&quot;">​</a></h2><h3 id="图像处理" tabindex="-1">图像处理 <a class="header-anchor" href="#图像处理" aria-label="Permalink to &quot;图像处理&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;emscripten.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 图像处理函数</span></span>
<span class="line"><span style="color:#E1E4E8;">EMSCRIPTEN_KEEPALIVE</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> grayscale</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">uint8_t*</span><span style="color:#FFAB70;"> image</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> width</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> height</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> width </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> height </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 4</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">+=</span><span style="color:#79B8FF;"> 4</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">        uint8_t</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> image</span><span style="color:#E1E4E8;">[i];</span></span>
<span class="line"><span style="color:#F97583;">        uint8_t</span><span style="color:#E1E4E8;"> g </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> image</span><span style="color:#E1E4E8;">[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">]; </span></span>
<span class="line"><span style="color:#F97583;">        uint8_t</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> image</span><span style="color:#E1E4E8;">[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#6A737D;">        // 计算灰度值</span></span>
<span class="line"><span style="color:#F97583;">        uint8_t</span><span style="color:#E1E4E8;"> gray </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (r </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> g </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b) </span><span style="color:#F97583;">/</span><span style="color:#79B8FF;"> 3</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#FFAB70;">        image</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;</span><span style="color:#6A737D;">     // R</span></span>
<span class="line"><span style="color:#FFAB70;">        image</span><span style="color:#E1E4E8;">[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;</span><span style="color:#6A737D;"> // G  </span></span>
<span class="line"><span style="color:#FFAB70;">        image</span><span style="color:#E1E4E8;">[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;</span><span style="color:#6A737D;"> // B</span></span>
<span class="line"><span style="color:#6A737D;">        // Alpha 通道保持不变</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="加密计算" tabindex="-1">加密计算 <a class="header-anchor" href="#加密计算" aria-label="Permalink to &quot;加密计算&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#9ECBFF;"> &lt;emscripten.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 简单 XOR 加密</span></span>
<span class="line"><span style="color:#E1E4E8;">EMSCRIPTEN_KEEPALIVE</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> xor_encrypt</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">uint8_t*</span><span style="color:#FFAB70;"> data</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> length</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">uint8_t</span><span style="color:#FFAB70;"> key</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> length; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#FFAB70;">        data</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> data</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">^</span><span style="color:#E1E4E8;"> key;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div>`,75)])])}const d=a(o,[["render",e]]);export{F as __pageData,d as default};
