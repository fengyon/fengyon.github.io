import{_ as n,c as a,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const i=JSON.parse('{"title":"Electron é›†æˆ C++/Rust/NAPI","description":"","frontmatter":{},"headers":[{"level":2,"title":"é›†æˆæ¦‚è¿°","slug":"é›†æˆæ¦‚è¿°","link":"#é›†æˆæ¦‚è¿°","children":[]},{"level":2,"title":"N-API æ ¸å¿ƒæŠ€æœ¯","slug":"n-api-æ ¸å¿ƒæŠ€æœ¯","link":"#n-api-æ ¸å¿ƒæŠ€æœ¯","children":[{"level":3,"title":"N-API æ¶æ„è§£æ","slug":"n-api-æ¶æ„è§£æ","link":"#n-api-æ¶æ„è§£æ","children":[]},{"level":3,"title":"ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾","slug":"ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾","link":"#ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾","children":[]},{"level":3,"title":"åŸºæœ¬ N-API æ¨¡å—å¼€å‘","slug":"åŸºæœ¬-n-api-æ¨¡å—å¼€å‘","link":"#åŸºæœ¬-n-api-æ¨¡å—å¼€å‘","children":[]}]},{"level":2,"title":"C++ æ¨¡å—é›†æˆ","slug":"c-æ¨¡å—é›†æˆ","link":"#c-æ¨¡å—é›†æˆ","children":[{"level":3,"title":"C++ æ¨¡å—æ¶æ„è®¾è®¡","slug":"c-æ¨¡å—æ¶æ„è®¾è®¡","link":"#c-æ¨¡å—æ¶æ„è®¾è®¡","children":[]},{"level":3,"title":"å®Œæ•´ C++ æ¨¡å—ç¤ºä¾‹","slug":"å®Œæ•´-c-æ¨¡å—ç¤ºä¾‹","link":"#å®Œæ•´-c-æ¨¡å—ç¤ºä¾‹","children":[]},{"level":3,"title":"C++ æ¨¡å—çš„ Electron é›†æˆ","slug":"c-æ¨¡å—çš„-electron-é›†æˆ","link":"#c-æ¨¡å—çš„-electron-é›†æˆ","children":[]}]},{"level":2,"title":"Rust è¯­è¨€é›†æˆ","slug":"rust-è¯­è¨€é›†æˆ","link":"#rust-è¯­è¨€é›†æˆ","children":[{"level":3,"title":"Rust ä¸ N-API é›†æˆæ¶æ„","slug":"rust-ä¸-n-api-é›†æˆæ¶æ„","link":"#rust-ä¸-n-api-é›†æˆæ¶æ„","children":[]},{"level":3,"title":"napi-rs é¡¹ç›®é…ç½®","slug":"napi-rs-é¡¹ç›®é…ç½®","link":"#napi-rs-é¡¹ç›®é…ç½®","children":[]},{"level":3,"title":"Rust æ¨¡å—å®ç°","slug":"rust-æ¨¡å—å®ç°","link":"#rust-æ¨¡å—å®ç°","children":[]},{"level":3,"title":"Rust æ¨¡å—çš„ Electron åŒ…è£…å™¨","slug":"rust-æ¨¡å—çš„-electron-åŒ…è£…å™¨","link":"#rust-æ¨¡å—çš„-electron-åŒ…è£…å™¨","children":[]}]},{"level":2,"title":"é«˜çº§é›†æˆæ¨¡å¼","slug":"é«˜çº§é›†æˆæ¨¡å¼","link":"#é«˜çº§é›†æˆæ¨¡å¼","children":[{"level":3,"title":"å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç†","slug":"å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç†","link":"#å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç†","children":[]},{"level":3,"title":"æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–","slug":"æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–","link":"#æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–","children":[]}]},{"level":2,"title":"å®‰å…¨æœ€ä½³å®è·µ","slug":"å®‰å…¨æœ€ä½³å®è·µ","link":"#å®‰å…¨æœ€ä½³å®è·µ","children":[{"level":3,"title":"å®‰å…¨çš„æ¨¡å—åŠ è½½","slug":"å®‰å…¨çš„æ¨¡å—åŠ è½½","link":"#å®‰å…¨çš„æ¨¡å—åŠ è½½","children":[]},{"level":3,"title":"è¿›ç¨‹é—´é€šä¿¡å®‰å…¨","slug":"è¿›ç¨‹é—´é€šä¿¡å®‰å…¨","link":"#è¿›ç¨‹é—´é€šä¿¡å®‰å…¨","children":[]}]}],"relativePath":"special/electron/native.md","filePath":"special/electron/native.md"}'),o={name:"special/electron/native.md"};function e(c,s,E,t,r,y){return l(),a("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /special/electron/native.md for this page in Markdown format</div><h1 id="electron-é›†æˆ-c-rust-napi" tabindex="-1">Electron é›†æˆ C++/Rust/NAPI <a class="header-anchor" href="#electron-é›†æˆ-c-rust-napi" aria-label="Permalink to &quot;Electron é›†æˆ C++/Rust/NAPI&quot;">â€‹</a></h1><h2 id="é›†æˆæ¦‚è¿°" tabindex="-1">é›†æˆæ¦‚è¿° <a class="header-anchor" href="#é›†æˆæ¦‚è¿°" aria-label="Permalink to &quot;é›†æˆæ¦‚è¿°&quot;">â€‹</a></h2><p>Electron ä¸ C++/Rust/NAPI çš„é›†æˆæ˜¯ç°ä»£æ¡Œé¢åº”ç”¨å¼€å‘ä¸­çš„é‡è¦æŠ€æœ¯æ¨¡å¼ï¼Œå®ƒç»“åˆäº† Web æŠ€æœ¯çš„<strong>å¿«é€Ÿå¼€å‘èƒ½åŠ›</strong>å’Œç³»ç»Ÿçº§è¯­è¨€çš„<strong>é«˜æ€§èƒ½ä¼˜åŠ¿</strong>ã€‚è¿™ç§é›†æˆæ¨¡å¼å…è®¸å¼€å‘è€…åœ¨ Electron çš„æ¸²æŸ“è¿›ç¨‹å’Œä¸»è¿›ç¨‹ä¸­ç›´æ¥è°ƒç”¨åŸç”Ÿä»£ç ï¼Œå®ç°å¯¹è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€ç¡¬ä»¶æ“ä½œå’Œç°æœ‰åŸç”Ÿåº“çš„æ·±åº¦é›†æˆã€‚</p><p>é›†æˆæ¶æ„çš„æ ¸å¿ƒåœ¨äºé€šè¿‡ <strong>N-API</strong> å»ºç«‹ JavaScript ä¸åŸç”Ÿä»£ç ä¹‹é—´çš„é€šä¿¡æ¡¥æ¢ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Electron åº”ç”¨ (JavaScript/TypeScript)</span></span>
<span class="line"><span>    â†‘â†“ Node.js ç»‘å®šå±‚</span></span>
<span class="line"><span>åŸç”Ÿæ¨¡å— (C++/Rust) â† N-API æ¥å£</span></span>
<span class="line"><span>    â†‘</span></span>
<span class="line"><span>ç³»ç»Ÿèµ„æº (ç¡¬ä»¶/æ–‡ä»¶ç³»ç»Ÿ/åŸç”Ÿåº“)</span></span></code></pre></div><p>è¿™ç§æ¶æ„æ—¢ä¿æŒäº† Electron çš„è·¨å¹³å°ç‰¹æ€§ï¼Œåˆçªç ´äº† Web æŠ€æœ¯åœ¨æ€§èƒ½ä¸Šçš„é™åˆ¶ï¼Œä¸ºå¼€å‘é«˜æ€§èƒ½æ¡Œé¢åº”ç”¨æä¾›äº†å®Œç¾è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="n-api-æ ¸å¿ƒæŠ€æœ¯" tabindex="-1">N-API æ ¸å¿ƒæŠ€æœ¯ <a class="header-anchor" href="#n-api-æ ¸å¿ƒæŠ€æœ¯" aria-label="Permalink to &quot;N-API æ ¸å¿ƒæŠ€æœ¯&quot;">â€‹</a></h2><h3 id="n-api-æ¶æ„è§£æ" tabindex="-1">N-API æ¶æ„è§£æ <a class="header-anchor" href="#n-api-æ¶æ„è§£æ" aria-label="Permalink to &quot;N-API æ¶æ„è§£æ&quot;">â€‹</a></h3><p>N-API æ˜¯ Node.js æä¾›çš„<strong>ç¨³å®šçš„æŠ½è±¡å±‚</strong>ï¼Œå®ƒéš”ç¦»äº† JavaScript è¿è¡Œæ—¶ä¸åŸç”Ÿæ¨¡å—çš„åº•å±‚å®ç°ï¼Œç¡®ä¿åŸç”Ÿæ¨¡å—åœ¨ä¸åŒ Node.js ç‰ˆæœ¬ (åŒ…æ‹¬ Electron å†…ç½®çš„ Node.js) ä¸­çš„äºŒè¿›åˆ¶å…¼å®¹æ€§ã€‚</p><p><strong>N-API åœ¨ Electron ä¸­çš„å±‚æ¬¡ç»“æ„ï¼š</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>æ¸²æŸ“è¿›ç¨‹ (JavaScript) â†â†’ ä¸»è¿›ç¨‹ (Node.js)</span></span>
<span class="line"><span>                            â†‘</span></span>
<span class="line"><span>                      N-API æŠ½è±¡å±‚</span></span>
<span class="line"><span>                            â†‘</span></span>
<span class="line"><span>                      V8/Node.js ABI</span></span>
<span class="line"><span>                            â†‘</span></span>
<span class="line"><span>                    åŸç”Ÿæ¨¡å— (.node æ–‡ä»¶)</span></span></code></pre></div><h3 id="ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾" tabindex="-1">ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾ <a class="header-anchor" href="#ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾" aria-label="Permalink to &quot;ç¯å¢ƒé…ç½®ä¸å·¥å…·é“¾&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// scripts/napi-setup.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFileSync, writeFileSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;fs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> NAPISetup</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkPrerequisites</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  checkPrerequisites</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> prerequisites</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;node-gyp&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkCommand</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;node-gyp --version&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;Python 3.8+&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkCommand</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;python --version&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;C++ Build Tools&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkVisualStudio</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> missing</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(prerequisites)</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">filter</span><span style="color:#E1E4E8;">(([, </span><span style="color:#FFAB70;">exists</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#F97583;"> !</span><span style="color:#E1E4E8;">exists)</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> name);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (missing.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ç¼ºå°‘å¿…è¦çš„å¼€å‘ç¯å¢ƒ: \${</span><span style="color:#E1E4E8;">missing</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">join</span><span style="color:#9ECBFF;">(</span><span style="color:#9ECBFF;">&#39;, &#39;</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  checkCommand</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">command</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(command, { stdio: </span><span style="color:#9ECBFF;">&#39;ignore&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  checkVisualStudio</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (process.platform </span><span style="color:#F97583;">!==</span><span style="color:#9ECBFF;"> &#39;win32&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;where cl&#39;</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;ignore&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  createBindingConfig</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> bindingGyp</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      targets: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">          target_name: moduleName,</span></span>
<span class="line"><span style="color:#E1E4E8;">          sources: [</span></span>
<span class="line"><span style="color:#9ECBFF;">            &#39;src/addon.cpp&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">            &#39;src/native-wrapper.cpp&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          ],</span></span>
<span class="line"><span style="color:#E1E4E8;">          include_dirs: [</span></span>
<span class="line"><span style="color:#9ECBFF;">            &#39;&lt;!@(node -p &quot;require(</span><span style="color:#79B8FF;">\\\\</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">node</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addon</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">api\\\\</span><span style="color:#9ECBFF;">&#39;).include&quot;)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          ],</span></span>
<span class="line"><span style="color:#E1E4E8;">          dependencies: [</span></span>
<span class="line"><span style="color:#9ECBFF;">            &#39;&lt;!@(node -p &quot;require(</span><span style="color:#79B8FF;">\\\\</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">node</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addon</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">api\\\\</span><span style="color:#9ECBFF;">&#39;).gyp&quot;)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          ],</span></span>
<span class="line"><span style="color:#E1E4E8;">          defines: [</span></span>
<span class="line"><span style="color:#9ECBFF;">            &#39;NAPI_DISABLE_CPP_EXCEPTIONS&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          ],</span></span>
<span class="line"><span style="color:#E1E4E8;">          cflags: [</span><span style="color:#9ECBFF;">&#39;-std=c++14&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">          conditions: [</span></span>
<span class="line"><span style="color:#E1E4E8;">            [</span><span style="color:#9ECBFF;">&#39;OS==&quot;mac&quot;&#39;</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#9ECBFF;">              &#39;xcode_settings&#39;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#9ECBFF;">                &#39;OTHER_CPLUSPLUSFLAGS&#39;</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;-std=c++14&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;-stdlib=libc++&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">              }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }]</span></span>
<span class="line"><span style="color:#E1E4E8;">          ]</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">    writeFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;binding.gyp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(bindingGyp, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… binding.gyp é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> rebuildForElectron</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // è·å– Electron çš„ Node.js ç‰ˆæœ¬ä¿¡æ¯</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> electronVersion</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> process.versions.electron;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> nodeVersion</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> process.versions.node;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ”¨ ä¸º Electron é‡æ–°ç¼–è¯‘åŸç”Ÿæ¨¡å—...\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`   Electron: \${</span><span style="color:#E1E4E8;">electronVersion</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`   Node.js: \${</span><span style="color:#E1E4E8;">nodeVersion</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npx electron-rebuild -v \${</span><span style="color:#E1E4E8;">electronVersion</span><span style="color:#9ECBFF;">} -n \${</span><span style="color:#E1E4E8;">nodeVersion</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… åŸç”Ÿæ¨¡å—ç¼–è¯‘æˆåŠŸ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âŒ ç¼–è¯‘å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error.message);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> napiSetup</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> NAPISetup</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><h3 id="åŸºæœ¬-n-api-æ¨¡å—å¼€å‘" tabindex="-1">åŸºæœ¬ N-API æ¨¡å—å¼€å‘ <a class="header-anchor" href="#åŸºæœ¬-n-api-æ¨¡å—å¼€å‘" aria-label="Permalink to &quot;åŸºæœ¬ N-API æ¨¡å—å¼€å‘&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// native-module/src/addon.cpp</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">napi.h</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">vector</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">thread</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ç®€å•çš„è®¡ç®—å‡½æ•°ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—</span></span>
<span class="line"><span style="color:#E1E4E8;">int </span><span style="color:#B392F0;">fibonacci</span><span style="color:#E1E4E8;">(int n) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (n </span><span style="color:#F97583;">&lt;=</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> n;</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> fibonacci</span><span style="color:#E1E4E8;">(n </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#B392F0;"> fibonacci</span><span style="color:#E1E4E8;">(n </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// N-API åŒ…è£…å‡½æ•°</span></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Value </span><span style="color:#B392F0;">CalculateFibonacci</span><span style="color:#E1E4E8;">(const Napi::CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> info) {</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å‚æ•°éªŒè¯</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (info.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;éœ€è¦å‚æ•° n&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">ThrowAsJavaScriptException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#B392F0;">IsNumber</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;å‚æ•° n å¿…é¡»æ˜¯æ•°å­—&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">ThrowAsJavaScriptException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    int n </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Int32Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è¾“å…¥éªŒè¯</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (n </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">RangeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;å‚æ•° n ä¸èƒ½ä¸ºè´Ÿæ•°&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">ThrowAsJavaScriptException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (n </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 45</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">RangeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;å‚æ•° n ä¸èƒ½å¤§äº 45 (é˜²æ­¢é˜»å¡äº‹ä»¶å¾ªç¯)&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">ThrowAsJavaScriptException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è°ƒç”¨åŸç”Ÿå‡½æ•°</span></span>
<span class="line"><span style="color:#E1E4E8;">    int result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> fibonacci</span><span style="color:#E1E4E8;">(n);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> Napi::Number::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, result);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å¼‚æ­¥å·¥ä½œç»“æ„ä½“</span></span>
<span class="line"><span style="color:#E1E4E8;">struct </span><span style="color:#B392F0;">FibonacciWorker</span><span style="color:#E1E4E8;"> : </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::AsyncWorker {</span></span>
<span class="line"><span style="color:#E1E4E8;">    int n;</span></span>
<span class="line"><span style="color:#E1E4E8;">    int result;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">    FibonacciWorker</span><span style="color:#E1E4E8;">(Napi::Function</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> callback, int n)</span></span>
<span class="line"><span style="color:#E1E4E8;">        : </span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">AsyncWorker</span><span style="color:#E1E4E8;">(callback), </span><span style="color:#B392F0;">n</span><span style="color:#E1E4E8;">(n), </span><span style="color:#B392F0;">result</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    void</span><span style="color:#B392F0;"> Execute</span><span style="color:#E1E4E8;">() override {</span></span>
<span class="line"><span style="color:#6A737D;">        // åœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œè®¡ç®—ï¼Œä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯</span></span>
<span class="line"><span style="color:#E1E4E8;">        result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> fibonacci</span><span style="color:#E1E4E8;">(n);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    void</span><span style="color:#B392F0;"> OnOK</span><span style="color:#E1E4E8;">() override {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::HandleScope </span><span style="color:#B392F0;">scope</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#B392F0;">        Callback</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Call</span><span style="color:#E1E4E8;">({ </span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">(), Napi::Number::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">(), result) });</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å¼‚æ­¥ç‰ˆæœ¬æ–æ³¢é‚£å¥‘è®¡ç®—</span></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Value </span><span style="color:#B392F0;">CalculateFibonacciAsync</span><span style="color:#E1E4E8;">(const Napi::CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> info) {</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (info.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">TypeError</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;éœ€è¦å‚æ•° n å’Œå›è°ƒå‡½æ•°&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">ThrowAsJavaScriptException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    int n </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Int32Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Function callback </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Function</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    FibonacciWorker</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> worker </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> FibonacciWorker</span><span style="color:#E1E4E8;">(callback, n);</span></span>
<span class="line"><span style="color:#E1E4E8;">    worker</span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;">Queue</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Undefined</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// æ¨¡å—åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Object </span><span style="color:#B392F0;">Init</span><span style="color:#E1E4E8;">(Napi::Env env, Napi::Object </span><span style="color:#79B8FF;">exports</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    exports</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;calculateFibonacci&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">                Napi::Function::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, CalculateFibonacci));</span></span>
<span class="line"><span style="color:#79B8FF;">    exports</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;calculateFibonacciAsync&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">                Napi::Function::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, CalculateFibonacciAsync));</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> exports</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NODE_API_MODULE</span><span style="color:#E1E4E8;">(native_module, Init)</span></span></code></pre></div><h2 id="c-æ¨¡å—é›†æˆ" tabindex="-1">C++ æ¨¡å—é›†æˆ <a class="header-anchor" href="#c-æ¨¡å—é›†æˆ" aria-label="Permalink to &quot;C++ æ¨¡å—é›†æˆ&quot;">â€‹</a></h2><h3 id="c-æ¨¡å—æ¶æ„è®¾è®¡" tabindex="-1">C++ æ¨¡å—æ¶æ„è®¾è®¡ <a class="header-anchor" href="#c-æ¨¡å—æ¶æ„è®¾è®¡" aria-label="Permalink to &quot;C++ æ¨¡å—æ¶æ„è®¾è®¡&quot;">â€‹</a></h3><p>C++ ä¸ Electron çš„é›†æˆä¸»è¦é€šè¿‡ <strong>Node.js åŸç”Ÿæ’ä»¶</strong>å®ç°ï¼Œè¿™äº›æ’ä»¶ç¼–è¯‘ä¸º <code>.node</code> æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥åœ¨ Electron è¿›ç¨‹ä¸­åŠ è½½ã€‚</p><p><strong>C++ æ¨¡å—åŠ è½½æµç¨‹ï¼š</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>C++ æºä»£ç  (.cpp) â†’ node-gyp ç¼–è¯‘ â†’ åŸç”Ÿæ¨¡å— (.node)</span></span>
<span class="line"><span>                                                    â†“</span></span>
<span class="line"><span>                                              require() åŠ è½½</span></span>
<span class="line"><span>                                                    â†“</span></span>
<span class="line"><span>                                           JavaScript è°ƒç”¨æ¥å£</span></span></code></pre></div><h3 id="å®Œæ•´-c-æ¨¡å—ç¤ºä¾‹" tabindex="-1">å®Œæ•´ C++ æ¨¡å—ç¤ºä¾‹ <a class="header-anchor" href="#å®Œæ•´-c-æ¨¡å—ç¤ºä¾‹" aria-label="Permalink to &quot;å®Œæ•´ C++ æ¨¡å—ç¤ºä¾‹&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// native-module/src/advanced-calc.cpp</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">napi.h</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">vector</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">algorithm</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">thread</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">#include </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">chrono</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// æ€§èƒ½å¯†é›†å‹è®¡ç®—ï¼šçŸ©é˜µä¹˜æ³•</span></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Value </span><span style="color:#B392F0;">MatrixMultiply</span><span style="color:#E1E4E8;">(const Napi::CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> info) {</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è·å–è¾“å…¥çŸ©é˜µ</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Array matrixA </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Array matrixB </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t rowsA </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matrixA.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t colsA </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matrixA.</span><span style="color:#B392F0;">Get</span><span style="color:#E1E4E8;">(0u).As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t rowsB </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matrixB.</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t colsB </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matrixB.</span><span style="color:#B392F0;">Get</span><span style="color:#E1E4E8;">(0u).As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Length</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // éªŒè¯çŸ©é˜µç»´åº¦</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (colsA </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> rowsB) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, </span><span style="color:#9ECBFF;">&quot;çŸ©é˜µç»´åº¦ä¸åŒ¹é…&quot;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">ThrowAsJavaScriptException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">Null</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // åˆ›å»ºç»“æœçŸ©é˜µ</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Array result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Array</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, rowsA);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ‰§è¡ŒçŸ©é˜µä¹˜æ³•</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (size_t i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> rowsA; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::Array row </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matrixA.</span><span style="color:#B392F0;">Get</span><span style="color:#E1E4E8;">(i).As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#B392F0;">        Napi</span><span style="color:#E1E4E8;">::Array resultRow </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> Napi</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">Array</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, colsB);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        for</span><span style="color:#E1E4E8;"> (size_t j </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; j </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> colsB; j</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            double sum </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0.0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span></span>
<span class="line"><span style="color:#F97583;">            for</span><span style="color:#E1E4E8;"> (size_t k </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; k </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> colsA; k</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                double a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> row.</span><span style="color:#B392F0;">Get</span><span style="color:#E1E4E8;">(k).As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">DoubleValue</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#B392F0;">                Napi</span><span style="color:#E1E4E8;">::Array bRow </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> matrixB.</span><span style="color:#B392F0;">Get</span><span style="color:#E1E4E8;">(k).As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                double b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> bRow.</span><span style="color:#B392F0;">Get</span><span style="color:#E1E4E8;">(j).As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">DoubleValue</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">                sum </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span></span>
<span class="line"><span style="color:#E1E4E8;">            resultRow.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(j, Napi::Number::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, sum));</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        result.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(i, resultRow);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å›¾åƒå¤„ç†ï¼šç®€å•çš„ç°åº¦è½¬æ¢</span></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Value </span><span style="color:#B392F0;">ConvertToGrayscale</span><span style="color:#E1E4E8;">(const Napi::CallbackInfo</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;"> info) {</span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Env env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info.</span><span style="color:#B392F0;">Env</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">    Napi</span><span style="color:#E1E4E8;">::Uint8Array imageData </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Uint8Array</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t width </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Uint32Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t height </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> info[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">].As</span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Number</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">Uint32Value</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    uint8_t</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> imageData.</span><span style="color:#B392F0;">Data</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    size_t dataLength </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> imageData.</span><span style="color:#B392F0;">ElementLength</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å¤„ç†å›¾åƒæ•°æ® (RGBA è½¬ç°åº¦)</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (size_t i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> dataLength; i </span><span style="color:#F97583;">+=</span><span style="color:#79B8FF;"> 4</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        uint8_t r </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data[i];</span></span>
<span class="line"><span style="color:#E1E4E8;">        uint8_t g </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">        uint8_t b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#6A737D;">        // ç°åº¦å…¬å¼</span></span>
<span class="line"><span style="color:#E1E4E8;">        uint8_t gray </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> static_cast</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">uint8_t</span><span style="color:#E1E4E8;">&gt;(</span><span style="color:#79B8FF;">0.299</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 0.587</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> g </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 0.114</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> b);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        data[i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;     </span><span style="color:#6A737D;">// R</span></span>
<span class="line"><span style="color:#E1E4E8;">        data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray; </span><span style="color:#6A737D;">// G</span></span>
<span class="line"><span style="color:#E1E4E8;">        data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray; </span><span style="color:#6A737D;">// B</span></span>
<span class="line"><span style="color:#6A737D;">        // A é€šé“ä¿æŒä¸å˜</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> imageData;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// åˆå§‹åŒ–å‡½æ•°</span></span>
<span class="line"><span style="color:#B392F0;">Napi</span><span style="color:#E1E4E8;">::Object </span><span style="color:#B392F0;">Init</span><span style="color:#E1E4E8;">(Napi::Env env, Napi::Object </span><span style="color:#79B8FF;">exports</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    exports</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;matrixMultiply&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">                Napi::Function::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, MatrixMultiply));</span></span>
<span class="line"><span style="color:#79B8FF;">    exports</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;convertToGrayscale&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">                Napi::Function::</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(env, ConvertToGrayscale));</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> exports</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NODE_API_MODULE</span><span style="color:#E1E4E8;">(advanced_calc, Init)</span></span></code></pre></div><h3 id="c-æ¨¡å—çš„-electron-é›†æˆ" tabindex="-1">C++ æ¨¡å—çš„ Electron é›†æˆ <a class="header-anchor" href="#c-æ¨¡å—çš„-electron-é›†æˆ" aria-label="Permalink to &quot;C++ æ¨¡å—çš„ Electron é›†æˆ&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/native-module-loader.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { contextBridge, ipcRenderer } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> NativeModuleLoader</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.modules </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // å®‰å…¨åœ°åŠ è½½åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // ä¸»è¿›ç¨‹ç¼–è¯‘çš„åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> nativeAddon</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">loadSecureModule</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;advanced-calc&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.modules.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;calculator&#39;</span><span style="color:#E1E4E8;">, nativeAddon);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… åŸç”Ÿæ¨¡å—åŠ è½½æˆåŠŸ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âŒ åŸç”Ÿæ¨¡å—åŠ è½½å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">fallbackToJavaScript</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> loadSecureModule</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šè¿‡ä¸»è¿›ç¨‹éªŒè¯æ¨¡å—å®Œæ•´æ€§</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (process.env.</span><span style="color:#79B8FF;">NODE_ENV</span><span style="color:#F97583;"> ===</span><span style="color:#9ECBFF;"> &#39;production&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> isVerified</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> ipcRenderer.</span><span style="color:#B392F0;">invoke</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;verify-native-module&#39;</span><span style="color:#E1E4E8;">, moduleName);</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">isVerified) {</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ¨¡å— \${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">} éªŒè¯å¤±è´¥\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // åŠ¨æ€å¯¼å…¥åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> modulePath</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`./build/Release/\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}.node\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  fallbackToJavaScript</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âš ï¸ ä½¿ç”¨ JavaScript å›é€€å®ç°&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // JavaScript å›é€€å®ç°</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.modules.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;calculator&#39;</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#B392F0;">      matrixMultiply</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">matrixA</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">matrixB</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">        // JavaScript å®ç°çš„çŸ©é˜µä¹˜æ³•ï¼ˆæ€§èƒ½è¾ƒä½ï¼‰</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> rowsA</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> matrixA.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> colsA</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> matrixA[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> colsB</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> matrixB[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> rowsA; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          result[i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#F97583;">          for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> j </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; j </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> colsB; j</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">            let</span><span style="color:#E1E4E8;"> sum </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">            for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> k </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; k </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> colsA; k</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">              sum </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> matrixA[i][k] </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> matrixB[k][j];</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            result[i][j] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> sum;</span></span>
<span class="line"><span style="color:#E1E4E8;">          }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#B392F0;">      convertToGrayscale</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">imageData</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">width</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">height</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">        // JavaScript å®ç°çš„ç°åº¦è½¬æ¢</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> data</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Uint8Array</span><span style="color:#E1E4E8;">(imageData);</span></span>
<span class="line"><span style="color:#F97583;">        for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> data.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">+=</span><span style="color:#79B8FF;"> 4</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">          const</span><span style="color:#79B8FF;"> r</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> data[i];</span></span>
<span class="line"><span style="color:#F97583;">          const</span><span style="color:#79B8FF;"> g</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">          const</span><span style="color:#79B8FF;"> b</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">          const</span><span style="color:#79B8FF;"> gray</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 0.299</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 0.587</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> g </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 0.114</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span></span>
<span class="line"><span style="color:#E1E4E8;">          data[i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;</span></span>
<span class="line"><span style="color:#E1E4E8;">          data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;</span></span>
<span class="line"><span style="color:#E1E4E8;">          data[i </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> gray;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> data;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getModule</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.modules.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(name);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// æš´éœ²å®‰å…¨çš„ API åˆ°æ¸²æŸ“è¿›ç¨‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> loader</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> NativeModuleLoader</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">contextBridge.</span><span style="color:#B392F0;">exposeInMainWorld</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;nativeModules&#39;</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#B392F0;">  getCalculator</span><span style="color:#E1E4E8;">: () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> loader.</span><span style="color:#B392F0;">getModule</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;calculator&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#B392F0;">  isNativeAvailable</span><span style="color:#E1E4E8;">: () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> loader.modules.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;calculator&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h2 id="rust-è¯­è¨€é›†æˆ" tabindex="-1">Rust è¯­è¨€é›†æˆ <a class="header-anchor" href="#rust-è¯­è¨€é›†æˆ" aria-label="Permalink to &quot;Rust è¯­è¨€é›†æˆ&quot;">â€‹</a></h2><h3 id="rust-ä¸-n-api-é›†æˆæ¶æ„" tabindex="-1">Rust ä¸ N-API é›†æˆæ¶æ„ <a class="header-anchor" href="#rust-ä¸-n-api-é›†æˆæ¶æ„" aria-label="Permalink to &quot;Rust ä¸ N-API é›†æˆæ¶æ„&quot;">â€‹</a></h3><p>Rust é€šè¿‡ <strong>napi-rs</strong> æ¡†æ¶ä¸ Electron é›†æˆï¼Œæä¾›äº†å†…å­˜å®‰å…¨å’Œé›¶æˆæœ¬æŠ½è±¡çš„ä¼˜åŠ¿ã€‚</p><p><strong>Rust é›†æˆæ¶æ„ï¼š</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Rust ä»£ç  â†’ napi-rs ç»‘å®š â†’ Node.js å…¼å®¹æ¨¡å—</span></span>
<span class="line"><span>                                          â†“</span></span>
<span class="line"><span>                                    Electron åº”ç”¨</span></span></code></pre></div><h3 id="napi-rs-é¡¹ç›®é…ç½®" tabindex="-1">napi-rs é¡¹ç›®é…ç½® <a class="header-anchor" href="#napi-rs-é¡¹ç›®é…ç½®" aria-label="Permalink to &quot;napi-rs é¡¹ç›®é…ç½®&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// rust-module/Cargo.toml</span></span>
<span class="line"><span style="color:#E1E4E8;">[package]</span></span>
<span class="line"><span style="color:#E1E4E8;">name </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;electron-rust-module&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">version </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;0.1.0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">edition </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;2021&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[lib]</span></span>
<span class="line"><span style="color:#E1E4E8;">crate</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;cdylib&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[dependencies]</span></span>
<span class="line"><span style="color:#E1E4E8;">napi </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;2.0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">napi</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">derive </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;2.0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">tokio </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { version </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;1.0&quot;</span><span style="color:#E1E4E8;">, features </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;full&quot;</span><span style="color:#E1E4E8;">] }</span></span>
<span class="line"><span style="color:#E1E4E8;">image </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;0.24.0&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[build</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">dependencies]</span></span>
<span class="line"><span style="color:#E1E4E8;">napi</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">build </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;1.0&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[package.metadata.napi]</span></span>
<span class="line"><span style="color:#E1E4E8;">name </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &quot;electron_rust_module&quot;</span></span></code></pre></div><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// rust-module/build.rs</span></span>
<span class="line"><span style="color:#E1E4E8;">fn </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#B392F0;">    napi_build</span><span style="color:#E1E4E8;">::</span><span style="color:#B392F0;">setup</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="rust-æ¨¡å—å®ç°" tabindex="-1">Rust æ¨¡å—å®ç° <a class="header-anchor" href="#rust-æ¨¡å—å®ç°" aria-label="Permalink to &quot;Rust æ¨¡å—å®ç°&quot;">â€‹</a></h3><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// rust-module/src/lib.rs</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#B392F0;"> napi_derive</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">napi;</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#B392F0;"> napi</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">bindgen_prelude</span><span style="color:#F97583;">::*</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">JsUint8Array</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">JsUnknown</span><span style="color:#E1E4E8;">};</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#B392F0;"> image</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">ImageBuffer</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">Rgba</span><span style="color:#E1E4E8;">};</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#B392F0;"> std</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">convert</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">TryInto</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// é«˜æ€§èƒ½è®¡ç®—ï¼šå¹¶è¡Œå›¾åƒå¤„ç†</span></span>
<span class="line"><span style="color:#E1E4E8;">#[napi]</span></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#B392F0;"> process_image_async</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">  image_data</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> JsUint8Array</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  width</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  height</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  callback</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">JsFunction</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> Result</span><span style="color:#E1E4E8;">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#F97583;">  let</span><span style="color:#E1E4E8;"> data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> image_data</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">into_value</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">bindgen_prelude</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">spawn</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#F97583;"> move</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    // åœ¨ Tokio è¿è¡Œæ—¶ä¸­å¤„ç†å›¾åƒ</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> process_image_internal</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">data, width, height)</span><span style="color:#F97583;">.await</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å›è°ƒ JavaScript</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> callback_result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> callback</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">call</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">None</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">[result]);</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#F97583;"> let</span><span style="color:#B392F0;"> Err</span><span style="color:#E1E4E8;">(e) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> callback_result {</span></span>
<span class="line"><span style="color:#B392F0;">      eprintln!</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;å›è°ƒè°ƒç”¨å¤±è´¥: {}&quot;</span><span style="color:#E1E4E8;">, e);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  Ok</span><span style="color:#E1E4E8;">(())</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#F97583;"> fn</span><span style="color:#B392F0;"> process_image_internal</span><span style="color:#E1E4E8;">(data</span><span style="color:#F97583;">:</span><span style="color:#F97583;"> &amp;</span><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">u8</span><span style="color:#E1E4E8;">], width</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;">, height</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> JsUnknown</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // ä½¿ç”¨ image crate å¤„ç†å›¾åƒ</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#F97583;"> let</span><span style="color:#B392F0;"> Ok</span><span style="color:#E1E4E8;">(img) </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> ImageBuffer</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">Rgba</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">u8</span><span style="color:#E1E4E8;">&gt;, _&gt;</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from_raw</span><span style="color:#E1E4E8;">(width, height, data</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">to_vec</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#6A737D;">    // åº”ç”¨å›¾åƒå¤„ç†ç®—æ³•ï¼ˆç¤ºä¾‹ï¼šåè½¬é¢œè‰²ï¼‰</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> processed</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> ImageBuffer</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">Rgba</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">u8</span><span style="color:#E1E4E8;">&gt;, </span><span style="color:#B392F0;">Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">u8</span><span style="color:#E1E4E8;">&gt;&gt; </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> img</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">pixels</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">|</span><span style="color:#B392F0;"> Rgba</span><span style="color:#E1E4E8;">([</span><span style="color:#79B8FF;">255</span><span style="color:#F97583;"> -</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">255</span><span style="color:#F97583;"> -</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">], </span><span style="color:#79B8FF;">255</span><span style="color:#F97583;"> -</span><span style="color:#E1E4E8;"> p[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">], p[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">]]))</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">collect</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">Vec</span><span style="color:#E1E4E8;">&lt;_&gt;&gt;()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">try_into</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">unwrap</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è½¬æ¢å› JavaScript å¯ç”¨çš„æ ¼å¼</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> result_data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> processed</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">into_raw</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#B392F0;">    napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Env</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from_raw</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">unsafe</span><span style="color:#E1E4E8;"> { </span><span style="color:#B392F0;">napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">sys</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">napi_env</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">default</span><span style="color:#E1E4E8;">() })</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">create_uint8_array</span><span style="color:#E1E4E8;">(result_data)</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">unwrap</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">into_unknown</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Env</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from_raw</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">unsafe</span><span style="color:#E1E4E8;"> { </span><span style="color:#B392F0;">napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">sys</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">napi_env</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">default</span><span style="color:#E1E4E8;">() })</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">get_undefined</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">unwrap</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">into_unknown</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// CPU å¯†é›†å‹è®¡ç®—ï¼šç‰©ç†æ¨¡æ‹Ÿ</span></span>
<span class="line"><span style="color:#E1E4E8;">#[napi]</span></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#B392F0;"> physics_simulation</span><span style="color:#E1E4E8;">(particles</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;">, steps</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> u32</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  let</span><span style="color:#F97583;"> mut</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#B392F0;">u32</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // ç®€åŒ–çš„ç‰©ç†æ¨¡æ‹Ÿè®¡ç®—</span></span>
<span class="line"><span style="color:#F97583;">  for</span><span style="color:#E1E4E8;"> step </span><span style="color:#F97583;">in</span><span style="color:#79B8FF;"> 0</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">steps {</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> particle </span><span style="color:#F97583;">in</span><span style="color:#79B8FF;"> 0</span><span style="color:#F97583;">..</span><span style="color:#E1E4E8;">particles {</span></span>
<span class="line"><span style="color:#6A737D;">      // æ¨¡æ‹Ÿä¸€äº›è®¡ç®—å¯†é›†å‹æ“ä½œ</span></span>
<span class="line"><span style="color:#E1E4E8;">      result </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> result</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">wrapping_add</span><span style="color:#E1E4E8;">(step</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">wrapping_mul</span><span style="color:#E1E4E8;">(particle));</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  result</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ç»“æ„ä½“ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#E1E4E8;">#[napi]</span></span>
<span class="line"><span style="color:#F97583;">struct</span><span style="color:#B392F0;"> DataProcessor</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  multiplier</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> f64</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#[napi]</span></span>
<span class="line"><span style="color:#F97583;">impl</span><span style="color:#B392F0;"> DataProcessor</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  #[napi(constructor)]</span></span>
<span class="line"><span style="color:#F97583;">  pub</span><span style="color:#F97583;"> fn</span><span style="color:#B392F0;"> new</span><span style="color:#E1E4E8;">(multiplier</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> f64</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#79B8FF;"> Self</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    DataProcessor</span><span style="color:#E1E4E8;"> { multiplier }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  #[napi]</span></span>
<span class="line"><span style="color:#F97583;">  pub</span><span style="color:#F97583;"> fn</span><span style="color:#B392F0;"> process</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">, data</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">f64</span><span style="color:#E1E4E8;">&gt;) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">f64</span><span style="color:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8;">    data</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">into_iter</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">x</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> self</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">multiplier)</span></span>
<span class="line"><span style="color:#F97583;">      .</span><span style="color:#B392F0;">collect</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  #[napi]</span></span>
<span class="line"><span style="color:#F97583;">  pub</span><span style="color:#F97583;"> fn</span><span style="color:#B392F0;"> process_async</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">, data</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">f64</span><span style="color:#E1E4E8;">&gt;) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">bindgen_prelude</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Promise</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">f64</span><span style="color:#E1E4E8;">&gt;&gt; {</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> multiplier </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> self</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">multiplier;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">    napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">bindgen_prelude</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Promise</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">move</span><span style="color:#F97583;"> |</span><span style="color:#E1E4E8;">resolve, _</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">bindgen_prelude</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">spawn</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#F97583;"> move</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">        // å¼‚æ­¥å¤„ç†</span></span>
<span class="line"><span style="color:#F97583;">        let</span><span style="color:#E1E4E8;"> result</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">f64</span><span style="color:#E1E4E8;">&gt; </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">into_iter</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">          .</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">x</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> multiplier)</span></span>
<span class="line"><span style="color:#F97583;">          .</span><span style="color:#B392F0;">collect</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        resolve</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">resolve</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Ok</span><span style="color:#E1E4E8;">(result));</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// æ¨¡å—åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#E1E4E8;">#[napi]</span></span>
<span class="line"><span style="color:#F97583;">pub</span><span style="color:#F97583;"> fn</span><span style="color:#B392F0;"> init</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> napi</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">Result</span><span style="color:#E1E4E8;">&lt;()&gt; {</span></span>
<span class="line"><span style="color:#B392F0;">  Ok</span><span style="color:#E1E4E8;">(())</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="rust-æ¨¡å—çš„-electron-åŒ…è£…å™¨" tabindex="-1">Rust æ¨¡å—çš„ Electron åŒ…è£…å™¨ <a class="header-anchor" href="#rust-æ¨¡å—çš„-electron-åŒ…è£…å™¨" aria-label="Permalink to &quot;Rust æ¨¡å—çš„ Electron åŒ…è£…å™¨&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/rust-module-adapter.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { join, dirname } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;path&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { fileURLToPath } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;url&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> RustModuleAdapter</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.module </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.isInitialized </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.__dirname </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> dirname</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">fileURLToPath</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">meta</span><span style="color:#E1E4E8;">.url));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> initialize</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.isInitialized) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // åŠ¨æ€å¯¼å…¥ Rust æ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> modulePath</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> join</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.__dirname, </span><span style="color:#9ECBFF;">&#39;../rust-module/index.node&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.module </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> import</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // åˆå§‹åŒ–æ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.module.</span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.isInitialized </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… Rust æ¨¡å—åˆå§‹åŒ–æˆåŠŸ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âŒ Rust æ¨¡å—åˆå§‹åŒ–å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> processImage</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">imageData</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">width</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">height</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureInitialized</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#F97583;"> new</span><span style="color:#79B8FF;"> Promise</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">resolve</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">reject</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.module.</span><span style="color:#B392F0;">processImageAsync</span><span style="color:#E1E4E8;">(imageData, width, height, (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (err) </span><span style="color:#B392F0;">reject</span><span style="color:#E1E4E8;">(err);</span></span>
<span class="line"><span style="color:#F97583;">        else</span><span style="color:#B392F0;"> resolve</span><span style="color:#E1E4E8;">(result);</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  physicsSimulation</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">particles</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">steps</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.isInitialized) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Rust æ¨¡å—æœªåˆå§‹åŒ–&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.module.</span><span style="color:#B392F0;">physicsSimulation</span><span style="color:#E1E4E8;">(particles, steps);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  createDataProcessor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">multiplier</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.isInitialized) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Rust æ¨¡å—æœªåˆå§‹åŒ–&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#F97583;"> new</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.module.</span><span style="color:#B392F0;">DataProcessor</span><span style="color:#E1E4E8;">(multiplier);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> ensureInitialized</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.isInitialized) {</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">initialize</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å•ä¾‹å®ä¾‹</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> rustModule</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> RustModuleAdapter</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// åœ¨é¢„åŠ è½½è„šæœ¬ä¸­å®‰å…¨æš´éœ²</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> exposeRustModule</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  contextBridge.</span><span style="color:#B392F0;">exposeInMainWorld</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;rustModule&#39;</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#B392F0;">    processImage</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">imageData</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">width</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">height</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      rustModule.</span><span style="color:#B392F0;">processImage</span><span style="color:#E1E4E8;">(imageData, width, height),</span></span>
<span class="line"><span style="color:#B392F0;">    physicsSimulation</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">particles</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">steps</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      rustModule.</span><span style="color:#B392F0;">physicsSimulation</span><span style="color:#E1E4E8;">(particles, steps),</span></span>
<span class="line"><span style="color:#B392F0;">    createDataProcessor</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">multiplier</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      rustModule.</span><span style="color:#B392F0;">createDataProcessor</span><span style="color:#E1E4E8;">(multiplier),</span></span>
<span class="line"><span style="color:#B392F0;">    isAvailable</span><span style="color:#E1E4E8;">: () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> rustModule.isInitialized</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="é«˜çº§é›†æˆæ¨¡å¼" tabindex="-1">é«˜çº§é›†æˆæ¨¡å¼ <a class="header-anchor" href="#é«˜çº§é›†æˆæ¨¡å¼" aria-label="Permalink to &quot;é«˜çº§é›†æˆæ¨¡å¼&quot;">â€‹</a></h2><h3 id="å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç†" tabindex="-1">å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç† <a class="header-anchor" href="#å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç†" aria-label="Permalink to &quot;å¤šçº¿ç¨‹ä¸å¼‚æ­¥å¤„ç†&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/thread-manager.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { Worker, isMainThread, parentPort, workerData } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;worker_threads&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> NativeThreadManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.workers </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.taskQueue </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // åˆ›å»ºä¸“ç”¨å·¥ä½œçº¿ç¨‹</span></span>
<span class="line"><span style="color:#B392F0;">  createWorker</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">taskType</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> worker</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Worker</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./native-worker.js&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">meta</span><span style="color:#E1E4E8;">.url), {</span></span>
<span class="line"><span style="color:#E1E4E8;">      workerData: { moduleName, taskType },</span></span>
<span class="line"><span style="color:#E1E4E8;">      stdout: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      stderr: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> workerId</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#E1E4E8;">taskType</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#E1E4E8;">Date</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">now</span><span style="color:#9ECBFF;">()</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.workers.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(workerId, worker);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    worker.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;message&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">handleWorkerResult</span><span style="color:#E1E4E8;">(workerId, result);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    worker.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">error</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å·¥ä½œçº¿ç¨‹ \${</span><span style="color:#E1E4E8;">workerId</span><span style="color:#9ECBFF;">} é”™è¯¯:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.workers.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(workerId);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    worker.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;exit&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">code</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (code </span><span style="color:#F97583;">!==</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å·¥ä½œçº¿ç¨‹ \${</span><span style="color:#E1E4E8;">workerId</span><span style="color:#9ECBFF;">} é€€å‡ºï¼Œä»£ç : \${</span><span style="color:#E1E4E8;">code</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.workers.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(workerId);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> workerId;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // æäº¤ä»»åŠ¡åˆ°å·¥ä½œçº¿ç¨‹</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> submitTask</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">workerId</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">taskData</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">timeout</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 30000</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#F97583;"> new</span><span style="color:#79B8FF;"> Promise</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">resolve</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">reject</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> taskId</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`task-\${</span><span style="color:#E1E4E8;">Date</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">now</span><span style="color:#9ECBFF;">()</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#E1E4E8;">Math</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">random</span><span style="color:#9ECBFF;">().</span><span style="color:#B392F0;">toString</span><span style="color:#9ECBFF;">(</span><span style="color:#79B8FF;">36</span><span style="color:#9ECBFF;">).</span><span style="color:#B392F0;">substr</span><span style="color:#9ECBFF;">(</span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">, </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> timeoutId</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> setTimeout</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">        reject</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ä»»åŠ¡ \${</span><span style="color:#E1E4E8;">taskId</span><span style="color:#9ECBFF;">} æ‰§è¡Œè¶…æ—¶\`</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.taskQueue.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(taskId);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }, timeout);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.taskQueue.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(taskId, { resolve, reject, timeoutId });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> worker</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.workers.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(workerId);</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">worker) {</span></span>
<span class="line"><span style="color:#B392F0;">        reject</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å·¥ä½œçº¿ç¨‹ \${</span><span style="color:#E1E4E8;">workerId</span><span style="color:#9ECBFF;">} ä¸å­˜åœ¨\`</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      worker.</span><span style="color:#B392F0;">postMessage</span><span style="color:#E1E4E8;">({ taskId, data: taskData });</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  handleWorkerResult</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">workerId</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">taskId</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">data</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">error</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> task</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.taskQueue.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(taskId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">task) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æœªçŸ¥ä»»åŠ¡ ID: \${</span><span style="color:#E1E4E8;">taskId</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">    clearTimeout</span><span style="color:#E1E4E8;">(task.timeoutId);</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.taskQueue.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(taskId);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      task.</span><span style="color:#B392F0;">reject</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(error));</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      task.</span><span style="color:#B392F0;">resolve</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // ä¼˜é›…å…³é—­æ‰€æœ‰å·¥ä½œçº¿ç¨‹</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> shutdown</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> shutdownPromises</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Array.</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.workers.</span><span style="color:#B392F0;">values</span><span style="color:#E1E4E8;">()).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">worker</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#F97583;"> new</span><span style="color:#79B8FF;"> Promise</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">resolve</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        worker.</span><span style="color:#B392F0;">once</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;exit&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> resolve</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        worker.</span><span style="color:#B392F0;">postMessage</span><span style="color:#E1E4E8;">({ type: </span><span style="color:#9ECBFF;">&#39;shutdown&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#6A737D;">        // å¼ºåˆ¶ç»ˆæ­¢ï¼ˆå¦‚æœ 5 ç§’å†…æ²¡æœ‰æ­£å¸¸é€€å‡ºï¼‰</span></span>
<span class="line"><span style="color:#B392F0;">        setTimeout</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">          if</span><span style="color:#E1E4E8;"> (worker.threadId) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            worker.</span><span style="color:#B392F0;">terminate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">          }</span></span>
<span class="line"><span style="color:#B392F0;">          resolve</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        }, </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> Promise</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">all</span><span style="color:#E1E4E8;">(shutdownPromises);</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.workers.</span><span style="color:#B392F0;">clear</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.taskQueue.</span><span style="color:#B392F0;">clear</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… æ‰€æœ‰å·¥ä½œçº¿ç¨‹å·²å…³é—­&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> threadManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> NativeThreadManager</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/native-worker.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { workerData, parentPort, isMainThread } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;worker_threads&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { rustModule } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;./rust-module-adapter.js&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { nativeModuleLoader } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;./native-module-loader.js&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> NativeWorker</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">taskType</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.moduleName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> moduleName;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.taskType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> taskType;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.isShuttingDown </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">initialize</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> initialize</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // åˆå§‹åŒ–ç›¸åº”çš„åŸç”Ÿæ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.moduleName </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;rust&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#E1E4E8;"> rustModule.</span><span style="color:#B392F0;">initialize</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.moduleName </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;cpp&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#E1E4E8;"> nativeModuleLoader.</span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… å·¥ä½œçº¿ç¨‹åˆå§‹åŒ–å®Œæˆ: \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">taskType</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å·¥ä½œçº¿ç¨‹åˆå§‹åŒ–å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#E1E4E8;">      process.</span><span style="color:#B392F0;">exit</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> processTask</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">taskData</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.isShuttingDown) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å·¥ä½œçº¿ç¨‹æ­£åœ¨å…³é—­&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      switch</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.taskType) {</span></span>
<span class="line"><span style="color:#F97583;">        case</span><span style="color:#9ECBFF;"> &#39;image-processing&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">          return</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">processImageTask</span><span style="color:#E1E4E8;">(taskData);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        case</span><span style="color:#9ECBFF;"> &#39;physics-simulation&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">          return</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">processPhysicsTask</span><span style="color:#E1E4E8;">(taskData);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        case</span><span style="color:#9ECBFF;"> &#39;matrix-calculation&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">          return</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">processMatrixTask</span><span style="color:#E1E4E8;">(taskData);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        default</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">          throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æœªçŸ¥ä»»åŠ¡ç±»å‹: \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">taskType</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ä»»åŠ¡å¤„ç†å¤±è´¥:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> processImageTask</span><span style="color:#E1E4E8;">({ </span><span style="color:#FFAB70;">imageData</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">width</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">height</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">operation</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.moduleName </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;rust&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> processor</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> rustModule.</span><span style="color:#B392F0;">createDataProcessor</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> processedData</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> processor.</span><span style="color:#B392F0;">process_async</span><span style="color:#E1E4E8;">(Array.</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(imageData));</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Uint8Array</span><span style="color:#E1E4E8;">(processedData);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> calculator</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> nativeModuleLoader.</span><span style="color:#B392F0;">getModule</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;calculator&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> calculator.</span><span style="color:#B392F0;">convertToGrayscale</span><span style="color:#E1E4E8;">(imageData, width, height);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> processPhysicsTask</span><span style="color:#E1E4E8;">({ </span><span style="color:#FFAB70;">particles</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">steps</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.moduleName </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;rust&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> rustModule.</span><span style="color:#B392F0;">physicsSimulation</span><span style="color:#E1E4E8;">(particles, steps);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // å›é€€åˆ° JavaScript å®ç°</span></span>
<span class="line"><span style="color:#F97583;">      let</span><span style="color:#E1E4E8;"> result </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> step </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; step </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> steps; step</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">        for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> particle </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; particle </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> particles; particle</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          result </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> step </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> particle;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> processMatrixTask</span><span style="color:#E1E4E8;">({ </span><span style="color:#FFAB70;">matrixA</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">matrixB</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> calculator</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> nativeModuleLoader.</span><span style="color:#B392F0;">getModule</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;calculator&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> calculator.</span><span style="color:#B392F0;">matrixMultiply</span><span style="color:#E1E4E8;">(matrixA, matrixB);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å·¥ä½œçº¿ç¨‹ä¸»é€»è¾‘</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">isMainThread) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> worker</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> NativeWorker</span><span style="color:#E1E4E8;">(workerData.moduleName, workerData.taskType);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  parentPort.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;message&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (message.type </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;shutdown&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      worker.isShuttingDown </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">taskId</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">data</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> message;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> worker.</span><span style="color:#B392F0;">processTask</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#E1E4E8;">      parentPort.</span><span style="color:#B392F0;">postMessage</span><span style="color:#E1E4E8;">({ taskId, data: result });</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      parentPort.</span><span style="color:#B392F0;">postMessage</span><span style="color:#E1E4E8;">({ </span></span>
<span class="line"><span style="color:#E1E4E8;">        taskId, </span></span>
<span class="line"><span style="color:#E1E4E8;">        error: error.message </span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–" tabindex="-1">æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ– <a class="header-anchor" href="#æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–" aria-label="Permalink to &quot;æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/performance-monitor.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { performance, PerformanceObserver } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;perf_hooks&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> NativeModulePerformanceMonitor</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.metrics </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.observer </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> PerformanceObserver</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">list</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">processMetrics</span><span style="color:#E1E4E8;">(list.</span><span style="color:#B392F0;">getEntries</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">startMonitoring</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  startMonitoring</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.observer.</span><span style="color:#B392F0;">observe</span><span style="color:#E1E4E8;">({ entryTypes: [</span><span style="color:#9ECBFF;">&#39;measure&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;function&#39;</span><span style="color:#E1E4E8;">] });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // åŒ…è£…åŸç”Ÿå‡½æ•°è°ƒç”¨ä»¥è¿›è¡Œæ€§èƒ½ç›‘æ§</span></span>
<span class="line"><span style="color:#B392F0;">  instrumentNativeFunction</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">nativeFunction</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">...</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> startMark</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">functionName</span><span style="color:#9ECBFF;">}-start\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> endMark</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">functionName</span><span style="color:#9ECBFF;">}-end\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> measureName</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">functionName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      performance.</span><span style="color:#B392F0;">mark</span><span style="color:#E1E4E8;">(startMark);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">      try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> nativeFunction</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">args);</span></span>
<span class="line"><span style="color:#E1E4E8;">        performance.</span><span style="color:#B392F0;">mark</span><span style="color:#E1E4E8;">(endMark);</span></span>
<span class="line"><span style="color:#E1E4E8;">        performance.</span><span style="color:#B392F0;">measure</span><span style="color:#E1E4E8;">(measureName, startMark, endMark);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">recordSuccess</span><span style="color:#E1E4E8;">(moduleName, functionName);</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        performance.</span><span style="color:#B392F0;">mark</span><span style="color:#E1E4E8;">(endMark);</span></span>
<span class="line"><span style="color:#E1E4E8;">        performance.</span><span style="color:#B392F0;">measure</span><span style="color:#E1E4E8;">(measureName, startMark, endMark);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">recordError</span><span style="color:#E1E4E8;">(moduleName, functionName, error);</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  processMetrics</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">entries</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    entries.</span><span style="color:#B392F0;">forEach</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">entry</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">functionName</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> entry.name.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.metrics.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(moduleName)) {</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.metrics.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(moduleName, </span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> moduleMetrics</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.metrics.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(moduleName);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">moduleMetrics.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(functionName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        moduleMetrics.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(functionName, {</span></span>
<span class="line"><span style="color:#E1E4E8;">          callCount: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          totalTime: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          averageTime: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          errorCount: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          successCount: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">        });</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> metrics</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> moduleMetrics.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(functionName);</span></span>
<span class="line"><span style="color:#E1E4E8;">      metrics.callCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      metrics.totalTime </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> entry.duration;</span></span>
<span class="line"><span style="color:#E1E4E8;">      metrics.averageTime </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> metrics.totalTime </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> metrics.callCount;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  recordSuccess</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">functionName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">updateMetrics</span><span style="color:#E1E4E8;">(moduleName, functionName, </span><span style="color:#9ECBFF;">&#39;success&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  recordError</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">updateMetrics</span><span style="color:#E1E4E8;">(moduleName, functionName, </span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`åŸç”Ÿå‡½æ•°è°ƒç”¨é”™è¯¯ [\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">functionName</span><span style="color:#9ECBFF;">}]:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  updateMetrics</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">type</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.metrics.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(moduleName)) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.metrics.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(moduleName, </span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> moduleMetrics</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.metrics.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(moduleName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">moduleMetrics.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(functionName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      moduleMetrics.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(functionName, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        callCount: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        totalTime: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        averageTime: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        errorCount: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        successCount: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> metrics</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> moduleMetrics.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(functionName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (type </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;success&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      metrics.successCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (type </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;error&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      metrics.errorCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š</span></span>
<span class="line"><span style="color:#B392F0;">  generateReport</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> report</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      timestamp: </span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">toISOString</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      modules: {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">functions</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">of</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.metrics) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      report.modules[moduleName] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">metrics</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">of</span><span style="color:#E1E4E8;"> functions) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        report.modules[moduleName][functionName] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">          ...</span><span style="color:#E1E4E8;">metrics,</span></span>
<span class="line"><span style="color:#E1E4E8;">          successRate: metrics.callCount </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#F97583;"> ?</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            (metrics.successCount </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> metrics.callCount) </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 100</span><span style="color:#F97583;"> :</span><span style="color:#79B8FF;"> 0</span></span>
<span class="line"><span style="color:#E1E4E8;">        };</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> report;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // æ£€æŸ¥æ€§èƒ½é—®é¢˜</span></span>
<span class="line"><span style="color:#B392F0;">  checkPerformanceIssues</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> issues</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> report</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">generateReport</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">functions</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">of</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(report.modules)) {</span></span>
<span class="line"><span style="color:#F97583;">      for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">metrics</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">of</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(functions)) {</span></span>
<span class="line"><span style="color:#6A737D;">        // æ£€æŸ¥å¹³å‡æ‰§è¡Œæ—¶é—´æ˜¯å¦è¿‡é•¿</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (metrics.averageTime </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 1000</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// 1ç§’</span></span>
<span class="line"><span style="color:#E1E4E8;">          issues.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">            type: </span><span style="color:#9ECBFF;">&#39;PERFORMANCE&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            module: moduleName,</span></span>
<span class="line"><span style="color:#E1E4E8;">            function: functionName,</span></span>
<span class="line"><span style="color:#E1E4E8;">            message: </span><span style="color:#9ECBFF;">\`å‡½æ•°æ‰§è¡Œæ—¶é—´è¿‡é•¿: \${</span><span style="color:#E1E4E8;">metrics</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">averageTime</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">toFixed</span><span style="color:#9ECBFF;">(</span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}ms\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            severity: </span><span style="color:#9ECBFF;">&#39;WARNING&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          });</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">        // æ£€æŸ¥é”™è¯¯ç‡æ˜¯å¦è¿‡é«˜</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (metrics.successRate </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;"> 90</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          issues.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">            type: </span><span style="color:#9ECBFF;">&#39;RELIABILITY&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            module: moduleName,</span></span>
<span class="line"><span style="color:#E1E4E8;">            function: functionName,</span></span>
<span class="line"><span style="color:#E1E4E8;">            message: </span><span style="color:#9ECBFF;">\`å‡½æ•°é”™è¯¯ç‡è¿‡é«˜: \${</span><span style="color:#9ECBFF;">(</span><span style="color:#79B8FF;">100</span><span style="color:#F97583;"> -</span><span style="color:#E1E4E8;"> metrics</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">successRate</span><span style="color:#9ECBFF;">).</span><span style="color:#B392F0;">toFixed</span><span style="color:#9ECBFF;">(</span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}%\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            severity: </span><span style="color:#9ECBFF;">&#39;ERROR&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          });</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> issues;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> performanceMonitor</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> NativeModulePerformanceMonitor</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><h2 id="å®‰å…¨æœ€ä½³å®è·µ" tabindex="-1">å®‰å…¨æœ€ä½³å®è·µ <a class="header-anchor" href="#å®‰å…¨æœ€ä½³å®è·µ" aria-label="Permalink to &quot;å®‰å…¨æœ€ä½³å®è·µ&quot;">â€‹</a></h2><h3 id="å®‰å…¨çš„æ¨¡å—åŠ è½½" tabindex="-1">å®‰å…¨çš„æ¨¡å—åŠ è½½ <a class="header-anchor" href="#å®‰å…¨çš„æ¨¡å—åŠ è½½" aria-label="Permalink to &quot;å®‰å…¨çš„æ¨¡å—åŠ è½½&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/secure-module-loader.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { createHash } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;crypto&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFileSync, statSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;fs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { join } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;path&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> SecureModuleLoader</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.trustedHashes </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">loadTrustedHashes</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  loadTrustedHashes</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // åŠ è½½å—ä¿¡ä»»çš„æ¨¡å—å“ˆå¸Œå€¼</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> hashes</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#B392F0;">        readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">join</span><span style="color:#E1E4E8;">(__dirname, </span><span style="color:#9ECBFF;">&#39;../trusted-modules.json&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.trustedHashes </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">(Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(hashes));</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ— æ³•åŠ è½½å—ä¿¡ä»»æ¨¡å—åˆ—è¡¨ï¼Œä½¿ç”¨ç©ºåˆ—è¡¨&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.trustedHashes </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Map</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // éªŒè¯æ¨¡å—å®Œæ•´æ€§</span></span>
<span class="line"><span style="color:#B392F0;">  verifyModuleIntegrity</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">modulePath</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> fileStats</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> statSync</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> fileBuffer</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> readFileSync</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // è®¡ç®—å“ˆå¸Œå€¼</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> hash</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> createHash</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sha256&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(fileBuffer).</span><span style="color:#B392F0;">digest</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> expectedHash</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.trustedHashes.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">expectedHash) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ¨¡å— \${</span><span style="color:#E1E4E8;">modulePath</span><span style="color:#9ECBFF;">} ä¸åœ¨å—ä¿¡ä»»åˆ—è¡¨ä¸­\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (hash </span><span style="color:#F97583;">!==</span><span style="color:#E1E4E8;"> expectedHash) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ¨¡å— \${</span><span style="color:#E1E4E8;">modulePath</span><span style="color:#9ECBFF;">} å“ˆå¸Œå€¼ä¸åŒ¹é…\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… æ¨¡å— \${</span><span style="color:#E1E4E8;">modulePath</span><span style="color:#9ECBFF;">} éªŒè¯æˆåŠŸ\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ¨¡å—éªŒè¯å¤±è´¥:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // å®‰å…¨åŠ è½½æ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> loadSecureModule</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">modulePath</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">fallbackImplementation</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éªŒè¯æ¨¡å—å®Œæ•´æ€§</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (process.env.</span><span style="color:#79B8FF;">NODE_ENV</span><span style="color:#F97583;"> ===</span><span style="color:#9ECBFF;"> &#39;production&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> isVerified</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">verifyModuleIntegrity</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">isVerified) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âš ï¸ æ¨¡å—éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨å›é€€å®ç°\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (fallbackImplementation) {</span></span>
<span class="line"><span style="color:#F97583;">          return</span><span style="color:#E1E4E8;"> fallbackImplementation;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">          throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ¨¡å—éªŒè¯å¤±è´¥ä¸”æ— å›é€€å®ç°\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // åŠ¨æ€å¯¼å…¥æ¨¡å—</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> module</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> import</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> module</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ¨¡å—åŠ è½½å¤±è´¥:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (fallbackImplementation) {</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> fallbackImplementation;</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // æ·»åŠ æ–°çš„å—ä¿¡ä»»æ¨¡å—</span></span>
<span class="line"><span style="color:#B392F0;">  addTrustedModule</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">modulePath</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">expectedHash</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">expectedHash) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> fileBuffer</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> readFileSync</span><span style="color:#E1E4E8;">(modulePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">      expectedHash </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> createHash</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sha256&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(fileBuffer).</span><span style="color:#B392F0;">digest</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.trustedHashes.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(modulePath, expectedHash);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–°å—ä¿¡ä»»æ¨¡å—æ–‡ä»¶</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">saveTrustedHashes</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  saveTrustedHashes</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> hashesObject</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">fromEntries</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.trustedHashes);</span></span>
<span class="line"><span style="color:#B392F0;">    writeFileSync</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#B392F0;">      join</span><span style="color:#E1E4E8;">(__dirname, </span><span style="color:#9ECBFF;">&#39;../trusted-modules.json&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#79B8FF;">      JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(hashesObject, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> secureModuleLoader</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> SecureModuleLoader</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><h3 id="è¿›ç¨‹é—´é€šä¿¡å®‰å…¨" tabindex="-1">è¿›ç¨‹é—´é€šä¿¡å®‰å…¨ <a class="header-anchor" href="#è¿›ç¨‹é—´é€šä¿¡å®‰å…¨" aria-label="Permalink to &quot;è¿›ç¨‹é—´é€šä¿¡å®‰å…¨&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// lib/secure-ipc.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ipcMain, ipcRenderer } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { createHash, randomBytes, createCipheriv, createDecipheriv } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;crypto&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> SecureIPC</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.sessionKey </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.initialized </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // åˆå§‹åŒ–å®‰å…¨ä¼šè¯</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> initializeSecureSession</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.initialized) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // ç”Ÿæˆä¼šè¯å¯†é’¥</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.sessionKey </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> randomBytes</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> ipcMain </span><span style="color:#F97583;">!==</span><span style="color:#9ECBFF;"> &#39;undefined&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">      // ä¸»è¿›ç¨‹ï¼šç­‰å¾…æ¸²æŸ“è¿›ç¨‹è¿æ¥</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupMainProcessSecurity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // æ¸²æŸ“è¿›ç¨‹ï¼šè¯·æ±‚ä¼šè¯å¯†é’¥</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupRendererProcessSecurity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.initialized </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  setupMainProcessSecurity</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    ipcMain.</span><span style="color:#B392F0;">handle</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;secure-session-request&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // éªŒè¯æ¸²æŸ“è¿›ç¨‹æ¥æº</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> senderUrl</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(event.senderFrame.url);</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (senderUrl.origin </span><span style="color:#F97583;">!==</span><span style="color:#9ECBFF;"> &#39;file://&#39;</span><span style="color:#F97583;"> &amp;&amp;</span><span style="color:#F97583;"> !</span><span style="color:#E1E4E8;">senderUrl.hostname.</span><span style="color:#B392F0;">endsWith</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.trusted.com&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        event.senderFrame.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;secure-session-error&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;æœªæˆæƒçš„æ¥æº&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // å‘é€åŠ å¯†çš„ä¼šè¯å¯†é’¥</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">encryptData</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.sessionKey.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> setupRendererProcessSecurity</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> encryptedKey</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> ipcRenderer.</span><span style="color:#B392F0;">invoke</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;secure-session-request&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> decryptedKey</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">decryptData</span><span style="color:#E1E4E8;">(encryptedKey);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.sessionKey </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Buffer.</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(decryptedKey, </span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… å®‰å…¨ä¼šè¯å·²å»ºç«‹&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å®‰å…¨ä¼šè¯å»ºç«‹å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // åŠ å¯†æ•°æ®</span></span>
<span class="line"><span style="color:#B392F0;">  encryptData</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> iv</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> randomBytes</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> cipher</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> createCipheriv</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;aes-256-gcm&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.sessionKey, iv);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> encrypted </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> cipher.</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(data), </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    encrypted </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> cipher.</span><span style="color:#B392F0;">final</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> authTag</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> cipher.</span><span style="color:#B392F0;">getAuthTag</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      iv: iv.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">      data: encrypted,</span></span>
<span class="line"><span style="color:#E1E4E8;">      authTag: authTag.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // è§£å¯†æ•°æ®</span></span>
<span class="line"><span style="color:#B392F0;">  decryptData</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">encryptedData</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">iv</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">data</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">authTag</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> encryptedData;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> decipher</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> createDecipheriv</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;aes-256-gcm&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.sessionKey, </span></span>
<span class="line"><span style="color:#E1E4E8;">      Buffer.</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(iv, </span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    decipher.</span><span style="color:#B392F0;">setAuthTag</span><span style="color:#E1E4E8;">(Buffer.</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(authTag, </span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> decrypted </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> decipher.</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(data, </span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    decrypted </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> decipher.</span><span style="color:#B392F0;">final</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(decrypted);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // å®‰å…¨åœ°è°ƒç”¨åŸç”Ÿå‡½æ•°</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> secureNativeCall</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">...</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureInitialized</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> request</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      module: moduleName,</span></span>
<span class="line"><span style="color:#E1E4E8;">      function: functionName,</span></span>
<span class="line"><span style="color:#E1E4E8;">      args: args,</span></span>
<span class="line"><span style="color:#E1E4E8;">      timestamp: Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      nonce: </span><span style="color:#B392F0;">randomBytes</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // åŠ å¯†è¯·æ±‚</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> encryptedRequest</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">encryptData</span><span style="color:#E1E4E8;">(request);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // é€šè¿‡å®‰å…¨çš„ IPC å‘é€è¯·æ±‚</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> encryptedResponse</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> ipcRenderer.</span><span style="color:#B392F0;">invoke</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">        &#39;secure-native-call&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        encryptedRequest</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // è§£å¯†å“åº”</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> response</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">decryptData</span><span style="color:#E1E4E8;">(encryptedResponse);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (response.error) {</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(response.error);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> response.result;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å®‰å…¨åŸç”Ÿè°ƒç”¨å¤±è´¥ [\${</span><span style="color:#E1E4E8;">moduleName</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">functionName</span><span style="color:#9ECBFF;">}]:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> ensureInitialized</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.initialized) {</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">initializeSecureSession</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> secureIPC</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> SecureIPC</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><p>é€šè¿‡ç³»ç»ŸåŒ–çš„æ¶æ„è®¾è®¡å’Œä¸¥æ ¼çš„å®‰å…¨å®è·µï¼ŒC++/Rust/NAPI ä¸ Electron çš„é›†æˆèƒ½å¤Ÿä¸ºæ¡Œé¢åº”ç”¨å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡å’ŒåŠŸèƒ½æ‰©å±•ï¼ŒåŒæ—¶ç¡®ä¿åº”ç”¨çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚</p>`,49)])])}const B=n(o,[["render",e]]);export{i as __pageData,B as default};
