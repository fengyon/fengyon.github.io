import{_ as a,c as n,o as l,b as e}from"./chunks/framework.CMLuPXeo.js";const d=JSON.parse('{"title":"nextjs 中间件","description":"","frontmatter":{},"headers":[{"level":2,"title":"中间件的作用时机","slug":"中间件的作用时机","link":"#中间件的作用时机","children":[]},{"level":2,"title":"适用场景","slug":"适用场景","link":"#适用场景","children":[{"level":3,"title":"中间件有效的场景","slug":"中间件有效的场景","link":"#中间件有效的场景","children":[]},{"level":3,"title":"中间件不适用的场景","slug":"中间件不适用的场景","link":"#中间件不适用的场景","children":[]}]},{"level":2,"title":"基本用法","slug":"基本用法","link":"#基本用法","children":[{"level":3,"title":"文件约定","slug":"文件约定","link":"#文件约定","children":[]},{"level":3,"title":"基本示例","slug":"基本示例","link":"#基本示例","children":[]}]},{"level":2,"title":"路径匹配","slug":"路径匹配","link":"#路径匹配","children":[{"level":3,"title":"匹配器配置","slug":"匹配器配置","link":"#匹配器配置","children":[]},{"level":3,"title":"条件语句匹配","slug":"条件语句匹配","link":"#条件语句匹配","children":[]}]},{"level":2,"title":"NextResponse API","slug":"nextresponse-api","link":"#nextresponse-api","children":[{"level":3,"title":"重定向和重写","slug":"重定向和重写","link":"#重定向和重写","children":[]},{"level":3,"title":"设置请求和响应头","slug":"设置请求和响应头","link":"#设置请求和响应头","children":[]}]},{"level":2,"title":"Cookie 操作","slug":"cookie-操作","link":"#cookie-操作","children":[{"level":3,"title":"Cookie 基本操作","slug":"cookie-基本操作","link":"#cookie-基本操作","children":[]}]},{"level":2,"title":"实际应用示例","slug":"实际应用示例","link":"#实际应用示例","children":[{"level":3,"title":"A/B 测试","slug":"a-b-测试","link":"#a-b-测试","children":[]},{"level":3,"title":"身份验证检查","slug":"身份验证检查","link":"#身份验证检查","children":[]},{"level":3,"title":"地域重定向","slug":"地域重定向","link":"#地域重定向","children":[]}]},{"level":2,"title":"性能考虑","slug":"性能考虑","link":"#性能考虑","children":[]}],"relativePath":"framework/nextjs/middleware.md","filePath":"framework/nextjs/middleware.md"}'),p={name:"framework/nextjs/middleware.md"};function o(t,s,c,r,i,E){return l(),n("div",null,[...s[0]||(s[0]=[e(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /framework/nextjs/middleware.md for this page in Markdown format</div><h1 id="nextjs-中间件" tabindex="-1">nextjs 中间件 <a class="header-anchor" href="#nextjs-中间件" aria-label="Permalink to &quot;nextjs 中间件&quot;">​</a></h1><p>Next.js 中间件允许你在请求完成之前运行代码。它基于传入的请求，通过重写、重定向、修改请求或响应头，或者直接响应来修改响应。</p><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>请求生命周期：</span></span>
<span class="line"><span>[请求到达] → [中间件执行] → [路由匹配/缓存内容] → [页面渲染]</span></span>
<span class="line"><span>        ↓</span></span>
<span class="line"><span>中间件可以：重定向、重写、修改头信息、直接响应</span></span></code></pre></div><h2 id="中间件的作用时机" tabindex="-1">中间件的作用时机 <a class="header-anchor" href="#中间件的作用时机" aria-label="Permalink to &quot;中间件的作用时机&quot;">​</a></h2><p>中间件在缓存内容和路由匹配之前运行。它的执行顺序在 Next.js 请求处理流程中相对靠前。</p><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Next.js 请求处理流程：</span></span>
<span class="line"><span>1. headers 从 next.config.js</span></span>
<span class="line"><span>2. redirects 从 next.config.js  </span></span>
<span class="line"><span>3. 中间件 (rewrites, redirects 等)</span></span>
<span class="line"><span>4. beforeFiles (rewrites) 从 next.config.js</span></span>
<span class="line"><span>5. 文件系统路由 (public/, _next/static/, pages/, app/ 等)</span></span>
<span class="line"><span>6. afterFiles (rewrites) 从 next.config.js</span></span>
<span class="line"><span>7. 动态路由 (/blog/[slug])</span></span>
<span class="line"><span>8. fallback (rewrites) 从 next.config.js</span></span></code></pre></div><h2 id="适用场景" tabindex="-1">适用场景 <a class="header-anchor" href="#适用场景" aria-label="Permalink to &quot;适用场景&quot;">​</a></h2><h3 id="中间件有效的场景" tabindex="-1">中间件有效的场景 <a class="header-anchor" href="#中间件有效的场景" aria-label="Permalink to &quot;中间件有效的场景&quot;">​</a></h3><ul><li>读取部分传入请求后快速重定向</li><li>根据 A/B 测试或实验重写到不同的页面</li><li>修改所有页面或部分页面的标题</li></ul><h3 id="中间件不适用的场景" tabindex="-1">中间件不适用的场景 <a class="header-anchor" href="#中间件不适用的场景" aria-label="Permalink to &quot;中间件不适用的场景&quot;">​</a></h3><ul><li>数据获取速度慢</li><li>会话管理</li></ul><h2 id="基本用法" tabindex="-1">基本用法 <a class="header-anchor" href="#基本用法" aria-label="Permalink to &quot;基本用法&quot;">​</a></h2><h3 id="文件约定" tabindex="-1">文件约定 <a class="header-anchor" href="#文件约定" aria-label="Permalink to &quot;文件约定&quot;">​</a></h3><p>在项目根目录创建 <code>middleware.ts</code> (或 <code>.js</code>) 文件来定义中间件。该文件应与 <code>pages</code> 或 <code>app</code> 目录处于同一级别，或者在 <code>src</code> 内部 (如果使用的话)。</p><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>项目结构：</span></span>
<span class="line"><span>my-project/</span></span>
<span class="line"><span>├── middleware.ts    # 中间件文件</span></span>
<span class="line"><span>├── app/ (或 pages/) # 路由目录</span></span>
<span class="line"><span>├── public/         # 静态资源</span></span>
<span class="line"><span>└── ...             # 其他文件</span></span></code></pre></div><p>注意：每个项目仅支持一个 <code>middleware.ts</code> 文件，但你可以将中间件逻辑模块化，分解到单独的文件中，然后导入到主 <code>middleware.ts</code> 文件中。</p><h3 id="基本示例" tabindex="-1">基本示例 <a class="header-anchor" href="#基本示例" aria-label="Permalink to &quot;基本示例&quot;">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { NextResponse } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#F97583;"> type</span><span style="color:#E1E4E8;"> { NextRequest } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">  // 重定向到 /home</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">redirect</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/home&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 配置匹配路径</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> config</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  matcher: </span><span style="color:#9ECBFF;">&#39;/about/:path*&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="路径匹配" tabindex="-1">路径匹配 <a class="header-anchor" href="#路径匹配" aria-label="Permalink to &quot;路径匹配&quot;">​</a></h2><h3 id="匹配器配置" tabindex="-1">匹配器配置 <a class="header-anchor" href="#匹配器配置" aria-label="Permalink to &quot;匹配器配置&quot;">​</a></h3><p>使用 <code>matcher</code> 来过滤中间件在特定路径上运行。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> config</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  matcher: [</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;/about/:path*&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;/dashboard/:path*&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  ],</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>匹配器规则：</p><ul><li>必须以 <code>/</code> 开头</li><li>可以包含命名参数：<code>/about/:path</code> 匹配 <code>/about/a</code> 和 <code>/about/b</code>，但不匹配 <code>/about/a/c</code></li><li>可以包含修饰符：<code>*</code> (零个或多个)、<code>?</code> (零个或一个)、<code>+</code> (一个或多个)</li><li>支持正则表达式</li></ul><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>matcher 示例：</span></span>
<span class="line"><span>/about/:path*   匹配 /about, /about/a, /about/a/b/c</span></span>
<span class="line"><span>/blog/:slug?   匹配 /blog 和 /blog/any-slug  </span></span>
<span class="line"><span>/products/:id+ 匹配 /products/123 但不匹配 /products</span></span></code></pre></div><h3 id="条件语句匹配" tabindex="-1">条件语句匹配 <a class="header-anchor" href="#条件语句匹配" aria-label="Permalink to &quot;条件语句匹配&quot;">​</a></h3><p>除了匹配器配置，你也可以在中间件函数内使用条件语句进行路径匹配。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { NextResponse } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#F97583;"> type</span><span style="color:#E1E4E8;"> { NextRequest } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (request.nextUrl.pathname.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/about&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/about-2&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (request.nextUrl.pathname.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/dashboard&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/dashboard/user&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="nextresponse-api" tabindex="-1">NextResponse API <a class="header-anchor" href="#nextresponse-api" aria-label="Permalink to &quot;NextResponse API&quot;">​</a></h2><p><code>NextResponse</code> API 允许你执行多种操作：</p><h3 id="重定向和重写" tabindex="-1">重定向和重写 <a class="header-anchor" href="#重定向和重写" aria-label="Permalink to &quot;重定向和重写&quot;">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 重定向到不同 URL</span></span>
<span class="line"><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">redirect</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/new-page&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 重写响应（显示不同 URL 的内容）</span></span>
<span class="line"><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/hidden-page&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span></code></pre></div><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>重定向 vs 重写：</span></span>
<span class="line"><span>请求 /old → 重定向到 /new → 浏览器地址栏变化</span></span>
<span class="line"><span>请求 /old → 重写到 /hidden → 显示 /hidden 内容，地址栏保持 /old</span></span></code></pre></div><h3 id="设置请求和响应头" tabindex="-1">设置请求和响应头 <a class="header-anchor" href="#设置请求和响应头" aria-label="Permalink to &quot;设置请求和响应头&quot;">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">  // 克隆请求头并设置新头信息</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> requestHeaders</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Headers</span><span style="color:#E1E4E8;">(request.headers)</span></span>
<span class="line"><span style="color:#E1E4E8;">  requestHeaders.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;x-custom-header&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;hello&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 创建修改了头信息的响应</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> response</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">next</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    request: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      headers: requestHeaders,</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 设置响应头</span></span>
<span class="line"><span style="color:#E1E4E8;">  response.headers.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;x-response-header&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;world&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> response</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="cookie-操作" tabindex="-1">Cookie 操作 <a class="header-anchor" href="#cookie-操作" aria-label="Permalink to &quot;Cookie 操作&quot;">​</a></h2><p>Next.js 通过 <code>NextRequest</code> 和 <code>NextResponse</code> 上的 <code>cookies</code> 扩展提供了便捷的 cookie 访问和操作方法。</p><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>请求 Cookie: 存储在 Cookie 头中</span></span>
<span class="line"><span>响应 Cookie: 存储在 Set-Cookie 头中</span></span></code></pre></div><h3 id="cookie-基本操作" tabindex="-1">Cookie 基本操作 <a class="header-anchor" href="#cookie-基本操作" aria-label="Permalink to &quot;Cookie 基本操作&quot;">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { NextResponse } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#F97583;"> type</span><span style="color:#E1E4E8;"> { NextRequest } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">  // 从请求中获取 cookie</span></span>
<span class="line"><span style="color:#F97583;">  let</span><span style="color:#E1E4E8;"> cookie </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.cookies.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;session&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(cookie) </span><span style="color:#6A737D;">// =&gt; { name: &#39;session&#39;, value: &#39;123&#39;, Path: &#39;/&#39; }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 检查 cookie 是否存在</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (request.cookies.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;session&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#6A737D;">    // 删除 cookie</span></span>
<span class="line"><span style="color:#E1E4E8;">    request.cookies.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;session&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 在响应中设置 cookie</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> response</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">next</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  response.cookies.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;user-token&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;abc123&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> response</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="实际应用示例" tabindex="-1">实际应用示例 <a class="header-anchor" href="#实际应用示例" aria-label="Permalink to &quot;实际应用示例&quot;">​</a></h2><h3 id="a-b-测试" tabindex="-1">A/B 测试 <a class="header-anchor" href="#a-b-测试" aria-label="Permalink to &quot;A/B 测试&quot;">​</a></h3><p>中间件非常适合实现 A/B 测试。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { NextResponse } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#F97583;"> type</span><span style="color:#E1E4E8;"> { NextRequest } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">  // 基于 cookie 或随机分配决定版本</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> variant</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">random</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#F97583;"> ?</span><span style="color:#9ECBFF;"> &#39;a&#39;</span><span style="color:#F97583;"> :</span><span style="color:#9ECBFF;"> &#39;b&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (request.nextUrl.pathname </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;/home&#39;</span><span style="color:#F97583;"> &amp;&amp;</span><span style="color:#E1E4E8;"> variant </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;b&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/home-b&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">next</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="身份验证检查" tabindex="-1">身份验证检查 <a class="header-anchor" href="#身份验证检查" aria-label="Permalink to &quot;身份验证检查&quot;">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { NextResponse } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#F97583;"> type</span><span style="color:#E1E4E8;"> { NextRequest } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> token</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> request.cookies.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;auth-token&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 如果访问受保护页面且未登录，重定向到登录页</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (request.nextUrl.pathname.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/dashboard&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#F97583;"> !</span><span style="color:#E1E4E8;">token) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">redirect</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/login&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 如果已登录但访问登录页，重定向到仪表板</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (request.nextUrl.pathname </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;/login&#39;</span><span style="color:#F97583;"> &amp;&amp;</span><span style="color:#E1E4E8;"> token) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">redirect</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/dashboard&#39;</span><span style="color:#E1E4E8;">, request.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">next</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> config</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  matcher: [</span><span style="color:#9ECBFF;">&#39;/dashboard/:path*&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;/login&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="地域重定向" tabindex="-1">地域重定向 <a class="header-anchor" href="#地域重定向" aria-label="Permalink to &quot;地域重定向&quot;">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { NextResponse } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#F97583;"> type</span><span style="color:#E1E4E8;"> { NextRequest } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;next/server&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> middleware</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">request</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> NextRequest</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> country</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> request.geo?.country </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> &#39;US&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 根据用户地区重写 URL</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (country </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;CN&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> URL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/zh-cn&#39;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> request.nextUrl.pathname))</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> NextResponse.</span><span style="color:#B392F0;">next</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="性能考虑" tabindex="-1">性能考虑 <a class="header-anchor" href="#性能考虑" aria-label="Permalink to &quot;性能考虑&quot;">​</a></h2><p>由于中间件为每个匹配的请求运行，应确保其逻辑轻量高效。</p><p>优化建议：</p><ul><li>使用精确的 matcher 配置减少不必要的执行</li><li>避免在中间件中进行慢速数据获取</li><li>将复杂逻辑模块化到单独文件中</li></ul><p>示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>性能优化：</span></span>
<span class="line"><span>精确匹配: matcher: &#39;/admin/:path*&#39; 而非 matcher: &#39;/:path*&#39;</span></span>
<span class="line"><span>轻量逻辑: 避免数据库查询、复杂计算</span></span>
<span class="line"><span>快速返回: 尽早返回响应</span></span></code></pre></div>`,61)])])}const F=a(p,[["render",o]]);export{d as __pageData,F as default};
