import{_ as n,c as a,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const F=JSON.parse('{"title":"WASM 与 JS 交互","description":"","frontmatter":{},"headers":[{"level":2,"title":"交互基础","slug":"交互基础","link":"#交互基础","children":[{"level":3,"title":"核心交互机制","slug":"核心交互机制","link":"#核心交互机制","children":[]}]},{"level":2,"title":"模块加载与实例化","slug":"模块加载与实例化","link":"#模块加载与实例化","children":[{"level":3,"title":"流式实例化","slug":"流式实例化","link":"#流式实例化","children":[]},{"level":3,"title":"实用封装函数","slug":"实用封装函数","link":"#实用封装函数","children":[]}]},{"level":2,"title":"函数导入与导出","slug":"函数导入与导出","link":"#函数导入与导出","children":[{"level":3,"title":"从 JavaScript 导入函数到 WASM","slug":"从-javascript-导入函数到-wasm","link":"#从-javascript-导入函数到-wasm","children":[]},{"level":3,"title":"从 WASM 导出函数到 JavaScript","slug":"从-wasm-导出函数到-javascript","link":"#从-wasm-导出函数到-javascript","children":[]}]},{"level":2,"title":"内存管理与数据交换","slug":"内存管理与数据交换","link":"#内存管理与数据交换","children":[{"level":3,"title":"共享内存机制","slug":"共享内存机制","link":"#共享内存机制","children":[]},{"level":3,"title":"内存操作实战","slug":"内存操作实战","link":"#内存操作实战","children":[]},{"level":3,"title":"内存分配策略","slug":"内存分配策略","link":"#内存分配策略","children":[]}]},{"level":2,"title":"高级数据类型处理","slug":"高级数据类型处理","link":"#高级数据类型处理","children":[{"level":3,"title":"复杂数据结构传递","slug":"复杂数据结构传递","link":"#复杂数据结构传递","children":[]}]},{"level":2,"title":"系统接口与 WASI","slug":"系统接口与-wasi","link":"#系统接口与-wasi","children":[{"level":3,"title":"Node.js 中的 WASI 集成","slug":"node-js-中的-wasi-集成","link":"#node-js-中的-wasi-集成","children":[]},{"level":3,"title":"as-wasi：高级 AssemblyScript 封装","slug":"as-wasi-高级-assemblyscript-封装","link":"#as-wasi-高级-assemblyscript-封装","children":[]}]},{"level":2,"title":"交互模式与架构","slug":"交互模式与架构","link":"#交互模式与架构","children":[{"level":3,"title":"命令模式 (Command Pattern)","slug":"命令模式-command-pattern","link":"#命令模式-command-pattern","children":[]},{"level":3,"title":"反应器模式 (Reactor Pattern)","slug":"反应器模式-reactor-pattern","link":"#反应器模式-reactor-pattern","children":[]}]},{"level":2,"title":"性能优化技巧","slug":"性能优化技巧","link":"#性能优化技巧","children":[{"level":3,"title":"最小化 JS-WASM 边界跨越","slug":"最小化-js-wasm-边界跨越","link":"#最小化-js-wasm-边界跨越","children":[]},{"level":3,"title":"内存管理最佳实践","slug":"内存管理最佳实践","link":"#内存管理最佳实践","children":[]}]},{"level":2,"title":"调试与错误处理","slug":"调试与错误处理","link":"#调试与错误处理","children":[{"level":3,"title":"跨边界错误处理","slug":"跨边界错误处理","link":"#跨边界错误处理","children":[]}]}],"relativePath":"leading/webassembly/js-interaction.md","filePath":"leading/webassembly/js-interaction.md"}'),o={name:"leading/webassembly/js-interaction.md"};function e(t,s,c,r,E,y){return l(),a("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /leading/webassembly/js-interaction.md for this page in Markdown format</div><h1 id="wasm-与-js-交互" tabindex="-1">WASM 与 JS 交互 <a class="header-anchor" href="#wasm-与-js-交互" aria-label="Permalink to &quot;WASM 与 JS 交互&quot;">​</a></h1><h2 id="交互基础" tabindex="-1">交互基础 <a class="header-anchor" href="#交互基础" aria-label="Permalink to &quot;交互基础&quot;">​</a></h2><p>WebAssembly (WASM) 与 JavaScript 的集成为开发者提供了更多选择和灵活性。WASM 本身并不具备与浏览器直接交互的能力，需要与 JavaScript 进行集成才能实现与 Web 平台的无缝交互。这种协作关系让开发者能够充分利用 WASM 的高性能特性，同时保留 JavaScript 的灵活性和丰富生态系统。</p><h3 id="核心交互机制" tabindex="-1">核心交互机制 <a class="header-anchor" href="#核心交互机制" aria-label="Permalink to &quot;核心交互机制&quot;">​</a></h3><p>WASM 与 JavaScript 之间通过两种主要方式进行交互：导入导出和 WebAssembly 的 JavaScript API。</p><p><strong>模块交互示意图：</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>JavaScript 环境</span></span>
<span class="line"><span>    ↓ ↑ 调用函数/传递数据</span></span>
<span class="line"><span>WASM 实例</span></span>
<span class="line"><span>    ├── 导出函数 (供 JS 调用)</span></span>
<span class="line"><span>    ├── 导入函数 (调用 JS 功能)  </span></span>
<span class="line"><span>    └── 线性内存 (共享数据)</span></span></code></pre></div><h2 id="模块加载与实例化" tabindex="-1">模块加载与实例化 <a class="header-anchor" href="#模块加载与实例化" aria-label="Permalink to &quot;模块加载与实例化&quot;">​</a></h2><h3 id="流式实例化" tabindex="-1">流式实例化 <a class="header-anchor" href="#流式实例化" aria-label="Permalink to &quot;流式实例化&quot;">​</a></h3><p>使用 <code>WebAssembly.instantiateStreaming</code> 可以直接从 Response 对象实例化 WASM 模块，这是最高效的加载方式：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 使用 Fetch API 加载和实例化 WASM 模块</span></span>
<span class="line"><span style="color:#E1E4E8;">WebAssembly.</span><span style="color:#B392F0;">instantiateStreaming</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">fetch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;module.wasm&#39;</span><span style="color:#E1E4E8;">), importObject)</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">results</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> instance</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> results.instance;</span></span>
<span class="line"><span style="color:#6A737D;">    // 使用导出的函数</span></span>
<span class="line"><span style="color:#E1E4E8;">    instance.exports.</span><span style="color:#B392F0;">exported_func</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span></code></pre></div><p>如果环境不支持流式实例化，可以使用缓冲方式：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 缓冲实例化作为备选方案</span></span>
<span class="line"><span style="color:#B392F0;">fetch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;module.wasm&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">response</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> response.</span><span style="color:#B392F0;">arrayBuffer</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">bytes</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">instantiate</span><span style="color:#E1E4E8;">(bytes, importObject))</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">results</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    results.instance.exports.</span><span style="color:#B392F0;">exported_func</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span></code></pre></div><h3 id="实用封装函数" tabindex="-1">实用封装函数 <a class="header-anchor" href="#实用封装函数" aria-label="Permalink to &quot;实用封装函数&quot;">​</a></h3><p>对于需要多次加载模块的场景，可以创建实用函数简化代码：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 封装获取和实例化的实用函数</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> fetchAndInstantiate</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">url</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">importObject</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#B392F0;"> fetch</span><span style="color:#E1E4E8;">(url)</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">response</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> response.</span><span style="color:#B392F0;">arrayBuffer</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">bytes</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">instantiate</span><span style="color:#E1E4E8;">(bytes, importObject))</span></span>
<span class="line"><span style="color:#E1E4E8;">    .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">results</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> results.instance);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 使用示例</span></span>
<span class="line"><span style="color:#B392F0;">fetchAndInstantiate</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;module.wasm&#39;</span><span style="color:#E1E4E8;">, importObject)</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    instance.exports.</span><span style="color:#B392F0;">exported_func</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span></code></pre></div><h2 id="函数导入与导出" tabindex="-1">函数导入与导出 <a class="header-anchor" href="#函数导入与导出" aria-label="Permalink to &quot;函数导入与导出&quot;">​</a></h2><h3 id="从-javascript-导入函数到-wasm" tabindex="-1">从 JavaScript 导入函数到 WASM <a class="header-anchor" href="#从-javascript-导入函数到-wasm" aria-label="Permalink to &quot;从 JavaScript 导入函数到 WASM&quot;">​</a></h3><p>在实例化 WASM 模块时，可以通过导入对象将 JavaScript 函数注入到 WASM 环境中：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 创建导入对象，包含 WASM 模块需要的外部函数</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> importObject</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // 环境相关的导入</span></span>
<span class="line"><span style="color:#E1E4E8;">  env: {</span></span>
<span class="line"><span style="color:#6A737D;">    // 内存操作函数</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryBase: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    tableBase: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    memory: </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">Memory</span><span style="color:#E1E4E8;">({ initial: </span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;"> }),</span></span>
<span class="line"><span style="color:#E1E4E8;">    table: </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">Table</span><span style="color:#E1E4E8;">({ initial: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, element: </span><span style="color:#9ECBFF;">&#39;anyfunc&#39;</span><span style="color:#E1E4E8;"> }),</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 从 JS 导入到 WASM 的函数</span></span>
<span class="line"><span style="color:#B392F0;">    js_log</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">value</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;WASM 输出:&#39;</span><span style="color:#E1E4E8;">, value),</span></span>
<span class="line"><span style="color:#B392F0;">    js_alert</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">messagePtr</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> message</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> getStringFromMemory</span><span style="color:#E1E4E8;">(instance, messagePtr);</span></span>
<span class="line"><span style="color:#B392F0;">      alert</span><span style="color:#E1E4E8;">(message);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 实例化时提供导入对象</span></span>
<span class="line"><span style="color:#E1E4E8;">WebAssembly.</span><span style="color:#B392F0;">instantiateStreaming</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">fetch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;module.wasm&#39;</span><span style="color:#E1E4E8;">), importObject)</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">results</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    instance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> results.instance;</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span></code></pre></div><p>在 C/C++ 代码中声明对应的导入函数：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 在 C 代码中声明导入的 JS 函数</span></span>
<span class="line"><span style="color:#F97583;">extern</span><span style="color:#F97583;"> void</span><span style="color:#B392F0;"> js_log</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> value</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">extern</span><span style="color:#F97583;"> void</span><span style="color:#B392F0;"> js_alert</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">const</span><span style="color:#F97583;"> char*</span><span style="color:#FFAB70;"> message</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 在 C 函数中调用 JS 函数</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> wasm_function</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#B392F0;">    js_log</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">    js_alert</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Hello from WASM!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="从-wasm-导出函数到-javascript" tabindex="-1">从 WASM 导出函数到 JavaScript <a class="header-anchor" href="#从-wasm-导出函数到-javascript" aria-label="Permalink to &quot;从 WASM 导出函数到 JavaScript&quot;">​</a></h3><p>WASM 模块可以将函数导出供 JavaScript 调用：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 在 C 代码中定义导出函数</span></span>
<span class="line"><span style="color:#B392F0;">__attribute__</span><span style="color:#E1E4E8;">((used)) </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> export </span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> a</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#FFAB70;"> b</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">__attribute__</span><span style="color:#E1E4E8;">((used)) </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> export </span><span style="color:#B392F0;">calculate</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">double</span><span style="color:#FFAB70;"> x</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 2.5</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>在 JavaScript 中调用导出的 WASM 函数：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 调用 WASM 导出的函数</span></span>
<span class="line"><span style="color:#E1E4E8;">instance.exports.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">);        </span><span style="color:#6A737D;">// 返回 8</span></span>
<span class="line"><span style="color:#E1E4E8;">instance.exports.</span><span style="color:#B392F0;">calculate</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10.0</span><span style="color:#E1E4E8;">);  </span><span style="color:#6A737D;">// 返回 25.0</span></span></code></pre></div><h2 id="内存管理与数据交换" tabindex="-1">内存管理与数据交换 <a class="header-anchor" href="#内存管理与数据交换" aria-label="Permalink to &quot;内存管理与数据交换&quot;">​</a></h2><h3 id="共享内存机制" tabindex="-1">共享内存机制 <a class="header-anchor" href="#共享内存机制" aria-label="Permalink to &quot;共享内存机制&quot;">​</a></h3><p>WebAssembly.Memory 对象是 JS 和 WASM 之间共享内存的核心。当 WebAssembly 模块被实例化时，它需要一个 memory 对象。</p><p><strong>内存共享示意图：</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>WebAssembly.Memory</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>ArrayBuffer ← JS 和 WASM 都可以访问</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>类型化数组 (Uint8Array, Int32Array 等)</span></span></code></pre></div><h3 id="内存操作实战" tabindex="-1">内存操作实战 <a class="header-anchor" href="#内存操作实战" aria-label="Permalink to &quot;内存操作实战&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 创建共享内存</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> memory</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">Memory</span><span style="color:#E1E4E8;">({ initial: </span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;"> }); </span><span style="color:#6A737D;">// 256页 = 16MB</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 在导入对象中提供内存</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> importObject</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  env: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    memory: memory</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 从 JS 访问 WASM 内存</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> readStringFromMemory</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">pointer</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">maxLength</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 256</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> memoryView</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Uint8Array</span><span style="color:#E1E4E8;">(memory.buffer);</span></span>
<span class="line"><span style="color:#F97583;">  let</span><span style="color:#E1E4E8;"> string </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">  for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> maxLength; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> char</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> memoryView[pointer </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i];</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (char </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 遇到 null 终止符停止</span></span>
<span class="line"><span style="color:#E1E4E8;">    string </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> String.</span><span style="color:#B392F0;">fromCharCode</span><span style="color:#E1E4E8;">(char);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> string;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> writeStringToMemory</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">pointer</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">string</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> memoryView</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Uint8Array</span><span style="color:#E1E4E8;">(memory.buffer);</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> encoder</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> TextEncoder</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> encoded</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> encoder.</span><span style="color:#B392F0;">encode</span><span style="color:#E1E4E8;">(string);</span></span>
<span class="line"><span style="color:#F97583;">  for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> encoded.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryView[pointer </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> encoded[i];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#6A737D;">  // 添加 null 终止符</span></span>
<span class="line"><span style="color:#E1E4E8;">  memoryView[pointer </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> encoded.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="内存分配策略" tabindex="-1">内存分配策略 <a class="header-anchor" href="#内存分配策略" aria-label="Permalink to &quot;内存分配策略&quot;">​</a></h3><p>对于复杂的数据交换，建议在 WASM 侧实现内存分配函数：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// C 代码中实现内存分配函数</span></span>
<span class="line"><span style="color:#F97583;">#define</span><span style="color:#B392F0;"> WASM_EXPORT</span><span style="color:#B392F0;"> __attribute__</span><span style="color:#E1E4E8;">((</span><span style="color:#B392F0;">visibility</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;default&quot;</span><span style="color:#E1E4E8;">)))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">void*</span><span style="color:#B392F0;"> malloc</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">size_t</span><span style="color:#FFAB70;"> size</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#B392F0;"> free</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">void*</span><span style="color:#FFAB70;"> ptr</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">WASM_EXPORT </span><span style="color:#F97583;">void*</span><span style="color:#B392F0;"> wasm_malloc</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">size_t</span><span style="color:#FFAB70;"> size</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> malloc</span><span style="color:#E1E4E8;">(size);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">WASM_EXPORT </span><span style="color:#F97583;">void</span><span style="color:#B392F0;"> wasm_free</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">void*</span><span style="color:#FFAB70;"> ptr</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#B392F0;">    free</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>在 JavaScript 中使用这些分配函数：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// JavaScript 中使用 WASM 的内存分配</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> allocateMemoryForWasm</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> data </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;string&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> bytes</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> TextEncoder</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">encode</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> ptr</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> instance.exports.</span><span style="color:#B392F0;">wasm_malloc</span><span style="color:#E1E4E8;">(bytes.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (ptr </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">return</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 分配失败</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> memoryView</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Uint8Array</span><span style="color:#E1E4E8;">(memory.buffer);</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> bytes.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      memoryView[ptr </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> bytes[i];</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryView[ptr </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> bytes.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// null 终止符</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> ptr;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> freeMemoryInWasm</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">ptr</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  instance.exports.</span><span style="color:#B392F0;">wasm_free</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="高级数据类型处理" tabindex="-1">高级数据类型处理 <a class="header-anchor" href="#高级数据类型处理" aria-label="Permalink to &quot;高级数据类型处理&quot;">​</a></h2><h3 id="复杂数据结构传递" tabindex="-1">复杂数据结构传递 <a class="header-anchor" href="#复杂数据结构传递" aria-label="Permalink to &quot;复杂数据结构传递&quot;">​</a></h3><p>对于复杂数据结构，需要在 JS 和 WASM 之间建立一致的内存布局：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// C 中定义数据结构</span></span>
<span class="line"><span style="color:#F97583;">typedef</span><span style="color:#F97583;"> struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    int</span><span style="color:#E1E4E8;"> id;</span></span>
<span class="line"><span style="color:#F97583;">    float</span><span style="color:#E1E4E8;"> x;</span></span>
<span class="line"><span style="color:#F97583;">    float</span><span style="color:#E1E4E8;"> y;</span></span>
<span class="line"><span style="color:#F97583;">    char</span><span style="color:#FFAB70;"> name</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">} Point;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">WASM_EXPORT </span><span style="color:#F97583;">void</span><span style="color:#B392F0;"> process_point</span><span style="color:#E1E4E8;">(Point</span><span style="color:#F97583;">*</span><span style="color:#FFAB70;"> point</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    point-&gt;x </span><span style="color:#F97583;">*=</span><span style="color:#79B8FF;"> 2.0</span><span style="color:#F97583;">f</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    point-&gt;y </span><span style="color:#F97583;">*=</span><span style="color:#79B8FF;"> 2.0</span><span style="color:#F97583;">f</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>在 JavaScript 中操作相同的内存布局：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// JavaScript 中操作 WASM 数据结构</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> createPointInWasm</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">x</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">y</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">  // 分配内存</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> pointSize</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 44</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// int(4) + float(4) + float(4) + char[32](32)</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> ptr</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> instance.exports.</span><span style="color:#B392F0;">wasm_malloc</span><span style="color:#E1E4E8;">(pointSize);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (ptr </span><span style="color:#F97583;">!==</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> memoryView</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> DataView</span><span style="color:#E1E4E8;">(memory.buffer);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 按照 C 结构体布局写入数据</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryView.</span><span style="color:#B392F0;">setInt32</span><span style="color:#E1E4E8;">(ptr, id, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);        </span><span style="color:#6A737D;">// id</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryView.</span><span style="color:#B392F0;">setFloat32</span><span style="color:#E1E4E8;">(ptr </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 4</span><span style="color:#E1E4E8;">, x, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);   </span><span style="color:#6A737D;">// x</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryView.</span><span style="color:#B392F0;">setFloat32</span><span style="color:#E1E4E8;">(ptr </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 8</span><span style="color:#E1E4E8;">, y, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">);   </span><span style="color:#6A737D;">// y</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 写入字符串</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> nameBytes</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> TextEncoder</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">encode</span><span style="color:#E1E4E8;">(name);</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">min</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;">, nameBytes.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">); i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      memoryView.</span><span style="color:#B392F0;">setUint8</span><span style="color:#E1E4E8;">(ptr </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 12</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> i, nameBytes[i]);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    memoryView.</span><span style="color:#B392F0;">setUint8</span><span style="color:#E1E4E8;">(ptr </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 12</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 31</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 确保 null 终止</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> ptr;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="系统接口与-wasi" tabindex="-1">系统接口与 WASI <a class="header-anchor" href="#系统接口与-wasi" aria-label="Permalink to &quot;系统接口与 WASI&quot;">​</a></h2><h3 id="node-js-中的-wasi-集成" tabindex="-1">Node.js 中的 WASI 集成 <a class="header-anchor" href="#node-js-中的-wasi-集成" aria-label="Permalink to &quot;Node.js 中的 WASI 集成&quot;">​</a></h3><p>Node.js 提供了 WASI 实现，允许 WASM 模块访问系统资源：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { WASI } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;wasi&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFile } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;fs/promises&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 创建 WASI 实例</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> wasi</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> WASI</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  version: </span><span style="color:#9ECBFF;">&#39;preview1&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  args: process.argv,</span></span>
<span class="line"><span style="color:#E1E4E8;">  env: process.env,</span></span>
<span class="line"><span style="color:#E1E4E8;">  preopens: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;/sandbox&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;/some/real/path&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 加载和实例化 WASM 模块</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> wasm</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">compile</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#F97583;">  await</span><span style="color:#B392F0;"> readFile</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./demo.wasm&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> instance</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">instantiate</span><span style="color:#E1E4E8;">(wasm, wasi.</span><span style="color:#B392F0;">getImportObject</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 启动 WASI 程序</span></span>
<span class="line"><span style="color:#E1E4E8;">wasi.</span><span style="color:#B392F0;">start</span><span style="color:#E1E4E8;">(instance);</span></span></code></pre></div><h3 id="as-wasi-高级-assemblyscript-封装" tabindex="-1">as-wasi：高级 AssemblyScript 封装 <a class="header-anchor" href="#as-wasi-高级-assemblyscript-封装" aria-label="Permalink to &quot;as-wasi：高级 AssemblyScript 封装&quot;">​</a></h3><p>as-wasi 项目为 AssemblyScript 提供了高级的 WASI API 封装：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// AssemblyScript 中使用 as-wasi</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { Console, FileSystem, Environ } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &quot;as-wasi&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 控制台输出</span></span>
<span class="line"><span style="color:#E1E4E8;">Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Hello from AssemblyScript!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 文件系统操作</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (FileSystem.</span><span style="color:#B392F0;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;data.txt&quot;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">  let</span><span style="color:#E1E4E8;"> file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> FileSystem.</span><span style="color:#B392F0;">open</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;data.txt&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;r&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">  let</span><span style="color:#E1E4E8;"> content </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> file.</span><span style="color:#B392F0;">readString</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;File content: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> content);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 环境变量访问</span></span>
<span class="line"><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> env </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Environ</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> path </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> env.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;PATH&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (path </span><span style="color:#F97583;">!==</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  Console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;PATH: &quot;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> path);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="交互模式与架构" tabindex="-1">交互模式与架构 <a class="header-anchor" href="#交互模式与架构" aria-label="Permalink to &quot;交互模式与架构&quot;">​</a></h2><h3 id="命令模式-command-pattern" tabindex="-1">命令模式 (Command Pattern) <a class="header-anchor" href="#命令模式-command-pattern" aria-label="Permalink to &quot;命令模式 (Command Pattern)&quot;">​</a></h3><p>命令模式涉及单次执行和请求/响应式的交互。这种模式通常通过 STDIN 接受输入并通过 STDOUT 输出结果。</p><p><strong>执行流程：</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>JS 调用 → WASM 命令模块 (一次性执行) → 返回结果 → 模块卸载</span></span></code></pre></div><h3 id="反应器模式-reactor-pattern" tabindex="-1">反应器模式 (Reactor Pattern) <a class="header-anchor" href="#反应器模式-reactor-pattern" aria-label="Permalink to &quot;反应器模式 (Reactor Pattern)&quot;">​</a></h3><p>反应器模式保持模块运行状态，处理多个请求。这种模式适合需要保持状态的长期运行任务。</p><p><strong>执行流程：</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>初始化 WASM 模块 → 保持运行状态 → 处理多个请求 → 回调宿主环境</span></span></code></pre></div><p>反应器模式实现示例：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// Reactor 模式示例</span></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> WASMReactor</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleUrl</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.instance </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.isRunning </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">loadModule</span><span style="color:#E1E4E8;">(moduleUrl);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> loadModule</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">moduleUrl</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">instance</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">instantiateStreaming</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#B392F0;">      fetch</span><span style="color:#E1E4E8;">(moduleUrl), </span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getImportObject</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.instance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> instance;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">startReactor</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  getImportObject</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      env: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        memory: </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> WebAssembly.</span><span style="color:#B392F0;">Memory</span><span style="color:#E1E4E8;">({ initial: </span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;"> }),</span></span>
<span class="line"><span style="color:#6A737D;">        // Reactor 回调函数</span></span>
<span class="line"><span style="color:#B392F0;">        on_data_ready</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">dataPtr</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">dataLen</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">onDataReady</span><span style="color:#E1E4E8;">(dataPtr, dataLen),</span></span>
<span class="line"><span style="color:#B392F0;">        on_error</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">errorCode</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">onError</span><span style="color:#E1E4E8;">(errorCode)</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  startReactor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.isRunning </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.instance.exports.</span><span style="color:#B392F0;">start_reactor</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  onDataReady</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">dataPtr</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">dataLen</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // 处理从 WASM 返回的数据</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> data</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> readStringFromMemory</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.instance, dataPtr, dataLen);</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">dispatchEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;data&#39;</span><span style="color:#E1E4E8;">, data);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  sendCommand</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">command</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.isRunning) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> cmdPtr</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> allocateMemoryForWasm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.instance, command);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.instance.exports.</span><span style="color:#B392F0;">process_command</span><span style="color:#E1E4E8;">(cmdPtr);</span></span>
<span class="line"><span style="color:#B392F0;">      freeMemoryInWasm</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.instance, cmdPtr);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="性能优化技巧" tabindex="-1">性能优化技巧 <a class="header-anchor" href="#性能优化技巧" aria-label="Permalink to &quot;性能优化技巧&quot;">​</a></h2><h3 id="最小化-js-wasm-边界跨越" tabindex="-1">最小化 JS-WASM 边界跨越 <a class="header-anchor" href="#最小化-js-wasm-边界跨越" aria-label="Permalink to &quot;最小化 JS-WASM 边界跨越&quot;">​</a></h3><p>每次跨越 JS-WASM 边界都有成本，应该批量处理数据：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 批量处理而不是单个处理</span></span>
<span class="line"><span style="color:#E1E4E8;">WASM_EXPORT </span><span style="color:#F97583;">void</span><span style="color:#B392F0;"> process_array</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int32_t*</span><span style="color:#FFAB70;"> input</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int32_t*</span><span style="color:#FFAB70;"> output</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">size_t</span><span style="color:#FFAB70;"> length</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> length; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#FFAB70;">        output</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#FFAB70;"> input</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 2</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// JavaScript 中批量调用</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> processLargeDataset</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">inputArray</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> inputSize</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> inputArray.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 4</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 每个 int32 4字节</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> outputSize</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> inputSize;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> inputPtr</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> instance.exports.</span><span style="color:#B392F0;">wasm_malloc</span><span style="color:#E1E4E8;">(inputSize);</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> outputPtr</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> instance.exports.</span><span style="color:#B392F0;">wasm_malloc</span><span style="color:#E1E4E8;">(outputSize);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 批量写入输入数据</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> inputView</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Int32Array</span><span style="color:#E1E4E8;">(memory.buffer, inputPtr, inputArray.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  inputView.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(inputArray);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 单次调用处理整个数组</span></span>
<span class="line"><span style="color:#E1E4E8;">  instance.exports.</span><span style="color:#B392F0;">process_array</span><span style="color:#E1E4E8;">(inputPtr, outputPtr, inputArray.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 读取结果</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> outputView</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Int32Array</span><span style="color:#E1E4E8;">(memory.buffer, outputPtr, inputArray.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Array.</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(outputView);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 清理内存</span></span>
<span class="line"><span style="color:#E1E4E8;">  instance.exports.</span><span style="color:#B392F0;">wasm_free</span><span style="color:#E1E4E8;">(inputPtr);</span></span>
<span class="line"><span style="color:#E1E4E8;">  instance.exports.</span><span style="color:#B392F0;">wasm_free</span><span style="color:#E1E4E8;">(outputPtr);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="内存管理最佳实践" tabindex="-1">内存管理最佳实践 <a class="header-anchor" href="#内存管理最佳实践" aria-label="Permalink to &quot;内存管理最佳实践&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 内存管理工具类</span></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> WASMMemoryManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">memory</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.instance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> instance;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.memory </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> memory;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.allocations </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Set</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  alloc</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">size</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> ptr</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.instance.exports.</span><span style="color:#B392F0;">wasm_malloc</span><span style="color:#E1E4E8;">(size);</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (ptr </span><span style="color:#F97583;">!==</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.allocations.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> ptr;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  free</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">ptr</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.allocations.</span><span style="color:#B392F0;">has</span><span style="color:#E1E4E8;">(ptr)) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.instance.exports.</span><span style="color:#B392F0;">wasm_free</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.allocations.</span><span style="color:#B392F0;">delete</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  freeAll</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> ptr</span><span style="color:#F97583;"> of</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.allocations) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.instance.exports.</span><span style="color:#B392F0;">wasm_free</span><span style="color:#E1E4E8;">(ptr);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.allocations.</span><span style="color:#B392F0;">clear</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 自动内存增长监控</span></span>
<span class="line"><span style="color:#B392F0;">  ensureCapacity</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">requiredSize</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentSize</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.memory.buffer.byteLength;</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (requiredSize </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> currentSize) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> neededPages</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">ceil</span><span style="color:#E1E4E8;">((requiredSize </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> currentSize) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">64</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 1024</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.memory.</span><span style="color:#B392F0;">grow</span><span style="color:#E1E4E8;">(neededPages);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="调试与错误处理" tabindex="-1">调试与错误处理 <a class="header-anchor" href="#调试与错误处理" aria-label="Permalink to &quot;调试与错误处理&quot;">​</a></h2><h3 id="跨边界错误处理" tabindex="-1">跨边界错误处理 <a class="header-anchor" href="#跨边界错误处理" aria-label="Permalink to &quot;跨边界错误处理&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 统一的错误处理机制</span></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> WASMInteropError</span><span style="color:#F97583;"> extends</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">wasmErrorCode</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    super</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`WASM Error \${</span><span style="color:#E1E4E8;">wasmErrorCode</span><span style="color:#9ECBFF;">}: \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.wasmErrorCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wasmErrorCode;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// WASM 错误回调</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> setupErrorHandling</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">importObject</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  importObject.env.</span><span style="color:#B392F0;">js_throw_error</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">errorCode</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">messagePtr</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> message</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> readStringFromMemory</span><span style="color:#E1E4E8;">(instance, messagePtr);</span></span>
<span class="line"><span style="color:#F97583;">    throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> WASMInteropError</span><span style="color:#E1E4E8;">(errorCode, message);</span></span>
<span class="line"><span style="color:#E1E4E8;">  };</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 安全调用封装</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> safeWASMCall</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">instance</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">functionName</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">...</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> instance.exports[functionName](</span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">args);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> { success: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, result };</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`WASM call \${</span><span style="color:#E1E4E8;">functionName</span><span style="color:#9ECBFF;">} failed:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> { success: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, error };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>通过以上模式和技术，开发者可以构建高效、可靠的 WASM 与 JavaScript 交互方案，充分发挥两种技术的优势。</p>`,75)])])}const d=n(o,[["render",e]]);export{F as __pageData,d as default};
