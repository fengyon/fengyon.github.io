import{_ as n,c as a,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const i=JSON.parse('{"title":"å‘å¸ƒ","description":"","frontmatter":{},"headers":[{"level":2,"title":"Node.js å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿°","slug":"node-js-å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿°","link":"#node-js-å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿°","children":[]},{"level":2,"title":"ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥","slug":"ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥","link":"#ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥","children":[{"level":3,"title":"è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶","slug":"è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶","link":"#è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶","children":[]},{"level":3,"title":"é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç†","slug":"é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç†","link":"#é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç†","children":[]}]},{"level":2,"title":"npm åŒ…å‘å¸ƒé…ç½®","slug":"npm-åŒ…å‘å¸ƒé…ç½®","link":"#npm-åŒ…å‘å¸ƒé…ç½®","children":[{"level":3,"title":"package.json å‘å¸ƒä¼˜åŒ–","slug":"package-json-å‘å¸ƒä¼˜åŒ–","link":"#package-json-å‘å¸ƒä¼˜åŒ–","children":[]},{"level":3,"title":"å‘å¸ƒå‰éªŒè¯","slug":"å‘å¸ƒå‰éªŒè¯","link":"#å‘å¸ƒå‰éªŒè¯","children":[]}]},{"level":2,"title":"å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ–","slug":"å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ–","link":"#å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ–","children":[{"level":3,"title":"npm å‘å¸ƒæµç¨‹","slug":"npm-å‘å¸ƒæµç¨‹","link":"#npm-å‘å¸ƒæµç¨‹","children":[]},{"level":3,"title":"å¤šæ³¨å†Œè¡¨å‘å¸ƒ","slug":"å¤šæ³¨å†Œè¡¨å‘å¸ƒ","link":"#å¤šæ³¨å†Œè¡¨å‘å¸ƒ","children":[]}]},{"level":2,"title":"å‘å¸ƒåç»´æŠ¤","slug":"å‘å¸ƒåç»´æŠ¤","link":"#å‘å¸ƒåç»´æŠ¤","children":[{"level":3,"title":"ç‰ˆæœ¬åˆ†å‘ç®¡ç†","slug":"ç‰ˆæœ¬åˆ†å‘ç®¡ç†","link":"#ç‰ˆæœ¬åˆ†å‘ç®¡ç†","children":[]},{"level":3,"title":"å¼ƒç”¨ç®¡ç†","slug":"å¼ƒç”¨ç®¡ç†","link":"#å¼ƒç”¨ç®¡ç†","children":[]}]}],"relativePath":"special/cli/publish.md","filePath":"special/cli/publish.md"}'),o={name:"special/cli/publish.md"};function e(E,s,c,t,r,y){return l(),a("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /special/cli/publish.md for this page in Markdown format</div><h1 id="å‘å¸ƒ" tabindex="-1">å‘å¸ƒ <a class="header-anchor" href="#å‘å¸ƒ" aria-label="Permalink to &quot;å‘å¸ƒ&quot;">â€‹</a></h1><h2 id="node-js-å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿°" tabindex="-1">Node.js å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿° <a class="header-anchor" href="#node-js-å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿°" aria-label="Permalink to &quot;Node.js å‘½ä»¤è¡Œå‘å¸ƒæ¦‚è¿°&quot;">â€‹</a></h2><p>åœ¨ Node.js å‘½ä»¤è¡Œå·¥å…·å¼€å‘ä¸­ï¼Œå‘å¸ƒæ˜¯å°†æ„å»ºå®Œæˆçš„å·¥å…·äº¤ä»˜ç»™æœ€ç»ˆç”¨æˆ·çš„å…³é”®ç¯èŠ‚ã€‚ä¸€ä¸ªå®Œæ•´çš„å‘å¸ƒæµç¨‹æ¶‰åŠç‰ˆæœ¬ç®¡ç†ã€åŒ…åˆ†å‘ã€å®‰è£…ä¼˜åŒ–å’Œæ›´æ–°ç»´æŠ¤ç­‰å¤šä¸ªæ–¹é¢ï¼Œç›´æ¥å½±å“å·¥å…·çš„å¯è¾¾æ€§å’Œç”¨æˆ·ä½“éªŒã€‚</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>å‘å¸ƒæµç¨‹å…¨æ™¯å›¾ï¼š</span></span>
<span class="line"><span>ä»£ç å®Œæˆ â†’ ç‰ˆæœ¬ç®¡ç† â†’ æ„å»ºéªŒè¯ â†’ åŒ…å‘å¸ƒ â†’ å®‰è£…æµ‹è¯• â†’ æ›´æ–°ç»´æŠ¤</span></span>
<span class="line"><span>    â†“          â†“          â†“          â†“          â†“          â†“</span></span>
<span class="line"><span>åŠŸèƒ½å®ç°   è¯­ä¹‰ç‰ˆæœ¬   è´¨é‡æ£€æŸ¥   npmæ³¨å†Œè¡¨   ç”¨æˆ·ç¯å¢ƒ   æŒç»­æ”¯æŒ</span></span></code></pre></div><h2 id="ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥" tabindex="-1">ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥ <a class="header-anchor" href="#ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥" aria-label="Permalink to &quot;ç‰ˆæœ¬ç®¡ç†ä¸ç­–ç•¥&quot;">â€‹</a></h2><h3 id="è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶" tabindex="-1">è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ <a class="header-anchor" href="#è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶" aria-label="Permalink to &quot;è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶&quot;">â€‹</a></h3><p>è¯­ä¹‰åŒ–ç‰ˆæœ¬ (SemVer) æ˜¯è¡Œä¸šæ ‡å‡†ï¼Œé€šè¿‡ç‰ˆæœ¬å·ä¼ è¾¾å˜æ›´çš„æ€§è´¨å’Œå½±å“èŒƒå›´ã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// version-strategy.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFileSync, writeFileSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:fs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> VersionManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packagePath </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;package.json&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageData </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packagePath, </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // è¯­ä¹‰ç‰ˆæœ¬è§£æ</span></span>
<span class="line"><span style="color:#B392F0;">  parseVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">major</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">minor</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">patch</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">...</span><span style="color:#79B8FF;">preRelease</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> version.</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">/</span><span style="color:#79B8FF;">[</span><span style="color:#F97583;">^</span><span style="color:#79B8FF;">\\d.-]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">g</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      major: </span><span style="color:#B392F0;">parseInt</span><span style="color:#E1E4E8;">(major),</span></span>
<span class="line"><span style="color:#E1E4E8;">      minor: </span><span style="color:#B392F0;">parseInt</span><span style="color:#E1E4E8;">(minor),</span></span>
<span class="line"><span style="color:#E1E4E8;">      patch: </span><span style="color:#B392F0;">parseInt</span><span style="color:#E1E4E8;">(patch),</span></span>
<span class="line"><span style="color:#E1E4E8;">      preRelease: preRelease.</span><span style="color:#B392F0;">join</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // ç‰ˆæœ¬å‡çº§ç­–ç•¥</span></span>
<span class="line"><span style="color:#B392F0;">  bumpVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">type</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;patch&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">preReleaseId</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> current</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parseVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.version);</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> newVersion;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    switch</span><span style="color:#E1E4E8;"> (type) {</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;major&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        newVersion </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">major</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 1</span><span style="color:#9ECBFF;">}.0.0\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;minor&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        newVersion </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">major</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">minor</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 1</span><span style="color:#9ECBFF;">}.0\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;patch&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        newVersion </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">major</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">minor</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">patch</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 1</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      default</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ— æ•ˆçš„ç‰ˆæœ¬ç±»å‹: \${</span><span style="color:#E1E4E8;">type</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // é¢„å‘å¸ƒç‰ˆæœ¬å¤„ç†</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (preReleaseId) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      newVersion </span><span style="color:#F97583;">+=</span><span style="color:#9ECBFF;"> \`-\${</span><span style="color:#E1E4E8;">preReleaseId</span><span style="color:#9ECBFF;">}.0\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> newVersion;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // ç‰ˆæœ¬ä¾èµ–åˆ†æ</span></span>
<span class="line"><span style="color:#B392F0;">  analyzeDependencies</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">dependencies</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {}, </span><span style="color:#79B8FF;">peerDependencies</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {}, </span><span style="color:#79B8FF;">devDependencies</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {} } </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> analysis</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      production: Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(dependencies).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">range</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> ({</span></span>
<span class="line"><span style="color:#E1E4E8;">        name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        range,</span></span>
<span class="line"><span style="color:#E1E4E8;">        type: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getVersionConstraintType</span><span style="color:#E1E4E8;">(range)</span></span>
<span class="line"><span style="color:#E1E4E8;">      })),</span></span>
<span class="line"><span style="color:#E1E4E8;">      peer: Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(peerDependencies).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">range</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> ({</span></span>
<span class="line"><span style="color:#E1E4E8;">        name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        range,</span></span>
<span class="line"><span style="color:#E1E4E8;">        type: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getVersionConstraintType</span><span style="color:#E1E4E8;">(range)</span></span>
<span class="line"><span style="color:#E1E4E8;">      })),</span></span>
<span class="line"><span style="color:#E1E4E8;">      development: Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(devDependencies).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">range</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> ({</span></span>
<span class="line"><span style="color:#E1E4E8;">        name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        range,</span></span>
<span class="line"><span style="color:#E1E4E8;">        type: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getVersionConstraintType</span><span style="color:#E1E4E8;">(range)</span></span>
<span class="line"><span style="color:#E1E4E8;">      }))</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> analysis;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  getVersionConstraintType</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">range</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (range </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;*&#39;</span><span style="color:#F97583;"> ||</span><span style="color:#E1E4E8;"> range </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">return</span><span style="color:#9ECBFF;"> &#39;any&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (range.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;^&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">return</span><span style="color:#9ECBFF;"> &#39;compatible&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (range.</span><span style="color:#B392F0;">startsWith</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;~&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">return</span><span style="color:#9ECBFF;"> &#39;patch&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (range.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;||&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">return</span><span style="color:#9ECBFF;"> &#39;multiple&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (range.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;-&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">return</span><span style="color:#9ECBFF;"> &#39;range&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#9ECBFF;"> &#39;exact&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æ‰§è¡Œç‰ˆæœ¬æ›´æ–°</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> updateVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">type</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">preReleaseId</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> newVersion</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">bumpVersion</span><span style="color:#E1E4E8;">(type, preReleaseId);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> oldVersion</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.version;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ†™ ç‰ˆæœ¬æ›´æ–°: \${</span><span style="color:#E1E4E8;">oldVersion</span><span style="color:#9ECBFF;">} â†’ \${</span><span style="color:#E1E4E8;">newVersion</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–° package.json</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageData.version </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> newVersion;</span></span>
<span class="line"><span style="color:#B392F0;">    writeFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packagePath, </span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–° changelog</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">updateChangelog</span><span style="color:#E1E4E8;">(newVersion);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> { oldVersion, newVersion };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> updateChangelog</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // è¿™é‡Œå¯ä»¥é›†æˆ conventional-changelog</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> changelogEntry</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`## \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} (\${</span></span>
<span class="line"><span style="color:#F97583;">      new</span><span style="color:#B392F0;"> Date</span><span style="color:#9ECBFF;">().</span><span style="color:#B392F0;">toISOString</span><span style="color:#9ECBFF;">().</span><span style="color:#B392F0;">split</span><span style="color:#9ECBFF;">(</span><span style="color:#9ECBFF;">&#39;T&#39;</span><span style="color:#9ECBFF;">)[</span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">]</span></span>
<span class="line"><span style="color:#9ECBFF;">    })</span><span style="color:#79B8FF;">\\n\\n</span><span style="color:#9ECBFF;">* åŠŸèƒ½æ›´æ–°å’Œä¿®å¤</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œä¼šè¯»å–ç°æœ‰ CHANGELOG.md å¹¶æ’å…¥æ–°æ¡ç›®</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ“ æ›´æ–°æ—¥å¿—æ¡ç›®å·²å‡†å¤‡:&#39;</span><span style="color:#E1E4E8;">, changelogEntry);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> versionManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> VersionManager</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> versionInfo</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> versionManager.</span><span style="color:#B392F0;">updateVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;minor&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ç‰ˆæœ¬ä¿¡æ¯:&#39;</span><span style="color:#E1E4E8;">, versionInfo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> depsAnalysis</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> versionManager.</span><span style="color:#B392F0;">analyzeDependencies</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ä¾èµ–åˆ†æ:&#39;</span><span style="color:#E1E4E8;">, depsAnalysis);</span></span></code></pre></div><h3 id="é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç†" tabindex="-1">é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç† <a class="header-anchor" href="#é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç†" aria-label="Permalink to &quot;é¢„å‘å¸ƒç‰ˆæœ¬ç®¡ç†&quot;">â€‹</a></h3><p>é¢„å‘å¸ƒç‰ˆæœ¬ç”¨äºæµ‹è¯•å’Œæ—©æœŸç”¨æˆ·åé¦ˆï¼Œä¸ç ´åç¨³å®šç‰ˆæœ¬æµã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// pre-release.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> PreReleaseManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageData </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;package.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // åˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#B392F0;">  createPreRelease</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">type</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;beta&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> current</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.version;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> preReleaseVersion</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">current</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#E1E4E8;">type</span><span style="color:#9ECBFF;">}.\${</span><span style="color:#E1E4E8;">Date</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">now</span><span style="color:#9ECBFF;">()</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // ä½¿ç”¨ npm version ä½†ä¸æäº¤</span></span>
<span class="line"><span style="color:#B392F0;">    execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm version \${</span><span style="color:#E1E4E8;">preReleaseVersion</span><span style="color:#9ECBFF;">} --no-git-tag-version\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ§ª åˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬: \${</span><span style="color:#E1E4E8;">preReleaseVersion</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> preReleaseVersion;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // å‘å¸ƒé¢„å‘å¸ƒç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> publishPreRelease</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">tag</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;beta&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> version</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">createPreRelease</span><span style="color:#E1E4E8;">(tag);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸš€ å‘å¸ƒé¢„å‘å¸ƒç‰ˆæœ¬åˆ° npm (tag: \${</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">})...\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm publish --tag \${</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… é¢„å‘å¸ƒç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} å·²å‘å¸ƒ\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> version;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âŒ é¢„å‘å¸ƒç‰ˆæœ¬å‘å¸ƒå¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error.message);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // ä»é¢„å‘å¸ƒå‡çº§åˆ°ç¨³å®šç‰ˆ</span></span>
<span class="line"><span style="color:#B392F0;">  promoteToStable</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">preReleaseVersion</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> stableVersion</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> preReleaseVersion.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;-&#39;</span><span style="color:#E1E4E8;">)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ¯ å°†é¢„å‘å¸ƒç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">preReleaseVersion</span><span style="color:#9ECBFF;">} å‡çº§ä¸ºç¨³å®šç‰ˆ \${</span><span style="color:#E1E4E8;">stableVersion</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–°ç‰ˆæœ¬å·</span></span>
<span class="line"><span style="color:#B392F0;">    execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm version \${</span><span style="color:#E1E4E8;">stableVersion</span><span style="color:#9ECBFF;">} --no-git-tag-version\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // é‡æ–°å‘å¸ƒä¸º latest</span></span>
<span class="line"><span style="color:#B392F0;">    execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;npm publish --tag latest&#39;</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> stableVersion;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> preReleaseManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> PreReleaseManager</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// åˆ›å»ºå¹¶å‘å¸ƒ beta ç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#6A737D;">// const betaVersion = await preReleaseManager.publishPreRelease(&#39;beta&#39;);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å½“æµ‹è¯•é€šè¿‡åï¼Œå‡çº§åˆ°ç¨³å®šç‰ˆ</span></span>
<span class="line"><span style="color:#6A737D;">// const stableVersion = preReleaseManager.promoteToStable(betaVersion);</span></span></code></pre></div><h2 id="npm-åŒ…å‘å¸ƒé…ç½®" tabindex="-1">npm åŒ…å‘å¸ƒé…ç½® <a class="header-anchor" href="#npm-åŒ…å‘å¸ƒé…ç½®" aria-label="Permalink to &quot;npm åŒ…å‘å¸ƒé…ç½®&quot;">â€‹</a></h2><h3 id="package-json-å‘å¸ƒä¼˜åŒ–" tabindex="-1">package.json å‘å¸ƒä¼˜åŒ– <a class="header-anchor" href="#package-json-å‘å¸ƒä¼˜åŒ–" aria-label="Permalink to &quot;package.json å‘å¸ƒä¼˜åŒ–&quot;">â€‹</a></h3><p>ç²¾å¿ƒé…ç½®çš„ package.json æ˜¯æˆåŠŸå‘å¸ƒçš„å…³é”®ã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// package-optimization.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFileSync, writeFileSync, existsSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:fs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> PackageOptimizer</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packagePath </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;package.json&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageData </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packagePath, </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // ä¼˜åŒ–å‘å¸ƒé…ç½®</span></span>
<span class="line"><span style="color:#B392F0;">  optimizeForPublish</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> optimized</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      ...</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // å…³é”®å‘å¸ƒå­—æ®µ</span></span>
<span class="line"><span style="color:#E1E4E8;">      files: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureFilesField</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      main: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureMainField</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      bin: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureBinField</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      exports: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureExportsField</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // å‘å¸ƒå…ƒæ•°æ®</span></span>
<span class="line"><span style="color:#E1E4E8;">      keywords: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureKeywords</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      homepage: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.homepage </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> \`https://npmjs.com/package/\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      repository: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureRepository</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      bugs: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureBugs</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // å‘å¸ƒé…ç½®</span></span>
<span class="line"><span style="color:#E1E4E8;">      publishConfig: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensurePublishConfig</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // å¼•æ“è¦æ±‚</span></span>
<span class="line"><span style="color:#E1E4E8;">      engines: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureEngines</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      os: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureOS</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      cpu: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ensureCPU</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">    writeFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packagePath, </span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(optimized, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… package.json å·²ä¼˜åŒ–ç”¨äºå‘å¸ƒ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> optimized;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureFilesField</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> defaultFiles</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;dist/&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;bin/&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;README.md&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;LICENSE&#39;</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentFiles</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.files </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // åˆå¹¶å¹¶å»é‡</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> merged</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span><span style="color:#F97583;">...new</span><span style="color:#B392F0;"> Set</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">currentFiles, </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">defaultFiles])];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> missing</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> merged.</span><span style="color:#B392F0;">filter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">file</span><span style="color:#F97583;"> =&gt;</span><span style="color:#F97583;"> !</span><span style="color:#B392F0;">existsSync</span><span style="color:#E1E4E8;">(file.</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\\/</span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)));</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (missing.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âš ï¸  ä»¥ä¸‹æ–‡ä»¶åœ¨å‘å¸ƒåˆ—è¡¨ä¸­ä½†ä¸å­˜åœ¨:&#39;</span><span style="color:#E1E4E8;">, missing);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> merged;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureMainField</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.main </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#B392F0;"> existsSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;dist/cli.cjs&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#9ECBFF;"> &#39;./dist/cli.cjs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.main;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureBinField</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.bin </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#B392F0;"> existsSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;bin/cli.mjs&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> { [</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.name]: </span><span style="color:#9ECBFF;">&#39;./bin/cli.mjs&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.bin;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureExportsField</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> exports</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;.&#39;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        import: </span><span style="color:#9ECBFF;">&#39;./dist/cli.mjs&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        require: </span><span style="color:#9ECBFF;">&#39;./dist/cli.cjs&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        default: </span><span style="color:#9ECBFF;">&#39;./dist/cli.mjs&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;./package.json&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;./package.json&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å¦‚æœå­˜åœ¨æ ·å¼æ–‡ä»¶ï¼Œæ·»åŠ æ ·å¼å¯¼å‡º</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">existsSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;dist/style.css&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#79B8FF;">      exports</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&#39;./style.css&#39;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;./dist/style.css&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> exports</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureKeywords</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> baseKeywords</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;cli&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;command-line&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tool&#39;</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentKeywords</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.keywords </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> [</span><span style="color:#F97583;">...new</span><span style="color:#B392F0;"> Set</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">currentKeywords, </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">baseKeywords])];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureRepository</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.repository) </span><span style="color:#F97583;">return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.repository;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å°è¯•ä» git é…ç½®æ¨æ–­</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> remoteUrl</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;git config --get remote.origin.url&#39;</span><span style="color:#E1E4E8;">, { </span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      }).</span><span style="color:#B392F0;">trim</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (remoteUrl) {</span></span>
<span class="line"><span style="color:#F97583;">        return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          type: </span><span style="color:#9ECBFF;">&#39;git&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          url: remoteUrl.</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;git@github.com:&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;https://github.com/&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        };</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#6A737D;">      // å¿½ç•¥é”™è¯¯</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> undefined</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensurePublishConfig</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> defaultConfig</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      access: </span><span style="color:#9ECBFF;">&#39;public&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      registry: </span><span style="color:#9ECBFF;">&#39;https://registry.npmjs.org/&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">defaultConfig, </span><span style="color:#F97583;">...</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.publishConfig };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  ensureEngines</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.engines </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">      node: </span><span style="color:#9ECBFF;">&#39;&gt;=18.0.0&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      npm: </span><span style="color:#9ECBFF;">&#39;&gt;=8.0.0&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æ“ä½œç³»ç»Ÿå…¼å®¹æ€§å£°æ˜</span></span>
<span class="line"><span style="color:#B392F0;">  ensureOS</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.os </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;darwin&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">// macOS</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;linux&#39;</span><span style="color:#E1E4E8;">,   </span><span style="color:#6A737D;">// Linux</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;win32&#39;</span><span style="color:#6A737D;">    // Windows</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // CPU æ¶æ„å…¼å®¹æ€§å£°æ˜</span></span>
<span class="line"><span style="color:#B392F0;">  ensureCPU</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.cpu </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;x64&#39;</span><span style="color:#E1E4E8;">,     </span><span style="color:#6A737D;">// 64ä½ Intel/AMD</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;arm64&#39;</span><span style="color:#6A737D;">    // Apple Silicon, ARM</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> optimizer</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> PackageOptimizer</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> optimizedPackage</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> optimizer.</span><span style="color:#B392F0;">optimizeForPublish</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ä¼˜åŒ–åçš„åŒ…é…ç½®:&#39;</span><span style="color:#E1E4E8;">, optimizedPackage);</span></span></code></pre></div><h3 id="å‘å¸ƒå‰éªŒè¯" tabindex="-1">å‘å¸ƒå‰éªŒè¯ <a class="header-anchor" href="#å‘å¸ƒå‰éªŒè¯" aria-label="Permalink to &quot;å‘å¸ƒå‰éªŒè¯&quot;">â€‹</a></h3><p>ç¡®ä¿å‘å¸ƒåŒ…çš„è´¨é‡å’Œå®Œæ•´æ€§ã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// pre-publish-validation.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { existsSync, readFileSync, statSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:fs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> PrePublishValidator</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageData </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;package.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> runAllChecks</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ” è¿è¡Œå‘å¸ƒå‰éªŒè¯...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> results</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      passed: [],</span></span>
<span class="line"><span style="color:#E1E4E8;">      failed: [],</span></span>
<span class="line"><span style="color:#E1E4E8;">      warnings: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è¿è¡Œæ‰€æœ‰æ£€æŸ¥</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkPackageSize</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkRequiredFiles</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkBuildArtifacts</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkDependencies</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkLicense</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkReadme</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkExecutablePermissions</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ±‡æ€»ç»“æœ</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> of</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.checks) {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (check.status </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        results.passed.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (check.status </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;failed&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        results.failed.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        results.warnings.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">printResults</span><span style="color:#E1E4E8;">(results);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> results;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkPackageSize</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> { name: </span><span style="color:#9ECBFF;">&#39;åŒ…å¤§å°æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">, status: </span><span style="color:#9ECBFF;">&#39;pending&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // ä¼°ç®—åŒ…å¤§å°</span></span>
<span class="line"><span style="color:#F97583;">      let</span><span style="color:#E1E4E8;"> totalSize </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> files</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.files </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> filePattern</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> files) {</span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">existsSync</span><span style="color:#E1E4E8;">(filePattern)) {</span></span>
<span class="line"><span style="color:#F97583;">          const</span><span style="color:#79B8FF;"> stats</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> statSync</span><span style="color:#E1E4E8;">(filePattern);</span></span>
<span class="line"><span style="color:#E1E4E8;">          totalSize </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> stats.size;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> sizeMB</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> totalSize </span><span style="color:#F97583;">/</span><span style="color:#79B8FF;"> 1024</span><span style="color:#F97583;"> /</span><span style="color:#79B8FF;"> 1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.details </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`ä¼°ç®—å¤§å°: \${</span><span style="color:#E1E4E8;">sizeMB</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">toFixed</span><span style="color:#9ECBFF;">(</span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">} MB\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (sizeMB </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 50</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;warning&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;åŒ…å¤§å°è¶…è¿‡ 50MBï¼Œå¯èƒ½å½±å“å®‰è£…ä½“éªŒ&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;failed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`å¤§å°æ£€æŸ¥å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkRequiredFiles</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> { name: </span><span style="color:#9ECBFF;">&#39;å¿…è¦æ–‡ä»¶æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">, status: </span><span style="color:#9ECBFF;">&#39;pending&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> requiredFiles</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;package.json&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;README.md&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;LICENSE&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">      ...</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.files </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [])</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> missing</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> file</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> requiredFiles) {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">existsSync</span><span style="color:#E1E4E8;">(file)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        missing.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(file);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (missing.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;failed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`ç¼ºå°‘å¿…è¦æ–‡ä»¶: \${</span><span style="color:#E1E4E8;">missing</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">join</span><span style="color:#9ECBFF;">(</span><span style="color:#9ECBFF;">&#39;, &#39;</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;æ‰€æœ‰å¿…è¦æ–‡ä»¶éƒ½å­˜åœ¨&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkBuildArtifacts</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> { name: </span><span style="color:#9ECBFF;">&#39;æ„å»ºäº§ç‰©æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">, status: </span><span style="color:#9ECBFF;">&#39;pending&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨ä¸”å¯æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> binPath</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> typeof</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.bin </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;string&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">        ?</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.bin </span></span>
<span class="line"><span style="color:#F97583;">        :</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">values</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.bin </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> {})[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (binPath </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#B392F0;"> existsSync</span><span style="color:#E1E4E8;">(binPath)) {</span></span>
<span class="line"><span style="color:#6A737D;">        // éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span class="line"><span style="color:#B392F0;">        execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`node \${</span><span style="color:#E1E4E8;">binPath</span><span style="color:#9ECBFF;">} --version\`</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;pipe&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;failed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨æˆ–é…ç½®é”™è¯¯&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;failed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`æ„å»ºäº§ç‰©éªŒè¯å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkDependencies</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> { name: </span><span style="color:#9ECBFF;">&#39;ä¾èµ–æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">, status: </span><span style="color:#9ECBFF;">&#39;pending&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // æ£€æŸ¥æ˜¯å¦æœ‰æœªå£°æ˜çš„ä¾èµ–</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;npx depcheck&#39;</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;pipe&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;ä¾èµ–å…³ç³»æ­£å¸¸&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;warning&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;ä¾èµ–æ£€æŸ¥å‘ç°è­¦å‘Šï¼Œè¯·æ£€æŸ¥ depcheck è¾“å‡º&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkLicense</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> { name: </span><span style="color:#9ECBFF;">&#39;è®¸å¯è¯æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">, status: </span><span style="color:#9ECBFF;">&#39;pending&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.license) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;failed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;package.json ä¸­æœªå£°æ˜è®¸å¯è¯&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">existsSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;LICENSE&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;warning&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;å·²å£°æ˜è®¸å¯è¯ä½†ç¼ºå°‘ LICENSE æ–‡ä»¶&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`è®¸å¯è¯é…ç½®æ­£å¸¸: \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">license</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkExecutablePermissions</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> check</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> { name: </span><span style="color:#9ECBFF;">&#39;å¯æ‰§è¡Œæƒé™æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">, status: </span><span style="color:#9ECBFF;">&#39;pending&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> binPath</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> typeof</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.bin </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;string&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">        ?</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.packageData.bin </span></span>
<span class="line"><span style="color:#F97583;">        :</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">values</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageData.bin </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> {})[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (binPath </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#B392F0;"> existsSync</span><span style="color:#E1E4E8;">(binPath)) {</span></span>
<span class="line"><span style="color:#6A737D;">        // åœ¨ Unix ç³»ç»Ÿä¸Šæ£€æŸ¥æ‰§è¡Œæƒé™</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> stats</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> statSync</span><span style="color:#E1E4E8;">(binPath);</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> hasExecutePermission</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> (stats.mode </span><span style="color:#F97583;">&amp;</span><span style="color:#79B8FF;"> 0o111</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">!==</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (hasExecutePermission) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;å¯æ‰§è¡Œæ–‡ä»¶æƒé™æ­£ç¡®&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;warning&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;å¯æ‰§è¡Œæ–‡ä»¶ç¼ºå°‘æ‰§è¡Œæƒé™&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;passed&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;æ— å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦æ£€æŸ¥&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.status </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;warning&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      check.message </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`æƒé™æ£€æŸ¥å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.checks.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(check);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  printResults</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">results</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸ“Š å‘å¸ƒå‰éªŒè¯ç»“æœ:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">âœ… é€šè¿‡çš„æ£€æŸ¥:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    results.passed.</span><span style="color:#B392F0;">forEach</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">check</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`  âœ“ \${</span><span style="color:#E1E4E8;">check</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}: \${</span><span style="color:#E1E4E8;">check</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (results.warnings.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">âš ï¸  è­¦å‘Š:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      results.warnings.</span><span style="color:#B392F0;">forEach</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">check</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`  ! \${</span><span style="color:#E1E4E8;">check</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}: \${</span><span style="color:#E1E4E8;">check</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (results.failed.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">âŒ å¤±è´¥çš„æ£€æŸ¥:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      results.failed.</span><span style="color:#B392F0;">forEach</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">check</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`  âœ— \${</span><span style="color:#E1E4E8;">check</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}: \${</span><span style="color:#E1E4E8;">check</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸš« å‘å¸ƒè¢«é˜»æ­¢ï¼Œè¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡è¯•&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      process.</span><span style="color:#B392F0;">exit</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å‘å¸ƒï¼&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> validator</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> PrePublishValidator</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> validator.</span><span style="color:#B392F0;">runAllChecks</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><h2 id="å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ–" tabindex="-1">å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ– <a class="header-anchor" href="#å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ–" aria-label="Permalink to &quot;å‘å¸ƒæ‰§è¡Œä¸è‡ªåŠ¨åŒ–&quot;">â€‹</a></h2><h3 id="npm-å‘å¸ƒæµç¨‹" tabindex="-1">npm å‘å¸ƒæµç¨‹ <a class="header-anchor" href="#npm-å‘å¸ƒæµç¨‹" aria-label="Permalink to &quot;npm å‘å¸ƒæµç¨‹&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// publish-executor.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { createRequire } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:module&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> require</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> createRequire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">meta</span><span style="color:#E1E4E8;">.url);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> PublishExecutor</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">options</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {}) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.options </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      dryRun: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      tag: </span><span style="color:#9ECBFF;">&#39;latest&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      otp: process.env.</span><span style="color:#79B8FF;">NPM_OTP</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">      ...</span><span style="color:#E1E4E8;">options</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageData </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./package.json&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> publish</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸš€ å¼€å§‹å‘å¸ƒ \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // æ„å»ºå‘å¸ƒå‘½ä»¤</span></span>
<span class="line"><span style="color:#F97583;">      let</span><span style="color:#E1E4E8;"> publishCommand </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;npm publish&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.options.tag </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.options.tag </span><span style="color:#F97583;">!==</span><span style="color:#9ECBFF;"> &#39;latest&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        publishCommand </span><span style="color:#F97583;">+=</span><span style="color:#9ECBFF;"> \` --tag \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">options</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.options.otp) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        publishCommand </span><span style="color:#F97583;">+=</span><span style="color:#9ECBFF;"> \` --otp \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">options</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">otp</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.options.dryRun) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        publishCommand </span><span style="color:#F97583;">+=</span><span style="color:#9ECBFF;"> &#39; --dry-run&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ§ª å¹²è¿è¡Œæ¨¡å¼ï¼Œä¸ä¼šå®é™…å‘å¸ƒ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">      // æ‰§è¡Œå‘å¸ƒ</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ‰§è¡Œ: \${</span><span style="color:#E1E4E8;">publishCommand</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> output</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(publishCommand, { encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å‘å¸ƒè¾“å‡º:&#39;</span><span style="color:#E1E4E8;">, output);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.options.dryRun) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… æˆåŠŸå‘å¸ƒ \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">postPublishTasks</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ å‘å¸ƒå¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> postPublishTasks</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸ”§ æ‰§è¡Œå‘å¸ƒåä»»åŠ¡...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> tasks</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">verifyPackageOnNPM</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">createGitTag</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">updateDistributionTags</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">notifyTeam</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> task</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> tasks) {</span></span>
<span class="line"><span style="color:#F97583;">      try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#E1E4E8;"> task;</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å‘å¸ƒåä»»åŠ¡è­¦å‘Š: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> verifyPackageOnNPM</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ” éªŒè¯åŒ…åœ¨ npm ä¸Šçš„å¯ç”¨æ€§...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // ä½¿ç”¨ npm view æ£€æŸ¥åŒ…ä¿¡æ¯</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm view \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">} version\`</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;pipe&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… åŒ…åœ¨ npm ä¸Šå¯è®¿é—®&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;åŒ…åœ¨ npm ä¸Šä¸å¯è®¿é—®ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…åŒæ­¥&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> createGitTag</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ·ï¸  åˆ›å»º Git æ ‡ç­¾...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> tagName</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`v\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`git tag -a \${</span><span style="color:#E1E4E8;">tagName</span><span style="color:#9ECBFF;">} -m &quot;Release \${</span><span style="color:#E1E4E8;">tagName</span><span style="color:#9ECBFF;">}&quot;\`</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;git push --tags&#39;</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… Git æ ‡ç­¾ \${</span><span style="color:#E1E4E8;">tagName</span><span style="color:#9ECBFF;">} å·²åˆ›å»ºå¹¶æ¨é€\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`Git æ ‡ç­¾åˆ›å»ºå¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> updateDistributionTags</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.options.tag </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;latest&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ“¢ æ›´æ–°æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">        // ç¡®ä¿æœ€æ–°ç‰ˆæœ¬è¢«æ ‡è®°ä¸º latest</span></span>
<span class="line"><span style="color:#B392F0;">        execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm dist-tag add \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} latest\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">          stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        });</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾å·²æ›´æ–°&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`åˆ†å¸ƒæ ‡ç­¾æ›´æ–°å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> notifyTeam</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ“¢ å‘é€å‘å¸ƒé€šçŸ¥...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è¿™é‡Œå¯ä»¥é›†æˆ Slackã€Discord æˆ–é‚®ä»¶é€šçŸ¥</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> message</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`ğŸ‰ \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">} v\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageData</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} å·²å‘å¸ƒï¼\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(message);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæœ‰å…·ä½“çš„é€šçŸ¥é€»è¾‘</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> publisher</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> PublishExecutor</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  dryRun: process.argv.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;--dry-run&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  tag: process.env.</span><span style="color:#79B8FF;">NPM_TAG</span><span style="color:#F97583;"> ||</span><span style="color:#9ECBFF;"> &#39;latest&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> success</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> publisher.</span><span style="color:#B392F0;">publish</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">process.</span><span style="color:#B392F0;">exit</span><span style="color:#E1E4E8;">(success </span><span style="color:#F97583;">?</span><span style="color:#79B8FF;"> 0</span><span style="color:#F97583;"> :</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">);</span></span></code></pre></div><h3 id="å¤šæ³¨å†Œè¡¨å‘å¸ƒ" tabindex="-1">å¤šæ³¨å†Œè¡¨å‘å¸ƒ <a class="header-anchor" href="#å¤šæ³¨å†Œè¡¨å‘å¸ƒ" aria-label="Permalink to &quot;å¤šæ³¨å†Œè¡¨å‘å¸ƒ&quot;">â€‹</a></h3><p>æ”¯æŒå‘å¸ƒåˆ°å¤šä¸ªåŒ…æ³¨å†Œè¡¨ (npmã€GitHub Packages ç­‰)ã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// multi-registry-publish.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> MultiRegistryPublisher</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.registries </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      npm: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        command: </span><span style="color:#9ECBFF;">&#39;npm publish&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        registry: </span><span style="color:#9ECBFF;">&#39;https://registry.npmjs.org/&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        requiredAuth: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      github: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        command: </span><span style="color:#9ECBFF;">&#39;npm publish&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        registry: </span><span style="color:#9ECBFF;">&#39;https://npm.pkg.github.com/&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        requiredAuth: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        scope: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      verdaccio: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        command: </span><span style="color:#9ECBFF;">&#39;npm publish&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        registry: </span><span style="color:#9ECBFF;">&#39;http://localhost:4873/&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        requiredAuth: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> publishToAll</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">registries</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;npm&#39;</span><span style="color:#E1E4E8;">]) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> results</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> registryName</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> registries) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸš€ å‘å¸ƒåˆ° \${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">}...\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> success</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">publishToRegistry</span><span style="color:#E1E4E8;">(registryName);</span></span>
<span class="line"><span style="color:#E1E4E8;">        results[registryName] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { success, error: </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        if</span><span style="color:#E1E4E8;"> (success) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… æˆåŠŸå‘å¸ƒåˆ° \${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        results[registryName] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { success: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">, error: error.message };</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ å‘å¸ƒåˆ° \${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">} å¤±è´¥:\`</span><span style="color:#E1E4E8;">, error.message);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">printPublishSummary</span><span style="color:#E1E4E8;">(results);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> results;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> publishToRegistry</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">registryName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> registry</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.registries[registryName];</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">registry) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æœªçŸ¥çš„æ³¨å†Œè¡¨: \${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥è®¤è¯</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (registry.requiredAuth) {</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkAuth</span><span style="color:#E1E4E8;">(registryName, registry.registry);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ„å»ºå‘å¸ƒå‘½ä»¤</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> command </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> registry.command;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (registry.registry) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      command </span><span style="color:#F97583;">+=</span><span style="color:#9ECBFF;"> \` --registry \${</span><span style="color:#E1E4E8;">registry</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">registry</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (registry.scope) {</span></span>
<span class="line"><span style="color:#6A737D;">      // GitHub Packages éœ€è¦ scope</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> packageName</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;npm pkg get name&#39;</span><span style="color:#E1E4E8;">, { encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;"> }));</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">packageName.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">)) {</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`\${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">} éœ€è¦ä½œç”¨åŸŸåŒ…åç§° (å¦‚ @username/package)\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ‰§è¡Œå‘å¸ƒ</span></span>
<span class="line"><span style="color:#B392F0;">    execSync</span><span style="color:#E1E4E8;">(command, { stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkAuth</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">registryName</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">registryUrl</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm whoami --registry \${</span><span style="color:#E1E4E8;">registryUrl</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;pipe&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… å·²è®¤è¯åˆ° \${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æœªè®¤è¯åˆ° \${</span><span style="color:#E1E4E8;">registryName</span><span style="color:#9ECBFF;">}ï¼Œè¯·å…ˆè¿è¡Œ: npm login --registry=\${</span><span style="color:#E1E4E8;">registryUrl</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  printPublishSummary</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">results</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸ“Š å¤šæ³¨å†Œè¡¨å‘å¸ƒæ‘˜è¦:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> successful</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(results).</span><span style="color:#B392F0;">filter</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">_</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> result.success);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> failed</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(results).</span><span style="color:#B392F0;">filter</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">_</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#F97583;"> !</span><span style="color:#E1E4E8;">result.success);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (successful.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">âœ… æˆåŠŸå‘å¸ƒçš„æ³¨å†Œè¡¨:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      successful.</span><span style="color:#B392F0;">forEach</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`  âœ“ \${</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (failed.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">âŒ å‘å¸ƒå¤±è´¥çš„æ³¨å†Œè¡¨:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      failed.</span><span style="color:#B392F0;">forEach</span><span style="color:#E1E4E8;">(([</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`  âœ— \${</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">}: \${</span><span style="color:#E1E4E8;">result</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">ğŸ¯ æ€»ä½“ç»“æœ: \${</span><span style="color:#E1E4E8;">successful</span><span style="color:#9ECBFF;">.</span><span style="color:#79B8FF;">length</span><span style="color:#9ECBFF;">}/\${</span><span style="color:#E1E4E8;">Object</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">keys</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">results</span><span style="color:#9ECBFF;">).</span><span style="color:#79B8FF;">length</span><span style="color:#9ECBFF;">} æˆåŠŸ\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // é…ç½®å¤šä¸ªæ³¨å†Œè¡¨</span></span>
<span class="line"><span style="color:#B392F0;">  setupRegistryConfigs</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> configs</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;registry&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;https://registry.npmjs.org/&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;@mycompany:registry&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;https://npm.pkg.github.com/&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;//registry.npmjs.org/:_authToken&#39;</span><span style="color:#E1E4E8;">: process.env.</span><span style="color:#79B8FF;">NPM_TOKEN</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;//npm.pkg.github.com/:_authToken&#39;</span><span style="color:#E1E4E8;">: process.env.</span><span style="color:#79B8FF;">GITHUB_TOKEN</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">key</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">of</span><span style="color:#E1E4E8;"> Object.</span><span style="color:#B392F0;">entries</span><span style="color:#E1E4E8;">(configs)) {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (value) {</span></span>
<span class="line"><span style="color:#F97583;">        try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">          execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm config set \${</span><span style="color:#E1E4E8;">key</span><span style="color:#9ECBFF;">} \${</span><span style="color:#E1E4E8;">value</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, { stdio: </span><span style="color:#9ECBFF;">&#39;pipe&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… é…ç½®: \${</span><span style="color:#E1E4E8;">key</span><span style="color:#9ECBFF;">} = \${</span><span style="color:#E1E4E8;">value</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">          console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âš ï¸  é…ç½®å¤±è´¥: \${</span><span style="color:#E1E4E8;">key</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> multiPublisher</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> MultiRegistryPublisher</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// é…ç½®æ³¨å†Œè¡¨</span></span>
<span class="line"><span style="color:#E1E4E8;">multiPublisher.</span><span style="color:#B392F0;">setupRegistryConfigs</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å‘å¸ƒåˆ°å¤šä¸ªæ³¨å†Œè¡¨</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> results</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> multiPublisher.</span><span style="color:#B392F0;">publishToAll</span><span style="color:#E1E4E8;">([</span><span style="color:#9ECBFF;">&#39;npm&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;github&#39;</span><span style="color:#E1E4E8;">]);</span></span></code></pre></div><h2 id="å‘å¸ƒåç»´æŠ¤" tabindex="-1">å‘å¸ƒåç»´æŠ¤ <a class="header-anchor" href="#å‘å¸ƒåç»´æŠ¤" aria-label="Permalink to &quot;å‘å¸ƒåç»´æŠ¤&quot;">â€‹</a></h2><h3 id="ç‰ˆæœ¬åˆ†å‘ç®¡ç†" tabindex="-1">ç‰ˆæœ¬åˆ†å‘ç®¡ç† <a class="header-anchor" href="#ç‰ˆæœ¬åˆ†å‘ç®¡ç†" aria-label="Permalink to &quot;ç‰ˆæœ¬åˆ†å‘ç®¡ç†&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// distribution-management.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> DistributionManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">packageName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> packageName;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æŸ¥çœ‹åˆ†å¸ƒæ ‡ç­¾</span></span>
<span class="line"><span style="color:#B392F0;">  listDistributionTags</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> output</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm dist-tag ls \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, { </span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ğŸ·ï¸  åˆ†å¸ƒæ ‡ç­¾:&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(output);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> output.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        .</span><span style="color:#B392F0;">filter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">line</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> line.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;:&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        .</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">line</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">          const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">tag</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">version</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> line.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;:&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">s</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> s.</span><span style="color:#B392F0;">trim</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#F97583;">          return</span><span style="color:#E1E4E8;"> { tag, version };</span></span>
<span class="line"><span style="color:#E1E4E8;">        });</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ— æ³•è·å–åˆ†å¸ƒæ ‡ç­¾:&#39;</span><span style="color:#E1E4E8;">, error.message);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æ·»åŠ åˆ†å¸ƒæ ‡ç­¾</span></span>
<span class="line"><span style="color:#B392F0;">  addDistributionTag</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">tag</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm dist-tag add \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} \${</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… æ·»åŠ æ ‡ç­¾: \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} â†’ \${</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ æ·»åŠ æ ‡ç­¾å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // åˆ é™¤åˆ†å¸ƒæ ‡ç­¾</span></span>
<span class="line"><span style="color:#B392F0;">  removeDistributionTag</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">tag</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm dist-tag rm \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">} \${</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… åˆ é™¤æ ‡ç­¾: \${</span><span style="color:#E1E4E8;">tag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ åˆ é™¤æ ‡ç­¾å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æ¨å¹¿ç‰ˆæœ¬ï¼ˆå¦‚ä» beta åˆ° latestï¼‰</span></span>
<span class="line"><span style="color:#B392F0;">  promoteVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">fromTag</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">toTag</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;latest&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> tags</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">listDistributionTags</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> fromVersion</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> tags.</span><span style="color:#B392F0;">find</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">t</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> t.tag </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> fromTag)?.version;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">fromVersion) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ æœªæ‰¾åˆ°æ ‡ç­¾: \${</span><span style="color:#E1E4E8;">fromTag</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ¯ æ¨å¹¿ç‰ˆæœ¬: \${</span><span style="color:#E1E4E8;">fromVersion</span><span style="color:#9ECBFF;">} (\${</span><span style="color:#E1E4E8;">fromTag</span><span style="color:#9ECBFF;">} â†’ \${</span><span style="color:#E1E4E8;">toTag</span><span style="color:#9ECBFF;">})\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">addDistributionTag</span><span style="color:#E1E4E8;">(fromVersion, toTag);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æ£€æŸ¥ç‰ˆæœ¬é‡‡ç”¨æƒ…å†µ</span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkVersionAdoption</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">      // ä½¿ç”¨ npm stats æˆ–å…¶ä»–åˆ†æå·¥å…·</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> info</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm view \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> downloads</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getDownloadStats</span><span style="color:#E1E4E8;">(version);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        version,</span></span>
<span class="line"><span style="color:#E1E4E8;">        info: info.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">slice</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">), </span><span style="color:#6A737D;">// å‰10è¡Œä¿¡æ¯</span></span>
<span class="line"><span style="color:#E1E4E8;">        downloads,</span></span>
<span class="line"><span style="color:#E1E4E8;">        published: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getPublishTime</span><span style="color:#E1E4E8;">(version)</span></span>
<span class="line"><span style="color:#E1E4E8;">      };</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> { version, error: error.message };</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> getDownloadStats</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> output</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm stats \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, { </span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#6A737D;">      // è§£æä¸‹è½½ç»Ÿè®¡ä¿¡æ¯</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> { lastDay: </span><span style="color:#9ECBFF;">&#39;N/A&#39;</span><span style="color:#E1E4E8;">, lastWeek: </span><span style="color:#9ECBFF;">&#39;N/A&#39;</span><span style="color:#E1E4E8;">, lastMonth: </span><span style="color:#9ECBFF;">&#39;N/A&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> { error: </span><span style="color:#9ECBFF;">&#39;æ— æ³•è·å–ä¸‹è½½ç»Ÿè®¡&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  getPublishTime</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> output</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm view \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} time\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> lines</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> output.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> publishLine</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> lines.</span><span style="color:#B392F0;">find</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">line</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> line.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(version));</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> publishLine </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> publishLine.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;&#39;&quot;</span><span style="color:#E1E4E8;">)[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;"> &#39;æœªçŸ¥&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#9ECBFF;"> &#39;æœªçŸ¥&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> distManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> DistributionManager</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;my-cli-tool&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ç®¡ç†åˆ†å¸ƒæ ‡ç­¾</span></span>
<span class="line"><span style="color:#E1E4E8;">distManager.</span><span style="color:#B392F0;">listDistributionTags</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#6A737D;">// distManager.promoteVersion(&#39;beta&#39;, &#39;latest&#39;);</span></span>
<span class="line"><span style="color:#6A737D;">// distManager.addDistributionTag(&#39;1.2.3&#39;, &#39;stable&#39;);</span></span></code></pre></div><h3 id="å¼ƒç”¨ç®¡ç†" tabindex="-1">å¼ƒç”¨ç®¡ç† <a class="header-anchor" href="#å¼ƒç”¨ç®¡ç†" aria-label="Permalink to &quot;å¼ƒç”¨ç®¡ç†&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// deprecation-manager.mjs</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { execSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;node:child_process&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> DeprecationManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">packageName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.packageName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> packageName;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // å¼ƒç”¨ç‰¹å®šç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#B392F0;">  deprecateVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> deprecateMessage</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> message </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> \`ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} å·²å¼ƒç”¨ï¼Œè¯·å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm deprecate \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}@\${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} &quot;\${</span><span style="color:#E1E4E8;">deprecateMessage</span><span style="color:#9ECBFF;">}&quot;\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âš ï¸  å·²å¼ƒç”¨ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}: \${</span><span style="color:#E1E4E8;">deprecateMessage</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ å¼ƒç”¨æ“ä½œå¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // å¼ƒç”¨ç‰ˆæœ¬èŒƒå›´</span></span>
<span class="line"><span style="color:#B392F0;">  deprecateVersionRange</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">range</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm deprecate \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">}@&quot;\${</span><span style="color:#E1E4E8;">range</span><span style="color:#9ECBFF;">}&quot; &quot;\${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}&quot;\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        stdio: </span><span style="color:#9ECBFF;">&#39;inherit&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âš ï¸  å·²å¼ƒç”¨ç‰ˆæœ¬èŒƒå›´ \${</span><span style="color:#E1E4E8;">range</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ èŒƒå›´å¼ƒç”¨å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // æ‰¹é‡å¼ƒç”¨æ—§ç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#B392F0;">  deprecateOldVersions</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">keepLast</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 5</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> versions</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getVersionList</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> oldVersions</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> versions.</span><span style="color:#B392F0;">slice</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">keepLast);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ—‘ï¸  å‡†å¤‡å¼ƒç”¨ \${</span><span style="color:#E1E4E8;">oldVersions</span><span style="color:#9ECBFF;">.</span><span style="color:#79B8FF;">length</span><span style="color:#9ECBFF;">} ä¸ªæ—§ç‰ˆæœ¬ï¼Œä¿ç•™æœ€æ–°çš„ \${</span><span style="color:#E1E4E8;">keepLast</span><span style="color:#9ECBFF;">} ä¸ªç‰ˆæœ¬\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> deprecatedCount </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> version</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> oldVersions) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> success</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">deprecateVersion</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        version, </span></span>
<span class="line"><span style="color:#9ECBFF;">        \`ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} å·²è¿‡æ—¶ï¼Œè¯·å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬\`</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (success) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        deprecatedCount</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âœ… å·²å¼ƒç”¨ \${</span><span style="color:#E1E4E8;">deprecatedCount</span><span style="color:#9ECBFF;">}/\${</span><span style="color:#E1E4E8;">oldVersions</span><span style="color:#9ECBFF;">.</span><span style="color:#79B8FF;">length</span><span style="color:#9ECBFF;">} ä¸ªæ—§ç‰ˆæœ¬\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> deprecatedCount;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // è·å–ç‰ˆæœ¬åˆ—è¡¨</span></span>
<span class="line"><span style="color:#B392F0;">  getVersionList</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> output</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm view \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">} versions --json\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(output);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ— æ³•è·å–ç‰ˆæœ¬åˆ—è¡¨:&#39;</span><span style="color:#E1E4E8;">, error.message);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // ç”Ÿæˆå¼ƒç”¨æŠ¥å‘Š</span></span>
<span class="line"><span style="color:#B392F0;">  generateDeprecationReport</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> versions</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getVersionList</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentVersion</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> versions[versions.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> -</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> report</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      package: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.packageName,</span></span>
<span class="line"><span style="color:#E1E4E8;">      currentVersion,</span></span>
<span class="line"><span style="color:#E1E4E8;">      totalVersions: versions.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      deprecated: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getDeprecatedVersions</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      recommendations: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // ç”Ÿæˆå»ºè®®</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (versions.</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;</span><span style="color:#79B8FF;"> 10</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      report.recommendations.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;è€ƒè™‘å¼ƒç”¨ä¸€äº›æ—§ç‰ˆæœ¬ä»¥å‡å°‘ç»´æŠ¤è´Ÿæ‹…&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> majorVersions</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">groupByMajorVersion</span><span style="color:#E1E4E8;">(versions);</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (Object.</span><span style="color:#B392F0;">keys</span><span style="color:#E1E4E8;">(majorVersions).</span><span style="color:#79B8FF;">length</span><span style="color:#F97583;"> &gt;=</span><span style="color:#79B8FF;"> 3</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      report.recommendations.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å¤šä¸ªä¸»è¦ç‰ˆæœ¬å¹¶å­˜ï¼Œè€ƒè™‘å¼ƒç”¨æ—§çš„ä¸»è¦ç‰ˆæœ¬&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> report;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  getDeprecatedVersions</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> output</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> execSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`npm view \${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">packageName</span><span style="color:#9ECBFF;">} --json\`</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">        encoding: </span><span style="color:#9ECBFF;">&#39;utf8&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> info</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(output);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> info.deprecated </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#B392F0;">  groupByMajorVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">versions</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> groups</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> version</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> versions) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> major</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> version.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">groups[major]) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        groups[major] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      groups[major].</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(version);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> groups;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> deprecationManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> DeprecationManager</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;my-cli-tool&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ç”Ÿæˆå¼ƒç”¨æŠ¥å‘Š</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> report</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> deprecationManager.</span><span style="color:#B392F0;">generateDeprecationReport</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å¼ƒç”¨æŠ¥å‘Š:&#39;</span><span style="color:#E1E4E8;">, report);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// å¼ƒç”¨æ—§ç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#6A737D;">// deprecationManager.deprecateOldVersions(3);</span></span></code></pre></div><p>é€šè¿‡å®æ–½è¿™äº›å‘å¸ƒç­–ç•¥å’Œå·¥å…·ï¼ŒNode.js å‘½ä»¤è¡Œå·¥å…·å¯ä»¥å®ç°ä¸“ä¸šåŒ–çš„å‘å¸ƒæµç¨‹ï¼Œç¡®ä¿ç‰ˆæœ¬ç®¡ç†çš„è§„èŒƒæ€§ã€å‘å¸ƒè¿‡ç¨‹çš„å¯æ§æ€§ä»¥åŠç”¨æˆ·è·å–çš„ä¾¿åˆ©æ€§ã€‚</p>`,31)])])}const B=n(o,[["render",e]]);export{i as __pageData,B as default};
