import{_ as a,c as n,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const d=JSON.parse('{"title":"React Compiler","description":"","frontmatter":{},"headers":[{"level":2,"title":"React Compiler 简介","slug":"react-compiler-简介","link":"#react-compiler-简介","children":[{"level":3,"title":"为什么要使用 React Compiler？","slug":"为什么要使用-react-compiler","link":"#为什么要使用-react-compiler","children":[]}]},{"level":2,"title":"核心原理与工作流程","slug":"核心原理与工作流程","link":"#核心原理与工作流程","children":[{"level":3,"title":"工作流程概述","slug":"工作流程概述","link":"#工作流程概述","children":[]},{"level":3,"title":"核心原理详解","slug":"核心原理详解","link":"#核心原理详解","children":[]}]},{"level":2,"title":"优化的主要场景与 API","slug":"优化的主要场景与-api","link":"#优化的主要场景与-api","children":[{"level":3,"title":"重新渲染优化","slug":"重新渲染优化","link":"#重新渲染优化","children":[]},{"level":3,"title":"昂贵计算优化","slug":"昂贵计算优化","link":"#昂贵计算优化","children":[]}]},{"level":2,"title":"代码示例：优化前后对比","slug":"代码示例-优化前后对比","link":"#代码示例-优化前后对比","children":[{"level":3,"title":"基础组件优化","slug":"基础组件优化","link":"#基础组件优化","children":[]},{"level":3,"title":"条件渲染优化","slug":"条件渲染优化","link":"#条件渲染优化","children":[]},{"level":3,"title":"嵌套 Hook 优化","slug":"嵌套-hook-优化","link":"#嵌套-hook-优化","children":[]}]},{"level":2,"title":"配置与使用方式","slug":"配置与使用方式","link":"#配置与使用方式","children":[{"level":3,"title":"新项目配置","slug":"新项目配置","link":"#新项目配置","children":[]},{"level":3,"title":"现有项目渐进式采用","slug":"现有项目渐进式采用","link":"#现有项目渐进式采用","children":[]},{"level":3,"title":"React 版本兼容性","slug":"react-版本兼容性","link":"#react-版本兼容性","children":[]}]},{"level":2,"title":"注意事项与限制","slug":"注意事项与限制","link":"#注意事项与限制","children":[{"level":3,"title":"当前限制","slug":"当前限制","link":"#当前限制","children":[]},{"level":3,"title":"生产环境使用建议","slug":"生产环境使用建议","link":"#生产环境使用建议","children":[]}]}],"relativePath":"framework/react/compiler.md","filePath":"framework/react/compiler.md"}'),o={name:"framework/react/compiler.md"};function e(t,s,c,r,E,i){return l(),n("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /framework/react/compiler.md for this page in Markdown format</div><h1 id="react-compiler" tabindex="-1">React Compiler <a class="header-anchor" href="#react-compiler" aria-label="Permalink to &quot;React Compiler&quot;">​</a></h1><h2 id="react-compiler-简介" tabindex="-1">React Compiler 简介 <a class="header-anchor" href="#react-compiler-简介" aria-label="Permalink to &quot;React Compiler 简介&quot;">​</a></h2><p>React Compiler 是一个用 <strong>Rust</strong> 编写的<strong>自动记忆化 (auto-memoization) 编译器</strong>，它能够在构建阶段自动优化 React 应用代码。它的主要目标是解决 React 应用中<strong>手动记忆化</strong>的复杂性和维护负担，让开发者能够编写更简洁的代码，同时获得更好的性能表现。</p><h3 id="为什么要使用-react-compiler" tabindex="-1">为什么要使用 React Compiler？ <a class="header-anchor" href="#为什么要使用-react-compiler" aria-label="Permalink to &quot;为什么要使用 React Compiler？&quot;">​</a></h3><p>在传统的 React 开发中，当组件的 props、state 或 context 发生变化时，React 会重新渲染该组件及其所有子组件，除非你手动使用 <code>useMemo</code>、<code>useCallback</code> 或 <code>React.memo</code> 进行优化。这种手动记忆化存在几个问题：</p><ul><li><strong>繁琐且容易出错</strong>：需要仔细选择依赖项，否则可能导致过度记忆化或记忆化不足</li><li><strong>代码可读性差</strong>：大量的记忆化代码会掩盖业务逻辑</li><li><strong>维护困难</strong>：随着组件演变，需要不断调整记忆化策略</li></ul><p>React Compiler 通过<strong>静态分析</strong> React 代码，理解组件的依赖关系和数据流，自动应用等效的记忆化优化，使开发者可以专注于业务逻辑而不是性能优化。</p><h2 id="核心原理与工作流程" tabindex="-1">核心原理与工作流程 <a class="header-anchor" href="#核心原理与工作流程" aria-label="Permalink to &quot;核心原理与工作流程&quot;">​</a></h2><h3 id="工作流程概述" tabindex="-1">工作流程概述 <a class="header-anchor" href="#工作流程概述" aria-label="Permalink to &quot;工作流程概述&quot;">​</a></h3><p>React Compiler 的工作流程可以概括为四个主要阶段：</p><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="color:#E1E4E8;">    A[源代码] --&gt; B[解析阶段]</span></span>
<span class="line"><span style="color:#E1E4E8;">    B --&gt; C[中间表示 HIR]</span></span>
<span class="line"><span style="color:#E1E4E8;">    C --&gt; D[优化阶段]</span></span>
<span class="line"><span style="color:#E1E4E8;">    D --&gt; E[代码生成阶段]</span></span>
<span class="line"><span style="color:#E1E4E8;">    E --&gt; F[优化后的代码]</span></span></code></pre></div><h3 id="核心原理详解" tabindex="-1">核心原理详解 <a class="header-anchor" href="#核心原理详解" aria-label="Permalink to &quot;核心原理详解&quot;">​</a></h3><h4 id="。1-解析与中间表示" tabindex="-1">。1 解析与中间表示 <a class="header-anchor" href="#。1-解析与中间表示" aria-label="Permalink to &quot;。1 解析与中间表示&quot;">​</a></h4><p>编译器首先将 JavaScript 代码解析为<strong>抽象语法树 (AST)</strong>，然后转换为<strong>高级中间表示 (HIR)</strong>。HIR 是一种更适合进行 React 特定优化的表示形式，它捕获了组件中的控制流和数据流信息。</p><p>在 HIR 中，代码被转换为<strong>静态单赋值 (SSA) 形式</strong>，这意味着每个变量只被赋值一次。这种形式使得编译器能够更精确地追踪值的变化和依赖关系。</p><h4 id="。2-依赖分析与记忆化策略" tabindex="-1">。2 依赖分析与记忆化策略 <a class="header-anchor" href="#。2-依赖分析与记忆化策略" aria-label="Permalink to &quot;。2 依赖分析与记忆化策略&quot;">​</a></h4><p>编译器通过分析 JavaScript 和 JSX 代码，理解哪些值在重新渲染期间需要保持稳定，哪些计算可以缓存。它会识别：</p><ul><li><strong>响应式值</strong>：props、state 和 context 等可能触发重新渲染的值</li><li><strong>派生值</strong>：从响应式值计算得到的值</li><li><strong>事件处理函数</strong>：在组件内定义的函数</li></ul><p>基于这些分析，编译器会插入适当的记忆化代码，确保只有当真正依赖的值发生变化时，组件才会重新渲染。</p><h4 id="。3-代码生成与优化" tabindex="-1">。3 代码生成与优化 <a class="header-anchor" href="#。3-代码生成与优化" aria-label="Permalink to &quot;。3 代码生成与优化&quot;">​</a></h4><p>在优化阶段，编译器应用多种优化技术：</p><ul><li><strong>常量折叠</strong>：在编译时计算常量表达式</li><li><strong>死代码消除</strong>：移除不会影响渲染结果的代码</li><li><strong>函数内联</strong>：将小函数内联到调用处，减少函数调用开销</li><li><strong>条件渲染优化</strong>：简化条件渲染逻辑</li></ul><h2 id="优化的主要场景与-api" tabindex="-1">优化的主要场景与 API <a class="header-anchor" href="#优化的主要场景与-api" aria-label="Permalink to &quot;优化的主要场景与 API&quot;">​</a></h2><p>React Compiler 主要优化以下两种场景：</p><table tabindex="0"><thead><tr><th>优化场景</th><th>描述</th><th>手动优化方式</th></tr></thead><tbody><tr><td>跳过组件的级联重新渲染</td><td>防止父组件重新渲染导致不必要的子组件重新渲染</td><td><code>React.memo</code>, <code>useCallback</code>, <code>useMemo</code></td></tr><tr><td>跳过 React 外部的昂贵计算</td><td>避免重复执行昂贵的计算函数</td><td><code>useMemo</code></td></tr></tbody></table><h3 id="重新渲染优化" tabindex="-1">重新渲染优化 <a class="header-anchor" href="#重新渲染优化" aria-label="Permalink to &quot;重新渲染优化&quot;">​</a></h3><p>在没有编译器的情况下，当父组件重新渲染时，所有子组件也会重新渲染，即使它们的 props 没有变化。React Compiler 通过自动记忆化组件和 props，实现了<strong>细粒度响应式</strong>，确保只有真正发生变化的部分才会重新渲染。</p><h3 id="昂贵计算优化" tabindex="-1">昂贵计算优化 <a class="header-anchor" href="#昂贵计算优化" aria-label="Permalink to &quot;昂贵计算优化&quot;">​</a></h3><p>对于在组件内部执行的昂贵计算 (如处理大型数组)，编译器会自动判断何时需要重新计算，何时可以返回缓存的结果。</p><h2 id="代码示例-优化前后对比" tabindex="-1">代码示例：优化前后对比 <a class="header-anchor" href="#代码示例-优化前后对比" aria-label="Permalink to &quot;代码示例：优化前后对比&quot;">​</a></h2><h3 id="基础组件优化" tabindex="-1">基础组件优化 <a class="header-anchor" href="#基础组件优化" aria-label="Permalink to &quot;基础组件优化&quot;">​</a></h3><p><strong>优化前</strong>：需要手动记忆化</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { useMemo, useCallback, memo } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;react&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> ExpensiveComponent</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> memo</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">function</span><span style="color:#B392F0;"> ExpensiveComponent</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#FFAB70;">  data</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#FFAB70;">  onClick</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">}) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> processedData</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useMemo</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> expensiveProcessing</span><span style="color:#E1E4E8;">(data)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, [data])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> handleClick</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useCallback</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#FFAB70;">item</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      onClick</span><span style="color:#E1E4E8;">(item.id)</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    [onClick],</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      {processedData.</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">item</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">        &lt;</span><span style="color:#79B8FF;">Item</span><span style="color:#B392F0;"> key</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{item.id} </span><span style="color:#B392F0;">onClick</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{() </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> handleClick</span><span style="color:#E1E4E8;">(item)} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      ))}</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><p><strong>优化后</strong>：编译器自动处理记忆化</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> ExpensiveComponent</span><span style="color:#E1E4E8;">({ </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">onClick</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> processedData</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> expensiveProcessing</span><span style="color:#E1E4E8;">(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#B392F0;"> handleClick</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">item</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    onClick</span><span style="color:#E1E4E8;">(item.id)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      {processedData.</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">item</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">        &lt;</span><span style="color:#79B8FF;">Item</span><span style="color:#B392F0;"> key</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{item.id} </span><span style="color:#B392F0;">onClick</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{() </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> handleClick</span><span style="color:#E1E4E8;">(item)} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      ))}</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>注意，即使在优化后的版本中使用了箭头函数 <code>() =&gt; handleClick(item)</code>，编译器也能正确优化，确保 <code>Item</code> 组件不会不必要地重新渲染。</p><h3 id="条件渲染优化" tabindex="-1">条件渲染优化 <a class="header-anchor" href="#条件渲染优化" aria-label="Permalink to &quot;条件渲染优化&quot;">​</a></h3><p><strong>优化前</strong>：</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> UserProfile</span><span style="color:#E1E4E8;">({ </span><span style="color:#FFAB70;">user</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">isAdmin</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">settings</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">setSettings</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> useState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> adminFeatures</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useMemo</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> isAdmin </span><span style="color:#F97583;">?</span><span style="color:#B392F0;"> calculateAdminFeatures</span><span style="color:#E1E4E8;">(user) </span><span style="color:#F97583;">:</span><span style="color:#79B8FF;"> null</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, [isAdmin, user])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> userSettings</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useMemo</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> processSettings</span><span style="color:#E1E4E8;">(settings)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, [settings])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      &lt;</span><span style="color:#79B8FF;">Header</span><span style="color:#B392F0;"> user</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{user} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      {isAdmin </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> &lt;</span><span style="color:#79B8FF;">AdminPanel</span><span style="color:#B392F0;"> features</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{adminFeatures} /&gt;}</span></span>
<span class="line"><span style="color:#E1E4E8;">      &lt;</span><span style="color:#79B8FF;">SettingsPanel</span><span style="color:#B392F0;"> settings</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{userSettings} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p><strong>优化后</strong>：</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> UserProfile</span><span style="color:#E1E4E8;">({ </span><span style="color:#FFAB70;">user</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">isAdmin</span><span style="color:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">settings</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">setSettings</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> useState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> adminFeatures</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> isAdmin </span><span style="color:#F97583;">?</span><span style="color:#B392F0;"> calculateAdminFeatures</span><span style="color:#E1E4E8;">(user) </span><span style="color:#F97583;">:</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> userSettings</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> processSettings</span><span style="color:#E1E4E8;">(settings);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      &lt;</span><span style="color:#79B8FF;">Header</span><span style="color:#B392F0;"> user</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{user} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">      {isAdmin </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> &lt;</span><span style="color:#79B8FF;">AdminPanel</span><span style="color:#B392F0;"> features</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{adminFeatures} /&gt;}</span></span>
<span class="line"><span style="color:#E1E4E8;">      &lt;</span><span style="color:#79B8FF;">SettingsPanel</span><span style="color:#B392F0;"> settings</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{userSettings} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  );</span></span></code></pre></div><h3 id="嵌套-hook-优化" tabindex="-1">嵌套 Hook 优化 <a class="header-anchor" href="#嵌套-hook-优化" aria-label="Permalink to &quot;嵌套 Hook 优化&quot;">​</a></h3><p><strong>优化前</strong>：依赖链复杂容易出错</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> App</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ({ </span><span style="color:#FFAB70;">x</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">y</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">z</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> handleX</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useCallback</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(x)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, [x])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> handleY</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useCallback</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    handleX</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(y)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, [y, handleX])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 表面上只跟 z, handleY 有关，实际上当 x 变化时 handleZ 也会变更</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> handleZ</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> useCallback</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    handleY</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(z)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }, [z, handleY])</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p><strong>优化后</strong>：编译器自动管理依赖</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> App</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ({ </span><span style="color:#FFAB70;">x</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">y</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">z</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#B392F0;"> handleX</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(x)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#B392F0;"> handleY</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    handleX</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(y)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#B392F0;"> handleZ</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    handleY</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(z)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="配置与使用方式" tabindex="-1">配置与使用方式 <a class="header-anchor" href="#配置与使用方式" aria-label="Permalink to &quot;配置与使用方式&quot;">​</a></h2><h3 id="新项目配置" tabindex="-1">新项目配置 <a class="header-anchor" href="#新项目配置" aria-label="Permalink to &quot;新项目配置&quot;">​</a></h3><p>对于使用 Vite 的新 React 项目：</p><ol><li><strong>安装依赖</strong>：</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">pnpm</span><span style="color:#9ECBFF;"> create</span><span style="color:#9ECBFF;"> vite</span><span style="color:#9ECBFF;"> my-react-app</span><span style="color:#79B8FF;"> --template</span><span style="color:#9ECBFF;"> react-ts</span></span>
<span class="line"><span style="color:#B392F0;">pnpm</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> babel-plugin-react-compiler</span><span style="color:#9ECBFF;"> eslint-plugin-react-compiler</span></span></code></pre></div><ol start="2"><li><strong>配置 Vite</strong>：</li></ol><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// vite.config.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { defineConfig } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;vite&#39;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> react </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;@vitejs/plugin-react&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#B392F0;"> defineConfig</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="color:#B392F0;">    react</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">      babel: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        plugins: [[</span><span style="color:#9ECBFF;">&#39;babel-plugin-react-compiler&#39;</span><span style="color:#E1E4E8;">]],</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">    }),</span></span>
<span class="line"><span style="color:#E1E4E8;">  ],</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><ol start="3"><li><strong>配置 ESLint</strong>：</li></ol><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// .eslintrc.js</span></span>
<span class="line"><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">exports</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  plugins: [</span><span style="color:#9ECBFF;">&#39;eslint-plugin-react-compiler&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">  rules: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;react-compiler/react-compiler&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="现有项目渐进式采用" tabindex="-1">现有项目渐进式采用 <a class="header-anchor" href="#现有项目渐进式采用" aria-label="Permalink to &quot;现有项目渐进式采用&quot;">​</a></h3><p>对于现有代码库，建议采用渐进式策略：</p><ol><li><strong>健康检查</strong>：</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">npx</span><span style="color:#9ECBFF;"> react-compiler-healthcheck@latest</span></span></code></pre></div><p>该脚本会检查：</p><ul><li>可以成功优化的组件比例</li><li><code>StrictMode</code> 使用情况</li><li>已知不兼容的库</li></ul><ol start="2"><li><strong>局部编译配置</strong>：</li></ol><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 只编译 src/components 目录下的文件</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> ReactCompilerConfig</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">  sources</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">filename</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> filename.</span><span style="color:#B392F0;">indexOf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;src/components&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">!==</span><span style="color:#F97583;"> -</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#B392F0;"> defineConfig</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="color:#B392F0;">    react</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">      babel: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        plugins: [[</span><span style="color:#9ECBFF;">&#39;babel-plugin-react-compiler&#39;</span><span style="color:#E1E4E8;">, ReactCompilerConfig]],</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">    }),</span></span>
<span class="line"><span style="color:#E1E4E8;">  ],</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><ol start="3"><li><strong>源码注解控制</strong>：</li></ol><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 强制编译当前组件</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> MyComponent</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;use memo&#39;</span></span>
<span class="line"><span style="color:#6A737D;">  // ...</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 跳过当前组件编译</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> AnotherComponent</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;use no memo&#39;</span></span>
<span class="line"><span style="color:#6A737D;">  // ...</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="react-版本兼容性" tabindex="-1">React 版本兼容性 <a class="header-anchor" href="#react-版本兼容性" aria-label="Permalink to &quot;React 版本兼容性&quot;">​</a></h3><p>React Compiler 支持 React 17、18 和 19。对于 React 17 和 18 项目，需要安装额外的运行时包：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">npm</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> react-compiler-runtime@rc</span></span></code></pre></div><p>配置对应 target：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// babel.config.js</span></span>
<span class="line"><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">exports</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;babel-plugin-react-compiler&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      {</span></span>
<span class="line"><span style="color:#E1E4E8;">        target: </span><span style="color:#9ECBFF;">&#39;18&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 或 &#39;17&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">    ],</span></span>
<span class="line"><span style="color:#E1E4E8;">  ],</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="注意事项与限制" tabindex="-1">注意事项与限制 <a class="header-anchor" href="#注意事项与限制" aria-label="Permalink to &quot;注意事项与限制&quot;">​</a></h2><h3 id="当前限制" tabindex="-1">当前限制 <a class="header-anchor" href="#当前限制" aria-label="Permalink to &quot;当前限制&quot;">​</a></h3><p>虽然 React Compiler 功能强大，但目前仍有以下限制：</p><ol><li><p><strong>并非万能解决方案</strong>：在真实世界的复杂应用中，编译器可能无法优化所有不必要的重新渲染。一项测试显示，在 10 个明显的不必要重新渲染案例中，编译器只修复了其中 2 个。</p></li><li><p><strong>遵循 React 规则</strong>：编译器要求代码严格遵循 React 的规则，特别是：</p><ul><li>组件必须是纯函数</li><li>Hook 必须在顶层调用，且条件不变</li><li>遵循其他 React 规则</li></ul></li><li><p><strong>手动记忆化可能干扰编译器</strong>：如果选择保留手动记忆化，React Compiler 会分析它们，并判断你的手动记忆化是否与其自动推断出的记忆化一致。如果不一致，编译器将选择放弃优化该组件。</p></li></ol><h3 id="生产环境使用建议" tabindex="-1">生产环境使用建议 <a class="header-anchor" href="#生产环境使用建议" aria-label="Permalink to &quot;生产环境使用建议&quot;">​</a></h3><ol><li><p><strong>逐步启用</strong>：先在非关键路径组件上启用编译器，验证无误后再逐步扩大范围。</p></li><li><p><strong>严格监控</strong>：在生产环境中密切关注性能指标和错误报告。</p></li><li><p><strong>保留测试覆盖</strong>：确保有充分的测试覆盖，防止优化引入意外行为。</p></li><li><p><strong>了解降级策略</strong>：准备好遇到问题时快速禁用编译器的方案。</p></li></ol>`,77)])])}const F=a(o,[["render",e]]);export{d as __pageData,F as default};
