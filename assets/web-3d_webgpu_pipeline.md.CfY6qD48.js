import{_ as a,c as n,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const F=JSON.parse('{"title":"WebGPU 渲染管线","description":"","frontmatter":{},"headers":[{"level":2,"title":"渲染管线概述","slug":"渲染管线概述","link":"#渲染管线概述","children":[]},{"level":2,"title":"管线创建与配置","slug":"管线创建与配置","link":"#管线创建与配置","children":[{"level":3,"title":"管线创建","slug":"管线创建","link":"#管线创建","children":[]},{"level":3,"title":"管线布局","slug":"管线布局","link":"#管线布局","children":[]}]},{"level":2,"title":"输入装配阶段","slug":"输入装配阶段","link":"#输入装配阶段","children":[{"level":3,"title":"顶点缓冲区布局","slug":"顶点缓冲区布局","link":"#顶点缓冲区布局","children":[]},{"level":3,"title":"图元拓扑","slug":"图元拓扑","link":"#图元拓扑","children":[]}]},{"level":2,"title":"顶点着色阶段","slug":"顶点着色阶段","link":"#顶点着色阶段","children":[{"level":3,"title":"顶点着色器示例","slug":"顶点着色器示例","link":"#顶点着色器示例","children":[]},{"level":3,"title":"内置变量","slug":"内置变量","link":"#内置变量","children":[]}]},{"level":2,"title":"图元组装阶段","slug":"图元组装阶段","link":"#图元组装阶段","children":[{"level":3,"title":"面剔除","slug":"面剔除","link":"#面剔除","children":[]}]},{"level":2,"title":"光栅化阶段","slug":"光栅化阶段","link":"#光栅化阶段","children":[{"level":3,"title":"多重采样抗锯齿","slug":"多重采样抗锯齿","link":"#多重采样抗锯齿","children":[]}]},{"level":2,"title":"片段着色阶段","slug":"片段着色阶段","link":"#片段着色阶段","children":[{"level":3,"title":"片段着色器示例","slug":"片段着色器示例","link":"#片段着色器示例","children":[]},{"level":3,"title":"早期深度测试","slug":"早期深度测试","link":"#早期深度测试","children":[]}]},{"level":2,"title":"输出合并阶段","slug":"输出合并阶段","link":"#输出合并阶段","children":[{"level":3,"title":"深度和模板测试","slug":"深度和模板测试","link":"#深度和模板测试","children":[]},{"level":3,"title":"颜色混合","slug":"颜色混合","link":"#颜色混合","children":[]}]},{"level":2,"title":"渲染通道编码","slug":"渲染通道编码","link":"#渲染通道编码","children":[{"level":3,"title":"渲染通道设置","slug":"渲染通道设置","link":"#渲染通道设置","children":[]},{"level":3,"title":"绘制命令","slug":"绘制命令","link":"#绘制命令","children":[]}]},{"level":2,"title":"多渲染目标","slug":"多渲染目标","link":"#多渲染目标","children":[]},{"level":2,"title":"性能优化特性","slug":"性能优化特性","link":"#性能优化特性","children":[{"level":3,"title":"管线状态对象","slug":"管线状态对象","link":"#管线状态对象","children":[]},{"level":3,"title":"动态状态","slug":"动态状态","link":"#动态状态","children":[]},{"level":3,"title":"间接绘制","slug":"间接绘制","link":"#间接绘制","children":[]}]}],"relativePath":"web-3d/webgpu/pipeline.md","filePath":"web-3d/webgpu/pipeline.md"}'),o={name:"web-3d/webgpu/pipeline.md"};function e(t,s,c,r,E,i){return l(),n("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /web-3d/webgpu/pipeline.md for this page in Markdown format</div><h1 id="webgpu-渲染管线" tabindex="-1">WebGPU 渲染管线 <a class="header-anchor" href="#webgpu-渲染管线" aria-label="Permalink to &quot;WebGPU 渲染管线&quot;">​</a></h1><p>WebGPU 渲染管线是现代图形编程的核心组件，它定义了几何数据从原始顶点到最终像素的完整处理流程。与传统的 WebGL 管线相比，WebGPU 提供了更精细的控制和更高的性能，同时引入了更严格的类型安全和并行处理能力。</p><h2 id="渲染管线概述" tabindex="-1">渲染管线概述 <a class="header-anchor" href="#渲染管线概述" aria-label="Permalink to &quot;渲染管线概述&quot;">​</a></h2><p>WebGPU 渲染管线是一个高度可配置的并行处理系统，它将 3D 场景数据转换为 2D 图像。管线设计借鉴了现代图形 API 的最佳实践，提供了明确的阶段划分和高效的数据流管理。</p><p><strong>管线架构示意图</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>应用阶段 → 输入装配 → 顶点着色 → 图元组装 → 光栅化 → 片段着色 → 输出合并</span></span>
<span class="line"><span>   ↓           ↓          ↓          ↓          ↓          ↓          ↓</span></span>
<span class="line"><span>CPU准备    顶点数据    顶点处理    几何构建    像素映射    颜色计算    最终输出</span></span></code></pre></div><h2 id="管线创建与配置" tabindex="-1">管线创建与配置 <a class="header-anchor" href="#管线创建与配置" aria-label="Permalink to &quot;管线创建与配置&quot;">​</a></h2><p>在 WebGPU 中，渲染管线是通过管线布局和状态对象预先定义的，这种设计允许驱动程序进行深度优化。</p><h3 id="管线创建" tabindex="-1">管线创建 <a class="header-anchor" href="#管线创建" aria-label="Permalink to &quot;管线创建&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> renderPipeline</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> device.</span><span style="color:#B392F0;">createRenderPipeline</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    layout: pipelineLayout,</span></span>
<span class="line"><span style="color:#E1E4E8;">    vertex: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        module: vertexShaderModule,</span></span>
<span class="line"><span style="color:#E1E4E8;">        entryPoint: </span><span style="color:#9ECBFF;">&#39;vs_main&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        buffers: [vertexBufferLayout]</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    fragment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        module: fragmentShaderModule,</span></span>
<span class="line"><span style="color:#E1E4E8;">        entryPoint: </span><span style="color:#9ECBFF;">&#39;fs_main&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        targets: [{</span></span>
<span class="line"><span style="color:#E1E4E8;">            format: </span><span style="color:#9ECBFF;">&#39;bgra8unorm&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            blend: {</span></span>
<span class="line"><span style="color:#E1E4E8;">                color: {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    srcFactor: </span><span style="color:#9ECBFF;">&#39;src-alpha&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    dstFactor: </span><span style="color:#9ECBFF;">&#39;one-minus-src-alpha&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    operation: </span><span style="color:#9ECBFF;">&#39;add&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                },</span></span>
<span class="line"><span style="color:#E1E4E8;">                alpha: {</span></span>
<span class="line"><span style="color:#E1E4E8;">                    srcFactor: </span><span style="color:#9ECBFF;">&#39;one&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    dstFactor: </span><span style="color:#9ECBFF;">&#39;one-minus-src-alpha&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    operation: </span><span style="color:#9ECBFF;">&#39;add&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                }</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }]</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    primitive: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        topology: </span><span style="color:#9ECBFF;">&#39;triangle-list&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        cullMode: </span><span style="color:#9ECBFF;">&#39;back&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    depthStencil: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        format: </span><span style="color:#9ECBFF;">&#39;depth24plus-stencil8&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        depthWriteEnabled: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        depthCompare: </span><span style="color:#9ECBFF;">&#39;less&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    multisample: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        count: </span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="管线布局" tabindex="-1">管线布局 <a class="header-anchor" href="#管线布局" aria-label="Permalink to &quot;管线布局&quot;">​</a></h3><p>管线布局定义了着色器可以访问的资源绑定方式：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> pipelineLayout</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> device.</span><span style="color:#B392F0;">createPipelineLayout</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    bindGroupLayouts: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        bindGroupLayout </span><span style="color:#6A737D;">// 定义统一缓冲区、纹理等资源的绑定方式</span></span>
<span class="line"><span style="color:#E1E4E8;">    ]</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h2 id="输入装配阶段" tabindex="-1">输入装配阶段 <a class="header-anchor" href="#输入装配阶段" aria-label="Permalink to &quot;输入装配阶段&quot;">​</a></h2><p>输入装配阶段负责从缓冲区中读取顶点数据并组装成基本图元。这个阶段是渲染管线的起点，决定了如何解释输入的几何数据。</p><p><strong>输入装配流程</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>顶点缓冲区 → 索引缓冲区 → 顶点提取 → 图元组装</span></span>
<span class="line"><span>    ↓           ↓           ↓          ↓</span></span>
<span class="line"><span>位置/法线    顶点索引     属性读取    三角形/线</span></span></code></pre></div><h3 id="顶点缓冲区布局" tabindex="-1">顶点缓冲区布局 <a class="header-anchor" href="#顶点缓冲区布局" aria-label="Permalink to &quot;顶点缓冲区布局&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> vertexBufferLayout</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    arrayStride: </span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 每个顶点占32字节</span></span>
<span class="line"><span style="color:#E1E4E8;">    attributes: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">            format: </span><span style="color:#9ECBFF;">&#39;float32x3&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 位置：3个float32</span></span>
<span class="line"><span style="color:#E1E4E8;">            offset: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            shaderLocation: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">            format: </span><span style="color:#9ECBFF;">&#39;float32x3&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 法线：3个float32  </span></span>
<span class="line"><span style="color:#E1E4E8;">            offset: </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            shaderLocation: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">            format: </span><span style="color:#9ECBFF;">&#39;float32x2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 纹理坐标：2个float32</span></span>
<span class="line"><span style="color:#E1E4E8;">            offset: </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            shaderLocation: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    ]</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span></code></pre></div><h3 id="图元拓扑" tabindex="-1">图元拓扑 <a class="header-anchor" href="#图元拓扑" aria-label="Permalink to &quot;图元拓扑&quot;">​</a></h3><p>WebGPU 支持多种图元拓扑类型：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>点列表:        ●   ●   ●   ●</span></span>
<span class="line"><span>线列表:        ├───┼───┼───┤</span></span>
<span class="line"><span>线带:         ├───┼───┼───┤</span></span>
<span class="line"><span>三角形列表:     ▲   ▲   ▲   ▲</span></span>
<span class="line"><span>              / \\ / \\ / \\ / \\</span></span>
<span class="line"><span>三角形带:     ▲▲▲▲▲▲▲▲▲▲▲▲▲</span></span>
<span class="line"><span>            / \\ / \\ / \\ / \\ /</span></span></code></pre></div><h2 id="顶点着色阶段" tabindex="-1">顶点着色阶段 <a class="header-anchor" href="#顶点着色阶段" aria-label="Permalink to &quot;顶点着色阶段&quot;">​</a></h2><p>顶点着色器是渲染管线的第一个可编程阶段，负责处理每个顶点的变换和属性计算。</p><h3 id="顶点着色器示例" tabindex="-1">顶点着色器示例 <a class="header-anchor" href="#顶点着色器示例" aria-label="Permalink to &quot;顶点着色器示例&quot;">​</a></h3><div class="language-wgsl"><button title="Copy Code" class="copy"></button><span class="lang">wgsl</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">struct</span><span style="color:#B392F0;"> VertexInput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) position: </span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) normal: </span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) texCoord: </span><span style="color:#F97583;">vec2</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">struct</span><span style="color:#B392F0;"> VertexOutput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">builtin</span><span style="color:#E1E4E8;">(position) position: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) worldPosition: </span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) worldNormal: </span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) texCoord: </span><span style="color:#F97583;">vec2</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">group</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">@</span><span style="color:#B392F0;">binding</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">uniform</span><span style="color:#E1E4E8;">&gt; modelViewProjection: </span><span style="color:#F97583;">mat4x4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">group</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">@</span><span style="color:#B392F0;">binding</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">uniform</span><span style="color:#E1E4E8;">&gt; modelMatrix: </span><span style="color:#F97583;">mat4x4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">vertex</span></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#B392F0;"> vs_main</span><span style="color:#E1E4E8;">(input: </span><span style="color:#B392F0;">VertexInput</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> VertexOutput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    var</span><span style="color:#E1E4E8;"> output: </span><span style="color:#B392F0;">VertexOutput</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 位置变换到裁剪空间</span></span>
<span class="line"><span style="color:#E1E4E8;">    output</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">position </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> modelViewProjection </span><span style="color:#F97583;">*</span><span style="color:#F97583;"> vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(input</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">position, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 法线变换到世界空间</span></span>
<span class="line"><span style="color:#E1E4E8;">    output</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">worldNormal </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (modelMatrix </span><span style="color:#F97583;">*</span><span style="color:#F97583;"> vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(input</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">normal, </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">xyz;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 世界空间位置</span></span>
<span class="line"><span style="color:#E1E4E8;">    output</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">worldPosition </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (modelMatrix </span><span style="color:#F97583;">*</span><span style="color:#F97583;"> vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(input</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">position, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">xyz;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 传递纹理坐标</span></span>
<span class="line"><span style="color:#E1E4E8;">    output</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">texCoord </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> input</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">texCoord;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> output;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="内置变量" tabindex="-1">内置变量 <a class="header-anchor" href="#内置变量" aria-label="Permalink to &quot;内置变量&quot;">​</a></h3><p>顶点着色器可以使用多种内置变量：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>@vertex_index:     顶点索引</span></span>
<span class="line"><span>@instance_index:   实例索引</span></span>
<span class="line"><span>@position:         输出位置（必须）</span></span>
<span class="line"><span>@point_size:       点大小（可选）</span></span></code></pre></div><h2 id="图元组装阶段" tabindex="-1">图元组装阶段 <a class="header-anchor" href="#图元组装阶段" aria-label="Permalink to &quot;图元组装阶段&quot;">​</a></h2><p>图元组装阶段将处理后的顶点连接成完整的几何图元，同时执行背面剔除、视锥体裁剪等操作。</p><p><strong>图元组装流程</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>处理后的顶点 → 图元连接 → 背面剔除 → 视锥裁剪 → 透视除法</span></span>
<span class="line"><span>     ↓           ↓          ↓          ↓          ↓</span></span>
<span class="line"><span> 顶点着色器输出   三角形构建   面剔除     可见性判断   规范化坐标</span></span></code></pre></div><h3 id="面剔除" tabindex="-1">面剔除 <a class="header-anchor" href="#面剔除" aria-label="Permalink to &quot;面剔除&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">primitive</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#B392F0;">    topology</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;triangle-list&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">    cullMode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;back&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">// 剔除背面</span></span>
<span class="line"><span style="color:#B392F0;">    frontFace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;ccw&#39;</span><span style="color:#6A737D;">   // 逆时针为正面</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>剔除模式示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>正面三角形 (保留):   背面三角形 (剔除):</span></span>
<span class="line"><span>   v0                  v0</span></span>
<span class="line"><span>  / \\                 / \\</span></span>
<span class="line"><span> v1---v2            v2---v1</span></span></code></pre></div><h2 id="光栅化阶段" tabindex="-1">光栅化阶段 <a class="header-anchor" href="#光栅化阶段" aria-label="Permalink to &quot;光栅化阶段&quot;">​</a></h2><p>光栅化是将几何图元转换为像素片段的过程，这个阶段确定哪些像素被图元覆盖，并为每个片段生成插值属性。</p><p><strong>光栅化流程</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>图元 → 扫描转换 → 深度计算 → 属性插值 → 片段生成</span></span>
<span class="line"><span> ↓        ↓          ↓          ↓          ↓</span></span>
<span class="line"><span>几何体   像素映射    深度值     平滑过渡   片段数据</span></span></code></pre></div><h3 id="多重采样抗锯齿" tabindex="-1">多重采样抗锯齿 <a class="header-anchor" href="#多重采样抗锯齿" aria-label="Permalink to &quot;多重采样抗锯齿&quot;">​</a></h3><p>WebGPU 支持多重采样抗锯齿 (MSAA)，通过在每个像素内采样多个位置来减少锯齿：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">multisample</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#B392F0;">    count</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">,                    </span><span style="color:#6A737D;">// 4倍多重采样</span></span>
<span class="line"><span style="color:#B392F0;">    mask</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0xFFFFFFFF</span><span style="color:#E1E4E8;">,            </span><span style="color:#6A737D;">// 所有样本都写入</span></span>
<span class="line"><span style="color:#B392F0;">    alphaToCoverageEnabled</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>MSAA 示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>无抗锯齿:         MSAA 4x:</span></span>
<span class="line"><span>像素边界锯齿      平滑边界</span></span>
<span class="line"><span>▓▓▓▓░░░░        ▓▓▓▓░░░░</span></span>
<span class="line"><span>▓▓▓░░░░░   →    ▓▓▓▒░░░░</span></span>
<span class="line"><span>▓▓░░░░░░        ▓▓▒▒░░░░</span></span>
<span class="line"><span>▓░░░░░░░        ▓▒▒▒░░░░</span></span></code></pre></div><h2 id="片段着色阶段" tabindex="-1">片段着色阶段 <a class="header-anchor" href="#片段着色阶段" aria-label="Permalink to &quot;片段着色阶段&quot;">​</a></h2><p>片段着色器是第二个可编程阶段，负责计算每个像素的最终颜色。这个阶段可以进行纹理采样、光照计算和材质处理。</p><h3 id="片段着色器示例" tabindex="-1">片段着色器示例 <a class="header-anchor" href="#片段着色器示例" aria-label="Permalink to &quot;片段着色器示例&quot;">​</a></h3><div class="language-wgsl"><button title="Copy Code" class="copy"></button><span class="lang">wgsl</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">struct</span><span style="color:#B392F0;"> FragmentInput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) worldPosition: </span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) worldNormal: </span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) texCoord: </span><span style="color:#F97583;">vec2</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">struct</span><span style="color:#B392F0;"> FragmentOutput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) color: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) normal: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span><span style="color:#6A737D;"> // G-Buffer 输出</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">group</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">@</span><span style="color:#B392F0;">binding</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> diffuseTexture: texture_2d&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">group</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">@</span><span style="color:#B392F0;">binding</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> textureSampler: sampler;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">fragment</span></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#B392F0;"> fs_main</span><span style="color:#E1E4E8;">(input: </span><span style="color:#B392F0;">FragmentInput</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> FragmentOutput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    var</span><span style="color:#E1E4E8;"> output: </span><span style="color:#B392F0;">FragmentOutput</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 纹理采样</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> diffuseColor </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> textureSample</span><span style="color:#E1E4E8;">(diffuseTexture, textureSampler, input</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">texCoord);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 法线归一化</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> normal </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> normalize</span><span style="color:#E1E4E8;">(input</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">worldNormal);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 简单光照计算</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> lightDir </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> normalize</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">vec3</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(</span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">    let</span><span style="color:#E1E4E8;"> intensity </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> max</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">dot</span><span style="color:#E1E4E8;">(normal, lightDir), </span><span style="color:#79B8FF;">0.1</span><span style="color:#E1E4E8;">);</span><span style="color:#6A737D;"> // 10%环境光</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // 最终颜色</span></span>
<span class="line"><span style="color:#E1E4E8;">    output</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">color </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(diffuseColor</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">rgb </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> intensity, diffuseColor</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">a);</span></span>
<span class="line"><span style="color:#E1E4E8;">    output</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">normal </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(normal </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">);</span><span style="color:#6A737D;"> // 编码法线</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> output;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="早期深度测试" tabindex="-1">早期深度测试 <a class="header-anchor" href="#早期深度测试" aria-label="Permalink to &quot;早期深度测试&quot;">​</a></h3><p>WebGPU 支持早期深度测试，在片段着色器执行前进行深度比较，避免不必要的着色计算：</p><div class="language-wgsl"><button title="Copy Code" class="copy"></button><span class="lang">wgsl</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">@</span><span style="color:#B392F0;">fragment</span></span>
<span class="line"><span style="color:#F97583;">fn</span><span style="color:#B392F0;"> fs_main</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">@</span><span style="color:#B392F0;">builtin</span><span style="color:#E1E4E8;">(position) fragPosition: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;) </span><span style="color:#F97583;">-&gt;</span><span style="color:#F97583;"> @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="color:#6A737D;">    // 如果启用早期深度测试，深度值已经确定</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#F97583;"> vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;(</span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="输出合并阶段" tabindex="-1">输出合并阶段 <a class="header-anchor" href="#输出合并阶段" aria-label="Permalink to &quot;输出合并阶段&quot;">​</a></h2><p>输出合并阶段将片段着色器的输出与帧缓冲区中的现有内容结合，执行深度测试、模板测试和混合操作。</p><h3 id="深度和模板测试" tabindex="-1">深度和模板测试 <a class="header-anchor" href="#深度和模板测试" aria-label="Permalink to &quot;深度和模板测试&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">depthStencil</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#B392F0;">    format</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;depth24plus-stencil8&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">    depthWriteEnabled</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">    depthCompare</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;less&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">    stencilFront</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#B392F0;">        compare</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;equal&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">        failOp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;keep&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">        depthFailOp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;keep&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#B392F0;">        passOp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;keep&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#B392F0;">    stencilBack</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#B392F0;">        compare</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;equal&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">        failOp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;keep&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">        depthFailOp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;keep&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#B392F0;">        passOp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;keep&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><p>深度测试示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>新片段深度: 0.3</span></span>
<span class="line"><span>深度缓冲区: 0.5</span></span>
<span class="line"><span>比较函数: &#39;less&#39;</span></span>
<span class="line"><span>结果: 通过测试，更新深度缓冲区</span></span></code></pre></div><h3 id="颜色混合" tabindex="-1">颜色混合 <a class="header-anchor" href="#颜色混合" aria-label="Permalink to &quot;颜色混合&quot;">​</a></h3><p>混合操作控制新颜色如何与目标颜色结合：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">targets</span><span style="color:#E1E4E8;">: [{</span></span>
<span class="line"><span style="color:#E1E4E8;">    format: </span><span style="color:#9ECBFF;">&#39;bgra8unorm&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    blend: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        color: {</span></span>
<span class="line"><span style="color:#E1E4E8;">            srcFactor: </span><span style="color:#9ECBFF;">&#39;src-alpha&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            dstFactor: </span><span style="color:#9ECBFF;">&#39;one-minus-src-alpha&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">            operation: </span><span style="color:#9ECBFF;">&#39;add&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">        alpha: {</span></span>
<span class="line"><span style="color:#E1E4E8;">            srcFactor: </span><span style="color:#9ECBFF;">&#39;one&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            dstFactor: </span><span style="color:#9ECBFF;">&#39;one-minus-src-alpha&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            operation: </span><span style="color:#9ECBFF;">&#39;add&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    writeMask: GPUColorWrite.</span><span style="color:#79B8FF;">ALL</span></span>
<span class="line"><span style="color:#E1E4E8;">}]</span></span></code></pre></div><p>混合公式示意图：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>源颜色:    (1.0, 0.0, 0.0, 0.5)</span></span>
<span class="line"><span>目标颜色:  (0.0, 0.0, 1.0, 1.0)</span></span>
<span class="line"><span>混合结果:  src * src.a + dst * (1 - src.a)</span></span>
<span class="line"><span>         = (0.5, 0.0, 0.5, 1.0)</span></span></code></pre></div><h2 id="渲染通道编码" tabindex="-1">渲染通道编码 <a class="header-anchor" href="#渲染通道编码" aria-label="Permalink to &quot;渲染通道编码&quot;">​</a></h2><p>渲染通道编码器负责记录所有的渲染命令，并将其封装为可执行的命令缓冲区。</p><h3 id="渲染通道设置" tabindex="-1">渲染通道设置 <a class="header-anchor" href="#渲染通道设置" aria-label="Permalink to &quot;渲染通道设置&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> renderPass</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> commandEncoder.</span><span style="color:#B392F0;">beginRenderPass</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    colorAttachments: [</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">            view: colorTextureView,</span></span>
<span class="line"><span style="color:#E1E4E8;">            loadOp: </span><span style="color:#9ECBFF;">&#39;clear&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            storeOp: </span><span style="color:#9ECBFF;">&#39;store&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">            clearValue: { r: </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">, b: </span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;">, a: </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;"> }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    ],</span></span>
<span class="line"><span style="color:#E1E4E8;">    depthStencilAttachment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        view: depthTextureView,</span></span>
<span class="line"><span style="color:#E1E4E8;">        depthLoadOp: </span><span style="color:#9ECBFF;">&#39;clear&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        depthStoreOp: </span><span style="color:#9ECBFF;">&#39;store&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        depthClearValue: </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        stencilLoadOp: </span><span style="color:#9ECBFF;">&#39;clear&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        stencilStoreOp: </span><span style="color:#9ECBFF;">&#39;store&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        stencilClearValue: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="绘制命令" tabindex="-1">绘制命令 <a class="header-anchor" href="#绘制命令" aria-label="Permalink to &quot;绘制命令&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 设置管道</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setPipeline</span><span style="color:#E1E4E8;">(renderPipeline);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 设置顶点缓冲区</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setVertexBuffer</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, vertexBuffer);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 设置绑定组</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setBindGroup</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, bindGroup);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 绘制调用</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">draw</span><span style="color:#E1E4E8;">(vertexCount, instanceCount, firstVertex, firstInstance);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 索引绘制</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setIndexBuffer</span><span style="color:#E1E4E8;">(indexBuffer, </span><span style="color:#9ECBFF;">&#39;uint16&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">drawIndexed</span><span style="color:#E1E4E8;">(indexCount, instanceCount, firstIndex, baseVertex, firstInstance);</span></span></code></pre></div><h2 id="多渲染目标" tabindex="-1">多渲染目标 <a class="header-anchor" href="#多渲染目标" aria-label="Permalink to &quot;多渲染目标&quot;">​</a></h2><p>WebGPU 支持多渲染目标 (MRT)，允许片段着色器同时输出到多个颜色附件：</p><div class="language-wgsl"><button title="Copy Code" class="copy"></button><span class="lang">wgsl</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">struct</span><span style="color:#B392F0;"> FragmentOutput</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) albedo: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span><span style="color:#6A737D;">     // 漫反射颜色</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) normal: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span><span style="color:#6A737D;">     // 世界法线</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) position: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span><span style="color:#6A737D;">   // 世界位置</span></span>
<span class="line"><span style="color:#F97583;">    @</span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) material: </span><span style="color:#F97583;">vec4</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#F97583;">f32</span><span style="color:#E1E4E8;">&gt;,</span><span style="color:#6A737D;">   // 材质参数</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span></code></pre></div><p>渲染目标配置：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">targets</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    { format: </span><span style="color:#9ECBFF;">&#39;rgba8unorm&#39;</span><span style="color:#E1E4E8;"> },    </span><span style="color:#6A737D;">// albedo</span></span>
<span class="line"><span style="color:#E1E4E8;">    { format: </span><span style="color:#9ECBFF;">&#39;rgba16float&#39;</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// normal  </span></span>
<span class="line"><span style="color:#E1E4E8;">    { format: </span><span style="color:#9ECBFF;">&#39;rgba16float&#39;</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// position</span></span>
<span class="line"><span style="color:#E1E4E8;">    { format: </span><span style="color:#9ECBFF;">&#39;rgba8unorm&#39;</span><span style="color:#E1E4E8;"> }     </span><span style="color:#6A737D;">// material</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span></code></pre></div><h2 id="性能优化特性" tabindex="-1">性能优化特性 <a class="header-anchor" href="#性能优化特性" aria-label="Permalink to &quot;性能优化特性&quot;">​</a></h2><h3 id="管线状态对象" tabindex="-1">管线状态对象 <a class="header-anchor" href="#管线状态对象" aria-label="Permalink to &quot;管线状态对象&quot;">​</a></h3><p>WebGPU 的管线状态对象 (PSO) 允许驱动程序预先编译和验证管线状态：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>管线创建时:  着色器编译 + 状态验证 + 资源绑定检查</span></span>
<span class="line"><span>渲染时:      直接使用预编译管线，无运行时开销</span></span></code></pre></div><h3 id="动态状态" tabindex="-1">动态状态 <a class="header-anchor" href="#动态状态" aria-label="Permalink to &quot;动态状态&quot;">​</a></h3><p>某些状态可以在渲染通道中动态设置，减少管线切换：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setBlendConstant</span><span style="color:#E1E4E8;">([</span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;">]);</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setStencilReference</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0xFF</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setViewport</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, canvas.width, canvas.height, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">setScissorRect</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, canvas.width, canvas.height);</span></span></code></pre></div><h3 id="间接绘制" tabindex="-1">间接绘制 <a class="header-anchor" href="#间接绘制" aria-label="Permalink to &quot;间接绘制&quot;">​</a></h3><p>支持间接绘制，减少 CPU-GPU 通信：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> indirectBuffer</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> device.</span><span style="color:#B392F0;">createBuffer</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">    size: </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 4个uint32: vertexCount, instanceCount, firstVertex, firstInstance</span></span>
<span class="line"><span style="color:#E1E4E8;">    usage: GPUBufferUsage.</span><span style="color:#79B8FF;">INDIRECT</span><span style="color:#F97583;"> |</span><span style="color:#E1E4E8;"> GPUBufferUsage.</span><span style="color:#79B8FF;">COPY_DST</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">renderPass.</span><span style="color:#B392F0;">drawIndirect</span><span style="color:#E1E4E8;">(indirectBuffer, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span></code></pre></div>`,86)])])}const d=a(o,[["render",e]]);export{F as __pageData,d as default};
