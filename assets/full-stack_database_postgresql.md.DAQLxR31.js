import{_ as a,c as n,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const F=JSON.parse('{"title":"PostgreSQL","description":"","frontmatter":{},"headers":[{"level":2,"title":"引言","slug":"引言","link":"#引言","children":[]},{"level":2,"title":"安装与基础连接","slug":"安装与基础连接","link":"#安装与基础连接","children":[{"level":3,"title":"安装 pg 模块","slug":"安装-pg-模块","link":"#安装-pg-模块","children":[]},{"level":3,"title":"建立数据库连接","slug":"建立数据库连接","link":"#建立数据库连接","children":[]}]},{"level":2,"title":"连接池的深入解析","slug":"连接池的深入解析","link":"#连接池的深入解析","children":[{"level":3,"title":"连接池的核心价值","slug":"连接池的核心价值","link":"#连接池的核心价值","children":[]},{"level":3,"title":"连接池配置参数详解","slug":"连接池配置参数详解","link":"#连接池配置参数详解","children":[]}]},{"level":2,"title":"执行 SQL 查询","slug":"执行-sql-查询","link":"#执行-sql-查询","children":[{"level":3,"title":"基础查询操作","slug":"基础查询操作","link":"#基础查询操作","children":[]},{"level":3,"title":"参数化查询","slug":"参数化查询","link":"#参数化查询","children":[]}]},{"level":2,"title":"CRUD 操作实践","slug":"crud-操作实践","link":"#crud-操作实践","children":[{"level":3,"title":"数据查询","slug":"数据查询","link":"#数据查询","children":[]},{"level":3,"title":"数据插入","slug":"数据插入","link":"#数据插入","children":[]},{"level":3,"title":"数据更新与删除","slug":"数据更新与删除","link":"#数据更新与删除","children":[]}]},{"level":2,"title":"事务管理","slug":"事务管理","link":"#事务管理","children":[{"level":3,"title":"手动事务控制","slug":"手动事务控制","link":"#手动事务控制","children":[]},{"level":3,"title":"使用事务管道","slug":"使用事务管道","link":"#使用事务管道","children":[]}]},{"level":2,"title":"高级特性","slug":"高级特性","link":"#高级特性","children":[{"level":3,"title":"流式处理","slug":"流式处理","link":"#流式处理","children":[]},{"level":3,"title":"连接池事件监听","slug":"连接池事件监听","link":"#连接池事件监听","children":[]}]},{"level":2,"title":"性能优化与最佳实践","slug":"性能优化与最佳实践","link":"#性能优化与最佳实践","children":[{"level":3,"title":"连接池优化策略","slug":"连接池优化策略","link":"#连接池优化策略","children":[]},{"level":3,"title":"错误处理机制","slug":"错误处理机制","link":"#错误处理机制","children":[]},{"level":3,"title":"安全注意事项","slug":"安全注意事项","link":"#安全注意事项","children":[]}]},{"level":2,"title":"故障排除","slug":"故障排除","link":"#故障排除","children":[{"level":3,"title":"常见问题与解决方案","slug":"常见问题与解决方案","link":"#常见问题与解决方案","children":[]},{"level":3,"title":"网络中断处理","slug":"网络中断处理","link":"#网络中断处理","children":[]}]}],"relativePath":"full-stack/database/postgresql.md","filePath":"full-stack/database/postgresql.md"}'),o={name:"full-stack/database/postgresql.md"};function e(t,s,c,r,E,y){return l(),n("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /full-stack/database/postgresql.md for this page in Markdown format</div><h1 id="postgresql" tabindex="-1">PostgreSQL <a class="header-anchor" href="#postgresql" aria-label="Permalink to &quot;PostgreSQL&quot;">​</a></h1><h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>PostgreSQL 是一款功能强大的开源关系型数据库，以其稳定性、扩展性和对 SQL 标准的严格遵循而闻名。Node.js 凭借其事件驱动和非阻塞 I/O 模型，成为构建高性能网络应用的理想选择。两者结合能够为开发者提供强大的工具集，用于构建各种数据驱动的应用程序。在 Node.js 生态中，<code>pg</code> 库是连接和操作 PostgreSQL 数据库的主流选择。</p><h2 id="安装与基础连接" tabindex="-1">安装与基础连接 <a class="header-anchor" href="#安装与基础连接" aria-label="Permalink to &quot;安装与基础连接&quot;">​</a></h2><h3 id="安装-pg-模块" tabindex="-1">安装 pg 模块 <a class="header-anchor" href="#安装-pg-模块" aria-label="Permalink to &quot;安装 pg 模块&quot;">​</a></h3><p>使用 npm 命令安装 <code>pg</code> 模块：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">npm</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> pg</span></span></code></pre></div><h3 id="建立数据库连接" tabindex="-1">建立数据库连接 <a class="header-anchor" href="#建立数据库连接" aria-label="Permalink to &quot;建立数据库连接&quot;">​</a></h3><p><code>pg</code> 提供了两种连接数据库的方式：直接客户端连接和连接池。</p><p><strong>单客户端连接示例：</strong></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">Client</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;pg&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> client</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Client</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  user: </span><span style="color:#9ECBFF;">&#39;your_user&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  host: </span><span style="color:#9ECBFF;">&#39;localhost&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  database: </span><span style="color:#9ECBFF;">&#39;your_database&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  password: </span><span style="color:#9ECBFF;">&#39;your_password&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  port: </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">client</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">connect</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;成功连接到数据库&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">  .</span><span style="color:#B392F0;">catch</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;连接失败&#39;</span><span style="color:#E1E4E8;">, err))</span></span></code></pre></div><p><strong>连接池配置示例：</strong></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">Pool</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;pg&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> pool</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Pool</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  user: </span><span style="color:#9ECBFF;">&#39;your_user&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  host: </span><span style="color:#9ECBFF;">&#39;localhost&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  database: </span><span style="color:#9ECBFF;">&#39;your_database&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  password: </span><span style="color:#9ECBFF;">&#39;your_password&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  port: </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  max: </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 连接池最大连接数</span></span>
<span class="line"><span style="color:#E1E4E8;">  idleTimeoutMillis: </span><span style="color:#79B8FF;">30000</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 连接空闲超时时间(30秒)</span></span>
<span class="line"><span style="color:#E1E4E8;">  connectionTimeoutMillis: </span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 连接超时时间(2秒)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><p>连接池通过复用数据库连接显著提升性能，特别是在高并发环境下。它预先建立一定数量的数据库连接，当应用需要时快速分配，使用完毕后回收而非销毁，减少了频繁建立连接的开销。</p><h2 id="连接池的深入解析" tabindex="-1">连接池的深入解析 <a class="header-anchor" href="#连接池的深入解析" aria-label="Permalink to &quot;连接池的深入解析&quot;">​</a></h2><h3 id="连接池的核心价值" tabindex="-1">连接池的核心价值 <a class="header-anchor" href="#连接池的核心价值" aria-label="Permalink to &quot;连接池的核心价值&quot;">​</a></h3><p>数据库连接是昂贵的资源，每次建立新连接都需要经历 TCP 三次握手、SSL/TLS 协商、PostgreSQL 认证等过程。连接池通过以下机制解决性能问题：</p><ul><li><strong>连接复用</strong>：避免频繁创建和销毁连接，提升响应速度</li><li><strong>资源控制</strong>：防止连接数过度增长导致数据库资源耗尽</li><li><strong>健康检查</strong>：自动检测并移除不健康的连接</li></ul><h3 id="连接池配置参数详解" tabindex="-1">连接池配置参数详解 <a class="header-anchor" href="#连接池配置参数详解" aria-label="Permalink to &quot;连接池配置参数详解&quot;">​</a></h3><table tabindex="0"><thead><tr><th>参数名</th><th>默认值</th><th>说明</th><th>推荐值</th></tr></thead><tbody><tr><td>max</td><td>10</td><td>连接池最大连接数</td><td>根据并发需求调整</td></tr><tr><td>min</td><td>0</td><td>连接池最小保持连接数</td><td>生产环境设置 1-2</td></tr><tr><td>idleTimeoutMillis</td><td>10000</td><td>空闲连接超时时间(毫秒)</td><td>30000-60000</td></tr><tr><td>connectionTimeoutMillis</td><td>0</td><td>连接建立超时时间(毫秒)</td><td>2000-5000</td></tr><tr><td>maxUses</td><td>Infinity</td><td>单个连接最大使用次数</td><td>1000-10000</td></tr><tr><td>maxLifetimeSeconds</td><td>0</td><td>连接最大生命周期(秒)</td><td>1800-3600</td></tr></tbody></table><p><strong>配置示例：</strong></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> pool</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Pool</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  max: </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  min: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  idleTimeoutMillis: </span><span style="color:#79B8FF;">30000</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  connectionTimeoutMillis: </span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  maxUses: </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 预防连接老化</span></span>
<span class="line"><span style="color:#E1E4E8;">  maxLifetimeSeconds: </span><span style="color:#79B8FF;">1800</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 30分钟连接生命周期</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><h2 id="执行-sql-查询" tabindex="-1">执行 SQL 查询 <a class="header-anchor" href="#执行-sql-查询" aria-label="Permalink to &quot;执行 SQL 查询&quot;">​</a></h2><h3 id="基础查询操作" tabindex="-1">基础查询操作 <a class="header-anchor" href="#基础查询操作" aria-label="Permalink to &quot;基础查询操作&quot;">​</a></h3><p><code>pg</code> 模块使用 <code>query</code> 方法执行 SQL 语句，支持回调和 Promise 两种风格。</p><p><strong>查询示例：</strong></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 使用 Promise</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> getUsers</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> res</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SELECT * FROM users WHERE status = $1&#39;</span><span style="color:#E1E4E8;">, [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;active&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    ])</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> res.rows</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;查询失败&#39;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#F97583;">    throw</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 使用回调</span></span>
<span class="line"><span style="color:#E1E4E8;">pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SELECT * FROM users&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (err) </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(res.rows)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><h3 id="参数化查询" tabindex="-1">参数化查询 <a class="header-anchor" href="#参数化查询" aria-label="Permalink to &quot;参数化查询&quot;">​</a></h3><p>参数化查询不仅能防止 SQL 注入攻击，还能提升查询性能：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> insertUser</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">username</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">email</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> query</span><span style="color:#F97583;"> =</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;INSERT INTO users (username, email) VALUES ($1, $2) RETURNING *&#39;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> values</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [username, email]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> res</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(query, values)</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> res.rows[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="crud-操作实践" tabindex="-1">CRUD 操作实践 <a class="header-anchor" href="#crud-操作实践" aria-label="Permalink to &quot;CRUD 操作实践&quot;">​</a></h2><h3 id="数据查询" tabindex="-1">数据查询 <a class="header-anchor" href="#数据查询" aria-label="Permalink to &quot;数据查询&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 条件查询</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> getUserById</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> res</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SELECT * FROM users WHERE id = $1&#39;</span><span style="color:#E1E4E8;">, [id])</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> res.rows[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 分页查询</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> getUsersPaginated</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">limit</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">offset</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> res</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;SELECT * FROM users ORDER BY id LIMIT $1 OFFSET $2&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    [limit, offset]</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> res.rows</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="数据插入" tabindex="-1">数据插入 <a class="header-anchor" href="#数据插入" aria-label="Permalink to &quot;数据插入&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> createProduct</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">price</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">category</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> query</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`</span></span>
<span class="line"><span style="color:#9ECBFF;">    INSERT INTO products (name, price, category) </span></span>
<span class="line"><span style="color:#9ECBFF;">    VALUES ($1, $2, $3) </span></span>
<span class="line"><span style="color:#9ECBFF;">    RETURNING *</span></span>
<span class="line"><span style="color:#9ECBFF;">  \`</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> values</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [name, price, category]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> res</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(query, values)</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> res.rows[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="数据更新与删除" tabindex="-1">数据更新与删除 <a class="header-anchor" href="#数据更新与删除" aria-label="Permalink to &quot;数据更新与删除&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 更新数据</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> updateUserEmail</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">newEmail</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> query</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;UPDATE users SET email = $1 WHERE id = $2 RETURNING *&#39;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> res</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(query, [newEmail, id])</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> res.rows[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 删除数据</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> deleteUser</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;DELETE FROM users WHERE id = $1&#39;</span><span style="color:#E1E4E8;">, [id])</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="事务管理" tabindex="-1">事务管理 <a class="header-anchor" href="#事务管理" aria-label="Permalink to &quot;事务管理&quot;">​</a></h2><h3 id="手动事务控制" tabindex="-1">手动事务控制 <a class="header-anchor" href="#手动事务控制" aria-label="Permalink to &quot;手动事务控制&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> transferMoney</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">fromId</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">toId</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">amount</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> client</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">connect</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#E1E4E8;"> client.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;BEGIN&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // 扣除发送方余额</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#E1E4E8;"> client.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;UPDATE accounts SET balance = balance - $1 WHERE id = $2&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [amount, fromId]</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // 增加接收方余额</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#E1E4E8;"> client.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;UPDATE accounts SET balance = balance + $1 WHERE id = $2&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [amount, toId]</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#E1E4E8;"> client.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;COMMIT&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> { success: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> }</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#E1E4E8;"> client.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ROLLBACK&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;转账失败&#39;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#F97583;">    throw</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    client.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="使用事务管道" tabindex="-1">使用事务管道 <a class="header-anchor" href="#使用事务管道" aria-label="Permalink to &quot;使用事务管道&quot;">​</a></h3><p>对于复杂的多语句事务，可以使用更简洁的事务管道写法：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> sql.</span><span style="color:#B392F0;">begin</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">sql</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> results</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> []</span></span>
<span class="line"><span style="color:#E1E4E8;">  results.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> sql</span><span style="color:#9ECBFF;">\`INSERT INTO table1 ...\`</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  results.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">await</span><span style="color:#B392F0;"> sql</span><span style="color:#9ECBFF;">\`INSERT INTO table2 ...\`</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> results</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><p><strong>重要注意事项：</strong></p><ul><li>在事务回调函数中必须使用事务上下文对象 (t) 执行 SQL，而非全局 db 对象</li><li>始终处理可能出现的异常情况，确保事务正确提交或回滚</li></ul><h2 id="高级特性" tabindex="-1">高级特性 <a class="header-anchor" href="#高级特性" aria-label="Permalink to &quot;高级特性&quot;">​</a></h2><h3 id="流式处理" tabindex="-1">流式处理 <a class="header-anchor" href="#流式处理" aria-label="Permalink to &quot;流式处理&quot;">​</a></h3><p>对于大型数据集，可以使用流式处理来避免内存溢出：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">Query</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;pg&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> processLargeDataset</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> client</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">connect</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> query</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SELECT * FROM large_table&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  query.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;row&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">row</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    // 处理每一行数据</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Row:&#39;</span><span style="color:#E1E4E8;">, row)</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  query.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;end&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;查询处理完毕&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    client.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  query.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;查询出错:&#39;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">    client.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  client.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(query)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="连接池事件监听" tabindex="-1">连接池事件监听 <a class="header-anchor" href="#连接池事件监听" aria-label="Permalink to &quot;连接池事件监听&quot;">​</a></h3><p>通过事件监听可以实时监控连接池状态：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">pool.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;connect&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">client</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;新客户端连接&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">pool.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;acquire&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">client</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;客户端从池中获取&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">pool.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;remove&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">client</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;客户端从池中移除&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">pool.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">client</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;空闲客户端错误&#39;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre></div><h2 id="性能优化与最佳实践" tabindex="-1">性能优化与最佳实践 <a class="header-anchor" href="#性能优化与最佳实践" aria-label="Permalink to &quot;性能优化与最佳实践&quot;">​</a></h2><h3 id="连接池优化策略" tabindex="-1">连接池优化策略 <a class="header-anchor" href="#连接池优化策略" aria-label="Permalink to &quot;连接池优化策略&quot;">​</a></h3><p>根据应用负载动态调整连接池参数：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> poolConfig</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  max: process.env.</span><span style="color:#79B8FF;">NODE_ENV</span><span style="color:#F97583;"> ===</span><span style="color:#9ECBFF;"> &#39;production&#39;</span><span style="color:#F97583;"> ?</span><span style="color:#79B8FF;"> 50</span><span style="color:#F97583;"> :</span><span style="color:#79B8FF;"> 10</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  min: process.env.</span><span style="color:#79B8FF;">NODE_ENV</span><span style="color:#F97583;"> ===</span><span style="color:#9ECBFF;"> &#39;production&#39;</span><span style="color:#F97583;"> ?</span><span style="color:#79B8FF;"> 5</span><span style="color:#F97583;"> :</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  idleTimeoutMillis: process.env.</span><span style="color:#79B8FF;">NODE_ENV</span><span style="color:#F97583;"> ===</span><span style="color:#9ECBFF;"> &#39;production&#39;</span><span style="color:#F97583;"> ?</span><span style="color:#79B8FF;"> 60000</span><span style="color:#F97583;"> :</span><span style="color:#79B8FF;"> 10000</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  connectionTimeoutMillis: </span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  maxUses: </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 预防连接泄漏</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="错误处理机制" tabindex="-1">错误处理机制 <a class="header-anchor" href="#错误处理机制" aria-label="Permalink to &quot;错误处理机制&quot;">​</a></h3><p>实现完善的错误处理和重试逻辑：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> queryWithRetry</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">queryText</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">params</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">retries</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 3</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">let</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> retries; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> pool.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(queryText, params)</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> result</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (i </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> retries </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      // 判断错误是否可重试</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">isRetryableError</span><span style="color:#E1E4E8;">(err)) {</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#B392F0;"> sleep</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#F97583;"> *</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">pow</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, i)) </span><span style="color:#6A737D;">// 指数退避</span></span>
<span class="line"><span style="color:#F97583;">        continue</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="安全注意事项" tabindex="-1">安全注意事项 <a class="header-anchor" href="#安全注意事项" aria-label="Permalink to &quot;安全注意事项&quot;">​</a></h3><ul><li><strong>使用参数化查询</strong>：始终使用参数化查询来防止 SQL 注入攻击</li><li><strong>凭据管理</strong>：不要将数据库凭据硬编码在代码中，使用环境变量或配置管理系统</li><li><strong>连接加密</strong>：生产环境中使用 SSL/TLS 加密数据库连接</li></ul><h2 id="故障排除" tabindex="-1">故障排除 <a class="header-anchor" href="#故障排除" aria-label="Permalink to &quot;故障排除&quot;">​</a></h2><h3 id="常见问题与解决方案" tabindex="-1">常见问题与解决方案 <a class="header-anchor" href="#常见问题与解决方案" aria-label="Permalink to &quot;常见问题与解决方案&quot;">​</a></h3><p><strong>连接泄漏</strong>：确保在使用后始终释放连接回连接池 <strong>连接超时</strong>：适当调整 <code>idleTimeoutMillis</code> 和 <code>connectionTimeoutMillis</code> 参数 <strong>连接池耗尽</strong>：检查是否有未释放的连接，或考虑增加 <code>max</code> 参数值</p><h3 id="网络中断处理" tabindex="-1">网络中断处理 <a class="header-anchor" href="#网络中断处理" aria-label="Permalink to &quot;网络中断处理&quot;">​</a></h3><p>在网络不稳定的环境中，需要特别处理连接池的网络中断问题：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> options</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">  error</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;client&#39;</span><span style="color:#F97583;"> in</span><span style="color:#E1E4E8;"> ctx </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> e.message </span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;"> &#39;Query read timeout&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      ctx.client.</span><span style="color:#B392F0;">end</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">// 强制终止失效连接</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div>`,68)])])}const d=a(o,[["render",e]]);export{F as __pageData,d as default};
