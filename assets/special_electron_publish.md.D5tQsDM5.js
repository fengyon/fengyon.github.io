import{_ as n,c as a,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const i=JSON.parse('{"title":"Electron å‘å¸ƒä¸æ›´æ–°","description":"","frontmatter":{},"headers":[{"level":2,"title":"å‘å¸ƒä¸æ›´æ–°æ¦‚è¿°","slug":"å‘å¸ƒä¸æ›´æ–°æ¦‚è¿°","link":"#å‘å¸ƒä¸æ›´æ–°æ¦‚è¿°","children":[]},{"level":2,"title":"åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘","slug":"åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘","link":"#åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘","children":[{"level":3,"title":"æ‰“åŒ…å·¥å…·é€‰æ‹©","slug":"æ‰“åŒ…å·¥å…·é€‰æ‹©","link":"#æ‰“åŒ…å·¥å…·é€‰æ‹©","children":[]},{"level":3,"title":"electron-builder é…ç½®","slug":"electron-builder-é…ç½®","link":"#electron-builder-é…ç½®","children":[]},{"level":3,"title":"è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬","slug":"è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬","link":"#è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬","children":[]}]},{"level":2,"title":"è‡ªåŠ¨æ›´æ–°æœºåˆ¶","slug":"è‡ªåŠ¨æ›´æ–°æœºåˆ¶","link":"#è‡ªåŠ¨æ›´æ–°æœºåˆ¶","children":[{"level":3,"title":"è‡ªåŠ¨æ›´æ–°æ¶æ„","slug":"è‡ªåŠ¨æ›´æ–°æ¶æ„","link":"#è‡ªåŠ¨æ›´æ–°æ¶æ„","children":[]},{"level":3,"title":"åŸºæœ¬æ›´æ–°é…ç½®","slug":"åŸºæœ¬æ›´æ–°é…ç½®","link":"#åŸºæœ¬æ›´æ–°é…ç½®","children":[]},{"level":3,"title":"æ¸²æŸ“è¿›ç¨‹é›†æˆ","slug":"æ¸²æŸ“è¿›ç¨‹é›†æˆ","link":"#æ¸²æŸ“è¿›ç¨‹é›†æˆ","children":[]}]},{"level":2,"title":"ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥","slug":"ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥","link":"#ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥","children":[{"level":3,"title":"ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥","slug":"ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥","link":"#ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥","children":[]},{"level":3,"title":"å‘å¸ƒæ¸ é“ç®¡ç†","slug":"å‘å¸ƒæ¸ é“ç®¡ç†","link":"#å‘å¸ƒæ¸ é“ç®¡ç†","children":[]}]},{"level":2,"title":"ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡","slug":"ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡","link":"#ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡","children":[{"level":3,"title":"é›†æˆ electron-update-sdk","slug":"é›†æˆ-electron-update-sdk","link":"#é›†æˆ-electron-update-sdk","children":[]}]},{"level":2,"title":"å®‰å…¨ä¸éªŒè¯","slug":"å®‰å…¨ä¸éªŒè¯","link":"#å®‰å…¨ä¸éªŒè¯","children":[{"level":3,"title":"ä»£ç ç­¾åä¸éªŒè¯","slug":"ä»£ç ç­¾åä¸éªŒè¯","link":"#ä»£ç ç­¾åä¸éªŒè¯","children":[]},{"level":3,"title":"å®‰å…¨æ›´æ–°ç­–ç•¥","slug":"å®‰å…¨æ›´æ–°ç­–ç•¥","link":"#å®‰å…¨æ›´æ–°ç­–ç•¥","children":[]}]}],"relativePath":"special/electron/publish.md","filePath":"special/electron/publish.md"}'),o={name:"special/electron/publish.md"};function e(E,s,t,c,r,y){return l(),a("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /special/electron/publish.md for this page in Markdown format</div><h1 id="electron-å‘å¸ƒä¸æ›´æ–°" tabindex="-1">Electron å‘å¸ƒä¸æ›´æ–° <a class="header-anchor" href="#electron-å‘å¸ƒä¸æ›´æ–°" aria-label="Permalink to &quot;Electron å‘å¸ƒä¸æ›´æ–°&quot;">â€‹</a></h1><h2 id="å‘å¸ƒä¸æ›´æ–°æ¦‚è¿°" tabindex="-1">å‘å¸ƒä¸æ›´æ–°æ¦‚è¿° <a class="header-anchor" href="#å‘å¸ƒä¸æ›´æ–°æ¦‚è¿°" aria-label="Permalink to &quot;å‘å¸ƒä¸æ›´æ–°æ¦‚è¿°&quot;">â€‹</a></h2><p>Electron åº”ç”¨çš„å‘å¸ƒä¸æ›´æ–°æ˜¯åº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„å…³é”®ç¯èŠ‚ï¼Œå®ƒæ¶µç›–äº†ä»<strong>åº”ç”¨æ‰“åŒ…</strong>ã€<strong>ä»£ç ç­¾å</strong>åˆ°<strong>åˆ†å‘ç»™ç”¨æˆ·</strong>å¹¶<strong>æŒç»­æä¾›æ›´æ–°</strong>çš„å®Œæ•´æµç¨‹ã€‚ä¸ä¼ ç»Ÿçš„ Web åº”ç”¨ä¸åŒï¼ŒElectron åº”ç”¨éœ€è¦å¤„ç†è·¨å¹³å°åˆ†å‘ã€è‡ªåŠ¨æ›´æ–°æœºåˆ¶å’Œç‰ˆæœ¬ç®¡ç†ç­‰ä¸€ç³»åˆ—å¤æ‚é—®é¢˜ã€‚</p><p>å®Œæ•´çš„å‘å¸ƒä¸æ›´æ–°æµç¨‹æ„æˆäº†ä¸€ä¸ªå¾ªç¯çš„å‘¨æœŸï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>å¼€å‘ â†’ æ‰“åŒ… â†’ ç­¾å â†’ å‘å¸ƒ â†’ æ›´æ–°æ£€æŸ¥ â†’ ä¸‹è½½ â†’ å®‰è£… â†’ é‡å¯</span></span>
<span class="line"><span>         â†‘                                      â†“</span></span>
<span class="line"><span>         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre></div><h2 id="åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘" tabindex="-1">åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘ <a class="header-anchor" href="#åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘" aria-label="Permalink to &quot;åº”ç”¨æ‰“åŒ…ä¸åˆ†å‘&quot;">â€‹</a></h2><h3 id="æ‰“åŒ…å·¥å…·é€‰æ‹©" tabindex="-1">æ‰“åŒ…å·¥å…·é€‰æ‹© <a class="header-anchor" href="#æ‰“åŒ…å·¥å…·é€‰æ‹©" aria-label="Permalink to &quot;æ‰“åŒ…å·¥å…·é€‰æ‹©&quot;">â€‹</a></h3><p>Electron åº”ç”¨æ‰“åŒ…çš„ä¸»è¦å·¥å…·åŒ…æ‹¬ <strong>electron-builder</strong> å’Œ <strong>Electron Forge</strong>ã€‚electron-builder å› å…¶ä¸°å¯Œçš„åŠŸèƒ½å’Œé…ç½®çµæ´»æ€§æˆä¸ºæœ€æµè¡Œçš„é€‰æ‹©ã€‚</p><p><strong>æ‰“åŒ…å·¥å…·å¯¹æ¯”ç¤ºæ„å›¾ï¼š</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>æºä»£ç  + èµ„æºæ–‡ä»¶</span></span>
<span class="line"><span>    â”œâ”€â”€ electron-builder (åŠŸèƒ½å…¨é¢ï¼Œé…ç½®çµæ´»)</span></span>
<span class="line"><span>    â”œâ”€â”€ Electron Forge (ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆ)  </span></span>
<span class="line"><span>    â””â”€â”€ æ‰‹åŠ¨æ‰“åŒ… (å®Œå…¨æ§åˆ¶ï¼Œå¤æ‚åº¦é«˜)</span></span></code></pre></div><h3 id="electron-builder-é…ç½®" tabindex="-1">electron-builder é…ç½® <a class="header-anchor" href="#electron-builder-é…ç½®" aria-label="Permalink to &quot;electron-builder é…ç½®&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// electron-builder.config.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { defineConfig } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron-builder&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#B392F0;"> defineConfig</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  appId: </span><span style="color:#9ECBFF;">&#39;com.yourcompany.yourapp&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  productName: </span><span style="color:#9ECBFF;">&#39;Your Awesome App&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  copyright: </span><span style="color:#9ECBFF;">\`Copyright Â© \${</span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Date</span><span style="color:#9ECBFF;">().</span><span style="color:#B392F0;">getFullYear</span><span style="color:#9ECBFF;">()</span><span style="color:#9ECBFF;">} Your Company\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  directories: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    output: </span><span style="color:#9ECBFF;">&#39;dist&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    buildResources: </span><span style="color:#9ECBFF;">&#39;build&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  files: [</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;package.json&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;build/**/*&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;dist/**/*&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;node_modules/**/*&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;!node_modules/.cache&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ],</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // å‹ç¼©é…ç½®</span></span>
<span class="line"><span style="color:#E1E4E8;">  compression: </span><span style="color:#9ECBFF;">&#39;maximum&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  asar: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // è‡ªåŠ¨æ›´æ–°é…ç½®</span></span>
<span class="line"><span style="color:#E1E4E8;">  publish: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    provider: </span><span style="color:#9ECBFF;">&#39;github&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    owner: </span><span style="color:#9ECBFF;">&#39;your-username&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    repo: </span><span style="color:#9ECBFF;">&#39;your-repo-name&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    releaseType: </span><span style="color:#9ECBFF;">&#39;release&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // å¹³å°ç‰¹å®šé…ç½®</span></span>
<span class="line"><span style="color:#E1E4E8;">  mac: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    category: </span><span style="color:#9ECBFF;">&#39;public.app-category.productivity&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    target: [</span><span style="color:#9ECBFF;">&#39;dmg&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;zip&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">    icon: </span><span style="color:#9ECBFF;">&#39;build/icons/icon.icns&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    darkModeSupport: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    hardenedRuntime: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  win: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    target: [</span><span style="color:#9ECBFF;">&#39;nsis&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;portable&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">    icon: </span><span style="color:#9ECBFF;">&#39;build/icons/icon.ico&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    publisherName: </span><span style="color:#9ECBFF;">&#39;Your Company&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  nsis: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    oneClick: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    allowToChangeInstallationDirectory: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    createDesktopShortcut: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    createStartMenuShortcut: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  linux: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    target: [</span><span style="color:#9ECBFF;">&#39;AppImage&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;deb&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">    category: </span><span style="color:#9ECBFF;">&#39;Office&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    icon: </span><span style="color:#9ECBFF;">&#39;build/icons&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬" tabindex="-1">è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬ <a class="header-anchor" href="#è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬" aria-label="Permalink to &quot;è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// scripts/build.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { build } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron-builder&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFile, writeFile } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;fs/promises&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { createHash } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;crypto&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> BuildManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.platforms </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#E1E4E8;">      { platform: </span><span style="color:#9ECBFF;">&#39;win32&#39;</span><span style="color:#E1E4E8;">, arch: [</span><span style="color:#9ECBFF;">&#39;x64&#39;</span><span style="color:#E1E4E8;">] },</span></span>
<span class="line"><span style="color:#E1E4E8;">      { platform: </span><span style="color:#9ECBFF;">&#39;darwin&#39;</span><span style="color:#E1E4E8;">, arch: [</span><span style="color:#9ECBFF;">&#39;x64&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;arm64&#39;</span><span style="color:#E1E4E8;">] },</span></span>
<span class="line"><span style="color:#E1E4E8;">      { platform: </span><span style="color:#9ECBFF;">&#39;linux&#39;</span><span style="color:#E1E4E8;">, arch: [</span><span style="color:#9ECBFF;">&#39;x64&#39;</span><span style="color:#E1E4E8;">] }</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> updateVersion</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // è¯»å– package.json</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> packageJson</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#B392F0;"> readFile</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./package.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è‡ªåŠ¨å¢åŠ æ„å»ºç‰ˆæœ¬å·</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (process.env.</span><span style="color:#79B8FF;">NODE_ENV</span><span style="color:#F97583;"> ===</span><span style="color:#9ECBFF;"> &#39;production&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> version</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> packageJson.version.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      version[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> String</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Number</span><span style="color:#E1E4E8;">(version[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      packageJson.version </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> version.</span><span style="color:#B392F0;">join</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#B392F0;"> writeFile</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">        &#39;./package.json&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">        JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(packageJson, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> packageJson.version;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> generateChecksums</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // ä¸ºæ„å»ºæ–‡ä»¶ç”Ÿæˆæ ¡éªŒå’Œ</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> files</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> glob</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;dist/**/*.{exe,dmg,AppImage,deb}&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> checksums</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> file</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> files) {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> content</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> readFile</span><span style="color:#E1E4E8;">(file);</span></span>
<span class="line"><span style="color:#E1E4E8;">      checksums[path.</span><span style="color:#B392F0;">basename</span><span style="color:#E1E4E8;">(file)] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">        createHash</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sha256&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(content).</span><span style="color:#B392F0;">digest</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#B392F0;"> writeFile</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;dist/checksums.json&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">      JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(checksums, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> buildAllPlatforms</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> version</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">updateVersion</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸš€ å¼€å§‹æ„å»ºç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}...\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">platform</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">arch</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">of</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.platforms) {</span></span>
<span class="line"><span style="color:#F97583;">      for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> a</span><span style="color:#F97583;"> of</span><span style="color:#E1E4E8;"> arch) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ”¨ æ„å»º \${</span><span style="color:#E1E4E8;">platform</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#E1E4E8;">a</span><span style="color:#9ECBFF;">}...\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#B392F0;"> build</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">          targets: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getPlatformTarget</span><span style="color:#E1E4E8;">(platform),</span></span>
<span class="line"><span style="color:#E1E4E8;">          [platform]: {},</span></span>
<span class="line"><span style="color:#E1E4E8;">          config: {</span></span>
<span class="line"><span style="color:#F97583;">            ...</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.config,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [platform]: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.config[platform] </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">          }</span></span>
<span class="line"><span style="color:#E1E4E8;">        });</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">generateChecksums</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆï¼&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getPlatformTarget</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">platform</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> targetMap</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      win32: </span><span style="color:#9ECBFF;">&#39;nsis&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      darwin: </span><span style="color:#9ECBFF;">&#39;dmg&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      linux: </span><span style="color:#9ECBFF;">&#39;AppImage&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> targetMap[platform] </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> &#39;dir&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> buildManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> BuildManager</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#E1E4E8;"> buildManager;</span></span></code></pre></div><h2 id="è‡ªåŠ¨æ›´æ–°æœºåˆ¶" tabindex="-1">è‡ªåŠ¨æ›´æ–°æœºåˆ¶ <a class="header-anchor" href="#è‡ªåŠ¨æ›´æ–°æœºåˆ¶" aria-label="Permalink to &quot;è‡ªåŠ¨æ›´æ–°æœºåˆ¶&quot;">â€‹</a></h2><h3 id="è‡ªåŠ¨æ›´æ–°æ¶æ„" tabindex="-1">è‡ªåŠ¨æ›´æ–°æ¶æ„ <a class="header-anchor" href="#è‡ªåŠ¨æ›´æ–°æ¶æ„" aria-label="Permalink to &quot;è‡ªåŠ¨æ›´æ–°æ¶æ„&quot;">â€‹</a></h3><p>Electron åº”ç”¨çš„è‡ªåŠ¨æ›´æ–°ä¸»è¦ä¾èµ– <strong>electron-updater</strong> æ¨¡å—ï¼Œå®ƒæä¾›äº†å®Œæ•´çš„æ›´æ–°æ£€æŸ¥ã€ä¸‹è½½å’Œå®‰è£…åŠŸèƒ½ã€‚</p><p><strong>æ›´æ–°æµç¨‹ç¤ºæ„å›¾ï¼š</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>å®¢æˆ·ç«¯åº”ç”¨</span></span>
<span class="line"><span>    â†“ æ£€æŸ¥æ›´æ–°</span></span>
<span class="line"><span>æ›´æ–°æœåŠ¡å™¨ (GitHub/GitLab/è‡ªå®šä¹‰)</span></span>
<span class="line"><span>    â†“ è¿”å›æ›´æ–°ä¿¡æ¯</span></span>
<span class="line"><span>å®¢æˆ·ç«¯ä¸‹è½½æ›´æ–°åŒ…</span></span>
<span class="line"><span>    â†“ éªŒè¯ç­¾å</span></span>
<span class="line"><span>å®‰è£…æ›´æ–°å¹¶é‡å¯</span></span></code></pre></div><h3 id="åŸºæœ¬æ›´æ–°é…ç½®" tabindex="-1">åŸºæœ¬æ›´æ–°é…ç½® <a class="header-anchor" href="#åŸºæœ¬æ›´æ–°é…ç½®" aria-label="Permalink to &quot;åŸºæœ¬æ›´æ–°é…ç½®&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// update/update-manager.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { autoUpdater } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron-updater&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { dialog, app, BrowserWindow } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { writeFile } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;fs/promises&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> UpdateManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">mainWindow</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.mainWindow </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mainWindow;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.autoDownload </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupAutoUpdater</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  setupAutoUpdater</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // é…ç½®è‡ªåŠ¨æ›´æ–°</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.autoDownload </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.autoDownload;</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.autoInstallOnAppQuit </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.allowDowngrade </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.fullChangelog </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // è®¾ç½®äº‹ä»¶ç›‘å¬</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupEventListeners</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è®°å½•æ›´æ–°çŠ¶æ€</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ›´æ–°ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  setupEventListeners</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥æ›´æ–°ä¸­</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;checking-for-update&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ­£åœ¨æ£€æŸ¥æ›´æ–°...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;checking-for-update&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æœ‰å¯ç”¨æ›´æ–°</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-available&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å‘ç°æ–°ç‰ˆæœ¬: \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-available&#39;</span><span style="color:#E1E4E8;">, info);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">handleUpdateAvailable</span><span style="color:#E1E4E8;">(info);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ²¡æœ‰å¯ç”¨æ›´æ–°</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-not-available&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-not-available&#39;</span><span style="color:#E1E4E8;">, info);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // ä¸‹è½½è¿›åº¦</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;download-progress&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">progress</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;download-progress&#39;</span><span style="color:#E1E4E8;">, progress);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">        \`ä¸‹è½½è¿›åº¦: \${</span><span style="color:#E1E4E8;">Math</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">floor</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">progress</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">percent</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}% \`</span><span style="color:#F97583;"> +</span></span>
<span class="line"><span style="color:#9ECBFF;">        \`(\${</span><span style="color:#E1E4E8;">progress</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">bytesPerSecond</span><span style="color:#9ECBFF;">} B/s)\`</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–°ä¸‹è½½å®Œæˆ</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-downloaded&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ›´æ–°ä¸‹è½½å®Œæˆ: \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-downloaded&#39;</span><span style="color:#E1E4E8;">, info);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">handleUpdateDownloaded</span><span style="color:#E1E4E8;">(info);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // é”™è¯¯å¤„ç†</span></span>
<span class="line"><span style="color:#E1E4E8;">    autoUpdater.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">error</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ›´æ–°é”™è¯¯: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-error&#39;</span><span style="color:#E1E4E8;">, { error: error.message });</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">handleUpdateError</span><span style="color:#E1E4E8;">(error);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> handleUpdateAvailable</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">response</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> dialog.</span><span style="color:#B392F0;">showMessageBox</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      type: </span><span style="color:#9ECBFF;">&#39;info&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      title: </span><span style="color:#9ECBFF;">&#39;å‘ç°æ–°ç‰ˆæœ¬&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      message: </span><span style="color:#9ECBFF;">\`å‘ç°æ–°ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}ï¼Œæ˜¯å¦ç«‹å³ä¸‹è½½ï¼Ÿ\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      detail: info.releaseNotes </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> &#39;æ–°ç‰ˆæœ¬åŒ…å«åŠŸèƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤ã€‚&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      buttons: [</span><span style="color:#9ECBFF;">&#39;ç«‹å³ä¸‹è½½&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;ç¨åæé†’&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;å¿½ç•¥æ­¤ç‰ˆæœ¬&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">      defaultId: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      cancelId: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    switch</span><span style="color:#E1E4E8;"> (response) {</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">// ç«‹å³ä¸‹è½½</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ç”¨æˆ·é€‰æ‹©ä¸‹è½½æ›´æ–°&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#E1E4E8;"> autoUpdater.</span><span style="color:#B392F0;">downloadUpdate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">// ç¨åæé†’</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ç”¨æˆ·é€‰æ‹©ç¨åæ›´æ–°&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#79B8FF;"> 2</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">// å¿½ç•¥æ­¤ç‰ˆæœ¬</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ç”¨æˆ·å¿½ç•¥ç‰ˆæœ¬: \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">ignoreVersion</span><span style="color:#E1E4E8;">(info.version);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  handleUpdateDownloaded</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    dialog.</span><span style="color:#B392F0;">showMessageBox</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      type: </span><span style="color:#9ECBFF;">&#39;info&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      title: </span><span style="color:#9ECBFF;">&#39;æ›´æ–°ä¸‹è½½å®Œæˆ&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      message: </span><span style="color:#9ECBFF;">&#39;æ–°ç‰ˆæœ¬å·²ä¸‹è½½å®Œæˆï¼Œæ˜¯å¦ç«‹å³é‡å¯åº”ç”¨ï¼Ÿ&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      detail: </span><span style="color:#9ECBFF;">&#39;åº”ç”¨å°†åœ¨é‡å¯åå®Œæˆæ›´æ–°ã€‚&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      buttons: [</span><span style="color:#9ECBFF;">&#39;ç«‹å³é‡å¯&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;ç¨åé‡å¯&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">      defaultId: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      cancelId: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    }).</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(({ </span><span style="color:#FFAB70;">response</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (response </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;ç”¨æˆ·ç¡®è®¤å®‰è£…æ›´æ–°ï¼Œå‡†å¤‡é‡å¯...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoUpdater.</span><span style="color:#B392F0;">quitAndInstall</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  handleUpdateError</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    dialog.</span><span style="color:#B392F0;">showMessageBox</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      type: </span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      title: </span><span style="color:#9ECBFF;">&#39;æ›´æ–°é”™è¯¯&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      message: </span><span style="color:#9ECBFF;">&#39;æ£€æŸ¥æ›´æ–°æˆ–ä¸‹è½½æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      detail: error.message,</span></span>
<span class="line"><span style="color:#E1E4E8;">      buttons: [</span><span style="color:#9ECBFF;">&#39;é‡è¯•&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;å–æ¶ˆ&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">      defaultId: </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    }).</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(({ </span><span style="color:#FFAB70;">response</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (response </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkForUpdates</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkForUpdates</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å¼€å§‹æ£€æŸ¥æ›´æ–°...&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> result</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> autoUpdater.</span><span style="color:#B392F0;">checkForUpdates</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ£€æŸ¥æ›´æ–°å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  sendStatusToWindow</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#F97583;"> !</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow.</span><span style="color:#B392F0;">isDestroyed</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.mainWindow.webContents.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-status&#39;</span><span style="color:#E1E4E8;">, { event, data });</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> timestamp</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">toISOString</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> logEntry</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> \`[\${</span><span style="color:#E1E4E8;">timestamp</span><span style="color:#9ECBFF;">}] \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#B392F0;"> writeFile</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update.log&#39;</span><span style="color:#E1E4E8;">, logEntry, { flag: </span><span style="color:#9ECBFF;">&#39;a&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å†™å…¥æ›´æ–°æ—¥å¿—å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ“ \${</span><span style="color:#E1E4E8;">logEntry</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> ignoreVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // å°†å¿½ç•¥çš„ç‰ˆæœ¬ä¿å­˜åˆ°é…ç½®ä¸­</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> ignoredVersions</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getIgnoredVersions</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    ignoredVersions.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">(version);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#B392F0;"> writeFile</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;update-config.json&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">      JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">({ ignoredVersions }, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getIgnoredVersions</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> config</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-config.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> config.ignoredVersions </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> [];</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#E1E4E8;"> UpdateManager;</span></span></code></pre></div><h3 id="æ¸²æŸ“è¿›ç¨‹é›†æˆ" tabindex="-1">æ¸²æŸ“è¿›ç¨‹é›†æˆ <a class="header-anchor" href="#æ¸²æŸ“è¿›ç¨‹é›†æˆ" aria-label="Permalink to &quot;æ¸²æŸ“è¿›ç¨‹é›†æˆ&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// renderer/update-ui.js</span></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> UpdateUI</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.updateRenderer </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupEventListeners</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">renderUpdateStatus</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  setupEventListeners</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // ç›‘å¬ä¸»è¿›ç¨‹å‘é€çš„æ›´æ–°çŠ¶æ€</span></span>
<span class="line"><span style="color:#E1E4E8;">    window.electronAPI.</span><span style="color:#B392F0;">onUpdateStatus</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">, { </span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">: </span><span style="color:#FFAB70;">status</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">handleUpdateStatus</span><span style="color:#E1E4E8;">(status, data);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°æŒ‰é’®</span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;check-updates&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkForUpdates</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // ä¸‹è½½æ›´æ–°æŒ‰é’®</span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;download-update&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">downloadUpdate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // å®‰è£…æ›´æ–°æŒ‰é’®</span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;install-update&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">installUpdate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  handleUpdateStatus</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">status</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> statusElement</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-status&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> progressElement</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;download-progress&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    switch</span><span style="color:#E1E4E8;"> (status) {</span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;checking-for-update&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        statusElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;æ­£åœ¨æ£€æŸ¥æ›´æ–°...&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showNotification</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ­£åœ¨æ£€æŸ¥æ›´æ–°&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;info&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;update-available&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        statusElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`å‘ç°æ–°ç‰ˆæœ¬: \${</span><span style="color:#E1E4E8;">data</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showUpdateAvailableDialog</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;update-not-available&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        statusElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showNotification</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;success&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;download-progress&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#F97583;">        const</span><span style="color:#79B8FF;"> percent</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">floor</span><span style="color:#E1E4E8;">(data.percent);</span></span>
<span class="line"><span style="color:#E1E4E8;">        progressElement.style.width </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">percent</span><span style="color:#9ECBFF;">}%\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        progressElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`\${</span><span style="color:#E1E4E8;">percent</span><span style="color:#9ECBFF;">}%\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        statusElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">          \`ä¸‹è½½è¿›åº¦: \${</span><span style="color:#E1E4E8;">percent</span><span style="color:#9ECBFF;">}% (\${</span><span style="color:#79B8FF;">this</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">formatBytes</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">data</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">bytesPerSecond</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}/s)\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;update-downloaded&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        statusElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;æ›´æ–°ä¸‹è½½å®Œæˆï¼Œå‡†å¤‡å®‰è£…&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showUpdateReadyDialog</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#F97583;">      case</span><span style="color:#9ECBFF;"> &#39;update-error&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        statusElement.textContent </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`æ›´æ–°å¤±è´¥: \${</span><span style="color:#E1E4E8;">data</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#79B8FF;">        this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showNotification</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ›´æ–°å¤±è´¥: \${</span><span style="color:#E1E4E8;">data</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">        break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  showUpdateAvailableDialog</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> dialog</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-dialog&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> message</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-message&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    message.innerHTML </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;h3&gt;å‘ç°æ–°ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}&lt;/h3&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;p&gt;\${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">releaseNotes</span><span style="color:#F97583;"> ||</span><span style="color:#9ECBFF;"> &#39;æ–°ç‰ˆæœ¬åŒ…å«åŠŸèƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤ã€‚&#39;}&lt;/p&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;div class=&quot;update-actions&quot;&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">        &lt;button id=&quot;confirm-download&quot; class=&quot;btn-primary&quot;&gt;ç«‹å³ä¸‹è½½&lt;/button&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">        &lt;button id=&quot;cancel-download&quot; class=&quot;btn-secondary&quot;&gt;ç¨å&lt;/button&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;/div&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">    \`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    dialog.style.display </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;block&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;confirm-download&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      window.electronAPI.</span><span style="color:#B392F0;">downloadUpdate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      dialog.style.display </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;none&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;cancel-download&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      dialog.style.display </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;none&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  showUpdateReadyDialog</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">info</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> dialog</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-dialog&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> message</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;update-message&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    message.innerHTML </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;h3&gt;æ›´æ–°ä¸‹è½½å®Œæˆ&lt;/h3&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;p&gt;ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">info</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} å·²ä¸‹è½½å®Œæˆï¼Œå¯ä»¥å®‰è£…ã€‚&lt;/p&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;div class=&quot;update-actions&quot;&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">        &lt;button id=&quot;confirm-install&quot; class=&quot;btn-primary&quot;&gt;ç«‹å³é‡å¯å¹¶å®‰è£…&lt;/button&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">        &lt;button id=&quot;delay-install&quot; class=&quot;btn-secondary&quot;&gt;ç¨åé‡å¯&lt;/button&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">      &lt;/div&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">    \`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    dialog.style.display </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;block&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;confirm-install&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      window.electronAPI.</span><span style="color:#B392F0;">installUpdate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    document.</span><span style="color:#B392F0;">getElementById</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;delay-install&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      dialog.style.display </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;none&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  formatBytes</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">bytes</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (bytes </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">return</span><span style="color:#9ECBFF;"> &#39;0 B&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> k</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 1024</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> sizes</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;B&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;KB&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MB&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;GB&#39;</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> i</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">floor</span><span style="color:#E1E4E8;">(Math.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(bytes) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(k));</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> parseFloat</span><span style="color:#E1E4E8;">((bytes </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> Math.</span><span style="color:#B392F0;">pow</span><span style="color:#E1E4E8;">(k, i)).</span><span style="color:#B392F0;">toFixed</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;"> &#39; &#39;</span><span style="color:#F97583;"> +</span><span style="color:#E1E4E8;"> sizes[i];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  showNotification</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">type</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;info&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> notification</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> document.</span><span style="color:#B392F0;">createElement</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;div&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    notification.className </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`notification notification-\${</span><span style="color:#E1E4E8;">type</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    notification.textContent </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> message;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    document.body.</span><span style="color:#B392F0;">appendChild</span><span style="color:#E1E4E8;">(notification);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">    setTimeout</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      notification.</span><span style="color:#B392F0;">remove</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }, </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkForUpdates</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      await</span><span style="color:#E1E4E8;"> window.electronAPI.</span><span style="color:#B392F0;">checkForUpdates</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showNotification</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ£€æŸ¥æ›´æ–°å¤±è´¥: \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#E1E4E8;"> UpdateUI;</span></span></code></pre></div><h2 id="ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥" tabindex="-1">ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥ <a class="header-anchor" href="#ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥" aria-label="Permalink to &quot;ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒç­–ç•¥&quot;">â€‹</a></h2><h3 id="ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥" tabindex="-1">ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ <a class="header-anchor" href="#ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥" aria-label="Permalink to &quot;ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥&quot;">â€‹</a></h3><p>Electron éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œå¹¶ä¸ Chromium å‘å¸ƒå‘¨æœŸä¿æŒåŒæ­¥ã€‚</p><p><strong>ç‰ˆæœ¬æ”¯æŒæ—¶é—´çº¿ç¤ºæ„å›¾ï¼š</strong></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Electron ç‰ˆæœ¬ â†’ Chromium ç‰ˆæœ¬ â†’ Node.js ç‰ˆæœ¬</span></span>
<span class="line"><span>    â†“               â†“               â†“</span></span>
<span class="line"><span>æ”¯æŒå‘¨æœŸ â†’   ~6ä¸ªæœˆæ”¯æŒ  â†’  å®‰å…¨æ›´æ–°  â†’  ç»ˆæ­¢æ”¯æŒ</span></span></code></pre></div><h3 id="å‘å¸ƒæ¸ é“ç®¡ç†" tabindex="-1">å‘å¸ƒæ¸ é“ç®¡ç† <a class="header-anchor" href="#å‘å¸ƒæ¸ é“ç®¡ç†" aria-label="Permalink to &quot;å‘å¸ƒæ¸ é“ç®¡ç†&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// config/release-channels.js</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> class</span><span style="color:#B392F0;"> ReleaseChannelManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.channels </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      stable: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        name: </span><span style="color:#9ECBFF;">&#39;stable&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        updateUrl: </span><span style="color:#9ECBFF;">&#39;https://github.com/your-username/your-repo/releases/latest&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        prerelease: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoUpdate: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      beta: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        name: </span><span style="color:#9ECBFF;">&#39;beta&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        updateUrl: </span><span style="color:#9ECBFF;">&#39;https://github.com/your-username/your-repo/releases/beta&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        prerelease: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoUpdate: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      development: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        name: </span><span style="color:#9ECBFF;">&#39;dev&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        updateUrl: </span><span style="color:#9ECBFF;">&#39;https://github.com/your-username/your-repo/releases/dev&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        prerelease: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoUpdate: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getCurrentChannel</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // ä»é…ç½®æ–‡ä»¶ä¸­è·å–å½“å‰æ¸ é“</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> config</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getAppConfig</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> config.updateChannel </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> &#39;stable&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> switchChannel</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">channelName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.channels[channelName]) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æœªçŸ¥çš„å‘å¸ƒæ¸ é“: \${</span><span style="color:#E1E4E8;">channelName</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> channel</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.channels[channelName];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–°è‡ªåŠ¨æ›´æ–°é…ç½®</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">updateUpdaterConfig</span><span style="color:#E1E4E8;">(channel);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // è®°å½•æ¸ é“åˆ‡æ¢</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logChannelSwitch</span><span style="color:#E1E4E8;">(channelName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ”„ å·²åˆ‡æ¢åˆ° \${</span><span style="color:#E1E4E8;">channelName</span><span style="color:#9ECBFF;">} æ¸ é“\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> channel;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkChannelUpdates</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentChannel</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getCurrentChannel</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> channel</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.channels[currentChannel];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">channel.autoUpdate) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ”• \${</span><span style="color:#E1E4E8;">currentChannel</span><span style="color:#9ECBFF;">} æ¸ é“å·²ç¦ç”¨è‡ªåŠ¨æ›´æ–°\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> updateInfo</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">fetchUpdateInfo</span><span style="color:#E1E4E8;">(channel);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">validateUpdateCompatibility</span><span style="color:#E1E4E8;">(updateInfo);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ£€æŸ¥ \${</span><span style="color:#E1E4E8;">currentChannel</span><span style="color:#9ECBFF;">} æ¸ é“æ›´æ–°å¤±è´¥:\`</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> fetchUpdateInfo</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">channel</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> response</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> fetch</span><span style="color:#E1E4E8;">(channel.updateUrl);</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">response.ok) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`è·å–æ›´æ–°ä¿¡æ¯å¤±è´¥: \${</span><span style="color:#E1E4E8;">response</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">statusText</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> data</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> response.</span><span style="color:#B392F0;">json</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      version: data.tag_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">      releaseNotes: data.body,</span></span>
<span class="line"><span style="color:#E1E4E8;">      publishDate: data.published_at,</span></span>
<span class="line"><span style="color:#E1E4E8;">      downloadUrl: data.assets[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]?.browser_download_url,</span></span>
<span class="line"><span style="color:#E1E4E8;">      channel: channel.name</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  validateUpdateCompatibility</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentVersion</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> app.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentPlatform</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> process.platform;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentArch</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> process.arch;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isVersionCompatible</span><span style="color:#E1E4E8;">(updateInfo.version, currentVersion)) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ç‰ˆæœ¬ä¸å…¼å®¹: \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥å¹³å°å…¼å®¹æ€§</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isPlatformSupported</span><span style="color:#E1E4E8;">(updateInfo, currentPlatform, currentArch)) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å¹³å°æ¶æ„ä¸æ”¯æŒ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> updateInfo;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isVersionCompatible</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">newVersion</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">currentVersion</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // å®ç°ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥é€»è¾‘</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> newParts</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> newVersion.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(Number);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> currentParts</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> currentVersion.</span><span style="color:#B392F0;">split</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;">(Number);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // ä¸»è¦ç‰ˆæœ¬å·ä¸åŒæ—¶ä¸å…¼å®¹</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> newParts[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> currentParts[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isPlatformSupported</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">platform</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">arch</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥æ›´æ–°æ˜¯å¦æ”¯æŒå½“å‰å¹³å°å’Œæ¶æ„</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> supportedPatterns</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">      \`\${</span><span style="color:#E1E4E8;">platform</span><span style="color:#9ECBFF;">}-\${</span><span style="color:#E1E4E8;">arch</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      \`\${</span><span style="color:#E1E4E8;">platform</span><span style="color:#9ECBFF;">}-universal\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;multi-platform&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> supportedPatterns.</span><span style="color:#B392F0;">some</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">pattern</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      updateInfo.downloadUrl.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(pattern)</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getAppConfig</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;app-config.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> { updateChannel: </span><span style="color:#9ECBFF;">&#39;stable&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> updateUpdaterConfig</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">channel</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> config</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      provider: </span><span style="color:#9ECBFF;">&#39;generic&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      url: channel.updateUrl,</span></span>
<span class="line"><span style="color:#E1E4E8;">      channel: channel.name</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#B392F0;"> writeFile</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;updater-config.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(config, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> logChannelSwitch</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">channelName</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> logEntry</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      timestamp: </span><span style="color:#F97583;">new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">toISOString</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      previousChannel: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getCurrentChannel</span><span style="color:#E1E4E8;">(),</span></span>
<span class="line"><span style="color:#E1E4E8;">      newChannel: channelName,</span></span>
<span class="line"><span style="color:#E1E4E8;">      version: app.</span><span style="color:#B392F0;">getVersion</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#B392F0;"> writeFile</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;channel-switch.log&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">stringify</span><span style="color:#E1E4E8;">(logEntry) </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;"> &#39;</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">, { </span></span>
<span class="line"><span style="color:#E1E4E8;">      flag: </span><span style="color:#9ECBFF;">&#39;a&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> channelManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> ReleaseChannelManager</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><h2 id="ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡" tabindex="-1">ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡ <a class="header-anchor" href="#ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡" aria-label="Permalink to &quot;ç¬¬ä¸‰æ–¹æ›´æ–°æœåŠ¡&quot;">â€‹</a></h2><h3 id="é›†æˆ-electron-update-sdk" tabindex="-1">é›†æˆ electron-update-sdk <a class="header-anchor" href="#é›†æˆ-electron-update-sdk" aria-label="Permalink to &quot;é›†æˆ electron-update-sdk&quot;">â€‹</a></h3><p>å¯¹äºéœ€è¦æ›´é«˜çº§æ›´æ–°åŠŸèƒ½çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å°è£…åº“ã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// services/update-service.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> updateServiceMain </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;@bugonly/electron-update-sdk/libs/main&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> updateServicePreload </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;@bugonly/electron-update-sdk/libs/preload&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { contextBridge } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;electron&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#B392F0;"> EnhancedUpdateService</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">mainWindow</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.mainWindow </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mainWindow;</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupUpdateService</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  setupUpdateService</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // è®¾ç½®æ›´æ–°æœåŠ¡</span></span>
<span class="line"><span style="color:#E1E4E8;">    updateServiceMain.</span><span style="color:#B392F0;">setup</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      feedUrl: </span><span style="color:#9ECBFF;">&#39;https://your-update-server.com/updates&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      autoDownload: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      enableProgress: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      logger: </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getLogger</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // è®¾ç½®è‡ªå®šä¹‰äº‹ä»¶å¤„ç†</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">setupCustomEventHandlers</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  setupCustomEventHandlers</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥æ›´æ–°ä¸­</span></span>
<span class="line"><span style="color:#E1E4E8;">    updateServiceMain.</span><span style="color:#B392F0;">onCheckingUpdate</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SDK: å¼€å§‹æ£€æŸ¥æ›´æ–°&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.mainWindow.webContents.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sdk-update-status&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;checking&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–°å¯ç”¨</span></span>
<span class="line"><span style="color:#E1E4E8;">    updateServiceMain.</span><span style="color:#B392F0;">onNeedUpdate</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`SDK: å‘ç°æ–°ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.mainWindow.webContents.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sdk-update-status&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;available&#39;</span><span style="color:#E1E4E8;">, updateInfo);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showSDKUpdateDialog</span><span style="color:#E1E4E8;">(updateInfo);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // ä¸‹è½½è¿›åº¦</span></span>
<span class="line"><span style="color:#E1E4E8;">    updateServiceMain.</span><span style="color:#B392F0;">onDownloading</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">progress</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.mainWindow.webContents.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sdk-download-progress&#39;</span><span style="color:#E1E4E8;">, progress);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // ä¸‹è½½å®Œæˆ</span></span>
<span class="line"><span style="color:#E1E4E8;">    updateServiceMain.</span><span style="color:#B392F0;">onDownloadSuccess</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SDK: æ›´æ–°ä¸‹è½½å®Œæˆ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.mainWindow.webContents.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sdk-update-status&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;downloaded&#39;</span><span style="color:#E1E4E8;">, updateInfo);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">showSDKInstallDialog</span><span style="color:#E1E4E8;">(updateInfo);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // æ›´æ–°å¤±è´¥</span></span>
<span class="line"><span style="color:#E1E4E8;">    updateServiceMain.</span><span style="color:#B392F0;">onUpdateFail</span><span style="color:#E1E4E8;">((</span><span style="color:#FFAB70;">error</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`SDK: æ›´æ–°å¤±è´¥ \${</span><span style="color:#E1E4E8;">error</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">      this</span><span style="color:#E1E4E8;">.mainWindow.webContents.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sdk-update-status&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  showSDKUpdateDialog</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    dialog.</span><span style="color:#B392F0;">showMessageBox</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      type: </span><span style="color:#9ECBFF;">&#39;info&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      title: </span><span style="color:#9ECBFF;">&#39;å‘ç°æ–°ç‰ˆæœ¬&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      message: </span><span style="color:#9ECBFF;">\`å‘ç°æ–°ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      detail: </span><span style="color:#9ECBFF;">&#39;æ˜¯å¦ç«‹å³ä¸‹è½½å¹¶å®‰è£…æ›´æ–°ï¼Ÿ&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      buttons: [</span><span style="color:#9ECBFF;">&#39;ç«‹å³æ›´æ–°&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;ç¨åæé†’&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">      defaultId: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      cancelId: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    }).</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(({ </span><span style="color:#FFAB70;">response</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (response </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        updateServiceMain.</span><span style="color:#B392F0;">confirmDownload</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  showSDKInstallDialog</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    dialog.</span><span style="color:#B392F0;">showMessageBox</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainWindow, {</span></span>
<span class="line"><span style="color:#E1E4E8;">      type: </span><span style="color:#9ECBFF;">&#39;info&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      title: </span><span style="color:#9ECBFF;">&#39;æ›´æ–°å‡†å¤‡å°±ç»ª&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      message: </span><span style="color:#9ECBFF;">\`ç‰ˆæœ¬ \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">} å·²ä¸‹è½½å®Œæˆ\`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      detail: </span><span style="color:#9ECBFF;">&#39;åº”ç”¨å°†åœ¨é‡å¯åå®Œæˆæ›´æ–°ã€‚&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      buttons: [</span><span style="color:#9ECBFF;">&#39;ç«‹å³é‡å¯&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;ç¨åé‡å¯&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">      defaultId: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      cancelId: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    }).</span><span style="color:#B392F0;">then</span><span style="color:#E1E4E8;">(({ </span><span style="color:#FFAB70;">response</span><span style="color:#E1E4E8;"> }) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (response </span><span style="color:#F97583;">===</span><span style="color:#79B8FF;"> 0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        updateServiceMain.</span><span style="color:#B392F0;">confirmUpdate</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getLogger</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      info</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`â„¹ï¸ \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#B392F0;">      error</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âŒ \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#B392F0;">      warn</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`âš ï¸ \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#B392F0;">      debug</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> console.</span><span style="color:#B392F0;">debug</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`ğŸ› \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  logUpdateEvent</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">message</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> timestamp</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">toISOString</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`[\${</span><span style="color:#E1E4E8;">timestamp</span><span style="color:#9ECBFF;">}] \${</span><span style="color:#E1E4E8;">message</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// é¢„åŠ è½½è„šæœ¬ä¸­æš´éœ² API</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> exposeUpdateAPI</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  contextBridge.</span><span style="color:#B392F0;">exposeInMainWorld</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;electronUpdateSDK&#39;</span><span style="color:#E1E4E8;">, updateServicePreload.content);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> default</span><span style="color:#E1E4E8;"> EnhancedUpdateService;</span></span></code></pre></div><h2 id="å®‰å…¨ä¸éªŒè¯" tabindex="-1">å®‰å…¨ä¸éªŒè¯ <a class="header-anchor" href="#å®‰å…¨ä¸éªŒè¯" aria-label="Permalink to &quot;å®‰å…¨ä¸éªŒè¯&quot;">â€‹</a></h2><h3 id="ä»£ç ç­¾åä¸éªŒè¯" tabindex="-1">ä»£ç ç­¾åä¸éªŒè¯ <a class="header-anchor" href="#ä»£ç ç­¾åä¸éªŒè¯" aria-label="Permalink to &quot;ä»£ç ç­¾åä¸éªŒè¯&quot;">â€‹</a></h3><p>ä»£ç ç­¾åæ˜¯å‘å¸ƒè¿‡ç¨‹ä¸­çš„å…³é”®å®‰å…¨æ­¥éª¤ã€‚</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// security/signing-manager.js</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { createVerify } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;crypto&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { readFileSync, existsSync } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;fs&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> class</span><span style="color:#B392F0;"> SigningManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.publicKey </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">loadPublicKey</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> verifyUpdateSignature</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateFilePath</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">signatureFilePath</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> updateData</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> readFile</span><span style="color:#E1E4E8;">(updateFilePath);</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> signature</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> readFile</span><span style="color:#E1E4E8;">(signatureFilePath, </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> verifier</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> createVerify</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SHA256&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      verifier.</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(updateData);</span></span>
<span class="line"><span style="color:#E1E4E8;">      verifier.</span><span style="color:#B392F0;">end</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> isValid</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> verifier.</span><span style="color:#B392F0;">verify</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.publicKey, signature, </span><span style="color:#9ECBFF;">&#39;base64&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">isValid) {</span></span>
<span class="line"><span style="color:#F97583;">        throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;æ›´æ–°æ–‡ä»¶ç­¾åéªŒè¯å¤±è´¥&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âœ… æ›´æ–°æ–‡ä»¶ç­¾åéªŒè¯æˆåŠŸ&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;âŒ æ›´æ–°æ–‡ä»¶ç­¾åéªŒè¯å¤±è´¥:&#39;</span><span style="color:#E1E4E8;">, error);</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  loadPublicKey</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> keyPath</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;security/public-key.pem&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">existsSync</span><span style="color:#E1E4E8;">(keyPath)) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;å…¬é’¥æ–‡ä»¶ä¸å­˜åœ¨&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#B392F0;"> readFileSync</span><span style="color:#E1E4E8;">(keyPath, </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> validateUpdateIntegrity</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // éªŒè¯ç‰ˆæœ¬å·æ ¼å¼</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isValidVersion</span><span style="color:#E1E4E8;">(updateInfo.version)) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ— æ•ˆçš„ç‰ˆæœ¬å·: \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">version</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // éªŒè¯å‘å¸ƒæ—¶é—´</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isValidReleaseDate</span><span style="color:#E1E4E8;">(updateInfo.publishDate)) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ— æ•ˆçš„å‘å¸ƒæ—¶é—´: \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">publishDate</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // éªŒè¯æ–‡ä»¶å¤§å°</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isValidFileSize</span><span style="color:#E1E4E8;">(updateInfo.fileSize)) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`æ— æ•ˆçš„æ–‡ä»¶å¤§å°: \${</span><span style="color:#E1E4E8;">updateInfo</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">fileSize</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isValidVersion</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">version</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> versionRegex</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> /</span><span style="color:#F97583;">^</span><span style="color:#79B8FF;">\\d</span><span style="color:#F97583;">+</span><span style="color:#85E89D;font-weight:bold;">\\.</span><span style="color:#79B8FF;">\\d</span><span style="color:#F97583;">+</span><span style="color:#85E89D;font-weight:bold;">\\.</span><span style="color:#79B8FF;">\\d</span><span style="color:#F97583;">+</span><span style="color:#DBEDFF;">(-</span><span style="color:#79B8FF;">[a-z0-9]</span><span style="color:#F97583;">+</span><span style="color:#DBEDFF;">)</span><span style="color:#F97583;">?$</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> versionRegex.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(version);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isValidReleaseDate</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">dateString</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> releaseDate</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">(dateString);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> now</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å‘å¸ƒæ—¶é—´ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (releaseDate </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> now) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // å‘å¸ƒæ—¶é—´ä¸èƒ½æ—©äºä¸€å¹´å‰</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> oneYearAgo</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Date</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    oneYearAgo.</span><span style="color:#B392F0;">setFullYear</span><span style="color:#E1E4E8;">(oneYearAgo.</span><span style="color:#B392F0;">getFullYear</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;"> 1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> releaseDate </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> oneYearAgo;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isValidFileSize</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">fileSize</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">    // æ–‡ä»¶å¤§å°åº”åœ¨ 1MB åˆ° 500MB ä¹‹é—´</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> minSize</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 1</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 1024</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 1024</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 1MB</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> maxSize</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 500</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 1024</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 1024</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 500MB</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> fileSize </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> minSize </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> fileSize </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> maxSize;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> createIntegrityCheck</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateFilePath</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> data</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> readFile</span><span style="color:#E1E4E8;">(updateFilePath);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> hashes</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      sha256: </span><span style="color:#B392F0;">createHash</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sha256&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(data).</span><span style="color:#B392F0;">digest</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">      sha512: </span><span style="color:#B392F0;">createHash</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;sha512&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(data).</span><span style="color:#B392F0;">digest</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">      size: data.</span><span style="color:#79B8FF;">length</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> hashes;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> signingManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> SigningManager</span><span style="color:#E1E4E8;">();</span></span></code></pre></div><h3 id="å®‰å…¨æ›´æ–°ç­–ç•¥" tabindex="-1">å®‰å…¨æ›´æ–°ç­–ç•¥ <a class="header-anchor" href="#å®‰å…¨æ›´æ–°ç­–ç•¥" aria-label="Permalink to &quot;å®‰å…¨æ›´æ–°ç­–ç•¥&quot;">â€‹</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// security/update-policy.js</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> class</span><span style="color:#B392F0;"> UpdatePolicyManager</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  constructor</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#79B8FF;">    this</span><span style="color:#E1E4E8;">.policies </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      security: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        priority: </span><span style="color:#9ECBFF;">&#39;high&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoDownload: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoInstall: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        maxRetries: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      feature: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        priority: </span><span style="color:#9ECBFF;">&#39;medium&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoDownload: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoInstall: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        maxRetries: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">      },</span></span>
<span class="line"><span style="color:#E1E4E8;">      maintenance: {</span></span>
<span class="line"><span style="color:#E1E4E8;">        priority: </span><span style="color:#9ECBFF;">&#39;low&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoDownload: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        autoInstall: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        maxRetries: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  determineUpdateType</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">version</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">releaseNotes</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> updateInfo;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isSecurityUpdate</span><span style="color:#E1E4E8;">(releaseNotes)) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#9ECBFF;"> &#39;security&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">isFeatureUpdate</span><span style="color:#E1E4E8;">(releaseNotes)) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#9ECBFF;"> &#39;feature&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#9ECBFF;"> &#39;maintenance&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isSecurityUpdate</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">releaseNotes</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> securityKeywords</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;security&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;vulnerability&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;cve&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;patch&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;fix&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;protection&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;safe&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;critical&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> notes</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> releaseNotes.</span><span style="color:#B392F0;">toLowerCase</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> securityKeywords.</span><span style="color:#B392F0;">some</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">keyword</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> notes.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(keyword));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  isFeatureUpdate</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">releaseNotes</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> featureKeywords</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;feature&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;new&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;enhancement&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;improvement&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;added&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;introduced&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;functionality&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> notes</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> releaseNotes.</span><span style="color:#B392F0;">toLowerCase</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> featureKeywords.</span><span style="color:#B392F0;">some</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">keyword</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> notes.</span><span style="color:#B392F0;">includes</span><span style="color:#E1E4E8;">(keyword));</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getUpdatePolicy</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateType</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.policies[updateType] </span><span style="color:#F97583;">||</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.policies.maintenance;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> shouldAutoInstall</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">updateInfo</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> updateType</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">determineUpdateType</span><span style="color:#E1E4E8;">(updateInfo);</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> policy</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getUpdatePolicy</span><span style="color:#E1E4E8;">(updateType);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">policy.autoInstall) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥å½“å‰ç½‘ç»œçŠ¶æ€</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> networkState</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkNetworkState</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">networkState.isStable) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> systemLoad</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkSystemLoad</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (systemLoad.isHigh) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥ç”¨æˆ·æ´»åŠ¨çŠ¶æ€</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> userActivity</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">checkUserActivity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (userActivity.isActive) {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#79B8FF;"> false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkNetworkState</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> response</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#B392F0;"> fetch</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;https://www.google.com&#39;</span><span style="color:#E1E4E8;">, { </span></span>
<span class="line"><span style="color:#E1E4E8;">        method: </span><span style="color:#9ECBFF;">&#39;HEAD&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        timeout: </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        isStable: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        type: navigator.connection?.effectiveType </span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;"> &#39;unknown&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      };</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        isStable: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        type: </span><span style="color:#9ECBFF;">&#39;offline&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      };</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  async</span><span style="color:#B392F0;"> checkSystemLoad</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // ç®€åŒ–çš„ç³»ç»Ÿè´Ÿè½½æ£€æŸ¥</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> memoryUsage</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> process.</span><span style="color:#B392F0;">memoryUsage</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> memoryPercent</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> memoryUsage.heapUsed </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> memoryUsage.heapTotal;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      isHigh: memoryPercent </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> 0.8</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      memoryUsage: memoryPercent</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  checkUserActivity</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // æ£€æŸ¥ç”¨æˆ·æœ€è¿‘æ˜¯å¦æœ‰æ´»åŠ¨</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> lastActivity</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">getLastUserActivity</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> inactiveThreshold</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 5</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 60</span><span style="color:#F97583;"> *</span><span style="color:#79B8FF;"> 1000</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 5åˆ†é’Ÿ</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      isActive: Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> lastActivity </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> inactiveThreshold,</span></span>
<span class="line"><span style="color:#E1E4E8;">      lastActivity</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">  getLastUserActivity</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#6A737D;">    // ä»åº”ç”¨çŠ¶æ€è·å–æœ€åæ´»åŠ¨æ—¶é—´</span></span>
<span class="line"><span style="color:#F97583;">    try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      const</span><span style="color:#79B8FF;"> state</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> JSON</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">parse</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">readFileSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;app-state.json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;utf-8&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> state.lastUserActivity </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">      return</span><span style="color:#E1E4E8;"> Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#F97583;"> const</span><span style="color:#79B8FF;"> policyManager</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> UpdatePolicyManager</span><span style="color:#E1E4E8;">();</span></span></code></pre></div>`,41)])])}const B=n(o,[["render",e]]);export{i as __pageData,B as default};
