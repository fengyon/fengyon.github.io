import{_ as a,c as n,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const F=JSON.parse('{"title":"ethers.js","description":"","frontmatter":{},"headers":[{"level":2,"title":"ethers.js 核心特点","slug":"ethers-js-核心特点","link":"#ethers-js-核心特点","children":[{"level":3,"title":"轻量级与模块化","slug":"轻量级与模块化","link":"#轻量级与模块化","children":[]},{"level":3,"title":"安全的钱包管理","slug":"安全的钱包管理","link":"#安全的钱包管理","children":[]},{"level":3,"title":"灵活的提供者系统","slug":"灵活的提供者系统","link":"#灵活的提供者系统","children":[]},{"level":3,"title":"完整的类型支持","slug":"完整的类型支持","link":"#完整的类型支持","children":[]}]},{"level":2,"title":"安装与配置","slug":"安装与配置","link":"#安装与配置","children":[{"level":3,"title":"环境要求","slug":"环境要求","link":"#环境要求","children":[]},{"level":3,"title":"安装 ethers.js","slug":"安装-ethers-js","link":"#安装-ethers-js","children":[]},{"level":3,"title":"项目结构","slug":"项目结构","link":"#项目结构","children":[]}]},{"level":2,"title":"核心概念与架构","slug":"核心概念与架构","link":"#核心概念与架构","children":[{"level":3,"title":"提供者 (Provider)","slug":"提供者-provider","link":"#提供者-provider","children":[]},{"level":3,"title":"签名者 (Signer)","slug":"签名者-signer","link":"#签名者-signer","children":[]},{"level":3,"title":"合约 (Contract)","slug":"合约-contract","link":"#合约-contract","children":[]}]},{"level":2,"title":"常用开源库与 API","slug":"常用开源库与-api","link":"#常用开源库与-api","children":[{"level":3,"title":"提供者 API","slug":"提供者-api","link":"#提供者-api","children":[]},{"level":3,"title":"钱包 API","slug":"钱包-api","link":"#钱包-api","children":[]},{"level":3,"title":"合约 API","slug":"合约-api","link":"#合约-api","children":[]},{"level":3,"title":"工具函数 API","slug":"工具函数-api","link":"#工具函数-api","children":[]}]},{"level":2,"title":"实用技巧与最佳实践","slug":"实用技巧与最佳实践","link":"#实用技巧与最佳实践","children":[{"level":3,"title":"错误处理","slug":"错误处理","link":"#错误处理","children":[]},{"level":3,"title":"Gas 管理","slug":"gas-管理","link":"#gas-管理","children":[]}]}],"relativePath":"leading/web3/ethers.md","filePath":"leading/web3/ethers.md"}'),o={name:"leading/web3/ethers.md"};function e(c,s,t,r,E,y){return l(),n("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /leading/web3/ethers.md for this page in Markdown format</div><h1 id="ethers-js" tabindex="-1">ethers.js <a class="header-anchor" href="#ethers-js" aria-label="Permalink to &quot;ethers.js&quot;">​</a></h1><p>ethers.js 是一个功能强大且轻量级的 JavaScript 库，专为与以太坊区块链及其生态系统进行交互而设计。它提供了一套完整的工具，帮助开发者连接以太坊网络、管理钱包、签署交易，并与智能合约进行无缝交互。其模块化架构和直观的 API 设计使其成为构建去中心化应用 (DApp) 的理想选择。</p><h2 id="ethers-js-核心特点" tabindex="-1">ethers.js 核心特点 <a class="header-anchor" href="#ethers-js-核心特点" aria-label="Permalink to &quot;ethers.js 核心特点&quot;">​</a></h2><h3 id="轻量级与模块化" tabindex="-1">轻量级与模块化 <a class="header-anchor" href="#轻量级与模块化" aria-label="Permalink to &quot;轻量级与模块化&quot;">​</a></h3><p>ethers.js 采用轻量级设计，相较于其他同类库，其包体积更小，这有助于提升 DApp 的加载性能。其模块化架构允许开发者仅引入项目所需的组件，例如钱包管理、合约交互或提供者 (Provider) 连接，从而优化最终应用体积。</p><h3 id="安全的钱包管理" tabindex="-1">安全的钱包管理 <a class="header-anchor" href="#安全的钱包管理" aria-label="Permalink to &quot;安全的钱包管理&quot;">​</a></h3><p>库提供了强大的工具来创建、保护和管理加密货币钱包。ethers.js 支持多种钱包类型，包括助记词、JSON 密钥库和私钥，并强调私钥在安全环境中的存储，确保用户资产安全。</p><h3 id="灵活的提供者系统" tabindex="-1">灵活的提供者系统 <a class="header-anchor" href="#灵活的提供者系统" aria-label="Permalink to &quot;灵活的提供者系统&quot;">​</a></h3><p>提供者 (Provider) 是与以太坊网络连接的桥梁。ethers.js 支持通过多种方式连接，包括标准的 JSON-RPC 接口以及 Infura、Alchemy 等流行服务节点。这使得它能够灵活地适应不同的开发和生产环境。</p><h3 id="完整的类型支持" tabindex="-1">完整的类型支持 <a class="header-anchor" href="#完整的类型支持" aria-label="Permalink to &quot;完整的类型支持&quot;">​</a></h3><p>ethers.js 原生支持 TypeScript，提供了完善的类型定义。这能够在开发过程中实现更好的类型检查和代码提示，提升代码质量和开发效率。</p><h2 id="安装与配置" tabindex="-1">安装与配置 <a class="header-anchor" href="#安装与配置" aria-label="Permalink to &quot;安装与配置&quot;">​</a></h2><h3 id="环境要求" tabindex="-1">环境要求 <a class="header-anchor" href="#环境要求" aria-label="Permalink to &quot;环境要求&quot;">​</a></h3><p>在开始之前，请确保你的开发环境满足以下要求：</p><ul><li>Node.js 版本 12 或以上</li><li>npm、yarn、pnpm 或 bun 等包管理器</li></ul><h3 id="安装-ethers-js" tabindex="-1">安装 ethers.js <a class="header-anchor" href="#安装-ethers-js" aria-label="Permalink to &quot;安装 ethers.js&quot;">​</a></h3><p>你可以使用你喜欢的包管理器来安装 ethers.js。以下是使用 npm 安装的命令：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">npm</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> ethers</span></span></code></pre></div><h3 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-label="Permalink to &quot;项目结构&quot;">​</a></h3><p>一个典型的使用 ethers.js 的项目目录结构如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>your-project/</span></span>
<span class="line"><span>├── node_modules/</span></span>
<span class="line"><span>├── src/</span></span>
<span class="line"><span>│   ├── scripts/</span></span>
<span class="line"><span>│   │   ├── provider.js</span></span>
<span class="line"><span>│   │   ├── wallet.js</span></span>
<span class="line"><span>│   │   └── contract.js</span></span>
<span class="line"><span>│   └── utils/</span></span>
<span class="line"><span>├── package.json</span></span>
<span class="line"><span>└── README.md</span></span></code></pre></div><h2 id="核心概念与架构" tabindex="-1">核心概念与架构 <a class="header-anchor" href="#核心概念与架构" aria-label="Permalink to &quot;核心概念与架构&quot;">​</a></h2><h3 id="提供者-provider" tabindex="-1">提供者 (Provider) <a class="header-anchor" href="#提供者-provider" aria-label="Permalink to &quot;提供者 (Provider)&quot;">​</a></h3><p>提供者是一个抽象，用于连接以太坊网络并执行查询操作。它负责与以太坊节点通信，但不管理私钥。示意图如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>你的DApp -&gt; Provider -&gt; 以太坊节点 (如 Infura、Alchemy 或本地节点)</span></span></code></pre></div><h3 id="签名者-signer" tabindex="-1">签名者 (Signer) <a class="header-anchor" href="#签名者-signer" aria-label="Permalink to &quot;签名者 (Signer)&quot;">​</a></h3><p>签名者是一个对象，代表一个能够对交易和消息进行签名的以太坊账户。它封装了私钥，并提供了签名功能。示意图如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Signer (持有私钥) -&gt; 对交易签名 -&gt; 通过 Provider 发送到网络</span></span></code></pre></div><h3 id="合约-contract" tabindex="-1">合约 (Contract) <a class="header-anchor" href="#合约-contract" aria-label="Permalink to &quot;合约 (Contract)&quot;">​</a></h3><p>合约对象是与部署在区块链上的智能合约进行交互的接口。它通过合约地址和应用程序二进制接口 (ABI) 来定义可调用的函数和事件。</p><h2 id="常用开源库与-api" tabindex="-1">常用开源库与 API <a class="header-anchor" href="#常用开源库与-api" aria-label="Permalink to &quot;常用开源库与 API&quot;">​</a></h2><h3 id="提供者-api" tabindex="-1">提供者 API <a class="header-anchor" href="#提供者-api" aria-label="Permalink to &quot;提供者 API&quot;">​</a></h3><h4 id="jsonrpcprovider" tabindex="-1">JsonRpcProvider <a class="header-anchor" href="#jsonrpcprovider" aria-label="Permalink to &quot;JsonRpcProvider&quot;">​</a></h4><p><code>JsonRpcProvider</code> 用于连接一个指定的 JSON-RPC 节点，这可以是本地节点，也可以是 Infura、Alchemy 等提供的服务端点。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 使用 Infura 作为提供者，连接到 Sepolia 测试网</span></span>
<span class="line"><span style="color:#6A737D;">// 替换 &#39;your-infura-project-id&#39; 为你的实际 Project ID</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> provider</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">JsonRpcProvider</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;https://sepolia.infura.io/v3/your-infura-project-id&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 查询网络信息</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> network</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">getNetwork</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;当前网络:&#39;</span><span style="color:#E1E4E8;">, network.name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 查询特定地址的 ETH 余额</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> address</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;0x742E4D6c9F1B2B5c44760d0447c43553e4543965&#39;</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> balance</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">getBalance</span><span style="color:#E1E4E8;">(address)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;余额:&#39;</span><span style="color:#E1E4E8;">, ethers.</span><span style="color:#B392F0;">formatEther</span><span style="color:#E1E4E8;">(balance), </span><span style="color:#9ECBFF;">&#39;ETH&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre></div><h4 id="browserprovider" tabindex="-1">BrowserProvider <a class="header-anchor" href="#browserprovider" aria-label="Permalink to &quot;BrowserProvider&quot;">​</a></h4><p>在浏览器环境中，如果用户安装了 MetaMask 等钱包，可以使用 <code>BrowserProvider</code> 来连接。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 检查 window.ethereum 是否存在（通常由 MetaMask 等钱包注入）</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> window.ethereum </span><span style="color:#F97583;">!==</span><span style="color:#9ECBFF;"> &#39;undefined&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#6A737D;">  // 创建 BrowserProvider 实例</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> provider</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">BrowserProvider</span><span style="color:#E1E4E8;">(window.ethereum)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 请求用户授权连接账户</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> accounts</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">send</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;eth_requestAccounts&#39;</span><span style="color:#E1E4E8;">, [])</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> signer</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">getSigner</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;已连接账户:&#39;</span><span style="color:#E1E4E8;">, accounts[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;请安装 MetaMask!&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h3 id="钱包-api" tabindex="-1">钱包 API <a class="header-anchor" href="#钱包-api" aria-label="Permalink to &quot;钱包 API&quot;">​</a></h3><h4 id="创建钱包" tabindex="-1">创建钱包 <a class="header-anchor" href="#创建钱包" aria-label="Permalink to &quot;创建钱包&quot;">​</a></h4><p>ethers.js 提供了多种创建钱包的方式，包括随机生成、从助记词恢复或从加密 JSON 文件导入。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 随机生成一个新钱包（主要用于测试环境）</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> randomWallet</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ethers.Wallet.</span><span style="color:#B392F0;">createRandom</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;地址:&#39;</span><span style="color:#E1E4E8;">, randomWallet.address)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;私钥:&#39;</span><span style="color:#E1E4E8;">, randomWallet.privateKey)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;助记词:&#39;</span><span style="color:#E1E4E8;">, randomWallet.mnemonic.phrase)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 通过私钥创建钱包</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> privateKey</span><span style="color:#F97583;"> =</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef&#39;</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> walletFromPrivateKey</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Wallet</span><span style="color:#E1E4E8;">(privateKey)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 通过助记词创建钱包</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> mnemonic</span><span style="color:#F97583;"> =</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;legal winner thank year wave sausage worth useful legal winner thank yellow&#39;</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> walletFromMnemonic</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ethers.Wallet.</span><span style="color:#B392F0;">fromPhrase</span><span style="color:#E1E4E8;">(mnemonic)</span></span></code></pre></div><h4 id="连接钱包与提供者" tabindex="-1">连接钱包与提供者 <a class="header-anchor" href="#连接钱包与提供者" aria-label="Permalink to &quot;连接钱包与提供者&quot;">​</a></h4><p>创建钱包实例后，可以将其与提供者连接，以便与区块链进行交互。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 创建提供者和钱包</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> provider</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">JsonRpcProvider</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;https://sepolia.infura.io/v3/your-infura-project-id&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> wallet</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Wallet</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  provider</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 发送交易（示例：转账 ETH）</span></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> sendTransaction</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> transaction</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    to: </span><span style="color:#9ECBFF;">&#39;0x742E4D6c9F1B2B5c44760d0447c43553e4543965&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    value: ethers.</span><span style="color:#B392F0;">parseEther</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;0.001&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 发送交易</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> txResponse</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> wallet.</span><span style="color:#B392F0;">sendTransaction</span><span style="color:#E1E4E8;">(transaction)</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;交易已发送，哈希:&#39;</span><span style="color:#E1E4E8;">, txResponse.hash)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 等待交易确认</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> receipt</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> txResponse.</span><span style="color:#B392F0;">wait</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;交易已确认，所在区块:&#39;</span><span style="color:#E1E4E8;">, receipt.blockNumber)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">sendTransaction</span><span style="color:#E1E4E8;">()</span></span></code></pre></div><h3 id="合约-api" tabindex="-1">合约 API <a class="header-anchor" href="#合约-api" aria-label="Permalink to &quot;合约 API&quot;">​</a></h3><h4 id="创建合约实例" tabindex="-1">创建合约实例 <a class="header-anchor" href="#创建合约实例" aria-label="Permalink to &quot;创建合约实例&quot;">​</a></h4><p>要与智能合约交互，首先需要创建合约实例，这需要合约地址和 ABI。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 示例：ERC-20 代币合约的部分 ABI</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> erc20Abi</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> [</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;function name() view returns (string)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;function symbol() view returns (string)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;function decimals() view returns (uint8)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;function totalSupply() view returns (uint256)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;function balanceOf(address) view returns (uint256)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;function transfer(address to, uint amount) returns (bool)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;event Transfer(address indexed from, address indexed to, uint amount)&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 合约地址（这里以 DAI 在 Sepolia 测试网为例）</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> contractAddress</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;0x7AF17bA886A5EdE2cB8eE946c7b3f0e1C1A84768&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 创建提供者和签名者</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> provider</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">JsonRpcProvider</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;https://sepolia.infura.io/v3/your-infura-project-id&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> signer</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Wallet</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  provider</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 创建合约实例</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> contract</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Contract</span><span style="color:#E1E4E8;">(contractAddress, erc20Abi, signer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 如果只需要读取数据，不需要签名，可以不传入 signer</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> readOnlyContract</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Contract</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">  contractAddress,</span></span>
<span class="line"><span style="color:#E1E4E8;">  erc20Abi,</span></span>
<span class="line"><span style="color:#E1E4E8;">  provider</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre></div><h4 id="与合约交互" tabindex="-1">与合约交互 <a class="header-anchor" href="#与合约交互" aria-label="Permalink to &quot;与合约交互&quot;">​</a></h4><p>创建合约实例后，可以调用其方法或监听事件。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 假设已有合约实例</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> contract</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Contract</span><span style="color:#E1E4E8;">(contractAddress, erc20Abi, signer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> interactWithContract</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">    // 调用 view 函数（只读，不消耗 Gas）</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> name</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> contract.</span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> symbol</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> contract.</span><span style="color:#B392F0;">symbol</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> decimals</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> contract.</span><span style="color:#B392F0;">decimals</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`代币信息: \${</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">} (\${</span><span style="color:#E1E4E8;">symbol</span><span style="color:#9ECBFF;">})，精度: \${</span><span style="color:#E1E4E8;">decimals</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // 查询余额</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> address</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;0x742E4D6c9F1B2B5c44760d0447c43553e4543965&#39;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> balance</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> contract.</span><span style="color:#B392F0;">balanceOf</span><span style="color:#E1E4E8;">(address)</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;余额:&#39;</span><span style="color:#E1E4E8;">, ethers.</span><span style="color:#B392F0;">formatUnits</span><span style="color:#E1E4E8;">(balance, decimals), symbol)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // 调用状态修改函数（需要签名并消耗 Gas）</span></span>
<span class="line"><span style="color:#6A737D;">    // 注意：此操作会真实发送交易并改变链上状态</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> toAddress</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;0x1234567890123456789012345678901234567890&#39;</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> amount</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">parseUnits</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;1.5&#39;</span><span style="color:#E1E4E8;">, decimals) </span><span style="color:#6A737D;">// 转账 1.5 个代币</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> tx</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> contract.</span><span style="color:#B392F0;">transfer</span><span style="color:#E1E4E8;">(toAddress, amount)</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;转账交易已发送，哈希:&#39;</span><span style="color:#E1E4E8;">, tx.hash)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> receipt</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> tx.</span><span style="color:#B392F0;">wait</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;转账成功，所在区块:&#39;</span><span style="color:#E1E4E8;">, receipt.blockNumber)</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;交互出错:&#39;</span><span style="color:#E1E4E8;">, error)</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">interactWithContract</span><span style="color:#E1E4E8;">()</span></span></code></pre></div><h4 id="监听合约事件" tabindex="-1">监听合约事件 <a class="header-anchor" href="#监听合约事件" aria-label="Permalink to &quot;监听合约事件&quot;">​</a></h4><p>许多智能合约在状态改变时会发出事件，你可以监听这些事件以实时更新你的应用。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 假设已有合约实例</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> contract</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Contract</span><span style="color:#E1E4E8;">(contractAddress, erc20Abi, provider)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 监听 Transfer 事件</span></span>
<span class="line"><span style="color:#E1E4E8;">contract.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Transfer&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">from</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">to</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">amount</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`转账事件: 从 \${</span><span style="color:#E1E4E8;">from</span><span style="color:#9ECBFF;">} 到 \${</span><span style="color:#E1E4E8;">to</span><span style="color:#9ECBFF;">}, 金额: \${</span><span style="color:#E1E4E8;">amount</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;完整事件日志:&#39;</span><span style="color:#E1E4E8;">, event)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 也可以使用过滤器来监听特定地址的转账</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> filter</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> contract.filters.</span><span style="color:#B392F0;">Transfer</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#79B8FF;">  null</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &#39;0x742E4D6c9F1B2B5c44760d0447c43553e4543965&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">contract.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(filter, (</span><span style="color:#FFAB70;">from</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">to</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">amount</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`有代币转入目标地址: 从 \${</span><span style="color:#E1E4E8;">from</span><span style="color:#9ECBFF;">} 转入 \${</span><span style="color:#E1E4E8;">amount</span><span style="color:#9ECBFF;">} 个代币\`</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 在应用退出或需要清理时，移除监听器</span></span>
<span class="line"><span style="color:#6A737D;">// contract.removeAllListeners();</span></span></code></pre></div><h3 id="工具函数-api" tabindex="-1">工具函数 API <a class="header-anchor" href="#工具函数-api" aria-label="Permalink to &quot;工具函数 API&quot;">​</a></h3><p>ethers.js 提供了一系列实用的工具函数，用于处理数据格式转换、哈希计算和编码等常见任务。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 单位转换</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ethers.</span><span style="color:#B392F0;">formatEther</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;1000000000000000000&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">// 1.0 (wei 转换为 ETH)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ethers.</span><span style="color:#B392F0;">parseEther</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;1.5&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">// 1500000000000000000n (ETH 转换为 wei，返回 BigInt)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 格式化单位（适用于 ERC-20 代币）</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ethers.</span><span style="color:#B392F0;">formatUnits</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;1500000&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">// 1.5 (假设代币精度为 6)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ethers.</span><span style="color:#B392F0;">parseUnits</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;2.5&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">)) </span><span style="color:#6A737D;">// 2500000000000000000n</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 哈希计算</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> message</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;Hello, Ethereum!&#39;</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> messageHash</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">hashMessage</span><span style="color:#E1E4E8;">(message)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;消息哈希:&#39;</span><span style="color:#E1E4E8;">, messageHash)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 地址工具</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> address</span><span style="color:#F97583;"> =</span><span style="color:#9ECBFF;"> &#39;0x742e4d6c9f1b2b5c44760d0447c43553e4543965&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;地址校验和:&#39;</span><span style="color:#E1E4E8;">, ethers.</span><span style="color:#B392F0;">getAddress</span><span style="color:#E1E4E8;">(address)) </span><span style="color:#6A737D;">// 输出大小写正确的校验和格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 编码与解码</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> data</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ethers.AbiCoder.</span><span style="color:#B392F0;">defaultAbiCoder</span><span style="color:#E1E4E8;">().</span><span style="color:#B392F0;">encode</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">  [</span><span style="color:#9ECBFF;">&#39;string&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;uint256&#39;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">  [</span><span style="color:#9ECBFF;">&#39;Hello&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;编码数据:&#39;</span><span style="color:#E1E4E8;">, data)</span></span></code></pre></div><h2 id="实用技巧与最佳实践" tabindex="-1">实用技巧与最佳实践 <a class="header-anchor" href="#实用技巧与最佳实践" aria-label="Permalink to &quot;实用技巧与最佳实践&quot;">​</a></h2><h3 id="错误处理" tabindex="-1">错误处理 <a class="header-anchor" href="#错误处理" aria-label="Permalink to &quot;错误处理&quot;">​</a></h3><p>在与区块链交互时，适当的错误处理至关重要。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> safeTransaction</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> provider</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">JsonRpcProvider</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;https://sepolia.infura.io/v3/your-infura-project-id&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> wallet</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Wallet</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &#39;0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      provider</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    // 在发送交易前检查余额是否足够支付转账金额和 Gas 费</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> balance</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">getBalance</span><span style="color:#E1E4E8;">(wallet.address)</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> requiredBalance</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">parseEther</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;0.001&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (balance </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> requiredBalance) {</span></span>
<span class="line"><span style="color:#F97583;">      throw</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Error</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">        \`余额不足。当前余额: \${</span><span style="color:#E1E4E8;">ethers</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">formatEther</span><span style="color:#9ECBFF;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">          balance</span></span>
<span class="line"><span style="color:#9ECBFF;">        )</span><span style="color:#9ECBFF;">} ETH，需要至少: \${</span><span style="color:#E1E4E8;">ethers</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">formatEther</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">requiredBalance</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">} ETH\`</span></span>
<span class="line"><span style="color:#E1E4E8;">      )</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> tx</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> wallet.</span><span style="color:#B392F0;">sendTransaction</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">      to: </span><span style="color:#9ECBFF;">&#39;0x742E4D6c9F1B2B5c44760d0447c43553e4543965&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      value: ethers.</span><span style="color:#B392F0;">parseEther</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;0.001&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">    return</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> tx.</span><span style="color:#B392F0;">wait</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="color:#F97583;">    if</span><span style="color:#E1E4E8;"> (error.code </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;INSUFFICIENT_FUNDS&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;错误: 账户余额不足以支付交易&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (error.code </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;NETWORK_ERROR&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;错误: 网络连接问题，请检查提供者设置&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> (error.code </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;CALL_EXCEPTION&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;错误: 合约调用失败，可能函数不存在或参数错误&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;未知错误:&#39;</span><span style="color:#E1E4E8;">, error)</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">safeTransaction</span><span style="color:#E1E4E8;">()</span></span></code></pre></div><h3 id="gas-管理" tabindex="-1">Gas 管理 <a class="header-anchor" href="#gas-管理" aria-label="Permalink to &quot;Gas 管理&quot;">​</a></h3><p>合理设置 Gas 价格和 Gas 限制有助于交易更快确认并控制成本。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> { ethers } </span><span style="color:#F97583;">from</span><span style="color:#9ECBFF;"> &#39;ethers&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">async</span><span style="color:#F97583;"> function</span><span style="color:#B392F0;"> sendTransactionWithGasOptions</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> provider</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">JsonRpcProvider</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;https://sepolia.infura.io/v3/your-infura-project-id&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> wallet</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#E1E4E8;"> ethers.</span><span style="color:#B392F0;">Wallet</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    provider</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 获取当前 Gas 价格</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> feeData</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">getFeeData</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;当前 Gas 价格:&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    ethers.</span><span style="color:#B392F0;">formatUnits</span><span style="color:#E1E4E8;">(feeData.gasPrice, </span><span style="color:#9ECBFF;">&#39;gwei&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#9ECBFF;">    &#39;Gwei&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 估算 Gas 限制</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> transaction</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    to: </span><span style="color:#9ECBFF;">&#39;0x742E4D6c9F1B2B5c44760d0447c43553e4543965&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    value: ethers.</span><span style="color:#B392F0;">parseEther</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;0.001&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> estimatedGas</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> provider.</span><span style="color:#B392F0;">estimateGas</span><span style="color:#E1E4E8;">(transaction)</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;估算的 Gas 限制:&#39;</span><span style="color:#E1E4E8;">, estimatedGas.</span><span style="color:#B392F0;">toString</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 发送交易，自定义 Gas 设置</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> tx</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> wallet.</span><span style="color:#B392F0;">sendTransaction</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#F97583;">    ...</span><span style="color:#E1E4E8;">transaction,</span></span>
<span class="line"><span style="color:#E1E4E8;">    gasLimit: estimatedGas, </span><span style="color:#6A737D;">// 使用估算值，或稍增加一些余量</span></span>
<span class="line"><span style="color:#E1E4E8;">    gasPrice: feeData.gasPrice, </span><span style="color:#6A737D;">// 使用当前网络 Gas 价格</span></span>
<span class="line"><span style="color:#6A737D;">    // 对于 EIP-1559 交易，可以设置 maxFeePerGas 和 maxPriorityFeePerGas</span></span>
<span class="line"><span style="color:#6A737D;">    // maxFeePerGas: feeData.maxFeePerGas,</span></span>
<span class="line"><span style="color:#6A737D;">    // maxPriorityFeePerGas: feeData.maxPriorityFeePerGas</span></span>
<span class="line"><span style="color:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> tx.</span><span style="color:#B392F0;">wait</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">sendTransactionWithGasOptions</span><span style="color:#E1E4E8;">()</span></span></code></pre></div>`,66)])])}const d=a(o,[["render",e]]);export{F as __pageData,d as default};
