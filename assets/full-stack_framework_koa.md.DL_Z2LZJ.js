import{_ as a,c as n,o as l,b as p}from"./chunks/framework.CMLuPXeo.js";const F=JSON.parse('{"title":"Koa.js","description":"","frontmatter":{},"headers":[{"level":2,"title":"核心特性","slug":"核心特性","link":"#核心特性","children":[{"level":3,"title":"轻量级设计","slug":"轻量级设计","link":"#轻量级设计","children":[]},{"level":3,"title":"洋葱模型中间件","slug":"洋葱模型中间件","link":"#洋葱模型中间件","children":[]},{"level":3,"title":"异步处理优势","slug":"异步处理优势","link":"#异步处理优势","children":[]},{"level":3,"title":"上下文对象","slug":"上下文对象","link":"#上下文对象","children":[]}]},{"level":2,"title":"快速开始","slug":"快速开始","link":"#快速开始","children":[{"level":3,"title":"环境要求","slug":"环境要求","link":"#环境要求","children":[]},{"level":3,"title":"安装与创建基础应用","slug":"安装与创建基础应用","link":"#安装与创建基础应用","children":[]}]},{"level":2,"title":"中间件机制详解","slug":"中间件机制详解","link":"#中间件机制详解","children":[{"level":3,"title":"中间件基础","slug":"中间件基础","link":"#中间件基础","children":[]},{"level":3,"title":"洋葱模型实践","slug":"洋葱模型实践","link":"#洋葱模型实践","children":[]},{"level":3,"title":"错误处理中间件","slug":"错误处理中间件","link":"#错误处理中间件","children":[]}]},{"level":2,"title":"核心 API 与使用","slug":"核心-api-与使用","link":"#核心-api-与使用","children":[{"level":3,"title":"Koa 应用实例","slug":"koa-应用实例","link":"#koa-应用实例","children":[]},{"level":3,"title":"上下文 Context","slug":"上下文-context","link":"#上下文-context","children":[]},{"level":3,"title":"请求 Request 对象","slug":"请求-request-对象","link":"#请求-request-对象","children":[]},{"level":3,"title":"响应 Response 对象","slug":"响应-response-对象","link":"#响应-response-对象","children":[]}]},{"level":2,"title":"常用中间件与扩展","slug":"常用中间件与扩展","link":"#常用中间件与扩展","children":[{"level":3,"title":"路由处理 - koa-router","slug":"路由处理-koa-router","link":"#路由处理-koa-router","children":[]},{"level":3,"title":"请求体解析 - koa-bodyparser","slug":"请求体解析-koa-bodyparser","link":"#请求体解析-koa-bodyparser","children":[]},{"level":3,"title":"静态文件服务 - koa-static","slug":"静态文件服务-koa-static","link":"#静态文件服务-koa-static","children":[]},{"level":3,"title":"文件上传 - koa-multer","slug":"文件上传-koa-multer","link":"#文件上传-koa-multer","children":[]}]},{"level":2,"title":"项目结构与最佳实践","slug":"项目结构与最佳实践","link":"#项目结构与最佳实践","children":[{"level":3,"title":"典型项目结构","slug":"典型项目结构","link":"#典型项目结构","children":[]},{"level":3,"title":"模块化路由示例","slug":"模块化路由示例","link":"#模块化路由示例","children":[]},{"level":3,"title":"认证中间件示例","slug":"认证中间件示例","link":"#认证中间件示例","children":[]}]}],"relativePath":"full-stack/framework/koa.md","filePath":"full-stack/framework/koa.md"}'),o={name:"full-stack/framework/koa.md"};function e(t,s,c,r,E,y){return l(),n("div",null,[...s[0]||(s[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /full-stack/framework/koa.md for this page in Markdown format</div><h1 id="koa-js" tabindex="-1">Koa.js <a class="header-anchor" href="#koa-js" aria-label="Permalink to &quot;Koa.js&quot;">​</a></h1><p>Koa.js 是一个基于 Node.js 平台的下一代 Web 开发框架，由 Express 原班人马打造。它旨在提供一个更小型、更富有表现力、更健壮的 Web 开发基础和 API。Koa 的核心思想是利用 async/await 彻底解决 Node.js 中的回调地狱问题，通过强大的中间件机制让 Web 开发变得更加简单和优雅。</p><h2 id="核心特性" tabindex="-1">核心特性 <a class="header-anchor" href="#核心特性" aria-label="Permalink to &quot;核心特性&quot;">​</a></h2><h3 id="轻量级设计" tabindex="-1">轻量级设计 <a class="header-anchor" href="#轻量级设计" aria-label="Permalink to &quot;轻量级设计&quot;">​</a></h3><p>Koa 本身非常精简，不包含任何内置的路由、模板引擎等功能。这种极简主义设计使得 Koa 的核心代码量仅有约 570 行，开发者可以根据需要灵活地通过第三方中间件添加功能，避免了功能冗余。</p><h3 id="洋葱模型中间件" tabindex="-1">洋葱模型中间件 <a class="header-anchor" href="#洋葱模型中间件" aria-label="Permalink to &quot;洋葱模型中间件&quot;">​</a></h3><p>Koa 最著名的特性就是其洋葱模型中间件机制。中间件按照“先进后出”的原则执行，类似洋葱的结构，请求从外到内传递，响应再从内到外返回。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>请求流向:</span></span>
<span class="line"><span>→ 中间件1 → 中间件2 → 中间件3 → 核心处理 → 中间件3 → 中间件2 → 中间件1 → 响应</span></span></code></pre></div><p>这种模型允许在请求和响应阶段都能执行逻辑，非常适合日志记录、性能监控、权限校验等通用功能。</p><h3 id="异步处理优势" tabindex="-1">异步处理优势 <a class="header-anchor" href="#异步处理优势" aria-label="Permalink to &quot;异步处理优势&quot;">​</a></h3><p>Koa 完全基于 async/await 实现，从根源上解决了回调地狱问题。相比传统的回调函数或 Promise 链，async/await 让异步代码看起来更像是同步的，大大提高了代码的可读性和可维护性。</p><h3 id="上下文对象" tabindex="-1">上下文对象 <a class="header-anchor" href="#上下文对象" aria-label="Permalink to &quot;上下文对象&quot;">​</a></h3><p>Koa 为每个请求创建一个 Context 对象，封装了 Node.js 的 request 和 response 对象。这个上下文对象提供了许多便利的方法和属性，同时保持了简洁的 API 设计。</p><h2 id="快速开始" tabindex="-1">快速开始 <a class="header-anchor" href="#快速开始" aria-label="Permalink to &quot;快速开始&quot;">​</a></h2><h3 id="环境要求" tabindex="-1">环境要求 <a class="header-anchor" href="#环境要求" aria-label="Permalink to &quot;环境要求&quot;">​</a></h3><p>Koa 需要 Node.js 7.6.0 或更高版本，这是为了支持 ES2015 和 async 函数功能。推荐使用 Node.js 14+ LTS 版本。</p><h3 id="安装与创建基础应用" tabindex="-1">安装与创建基础应用 <a class="header-anchor" href="#安装与创建基础应用" aria-label="Permalink to &quot;安装与创建基础应用&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 创建项目目录</span></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#9ECBFF;"> koa-demo</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#79B8FF;">cd</span><span style="color:#9ECBFF;"> koa-demo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 初始化 npm 项目</span></span>
<span class="line"><span style="color:#B392F0;">npm</span><span style="color:#9ECBFF;"> init</span><span style="color:#79B8FF;"> -y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 安装 Koa</span></span>
<span class="line"><span style="color:#B392F0;">npm</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> koa</span></span></code></pre></div><p>创建 <code>app.js</code> 文件：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Koa</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> app</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Koa</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 基础中间件示例</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">next</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> start</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;中间件开始&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 调用下一个中间件</span></span>
<span class="line"><span style="color:#F97583;">  await</span><span style="color:#B392F0;"> next</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> ms</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> Date.</span><span style="color:#B392F0;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> start;</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`中间件结束 - 耗时 \${</span><span style="color:#E1E4E8;">ms</span><span style="color:#9ECBFF;">}ms\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 响应处理中间件</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.status </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 200</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.type </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;text/html&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;&lt;h1&gt;Hello Koa.js&lt;/h1&gt;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 启动服务器</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> port</span><span style="color:#F97583;"> =</span><span style="color:#79B8FF;"> 3000</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;">(port, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`Koa服务已启动，访问地址：http://localhost:\${</span><span style="color:#E1E4E8;">port</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><p>运行应用：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">node</span><span style="color:#9ECBFF;"> app.js</span></span></code></pre></div><h2 id="中间件机制详解" tabindex="-1">中间件机制详解 <a class="header-anchor" href="#中间件机制详解" aria-label="Permalink to &quot;中间件机制详解&quot;">​</a></h2><h3 id="中间件基础" tabindex="-1">中间件基础 <a class="header-anchor" href="#中间件基础" aria-label="Permalink to &quot;中间件基础&quot;">​</a></h3><p>在 Koa 中，中间件是一个函数，接收 ctx (上下文) 和 next (下一个中间件函数) 两个参数。当中间件调用 <code>await next()</code> 时，执行流会暂停当前中间件，将控制权交给下一个中间件。</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">next</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // 请求阶段逻辑</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Before next()&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  await</span><span style="color:#B392F0;"> next</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 响应阶段逻辑</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;After next()&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="洋葱模型实践" tabindex="-1">洋葱模型实践 <a class="header-anchor" href="#洋葱模型实践" aria-label="Permalink to &quot;洋葱模型实践&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">next</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;中间件1 - 开始&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">  await</span><span style="color:#B392F0;"> next</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;中间件1 - 结束&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">next</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;中间件2 - 开始&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">  await</span><span style="color:#B392F0;"> next</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;中间件2 - 结束&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;核心业务逻辑&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;Hello World&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 执行顺序输出:</span></span>
<span class="line"><span style="color:#6A737D;">// 中间件1 - 开始</span></span>
<span class="line"><span style="color:#6A737D;">// 中间件2 - 开始</span></span>
<span class="line"><span style="color:#6A737D;">// 核心业务逻辑</span></span>
<span class="line"><span style="color:#6A737D;">// 中间件2 - 结束</span></span>
<span class="line"><span style="color:#6A737D;">// 中间件1 - 结束</span></span></code></pre></div><h3 id="错误处理中间件" tabindex="-1">错误处理中间件 <a class="header-anchor" href="#错误处理中间件" aria-label="Permalink to &quot;错误处理中间件&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// 错误处理中间件</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">next</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#B392F0;"> next</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.status </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> err.statusCode </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> err.status </span><span style="color:#F97583;">||</span><span style="color:#79B8FF;"> 500</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      message: err.message</span></span>
<span class="line"><span style="color:#E1E4E8;">    };</span></span>
<span class="line"><span style="color:#6A737D;">    // 触发应用的错误事件</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.app.</span><span style="color:#B392F0;">emit</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, err, ctx);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 统一错误事件监听</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;error&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;服务器错误:&#39;</span><span style="color:#E1E4E8;">, err, ctx);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h2 id="核心-api-与使用" tabindex="-1">核心 API 与使用 <a class="header-anchor" href="#核心-api-与使用" aria-label="Permalink to &quot;核心 API 与使用&quot;">​</a></h2><h3 id="koa-应用实例" tabindex="-1">Koa 应用实例 <a class="header-anchor" href="#koa-应用实例" aria-label="Permalink to &quot;Koa 应用实例&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Koa</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> app</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Koa</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 应用属性配置</span></span>
<span class="line"><span style="color:#E1E4E8;">app.proxy </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 信任代理头部</span></span>
<span class="line"><span style="color:#E1E4E8;">app.keys </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;secret-key&#39;</span><span style="color:#E1E4E8;">]; </span><span style="color:#6A737D;">// 签名 cookie 密钥</span></span></code></pre></div><h3 id="上下文-context" tabindex="-1">上下文 Context <a class="header-anchor" href="#上下文-context" aria-label="Permalink to &quot;上下文 Context&quot;">​</a></h3><p>Context 封装了 request 和 response 对象，并提供了许多有用的方法：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // 请求信息</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ctx.method); </span><span style="color:#6A737D;">// HTTP 方法</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ctx.url); </span><span style="color:#6A737D;">// 请求 URL</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ctx.query); </span><span style="color:#6A737D;">// 查询参数</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ctx.headers); </span><span style="color:#6A737D;">// 请求头</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 响应控制</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.status </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 200</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 状态码</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.type </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;application/json&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 内容类型</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { message: </span><span style="color:#9ECBFF;">&#39;Success&#39;</span><span style="color:#E1E4E8;"> }; </span><span style="color:#6A737D;">// 响应体</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.</span><span style="color:#B392F0;">redirect</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/new-path&#39;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 重定向</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.</span><span style="color:#B392F0;">throw</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">404</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;资源未找到&#39;</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// 抛出错误</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 上下文快捷方式</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ctx.state); </span><span style="color:#6A737D;">// 推荐的命名空间，用于通过中间件传递信息</span></span>
<span class="line"><span style="color:#E1E4E8;">  console.</span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">(ctx.cookies); </span><span style="color:#6A737D;">// cookie 操作</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="请求-request-对象" tabindex="-1">请求 Request 对象 <a class="header-anchor" href="#请求-request-对象" aria-label="Permalink to &quot;请求 Request 对象&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // 请求属性访问</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> method</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.method;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> url</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.url;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> header</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.header;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> origin</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.origin;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 请求体处理</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> body</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.body;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> query</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.query;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> querystring</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.querystring;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 内容协商</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> accepts</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.</span><span style="color:#B392F0;">accepts</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;json&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;html&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> type</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.type;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // IP 获取</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> ip</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.request.ip;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="响应-response-对象" tabindex="-1">响应 Response 对象 <a class="header-anchor" href="#响应-response-对象" aria-label="Permalink to &quot;响应 Response 对象&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // 响应状态设置</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.status </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 201</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 响应头设置</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;X-Custom-Header&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;value&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.type </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;application/json&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 响应体设置</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { data: </span><span style="color:#9ECBFF;">&#39;example&#39;</span><span style="color:#E1E4E8;"> };</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;Hello World&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.body </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;fs&#39;</span><span style="color:#E1E4E8;">).</span><span style="color:#B392F0;">createReadStream</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;file.txt&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 重定向</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.</span><span style="color:#B392F0;">redirect</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/new-location&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">  // 附件下载</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.response.</span><span style="color:#B392F0;">attachment</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;file.pdf&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h2 id="常用中间件与扩展" tabindex="-1">常用中间件与扩展 <a class="header-anchor" href="#常用中间件与扩展" aria-label="Permalink to &quot;常用中间件与扩展&quot;">​</a></h2><h3 id="路由处理-koa-router" tabindex="-1">路由处理 - koa-router <a class="header-anchor" href="#路由处理-koa-router" aria-label="Permalink to &quot;路由处理 - koa-router&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Koa</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Router</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa-router&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> app</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Koa</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> router</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Router</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 基础路由</span></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;首页&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 参数路由</span></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/users/:id&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`用户 ID: \${</span><span style="color:#E1E4E8;">ctx</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">params</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">id</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 嵌套路由</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> postsRouter</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Router</span><span style="color:#E1E4E8;">({ prefix: </span><span style="color:#9ECBFF;">&#39;/posts&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#E1E4E8;">postsRouter.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> &#39;文章列表&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"><span style="color:#E1E4E8;">postsRouter.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/:id/comments&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`文章 \${</span><span style="color:#E1E4E8;">ctx</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">params</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">id</span><span style="color:#9ECBFF;">} 的评论\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 注册路由</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(router.</span><span style="color:#B392F0;">routes</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(router.</span><span style="color:#B392F0;">allowedMethods</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(postsRouter.</span><span style="color:#B392F0;">routes</span><span style="color:#E1E4E8;">());</span></span></code></pre></div><h3 id="请求体解析-koa-bodyparser" tabindex="-1">请求体解析 - koa-bodyparser <a class="header-anchor" href="#请求体解析-koa-bodyparser" aria-label="Permalink to &quot;请求体解析 - koa-bodyparser&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Koa</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> bodyParser</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa-bodyparser&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> app</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Koa</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">bodyParser</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#6A737D;">  // 解析 JSON、form-urlencoded 请求体</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (ctx.method </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;POST&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">email</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ctx.request.body;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { received: { name, email } };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><h3 id="静态文件服务-koa-static" tabindex="-1">静态文件服务 - koa-static <a class="header-anchor" href="#静态文件服务-koa-static" aria-label="Permalink to &quot;静态文件服务 - koa-static&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Koa</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> serve</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa-static&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> app</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Koa</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 提供静态文件服务</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">serve</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;public&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 多个静态目录</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">serve</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;uploads&#39;</span><span style="color:#E1E4E8;">));</span></span></code></pre></div><h3 id="文件上传-koa-multer" tabindex="-1">文件上传 - koa-multer <a class="header-anchor" href="#文件上传-koa-multer" aria-label="Permalink to &quot;文件上传 - koa-multer&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Koa</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Router</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa-router&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> multer</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa-multer&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> app</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Koa</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> router</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Router</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> upload</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> multer</span><span style="color:#E1E4E8;">({ dest: </span><span style="color:#9ECBFF;">&#39;uploads/&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 单文件上传</span></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">post</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/upload&#39;</span><span style="color:#E1E4E8;">, upload.</span><span style="color:#B392F0;">single</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;file&#39;</span><span style="color:#E1E4E8;">), (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    filename: ctx.req.file.filename,</span></span>
<span class="line"><span style="color:#E1E4E8;">    originalname: ctx.req.file.originalname</span></span>
<span class="line"><span style="color:#E1E4E8;">  };</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 多文件上传</span></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">post</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/photos&#39;</span><span style="color:#E1E4E8;">, upload.</span><span style="color:#B392F0;">array</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;photos&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">), (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;"> \`成功上传 \${</span><span style="color:#E1E4E8;">ctx</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">req</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">files</span><span style="color:#9ECBFF;">.</span><span style="color:#79B8FF;">length</span><span style="color:#9ECBFF;">} 个文件\`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(router.</span><span style="color:#B392F0;">routes</span><span style="color:#E1E4E8;">());</span></span></code></pre></div><h2 id="项目结构与最佳实践" tabindex="-1">项目结构与最佳实践 <a class="header-anchor" href="#项目结构与最佳实践" aria-label="Permalink to &quot;项目结构与最佳实践&quot;">​</a></h2><h3 id="典型项目结构" tabindex="-1">典型项目结构 <a class="header-anchor" href="#典型项目结构" aria-label="Permalink to &quot;典型项目结构&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>koa-project/</span></span>
<span class="line"><span>├── app.js                 # 应用入口</span></span>
<span class="line"><span>├── package.json</span></span>
<span class="line"><span>├── config/               # 配置文件</span></span>
<span class="line"><span>│   └── index.js</span></span>
<span class="line"><span>├── src/</span></span>
<span class="line"><span>│   ├── controllers/      # 控制器</span></span>
<span class="line"><span>│   ├── models/           # 数据模型</span></span>
<span class="line"><span>│   ├── routes/           # 路由定义</span></span>
<span class="line"><span>│   ├── middleware/       # 自定义中间件</span></span>
<span class="line"><span>│   └── utils/            # 工具函数</span></span>
<span class="line"><span>├── public/               # 静态资源</span></span>
<span class="line"><span>└── uploads/              # 上传文件</span></span></code></pre></div><h3 id="模块化路由示例" tabindex="-1">模块化路由示例 <a class="header-anchor" href="#模块化路由示例" aria-label="Permalink to &quot;模块化路由示例&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// routes/users.js</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> Router</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;koa-router&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> router</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> new</span><span style="color:#B392F0;"> Router</span><span style="color:#E1E4E8;">({ prefix: </span><span style="color:#9ECBFF;">&#39;/users&#39;</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> users</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> UserModel.</span><span style="color:#B392F0;">findAll</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> users;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/:id&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> user</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> UserModel.</span><span style="color:#B392F0;">findById</span><span style="color:#E1E4E8;">(ctx.params.id);</span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">user) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.</span><span style="color:#B392F0;">throw</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">404</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;用户不存在&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> user;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">post</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">email</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ctx.request.body;</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> user</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> UserModel.</span><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;">({ name, email });</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.status </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> 201</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> user;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">exports</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> router;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// app.js 中注册路由</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> userRoutes</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;./routes/users&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">app.</span><span style="color:#B392F0;">use</span><span style="color:#E1E4E8;">(userRoutes.</span><span style="color:#B392F0;">routes</span><span style="color:#E1E4E8;">());</span></span></code></pre></div><h3 id="认证中间件示例" tabindex="-1">认证中间件示例 <a class="header-anchor" href="#认证中间件示例" aria-label="Permalink to &quot;认证中间件示例&quot;">​</a></h3><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// middleware/auth.js</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> jwt</span><span style="color:#F97583;"> =</span><span style="color:#B392F0;"> require</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;jsonwebtoken&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#B392F0;"> auth</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">next</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#79B8FF;"> token</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> ctx.headers.authorization?.</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Bearer &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">token) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.</span><span style="color:#B392F0;">throw</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">401</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;访问被拒绝，缺少令牌&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">  try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    const</span><span style="color:#79B8FF;"> decoded</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> jwt.</span><span style="color:#B392F0;">verify</span><span style="color:#E1E4E8;">(token, process.env.</span><span style="color:#79B8FF;">JWT_SECRET</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.state.user </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> decoded;</span></span>
<span class="line"><span style="color:#F97583;">    await</span><span style="color:#B392F0;"> next</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    ctx.</span><span style="color:#B392F0;">throw</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">401</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;无效的令牌&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">exports</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> auth;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 使用认证中间件</span></span>
<span class="line"><span style="color:#E1E4E8;">router.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/profile&#39;</span><span style="color:#E1E4E8;">, auth, </span><span style="color:#F97583;">async</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">ctx</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ctx.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    user: ctx.state.user,</span></span>
<span class="line"><span style="color:#E1E4E8;">    message: </span><span style="color:#9ECBFF;">&#39;这是受保护的用户资料&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  };</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre></div><p>Koa.js 通过其精巧的设计和强大的中间件机制，为现代 Node.js Web 开发提供了优雅的解决方案。其洋葱模型和基于 async/await 的异步处理让复杂应用的开发变得更加简单和可维护，而丰富的中间件生态系统则确保了框架的灵活性和扩展性。</p>`,58)])])}const d=a(o,[["render",e]]);export{F as __pageData,d as default};
