import{_ as a,c as n,o as e,b as l}from"./chunks/framework.CMLuPXeo.js";const h=JSON.parse('{"title":"React Fiber","description":"","frontmatter":{},"headers":[{"level":2,"title":"什么是 Fiber？","slug":"什么是-fiber","link":"#什么是-fiber","children":[]},{"level":2,"title":"Fiber 的基本原理","slug":"fiber-的基本原理","link":"#fiber-的基本原理","children":[{"level":3,"title":"传统 Stack Reconciler 的问题","slug":"传统-stack-reconciler-的问题","link":"#传统-stack-reconciler-的问题","children":[]},{"level":3,"title":"Fiber 架构的解决方案","slug":"fiber-架构的解决方案","link":"#fiber-架构的解决方案","children":[]}]},{"level":2,"title":"React 不同版本的 Fiber 演进","slug":"react-不同版本的-fiber-演进","link":"#react-不同版本的-fiber-演进","children":[{"level":3,"title":"React 16：Fiber 架构引入","slug":"react-16-fiber-架构引入","link":"#react-16-fiber-架构引入","children":[]},{"level":3,"title":"React 17：渐进式升级","slug":"react-17-渐进式升级","link":"#react-17-渐进式升级","children":[]},{"level":3,"title":"React 18：并发特性","slug":"react-18-并发特性","link":"#react-18-并发特性","children":[]},{"level":3,"title":"React 19：编译时优化","slug":"react-19-编译时优化","link":"#react-19-编译时优化","children":[]}]},{"level":2,"title":"Fiber 工作流程详解","slug":"fiber-工作流程详解","link":"#fiber-工作流程详解","children":[{"level":3,"title":"协调阶段 (Reconciliation Phase)","slug":"协调阶段-reconciliation-phase","link":"#协调阶段-reconciliation-phase","children":[]},{"level":3,"title":"提交阶段 (Commit Phase)","slug":"提交阶段-commit-phase","link":"#提交阶段-commit-phase","children":[]},{"level":3,"title":"优先级调度","slug":"优先级调度","link":"#优先级调度","children":[]}]},{"level":2,"title":"效果对比","slug":"效果对比","link":"#效果对比","children":[{"level":3,"title":"同步渲染 vs 并发渲染","slug":"同步渲染-vs-并发渲染","link":"#同步渲染-vs-并发渲染","children":[]},{"level":3,"title":"实际应用示例","slug":"实际应用示例","link":"#实际应用示例","children":[]}]}],"relativePath":"framework/react/fiber.md","filePath":"framework/react/fiber.md"}'),p={name:"framework/react/fiber.md"};function t(o,s,c,i,r,d){return e(),n("div",null,[...s[0]||(s[0]=[l(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /framework/react/fiber.md for this page in Markdown format</div><h1 id="react-fiber" tabindex="-1">React Fiber <a class="header-anchor" href="#react-fiber" aria-label="Permalink to &quot;React Fiber&quot;">​</a></h1><h2 id="什么是-fiber" tabindex="-1">什么是 Fiber？ <a class="header-anchor" href="#什么是-fiber" aria-label="Permalink to &quot;什么是 Fiber？&quot;">​</a></h2><p>Fiber 是 React 16 引入的新的协调引擎 (reconciliation engine)，它的核心目标是支持增量渲染，将渲染工作拆分成多个小任务，并赋予不同优先级，从而实现更流畅的用户体验。</p><h2 id="fiber-的基本原理" tabindex="-1">Fiber 的基本原理 <a class="header-anchor" href="#fiber-的基本原理" aria-label="Permalink to &quot;Fiber 的基本原理&quot;">​</a></h2><h3 id="传统-stack-reconciler-的问题" tabindex="-1">传统 Stack Reconciler 的问题 <a class="header-anchor" href="#传统-stack-reconciler-的问题" aria-label="Permalink to &quot;传统 Stack Reconciler 的问题&quot;">​</a></h3><p>React 15 及之前版本使用 Stack Reconciler：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>[组件A]</span></span>
<span class="line"><span>    ↓ 递归</span></span>
<span class="line"><span>[组件B] → [组件C]</span></span>
<span class="line"><span>    ↓      ↓</span></span>
<span class="line"><span>[组件D] [组件E] → [组件F]</span></span></code></pre></div><p>问题：一旦开始渲染，就无法中断，可能导致界面卡顿。</p><h3 id="fiber-架构的解决方案" tabindex="-1">Fiber 架构的解决方案 <a class="header-anchor" href="#fiber-架构的解决方案" aria-label="Permalink to &quot;Fiber 架构的解决方案&quot;">​</a></h3><p>Fiber 将组件表示为链表结构，支持中断和恢复：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>组件A → 组件B → 组件D → 组件C → 组件E → 组件F</span></span>
<span class="line"><span>  ↓       ↓       ↓       ↓       ↓       ↓</span></span>
<span class="line"><span> next   next   next   next   next   next</span></span></code></pre></div><p>每个 Fiber 节点包含：</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#B392F0;">  type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;div&#39;</span><span style="color:#F97583;"> |</span><span style="color:#E1E4E8;"> ComponentType,</span></span>
<span class="line"><span style="color:#B392F0;">  key</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">null</span><span style="color:#F97583;"> |</span><span style="color:#E1E4E8;"> string,</span></span>
<span class="line"><span style="color:#B392F0;">  child</span><span style="color:#E1E4E8;">: Fiber </span><span style="color:#F97583;">|</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">,      </span><span style="color:#6A737D;">// 第一个子节点</span></span>
<span class="line"><span style="color:#B392F0;">  sibling</span><span style="color:#E1E4E8;">: Fiber </span><span style="color:#F97583;">|</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">,    </span><span style="color:#6A737D;">// 下一个兄弟节点</span></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;">: Fiber </span><span style="color:#F97583;">|</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">,     </span><span style="color:#6A737D;">// 父节点</span></span>
<span class="line"><span style="color:#B392F0;">  alternate</span><span style="color:#E1E4E8;">: Fiber </span><span style="color:#F97583;">|</span><span style="color:#79B8FF;"> null</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">// 用于双缓存</span></span>
<span class="line"><span style="color:#B392F0;">  effectTag</span><span style="color:#E1E4E8;">: Placement </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> Update </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> Deletion,</span></span>
<span class="line"><span style="color:#B392F0;">  stateNode</span><span style="color:#E1E4E8;">: DOM节点 </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> 组件实例,</span></span>
<span class="line"><span style="color:#B392F0;">  memoizedProps</span><span style="color:#E1E4E8;">: props,</span></span>
<span class="line"><span style="color:#B392F0;">  memoizedState</span><span style="color:#E1E4E8;">: state,</span></span>
<span class="line"><span style="color:#6A737D;">  // ... 其他属性</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div><h2 id="react-不同版本的-fiber-演进" tabindex="-1">React 不同版本的 Fiber 演进 <a class="header-anchor" href="#react-不同版本的-fiber-演进" aria-label="Permalink to &quot;React 不同版本的 Fiber 演进&quot;">​</a></h2><h3 id="react-16-fiber-架构引入" tabindex="-1">React 16：Fiber 架构引入 <a class="header-anchor" href="#react-16-fiber-架构引入" aria-label="Permalink to &quot;React 16：Fiber 架构引入&quot;">​</a></h3><p><strong>更新方式</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>当前树 (Current) ↔ 工作进度树 (WorkInProgress)</span></span>
<span class="line"><span>      ↓</span></span>
<span class="line"><span>  双缓存切换</span></span></code></pre></div><p><strong>渲染流程</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>1. 开始渲染</span></span>
<span class="line"><span>   ↓</span></span>
<span class="line"><span>2. 创建 WorkInProgress 树</span></span>
<span class="line"><span>   ↓</span></span>
<span class="line"><span>3. 协调阶段 (可中断)</span></span>
<span class="line"><span>   |-- 处理组件更新</span></span>
<span class="line"><span>   |-- 标记副作用</span></span>
<span class="line"><span>   ↓</span></span>
<span class="line"><span>4. 提交阶段 (不可中断)</span></span>
<span class="line"><span>   |-- 执行 DOM 操作</span></span>
<span class="line"><span>   |-- 调用生命周期</span></span></code></pre></div><p><strong>效果</strong>：支持时间分片，避免主线程阻塞。</p><h3 id="react-17-渐进式升级" tabindex="-1">React 17：渐进式升级 <a class="header-anchor" href="#react-17-渐进式升级" aria-label="Permalink to &quot;React 17：渐进式升级&quot;">​</a></h3><p><strong>更新改进</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>事件委托变更：</span></span>
<span class="line"><span>document → React 树的根容器</span></span></code></pre></div><p><strong>Fiber 结构优化</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>组件树</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Fiber 树 (更稳定的内部实例)</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>DOM 树</span></span></code></pre></div><p><strong>效果</strong>：更好的多版本 React 共存支持。</p><h3 id="react-18-并发特性" tabindex="-1">React 18：并发特性 <a class="header-anchor" href="#react-18-并发特性" aria-label="Permalink to &quot;React 18：并发特性&quot;">​</a></h3><p><strong>并发渲染</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>高优先级更新: █████████ 立即执行</span></span>
<span class="line"><span>低优先级更新: ░░░░░░░░░ 可中断</span></span></code></pre></div><p><strong>自动批处理</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>// React 17: 只在事件处理中批处理</span></span>
<span class="line"><span>setState1() → 渲染</span></span>
<span class="line"><span>setState2() → 渲染</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// React 18: 更多场景批处理</span></span>
<span class="line"><span>setState1() → 一次渲染</span></span>
<span class="line"><span>setState2() ┘</span></span></code></pre></div><p><strong>新的 API</strong>：</p><ul><li><code>startTransition</code>：标记非紧急更新</li><li><code>useTransition</code>：并发状态管理</li><li><code>useDeferredValue</code>：延迟值更新</li></ul><h3 id="react-19-编译时优化" tabindex="-1">React 19：编译时优化 <a class="header-anchor" href="#react-19-编译时优化" aria-label="Permalink to &quot;React 19：编译时优化&quot;">​</a></h3><p><strong>预期改进</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>编译前: &lt;Component prop={value} /&gt;</span></span>
<span class="line"><span>编译后: 优化的 Fiber 结构 + 记忆化策略</span></span></code></pre></div><p><strong>资源管理</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>组件卸载 → 自动清理资源</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>useEffect 返回值的标准化处理</span></span></code></pre></div><h2 id="fiber-工作流程详解" tabindex="-1">Fiber 工作流程详解 <a class="header-anchor" href="#fiber-工作流程详解" aria-label="Permalink to &quot;Fiber 工作流程详解&quot;">​</a></h2><h3 id="协调阶段-reconciliation-phase" tabindex="-1">协调阶段 (Reconciliation Phase) <a class="header-anchor" href="#协调阶段-reconciliation-phase" aria-label="Permalink to &quot;协调阶段 (Reconciliation Phase)&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>当前 Fiber 树: A → B → D → C → E</span></span>
<span class="line"><span>    ↓ 开始更新</span></span>
<span class="line"><span>工作进度树: A&#39; → B&#39; → D&#39; → C&#39; → E&#39;</span></span>
<span class="line"><span>    ↓ 可中断位置</span></span>
<span class="line"><span>协调完成，准备提交</span></span></code></pre></div><h3 id="提交阶段-commit-phase" tabindex="-1">提交阶段 (Commit Phase) <a class="header-anchor" href="#提交阶段-commit-phase" aria-label="Permalink to &quot;提交阶段 (Commit Phase)&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>提交前: 当前树 A-B-D-C-E</span></span>
<span class="line"><span>    ↓ 不可中断</span></span>
<span class="line"><span>副作用列表: [放置B&#39;, 更新D&#39;, 删除C]</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>提交后: 新树 A&#39;-B&#39;-D&#39;-E&#39;</span></span></code></pre></div><h3 id="优先级调度" tabindex="-1">优先级调度 <a class="header-anchor" href="#优先级调度" aria-label="Permalink to &quot;优先级调度&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>优先级: Immediate → UserBlocking → Normal → Low → Idle</span></span>
<span class="line"><span>          ↓           ↓           ↓       ↓      ↓</span></span>
<span class="line"><span>       立即执行   用户交互后   普通更新   低优先级  空闲时</span></span></code></pre></div><h2 id="效果对比" tabindex="-1">效果对比 <a class="header-anchor" href="#效果对比" aria-label="Permalink to &quot;效果对比&quot;">​</a></h2><h3 id="同步渲染-vs-并发渲染" tabindex="-1">同步渲染 vs 并发渲染 <a class="header-anchor" href="#同步渲染-vs-并发渲染" aria-label="Permalink to &quot;同步渲染 vs 并发渲染&quot;">​</a></h3><p><strong>同步模式</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>渲染任务: ████████████████████████</span></span>
<span class="line"><span>主线程:   被完全阻塞 50ms</span></span></code></pre></div><p><strong>并发模式</strong>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>渲染任务: ████░░████░░████░░████░░</span></span>
<span class="line"><span>主线程:   可响应交互，总时间 60ms 但无卡顿</span></span></code></pre></div><h3 id="实际应用示例" tabindex="-1">实际应用示例 <a class="header-anchor" href="#实际应用示例" aria-label="Permalink to &quot;实际应用示例&quot;">​</a></h3><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// React 18 并发特性使用</span></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> SearchComponent</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">setQuery</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> useState</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">results</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">setResults</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#B392F0;"> useState</span><span style="color:#E1E4E8;">([])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  // 使用 startTransition 标记非紧急更新</span></span>
<span class="line"><span style="color:#F97583;">  const</span><span style="color:#B392F0;"> handleSearch</span><span style="color:#F97583;"> =</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">value</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">    setQuery</span><span style="color:#E1E4E8;">(value) </span><span style="color:#6A737D;">// 紧急更新：立即显示输入内容</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">    startTransition</span><span style="color:#E1E4E8;">(() </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#B392F0;">      setResults</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">filterResults</span><span style="color:#E1E4E8;">(value)) </span><span style="color:#6A737D;">// 非紧急更新：可中断的搜索结果更新</span></span>
<span class="line"><span style="color:#E1E4E8;">    })</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">  return</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    &lt;</span><span style="color:#85E89D;">input</span><span style="color:#B392F0;"> value</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{query} </span><span style="color:#B392F0;">onChange</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{(</span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#B392F0;"> handleSearch</span><span style="color:#E1E4E8;">(e.target.value)} /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre></div>`,54)])])}const u=a(p,[["render",t]]);export{h as __pageData,u as default};
