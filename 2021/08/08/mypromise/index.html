<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fengyg.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="根据promise A+写自己的promise废话不多说 1 ) promise a+测试工具1npm init -y &amp;&amp; npm install promises-aplus-tests -D  2 ) 新建promise.js,放入以下内容123456789101112131415161718192021222324252627282930313233343536373839">
<meta property="og:type" content="article">
<meta property="og:title" content="mypromise">
<meta property="og:url" content="http://fengyg.top/2021/08/08/mypromise/index.html">
<meta property="og:site_name" content="博客">
<meta property="og:description" content="根据promise A+写自己的promise废话不多说 1 ) promise a+测试工具1npm init -y &amp;&amp; npm install promises-aplus-tests -D  2 ) 新建promise.js,放入以下内容123456789101112131415161718192021222324252627282930313233343536373839">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808145033895.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808112937448.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808113024868.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808120600261.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808120648157.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808133200574.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808133400566.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808133817098.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808135115530.png">
<meta property="og:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808174610443.png">
<meta property="article:published_time" content="2021-08-08T09:54:09.000Z">
<meta property="article:modified_time" content="2022-06-26T11:36:41.696Z">
<meta property="article:author" content="fyg">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://fengyg.top/2021/08/08/images/promise/image-20210808145033895.png">

<link rel="canonical" href="http://fengyg.top/2021/08/08/mypromise/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mypromise | 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://fengyg.top/2021/08/08/mypromise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="fyg">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mypromise
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-08 17:54:09" itemprop="dateCreated datePublished" datetime="2021-08-08T17:54:09+08:00">2021-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-26 19:36:41" itemprop="dateModified" datetime="2022-06-26T19:36:41+08:00">2022-06-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="根据promise-A-写自己的promise"><a href="#根据promise-A-写自己的promise" class="headerlink" title="根据promise A+写自己的promise"></a>根据promise A+写自己的promise</h1><p>废话不多说</p>
<h3 id="1-promise-a-测试工具"><a href="#1-promise-a-测试工具" class="headerlink" title="1 ) promise a+测试工具"></a>1 ) promise a+测试工具</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init <span class="literal">-y</span> &amp;&amp; npm install promises<span class="literal">-aplus-tests</span> <span class="literal">-D</span></span><br></pre></td></tr></table></figure>

<h3 id="2-新建promise-js-放入以下内容"><a href="#2-新建promise-js-放入以下内容" class="headerlink" title="2 ) 新建promise.js,放入以下内容"></a>2 ) 新建promise.js,放入以下内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promisesAplusTests = <span class="built_in">require</span>(<span class="string">&quot;promises-aplus-tests&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">StateEnum</span> = &#123;</span><br><span class="line">    <span class="attr">PENDING</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">REJECTED</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">RESOLVED</span>:<span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> getThen = <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        || (<span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span></span><br><span class="line">            &amp;&amp; value !== <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">var</span> then = value.<span class="property">then</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> then;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> resolvePromise = <span class="keyword">function</span> (<span class="params">promise, value, resolve, reject</span>) &#123;</span><br><span class="line">    <span class="comment">//去掉resolve自身的情况 比如</span></span><br><span class="line">    <span class="comment">//let self = new Promise(resolve=&gt;resolve(self))</span></span><br><span class="line">    <span class="keyword">if</span> (value === promise) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//优化，保证能与其他promise库结合使用</span></span><br><span class="line">    <span class="keyword">var</span> called = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//此处将getThen放入try-catch，防止取then方法时报错</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> then = <span class="title function_">getThen</span>(value);</span><br><span class="line">        <span class="keyword">if</span> (then) &#123;</span><br><span class="line">            then.<span class="title function_">call</span>(value, <span class="keyword">function</span> (<span class="params">newValue</span>) &#123;</span><br><span class="line">                <span class="comment">//递归调用，直到把所有promise执行完</span></span><br><span class="line">                <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//newValue还可能是thenable</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(promise, newValue, resolve, reject);</span><br><span class="line">            &#125;, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">reject</span>(e);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//没有then方法则直接resolve</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">resolve</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//捕获不符合规范的then方法的错误</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (called)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        called = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MyPromise</span> = <span class="comment">/** <span class="doctag">@class</span> */</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">MyPromise</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callbacks</span> = [];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">errorHandlers</span> = [];</span><br><span class="line">        <span class="keyword">var</span> reject = <span class="keyword">function</span> (<span class="params">reason</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>) &#123;</span><br><span class="line">                _this.<span class="property">reason</span> = reason;</span><br><span class="line">                _this.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">REJECTED</span>;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    _this.<span class="property">errorHandlers</span></span><br><span class="line">                        .<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(reason); &#125;);</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//resolve只有resolvePromsie中能直接使用，其他地方均需通过resolvePromise</span></span><br><span class="line">        <span class="keyword">var</span> resolve = <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>) &#123;</span><br><span class="line">                _this.<span class="property">value</span> = value;</span><br><span class="line">                _this.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">RESOLVED</span>;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="comment">//不需要try-catch 因为fn中加了try-catch</span></span><br><span class="line">                    _this.<span class="property">callbacks</span></span><br><span class="line">                        .<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(value); &#125;);</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> called = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">executor</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">                <span class="comment">//防止rejected之后还resolvePromise</span></span><br><span class="line">                <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//reoslvePromise内部用了try-catch，这里可以不用try-catch</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(_this, value, resolve, reject);</span><br><span class="line">            &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">reject</span>(reason);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            called = <span class="literal">true</span>;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">newResolve, newReject</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fulfilledHandler;</span><br><span class="line">            <span class="keyword">var</span> rejectedHandler;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">                    <span class="comment">//这个try-catch为了捕获onfulfilled执行抛出的错误</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="title function_">newResolve</span>(<span class="title function_">onFulfilled</span>(value));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">newReject</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="title function_">newResolve</span>(value); &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123;</span><br><span class="line">                    <span class="comment">//这个try-catch为了捕获onRejected执行抛出的错误</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="title function_">newResolve</span>(<span class="title function_">onRejected</span>(reason));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">newReject</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="title function_">newReject</span>(reason); &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">RESOLVED</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="title function_">fulfilledHandler</span>(_this.<span class="property">value</span>); &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">REJECTED</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="title function_">rejectedHandler</span>(_this.<span class="property">reason</span>); &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                _this.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler);</span><br><span class="line">                _this.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">MyPromise</span>.<span class="property">deferred</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = &#123;</span><br><span class="line">            <span class="attr">promise</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">resolve</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">reject</span>: <span class="literal">null</span></span><br><span class="line">        &#125;;</span><br><span class="line">        result.<span class="property">promise</span> = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">            result.<span class="property">resolve</span> = resolve;</span><br><span class="line">            result.<span class="property">reject</span> = reject;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">MyPromise</span>;</span><br><span class="line">&#125;());</span><br><span class="line"><span class="title function_">promisesAplusTests</span>(<span class="title class_">MyPromise</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="comment">// All done; output is in the console. Or check `err` for number of failures.</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-测试"><a href="#3-测试" class="headerlink" title="3 ) 测试"></a>3 ) 测试</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node promise.js</span><br></pre></td></tr></table></figure>

<p><img src="../images/promise/image-20210808145033895.png" alt="image-20210808145033895"></p>
<p>全部通过</p>
<h2 id="1-阅读并理解promise标准：https-promisesaplus-com"><a href="#1-阅读并理解promise标准：https-promisesaplus-com" class="headerlink" title="1 阅读并理解promise标准：https://promisesaplus.com/"></a>1 阅读并理解promise标准：<a target="_blank" rel="noopener" href="https://promisesaplus.com/">https://promisesaplus.com/</a></h2><p>这个标准共分为三个部分：1. 名词解释（变量解释），2. 要求，3. 额外说明</p>
<h3 id="1-1-名词解释-帮助理解这个标准的解释"><a href="#1-1-名词解释-帮助理解这个标准的解释" class="headerlink" title="1.1 名词解释-帮助理解这个标准的解释"></a>1.1 名词解释-帮助理解这个标准的解释</h3><p>  1、promise：object|function 是一个有符合规范的then方法的object或者function</p>
<p>  2、thenable:  object|function 是一个定义了then方法（不一定符合规范）的object或者function</p>
<p>  3、value:any promise成功后的值</p>
<p>  4、exception:Error 捕获到的错误</p>
<p>  5、reason:any 描述为什么promise 失败了</p>
<h3 id="1-2-要求与额外说明均是用来帮助写promise的，需要结合代码说明"><a href="#1-2-要求与额外说明均是用来帮助写promise的，需要结合代码说明" class="headerlink" title="1.2 要求与额外说明均是用来帮助写promise的，需要结合代码说明"></a>1.2 要求与额外说明均是用来帮助写promise的，需要结合代码说明</h3><h2 id="2-开始手写promise"><a href="#2-开始手写promise" class="headerlink" title="2 开始手写promise"></a>2 开始手写promise</h2><h3 id="2-1-promise有三种状态：pending、rejected、fullfiled"><a href="#2-1-promise有三种状态：pending、rejected、fullfiled" class="headerlink" title="2.1 promise有三种状态：pending、rejected、fullfiled"></a>2.1 promise有三种状态：pending、rejected、fullfiled</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了保证唯一性，用对象表示</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">PENDING</span>: <span class="string">&#x27;PENDING&#x27;</span> = <span class="string">&#x27;PENDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">FULFILLED</span>: <span class="string">&#x27;FULFILLED&#x27;</span> = <span class="string">&#x27;FULFILLED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">REJECTED</span>: <span class="string">&#x27;REJECTED&#x27;</span> = <span class="string">&#x27;REJECTED&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-promise需要有自己的state、value-、reason、callbacks、errorHandlers、then方法"><a href="#2-2-promise需要有自己的state、value-、reason、callbacks、errorHandlers、then方法" class="headerlink" title="2.2 promise需要有自己的state、value 、reason、callbacks、errorHandlers、then方法"></a>2.2 promise需要有自己的state、value 、reason、callbacks、errorHandlers、then方法</h3><h4 id="2-2-1-代码"><a href="#2-2-1-代码" class="headerlink" title="2.2.1 代码"></a>2.2.1 代码</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">PENDING</span>: <span class="string">&#x27;PENDING&#x27;</span> = <span class="string">&#x27;PENDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">FULFILLED</span>: <span class="string">&#x27;FULFILLED&#x27;</span> = <span class="string">&#x27;FULFILLED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">REJECTED</span>: <span class="string">&#x27;REJECTED&#x27;</span> = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;    </span><br><span class="line">    <span class="attr">state</span>: <span class="string">&#x27;REJECTED&#x27;</span>|<span class="string">&#x27;PENDING&#x27;</span>|<span class="string">&#x27;FULFILLED&#x27;</span> = <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">any</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="attr">reason</span>: <span class="built_in">any</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="comment">//用来注册回调</span></span><br><span class="line">    <span class="attr">callbacks</span>: <span class="title class_">Array</span>&lt;<span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span>&gt; = []</span><br><span class="line">    <span class="attr">errorHandlers</span>: <span class="title class_">Array</span>&lt;<span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span>&gt; = []</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">executor: (resolve?: (value: <span class="built_in">unknown</span>) =&gt; <span class="built_in">void</span>, </span></span><br><span class="line"><span class="params">                 reject?: (reason?: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span>)</span></span><br><span class="line"><span class="params">        =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">        <span class="comment">//resolve用来改变状态、执行注册过的回调</span></span><br><span class="line">        <span class="comment">//promise的构造参数需要立即执行</span></span><br><span class="line">        <span class="keyword">let</span> <span class="title function_">reject</span> = (<span class="params">reason?: <span class="built_in">any</span></span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reason</span> = reason</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">REJECTED</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">errorHandlers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>(reason))</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="title function_">resolve</span> = (<span class="params">value?: <span class="built_in">any</span></span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">FULLFILED</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>(value))</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">executor</span>(resolve, reject)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">then</span>(<span class="params">onFulfilled?: <span class="built_in">any</span>, onRejected?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="comment">//返回一个新的promise，用来链式调用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">FULLFILED</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">onFulfilled</span>(<span class="variable language_">this</span>.<span class="property">value</span>)</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//rejected执行失败方法</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">onRejected</span>(<span class="variable language_">this</span>.<span class="property">reason</span>)</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// pending态注册回调</span></span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="title function_">push</span>(onFulfilled)</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(onRejected)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-转译后代码-小测试"><a href="#2-2-2-转译后代码-小测试" class="headerlink" title="2.2.2 转译后代码+小测试"></a>2.2.2 转译后代码+小测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;PENDING&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;FULFILLED&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;REJECTED&#x27;</span>; <span class="keyword">var</span> <span class="title class_">MyPromise</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">function</span> <span class="title function_">MyPromise</span>(<span class="params">executor</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">PENDING</span>; <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">callbacks</span> = []; <span class="variable language_">this</span>.<span class="property">errorHandlers</span> = []; <span class="keyword">var</span> reject = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">reason</span> = reason; _this.<span class="property">state</span> = <span class="variable constant_">REJECTED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">errorHandlers</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(reason); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> resolve = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">value</span> = value; _this.<span class="property">state</span> = <span class="variable constant_">FULFILLED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">callbacks</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(value); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">try</span> &#123; <span class="title function_">executor</span>(resolve, reject); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">reject</span>(e); &#125; &#125; <span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">newResolve, newReject</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">FULFILLED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">onFulfilled</span>(_this.<span class="property">value</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">onRejected</span>(_this.<span class="property">reason</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> &#123; _this.<span class="property">callbacks</span>.<span class="title function_">push</span>(onFulfilled); _this.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(onRejected); &#125; &#125;); &#125;; <span class="keyword">return</span> <span class="title class_">MyPromise</span>; &#125;()); </span><br><span class="line"><span class="comment">//测试代码,1秒后成功或失败，测试是否会再次成功或失败、成功或失败前的then能否调用、成功或失败后的then能否调用</span></span><br><span class="line"> <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.5</span> ? <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>) : <span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>); <span class="title function_">resolve</span>(<span class="string">&#x27;success2&#x27;</span>); <span class="title function_">reject</span>(<span class="string">&#x27;error2&#x27;</span>); &#125;, <span class="number">1000</span>); &#125;); promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value, <span class="number">0</span>); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason, <span class="number">0</span>); &#125;); promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value, <span class="number">1</span>); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason, <span class="number">1</span>); &#125;); promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value, <span class="number">2</span>); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason, <span class="number">2</span>); &#125;); promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value, <span class="number">3</span>); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason, <span class="number">3</span>); &#125;); promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value, <span class="number">4</span>); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason, <span class="number">4</span>); &#125;); <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value, <span class="number">5</span>, <span class="string">&#x27;timeout&#x27;</span>); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason, <span class="number">5</span>, <span class="string">&#x27;timeout&#x27;</span>); &#125;); &#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-执行结果"><a href="#2-2-3-执行结果" class="headerlink" title="2.2.3 执行结果"></a>2.2.3 执行结果</h4><p><img src="../images/promise/image-20210808112937448.png" alt="image-20210808112937448"><img src="../images/promise/image-20210808113024868.png" alt="image-20210808113024868"></p>
<p>执行顺序对了、也实现了只执行一次</p>
<h3 id="2-3-then的链式调用"><a href="#2-3-then的链式调用" class="headerlink" title="2.3 then的链式调用"></a>2.3 then的链式调用</h3><h4 id="2-3-1-理解链式调用"><a href="#2-3-1-理解链式调用" class="headerlink" title="2.3.1 理解链式调用"></a>2.3.1 理解链式调用</h4><p>举一个常见的链式调用例子，比如军训时的报数，1，2，3，4，5，6，7…</p>
<p>但是作为计算机，需要对这种行为进行抽象：</p>
<h5 id="1-什么时候从谁开始，军训时，教官叫左边或右边的第一个开始"><a href="#1-什么时候从谁开始，军训时，教官叫左边或右边的第一个开始" class="headerlink" title="1) 什么时候从谁开始，军训时，教官叫左边或右边的第一个开始"></a>1) 什么时候从谁开始，军训时，教官叫左边或右边的第一个开始</h5><h5 id="2-怎么调用-军训时，教官通知大家-报数后通知下一个报数"><a href="#2-怎么调用-军训时，教官通知大家-报数后通知下一个报数" class="headerlink" title="2) 怎么调用 军训时，教官通知大家:报数后通知下一个报数"></a>2) 怎么调用 军训时，教官通知大家:报数后通知下一个报数</h5><h5 id="3-什么时候停止-军训时，所有人都报完数了自动停止"><a href="#3-什么时候停止-军训时，所有人都报完数了自动停止" class="headerlink" title="3) 什么时候停止 军训时，所有人都报完数了自动停止"></a>3) 什么时候停止 军训时，所有人都报完数了自动停止</h5><p>所以他们的真实顺序应该为:</p>
<h5 id="1-注册函数-报数并通知下一个报数"><a href="#1-注册函数-报数并通知下一个报数" class="headerlink" title="1) 注册函数 报数并通知下一个报数"></a>1) 注册函数 报数并通知下一个报数</h5><h5 id="2-第一个报数开始-执行之前注册好的程序"><a href="#2-第一个报数开始-执行之前注册好的程序" class="headerlink" title="2) 第一个报数开始 执行之前注册好的程序"></a>2) 第一个报数开始 执行之前注册好的程序</h5><h5 id="3-结束-最后一个人报完数，报数停止"><a href="#3-结束-最后一个人报完数，报数停止" class="headerlink" title="3) 结束 最后一个人报完数，报数停止"></a>3) 结束 最后一个人报完数，报数停止</h5><p>promise中：</p>
<h5 id="1-注册-通过then方法在上一个promise的callbacks中加入自己的resolve方法-可以用来通知"><a href="#1-注册-通过then方法在上一个promise的callbacks中加入自己的resolve方法-可以用来通知" class="headerlink" title="1)注册 通过then方法在上一个promise的callbacks中加入自己的resolve方法(可以用来通知)"></a>1)注册 <strong>通过then方法在上一个promise的callbacks中加入自己的resolve方法</strong>(可以用来通知)</h5><h5 id="2-开始-第一个resolve或reject之后"><a href="#2-开始-第一个resolve或reject之后" class="headerlink" title="2) 开始 第一个resolve或reject之后"></a>2) 开始 第一个resolve或reject之后</h5><h5 id="3-结束-callbacks、errorHandlers中没有通知函数就结束了"><a href="#3-结束-callbacks、errorHandlers中没有通知函数就结束了" class="headerlink" title="3) 结束 callbacks、errorHandlers中没有通知函数就结束了"></a>3) 结束 callbacks、errorHandlers中没有通知函数就结束了</h5><p>可以实现 promise0 reolve -&gt; promise0 .callbacks -&gt; promise1 resolve -&gt; promise1 .callbacks -&gt; promise2 resolve -&gt; promise2 callbacks -&gt;….</p>
<p>因为会自动结束，所以关键只有两个：</p>
<h5 id="1-注册-在上一个promise的then中加入自己的resolve、reject-一定条件下调用"><a href="#1-注册-在上一个promise的then中加入自己的resolve、reject-一定条件下调用" class="headerlink" title="1) 注册 在上一个promise的then中加入自己的resolve、reject,一定条件下调用"></a>1) 注册 在上一个promise的then中加入自己的resolve、reject,一定条件下调用</h5><h5 id="2-开始第一个调用-第一个promise异步任务推入执行栈开始执行它的callbacks、errorHandlers"><a href="#2-开始第一个调用-第一个promise异步任务推入执行栈开始执行它的callbacks、errorHandlers" class="headerlink" title="2) 开始第一个调用 第一个promise异步任务推入执行栈开始执行它的callbacks、errorHandlers"></a>2) 开始第一个调用 第一个promise异步任务推入执行栈开始执行它的callbacks、errorHandlers</h5><h4 id="2-3-2-then的两个参数onFulfilled、onRejected都有可能不是函数"><a href="#2-3-2-then的两个参数onFulfilled、onRejected都有可能不是函数" class="headerlink" title="2.3.2 then的两个参数onFulfilled、onRejected都有可能不是函数"></a>2.3.2 then的两个参数onFulfilled、onRejected都有可能不是函数</h4><p>如果onFulfilled不是函数，则将值传递给返回的promise，即newResolve(value)</p>
<p>如果onFulfilled是函数，则需要newResolve( onFulfilled(value) ）</p>
<p>如果onRejected不是函数，则将值传递给返回的promise，即newReject(value)</p>
<p>如果onRejected是函数，则需要newResolve( onRejected(reason) ）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">then</span>(<span class="params">onFulfilled?: <span class="built_in">any</span>, onRejected?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="comment">//需要返回一个promise</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * 2.2.2 onFulfilled函数</span></span><br><span class="line"><span class="comment">            *    只能promise完成后调用，只能调用一次，并将value作为第一个参数</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 2.2.3 onRejected函数</span></span><br><span class="line"><span class="comment">             *    只能promise失败后调用，只能调用一次，并将reason作为第一个参数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">// 即将newResolve代替onFulfilled</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//需要做的处理有</span></span><br><span class="line">            <span class="comment">// 1、onFulfilled不是函数，则用newResolve代替 onFulFilled</span></span><br><span class="line">            <span class="comment">// 2、是函数，需要newResolve（  onFulfilled的返回值） 如果返回值为promise则需要将此promise执行并拿到执行的结果</span></span><br><span class="line">            <span class="comment">// 3、onRejected不是函数，则用newReject代替onRejected</span></span><br><span class="line">            <span class="comment">// 4、是函数，需要newReject（ reason ），即链式调用的时候，一个reject了，后面全部reject，且原因一样</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将需要执行的回调包一层函数，用来做更多处理</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">fulfilledHandler</span>: <span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">rejectedHandler</span>: <span class="function">(<span class="params">reason: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line">            <span class="comment">//如果onfullfilled不是函数</span></span><br><span class="line">            <span class="comment">//则此promise需要返回上一个promise的value</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                fulfilledHandler = <span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="title function_">newResolve</span>(value)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">newReject</span>(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fulfilledHandler = <span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> newValue = <span class="title function_">onFulfilled</span>(value)</span><br><span class="line">                        <span class="comment">//将执行结果传递给这个promise</span></span><br><span class="line">                        <span class="title function_">newResolve</span>(newValue)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">newReject</span>(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                rejectedHandler = <span class="function">(<span class="params">reason: <span class="built_in">any</span></span>) =&gt;</span> <span class="title function_">newReject</span>(reason)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                rejectedHandler = <span class="function">(<span class="params">reason: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> newValue = <span class="title function_">onRejected</span>(reason)</span><br><span class="line">                        <span class="comment">//将执行结果传递给这个promise</span></span><br><span class="line">                        <span class="title function_">newResolve</span>(newValue)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                        <span class="title function_">newReject</span>(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// fullfilled执行成功方法</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">FULLFILED</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">fulfilledHandler</span>(<span class="variable language_">this</span>.<span class="property">value</span>)</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//rejected执行失败方法</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">rejectedHandler</span>(<span class="variable language_">this</span>.<span class="property">value</span>)</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// pending态注册回调</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler)</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-转译后代码-测试"><a href="#2-3-3-转译后代码-测试" class="headerlink" title="2.3.3 转译后代码 + 测试"></a>2.3.3 转译后代码 + 测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;PENDING&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;FULFILLED&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;REJECTED&#x27;</span>; <span class="keyword">var</span> id = <span class="number">0</span>; <span class="keyword">var</span> <span class="title class_">MyPromise</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">function</span> <span class="title function_">MyPromise</span>(<span class="params">executor</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">PENDING</span>; <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">id</span> = id++; <span class="variable language_">this</span>.<span class="property">callbacks</span> = []; <span class="variable language_">this</span>.<span class="property">errorHandlers</span> = []; <span class="keyword">var</span> reject = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">reason</span> = reason; _this.<span class="property">state</span> = <span class="variable constant_">REJECTED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">errorHandlers</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(reason); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> resolve = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">value</span> = value; _this.<span class="property">state</span> = <span class="variable constant_">FULFILLED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">callbacks</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(value); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">try</span> &#123; <span class="title function_">executor</span>(resolve, reject); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">reject</span>(e); &#125; &#125; <span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">newResolve, newReject</span>) &#123; <span class="keyword">var</span> fulfilledHandler; <span class="keyword">var</span> rejectedHandler; <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onFulfilled</span>(value); <span class="title function_">newResolve</span>(newValue); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="title function_">newResolve</span>(value); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onRejected</span>(reason); <span class="title function_">newResolve</span>(newValue); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="title function_">newReject</span>(reason); &#125;; &#125; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">FULFILLED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">fulfilledHandler</span>(_this.<span class="property">value</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">rejectedHandler</span>(_this.<span class="property">reason</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> &#123; _this.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler); _this.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler); &#125; &#125;); &#125;; <span class="keyword">return</span> <span class="title class_">MyPromise</span>; &#125;()); </span><br><span class="line"><span class="comment">//测试onFulfilled、onRejected不为函数能否自动传给下一个promise</span></span><br><span class="line"><span class="keyword">var</span> i = <span class="number">0</span>; </span><br><span class="line"><span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="title class_">Math</span>.<span class="title function_">random</span>() &gt; <span class="number">0.5</span> ? <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>) : <span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>); &#125;)</span><br><span class="line">    .<span class="title function_">then</span>().<span class="title function_">then</span>().<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); <span class="keyword">return</span> value + <span class="string">&#x27;promise&#x27;</span> + i++; &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(reason); <span class="keyword">return</span> reason + <span class="string">&#x27;promise&#x27;</span> + i++; &#125;)</span><br><span class="line">    .<span class="title function_">then</span>().<span class="title function_">then</span>().<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(value); <span class="keyword">return</span> value + <span class="string">&#x27;promise&#x27;</span> + i++; &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(reason); <span class="keyword">return</span> reason + <span class="string">&#x27;promise&#x27;</span> + i++; &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h5><p><img src="../images/promise/image-20210808120600261.png" alt="image-20210806091930970"><img src="../images/promise/image-20210808120648157.png" alt="image-20210808120648157"></p>
<p>可以看到信息成功跳过了onFulfilled、onRejected不为函数的promise</p>
<h3 id="2-4-如果resolve的参数是thenable，需要执行其then方法拿到它的值"><a href="#2-4-如果resolve的参数是thenable，需要执行其then方法拿到它的值" class="headerlink" title="2.4 如果resolve的参数是thenable，需要执行其then方法拿到它的值"></a>2.4 如果resolve的参数是thenable，需要执行其then方法拿到它的值</h3><p>thenable:  object|function 是一个定义了then方法（不一定符合规范）的object或者function，为了兼容其他promise，就将这个函数或对象视为promise处理</p>
<h4 id="2-4-1-判断其是否为thenable"><a href="#2-4-1-判断其是否为thenable" class="headerlink" title="2.4.1 判断其是否为thenable"></a>2.4.1 判断其是否为thenable</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">isThenalbe</span> = (<span class="params">x</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        || (<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span></span><br><span class="line">            &amp;&amp; x !== <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="comment">//只取一次，符合外界调用逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> x.<span class="property">then</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="comment">//if(isThenalbe(value))&#123;</span></span><br><span class="line"><span class="comment">//    value.then(....)</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样判断有问题，因为这里取出了它的then方法，为了拿到里面的值，等会又需要调用其then方法，所以取了两次then，不符合执行逻辑。</p>
<p>可以改为获取其then方法，拿到再执行，获取为空则说明没有then方法。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了兼容其他版的promise，只通过判断变量的then属性是否为function来判断其是否为promise</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getThen</span> = (<span class="params">thenable: <span class="built_in">any</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> thenable === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        || (<span class="keyword">typeof</span> thenable === <span class="string">&#x27;object&#x27;</span></span><br><span class="line">            &amp;&amp; thenable !== <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="comment">//只取一次，符合外界调用逻辑</span></span><br><span class="line">        <span class="keyword">let</span> then = thenable.<span class="property">then</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> then</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-resolve不能直接调用"><a href="#2-4-2-resolve不能直接调用" class="headerlink" title="2.4.2 resolve不能直接调用"></a>2.4.2 resolve不能直接调用</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123; <span class="title function_">resolve</span>(<span class="string">&#x27;promise inner&#x27;</span>) &#125;)) &#125;)) &#125;)) &#125;)) &#125;)) &#125;))&#125;)</span><br></pre></td></tr></table></figure>

<p>之前有说过，链式调用的关键是</p>
<ol>
<li><p>注册 如果promise的value是thenable，则通过thenable的then方法注册自己的resolve方法，而自己的resolve不能自己调用，需要由value进行调用</p>
</li>
<li><p>开始调用 此处，从第一个resolve了不是thenable的值，就将它的callbacks推入执行队列，等待执行即可</p>
</li>
</ol>
<p>所以resolve不能直接调用，需要在加一层函数，也叫函数欺骗，改写executor函数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="title function_">executor</span>(<span class="function">(<span class="params">value?: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">//如果value是thenable的话 链式调用得在value中注册自己的resolve方法、reject方法用来执行自己的回调</span></span><br><span class="line">         <span class="comment">//所以需要四个参数</span></span><br><span class="line">         <span class="title function_">resolvePromise</span>(<span class="variable language_">this</span>, value, resolve ,reject)</span><br><span class="line">     &#125;, <span class="function">(<span class="params">reason?: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="title function_">reject</span>(reason)</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">     <span class="title function_">reject</span>(e)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-resolvePromise"><a href="#2-4-3-resolvePromise" class="headerlink" title="2.4.3 resolvePromise"></a>2.4.3 resolvePromise</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">promise: MyPromise, </span></span><br><span class="line"><span class="params">    value: <span class="built_in">any</span>, </span></span><br><span class="line"><span class="params">    resolve: (value?: <span class="built_in">any</span>) =&gt; <span class="built_in">unknown</span>, </span></span><br><span class="line"><span class="params">    reject: (reason?: <span class="built_in">any</span>) =&gt; <span class="built_in">unknown</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (value === promise) &#123;</span><br><span class="line">        <span class="comment">//去掉resolve自身的情况 比如</span></span><br><span class="line">        <span class="comment">//let self = new Promise(resolve=&gt;resolve(self))</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;TypeError: Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))</span><br><span class="line">        <span class="comment">//比如</span></span><br><span class="line">        <span class="keyword">let</span> x = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(x), <span class="number">10</span>))</span><br><span class="line">        <span class="comment">//Uncaught (in promise) TypeError: Chaining cycle detected for promise #&lt;Promise&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取then的时候可能会报错，所以需要try-catch</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> then = <span class="title function_">getThen</span>(value)</span><br><span class="line">        <span class="keyword">if</span> (then) &#123;</span><br><span class="line">            <span class="comment">//then为函数，则说明很可能为promise</span></span><br><span class="line">            <span class="comment">//为了兼容，就把它视为promise并执行其then方法</span></span><br><span class="line">            <span class="comment">//报错则捕获</span></span><br><span class="line">            <span class="comment">//执行其then</span></span><br><span class="line">            <span class="comment">//then为异步方法</span></span><br><span class="line">            then.<span class="title function_">call</span>(value, <span class="function">(<span class="params">newValue: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">//递归调用，直到不是promise为止</span></span><br><span class="line">                <span class="title function_">resolvePromise</span>(promise, newValue, resolve, reject)</span><br><span class="line">            &#125;, <span class="function">(<span class="params">reason: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(reason)</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//说明不是promise，则直接执行</span></span><br><span class="line">            <span class="title function_">resolve</span>(value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.4.4 测试</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;PENDING&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;FULFILLED&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;REJECTED&#x27;</span>; <span class="keyword">var</span> getThen = <span class="keyword">function</span> (<span class="params">thenable</span>) &#123; <span class="keyword">if</span> (<span class="keyword">typeof</span> thenable === <span class="string">&#x27;function&#x27;</span> || (<span class="keyword">typeof</span> thenable === <span class="string">&#x27;object&#x27;</span> &amp;&amp; thenable !== <span class="literal">null</span>)) &#123; <span class="keyword">var</span> then = thenable.<span class="property">then</span>; <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123; <span class="keyword">return</span> then; &#125; &#125; <span class="keyword">return</span> <span class="literal">null</span>; &#125;; <span class="keyword">var</span> resolvePromise = <span class="keyword">function</span> (<span class="params">promise, value, resolve, reject</span>) &#123; <span class="keyword">if</span> (value === promise) &#123; <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;TypeError: Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)); &#125; <span class="keyword">try</span> &#123; <span class="keyword">var</span> then = <span class="title function_">getThen</span>(value); <span class="keyword">if</span> (then) &#123; then.<span class="title function_">call</span>(value, <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="title function_">resolvePromise</span>(promise, value, resolve, reject); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="title function_">reject</span>(reason); &#125;); &#125; <span class="keyword">else</span> &#123; <span class="title function_">resolve</span>(value); &#125; &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">reject</span>(e); &#125; &#125;; <span class="keyword">var</span> <span class="title class_">MyPromise</span> = <span class="comment">/** <span class="doctag">@class</span> */</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">function</span> <span class="title function_">MyPromise</span>(<span class="params">executor</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">PENDING</span>; <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">callbacks</span> = []; <span class="variable language_">this</span>.<span class="property">errorHandlers</span> = []; <span class="keyword">var</span> reject = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">reason</span> = reason; _this.<span class="property">state</span> = <span class="variable constant_">REJECTED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">errorHandlers</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(reason); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> resolve = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">value</span> = value; _this.<span class="property">state</span> = <span class="variable constant_">FULFILLED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">callbacks</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(value); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">try</span> &#123; <span class="title function_">executor</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="title function_">resolvePromise</span>(_this, value, resolve, reject); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="title function_">reject</span>(reason); &#125;); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">reject</span>(e); &#125; &#125; <span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">newResolve, newReject</span>) &#123; <span class="keyword">var</span> fulfilledHandler; <span class="keyword">var</span> rejectedHandler; <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onFulfilled</span>(value); <span class="title function_">newResolve</span>( newValue); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="title function_">newResolve</span>(value); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onRejected</span>(reason); <span class="title function_">newResolve</span>(newValue); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="title function_">newReject</span>(reason); &#125;; &#125; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">FULFILLED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">fulfilledHandler</span>(_this.<span class="property">value</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">rejectedHandler</span>(_this.<span class="property">reason</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> &#123; _this.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler); _this.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="keyword">return</span> <span class="title class_">MyPromise</span>; &#125;()); </span><br><span class="line"><span class="comment">//测试</span></span><br><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(<span class="string">&#x27;promise inner&#x27;</span>); &#125;)); &#125;)); &#125;)); &#125;)); &#125;)); &#125;)); <span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>) &#125;); promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(value); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(reason); &#125;);</span><br></pre></td></tr></table></figure>

<p>结果输出了 error</p>
<p>按理说resolve之后就不能执行reject了，但是由于拿到promise的值是一个异步过程，</p>
<p>resolve之后还没有更改state为fulfilled reject执行了，成为了rejected状态</p>
<h4 id="2-4-5-resolvePromise的拦截"><a href="#2-4-5-resolvePromise的拦截" class="headerlink" title="2.4.5 resolvePromise的拦截"></a>2.4.5 resolvePromise的拦截</h4><p>所以得加一个拦截</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">called</span>:<span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">executor</span>(<span class="function">(<span class="params">value?: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        called = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">resolvePromise</span>(<span class="variable language_">this</span>, value, resolve, reject)</span><br><span class="line">    &#125;, <span class="function">(<span class="params">reason?: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        called = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">reject</span>(reason)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    called = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">reject</span>(e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-promise-a-标准的测试-https-github-com-promises-aplus-promises-tests"><a href="#2-5-promise-a-标准的测试-https-github-com-promises-aplus-promises-tests" class="headerlink" title="2.5 promise a+标准的测试 https://github.com/promises-aplus/promises-tests"></a>2.5 promise a+标准的测试 <a target="_blank" rel="noopener" href="https://github.com/promises-aplus/promises-tests">https://github.com/promises-aplus/promises-tests</a></h3><h4 id="2-5-1-初版测试"><a href="#2-5-1-初版测试" class="headerlink" title="2.5.1 初版测试"></a>2.5.1 初版测试</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install promises<span class="literal">-aplus-tests</span> <span class="literal">-D</span></span><br></pre></td></tr></table></figure>

<p>新建一个promise1.js,放入一下内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promisesAplusTests = <span class="built_in">require</span>(<span class="string">&quot;promises-aplus-tests&quot;</span>); <span class="keyword">var</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;PENDING&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;FULFILLED&#x27;</span>; <span class="keyword">var</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;REJECTED&#x27;</span>; <span class="keyword">var</span> getThen = <span class="keyword">function</span> (<span class="params">thenable</span>) &#123; <span class="keyword">if</span> (<span class="keyword">typeof</span> thenable === <span class="string">&#x27;function&#x27;</span> || (<span class="keyword">typeof</span> thenable === <span class="string">&#x27;object&#x27;</span> &amp;&amp; thenable !== <span class="literal">null</span>)) &#123; <span class="keyword">var</span> then = thenable.<span class="property">then</span>; <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123; <span class="keyword">return</span> then; &#125; &#125; <span class="keyword">return</span> <span class="literal">null</span>; &#125;; <span class="keyword">var</span> resolvePromise = <span class="keyword">function</span> (<span class="params">promise, value, resolve, reject</span>) &#123; <span class="keyword">if</span> (value === promise) &#123; <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;TypeError: Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)); &#125; <span class="keyword">try</span> &#123; <span class="keyword">var</span> then = <span class="title function_">getThen</span>(value); <span class="keyword">if</span> (then) &#123; then.<span class="title function_">call</span>(value, <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="title function_">resolvePromise</span>(promise, value, resolve, reject); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="title function_">reject</span>(reason); &#125;); &#125; <span class="keyword">else</span> &#123; <span class="title function_">resolve</span>(value); &#125; &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">reject</span>(e); &#125; &#125;; <span class="keyword">var</span> <span class="title class_">MyPromise</span> = (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">function</span> <span class="title function_">MyPromise</span>(<span class="params">executor</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">PENDING</span>; <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">callbacks</span> = []; <span class="variable language_">this</span>.<span class="property">errorHandlers</span> = []; <span class="keyword">var</span> reject = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">reason</span> = reason; _this.<span class="property">state</span> = <span class="variable constant_">REJECTED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">errorHandlers</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(reason); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> resolve = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">PENDING</span>) &#123; _this.<span class="property">value</span> = value; _this.<span class="property">state</span> = <span class="variable constant_">FULFILLED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">callbacks</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(value); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> called = <span class="literal">false</span>; <span class="keyword">try</span> &#123; <span class="title function_">executor</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>; <span class="title function_">resolvePromise</span>(_this, value, resolve, reject); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>;<span class="title function_">reject</span>(reason); &#125;); &#125; <span class="keyword">catch</span> (e) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>;<span class="title function_">reject</span>(e); &#125; &#125; <span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">newResolve, newReject</span>) &#123; <span class="keyword">var</span> fulfilledHandler; <span class="keyword">var</span> rejectedHandler; <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onFulfilled</span>(value); <span class="title function_">newResolve</span>(newValue); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="title function_">newResolve</span>(value); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onRejected</span>(reason); <span class="title function_">newResolve</span>(newValue); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="title function_">newReject</span>(reason); &#125;; &#125; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">FULFILLED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">fulfilledHandler</span>(_this.<span class="property">value</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">rejectedHandler</span>(_this.<span class="property">reason</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> &#123; _this.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler); _this.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="title class_">MyPromise</span>.<span class="property">deferred</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">var</span> result = &#123; <span class="attr">promise</span>: <span class="literal">null</span>, <span class="attr">resolve</span>: <span class="literal">null</span>, <span class="attr">reject</span>: <span class="literal">null</span> &#125;; result.<span class="property">promise</span> = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; result.<span class="property">resolve</span> = resolve; result.<span class="property">reject</span> = reject; &#125;); <span class="keyword">return</span> result; &#125;; <span class="keyword">return</span> <span class="title class_">MyPromise</span>; &#125;()); <span class="title function_">promisesAplusTests</span>(<span class="title class_">MyPromise</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(err); &#125;);</span><br></pre></td></tr></table></figure>

<p>然后运行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node promise1.js</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><img src="../images/promise/image-20210808133200574.png" alt="image-20210808133200574"></p>
<p>好家伙，居然没通过</p>
<p><img src="../images/promise/image-20210808133400566.png" alt="image-20210808133400566"></p>
<p><img src="../images/promise/image-20210808133817098.png" alt="image-20210808133817098"></p>
<p>所有的错误好像都是这两种<br>1 )  fulfilled、rejected的 promise再次resolve、reject了</p>
<p>2 ) 如果promise resolve了自己，reject TypeError </p>
<p>仔细看了看reject之后state直接变为rejected，肯定不会再执行，</p>
<p>那就只有resolve方法出了问题，直接执行resolve的执行地方只有promise的constructor与resolvePromise方法中</p>
<p>constructor那已经做了拦截</p>
<p>reject TypeError 我那里是reject(new Error())</p>
<p>那肯定是resolvePromise出了问题，需要做一个判断进行拦截：</p>
<h4 id="2-5-2-改完bug"><a href="#2-5-2-改完bug" class="headerlink" title="2.5.2 改完bug"></a>2.5.2 改完bug</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">promise: MyPromise,</span></span><br><span class="line"><span class="params">    value: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    resolve: (value?: <span class="built_in">any</span>) =&gt; <span class="built_in">unknown</span>,</span></span><br><span class="line"><span class="params">    reject: (reason?: <span class="built_in">any</span>) =&gt; <span class="built_in">unknown</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (value === promise) &#123;</span><br><span class="line">        <span class="comment">//去掉resolve自身的情况 比如</span></span><br><span class="line">        <span class="comment">//let self = new Promise(resolve=&gt;resolve(self))</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;TypeError: Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))</span><br><span class="line">        <span class="comment">//比如</span></span><br><span class="line">        <span class="keyword">let</span> x = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(x), <span class="number">10</span>))</span><br><span class="line">        <span class="comment">//Uncaught (in promise) TypeError: Chaining cycle detected for promise #&lt;Promise&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> called = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> then = <span class="title function_">getThen</span>(value)</span><br><span class="line">        <span class="keyword">if</span> (then) &#123;</span><br><span class="line">            <span class="comment">//then为函数，则说明很可能为promise</span></span><br><span class="line">            <span class="comment">//为了兼容，就把它视为promise并执行其then方法</span></span><br><span class="line">            <span class="comment">//报错则捕获</span></span><br><span class="line">            <span class="comment">//执行其then</span></span><br><span class="line">            <span class="comment">//then为异步方法</span></span><br><span class="line">            then.<span class="title function_">call</span>(value, <span class="function">(<span class="params">value: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                called = <span class="literal">true</span></span><br><span class="line">                <span class="comment">//递归调用，直到不是promise为止</span></span><br><span class="line">                <span class="title function_">resolvePromise</span>(promise, value, resolve, reject)</span><br><span class="line">            &#125;, <span class="function">(<span class="params">reason: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                called = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">reject</span>(reason)</span><br><span class="line">            &#125;)</span><br><span class="line">        <span class="comment">//说明不是promise，则直接执行</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        called = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">reject</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><img src="../images/promise/image-20210808135115530.png" alt="image-20210808135115530"></p>
<p>全部通过!!!终于大功告成</p>
<h2 id="3-最终代码"><a href="#3-最终代码" class="headerlink" title="3 最终代码"></a>3 最终代码</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> resolveType = <span class="function">(<span class="params">value: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">unknown</span></span><br><span class="line"><span class="keyword">type</span> handlerType = <span class="function">(<span class="params">value: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">unknown</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">promisesAplusTests</span>: <span class="title class_">Function</span> = <span class="built_in">require</span>(<span class="string">&quot;promises-aplus-tests&quot;</span>);</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">StateEnum</span> &#123;</span><br><span class="line">    <span class="variable constant_">PENDING</span> = <span class="number">0</span>,<span class="comment">//用简单的数据，节省一丁点内存</span></span><br><span class="line">    <span class="variable constant_">REJECTED</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="variable constant_">RESOLVED</span> = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> getThen = (<span class="attr">value</span>: <span class="built_in">any</span>): <span class="literal">null</span> | <span class="function"><span class="params">Function</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        || (<span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span></span><br><span class="line">            &amp;&amp; value !== <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">then</span>: <span class="built_in">unknown</span> = value.<span class="property">then</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> then</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> resolvePromise = (<span class="attr">promise</span>: <span class="title class_">MyPromise</span>,</span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">unknown</span>,</span><br><span class="line">    <span class="attr">resolve</span>: resolveType,</span><br><span class="line">    <span class="attr">reject</span>: resolveType): <span class="function"><span class="params">unknown</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//去掉resolve自身的情况 比如</span></span><br><span class="line">    <span class="comment">//let self = new Promise(resolve=&gt;resolve(self)</span></span><br><span class="line">    <span class="keyword">if</span> (value === promise) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//优化，保证能与其他promise库结合使用</span></span><br><span class="line">    <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//此处将getThen放入try-catch，防止取then方法时报错</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">then</span>: <span class="literal">null</span> | <span class="title class_">Function</span> = <span class="title function_">getThen</span>(value)</span><br><span class="line">        <span class="keyword">if</span> (then) &#123;</span><br><span class="line">            then.<span class="title function_">call</span>(value, <span class="function">(<span class="params">newValue: <span class="built_in">unknown</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">//递归调用，直到把所有promise执行完</span></span><br><span class="line">                <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                called = <span class="literal">true</span></span><br><span class="line">                <span class="comment">//newValue还可能是thenable</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(promise, newValue, resolve, reject)</span><br><span class="line">            &#125;, <span class="function">(<span class="params">e: <span class="built_in">unknown</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                called = <span class="literal">true</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">reject</span>(e)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//没有then方法则直接resolve</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">resolve</span>(value)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//捕获不符合规范的then方法的错误</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">        called = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: <span class="title class_">StateEnum</span> = <span class="title class_">StateEnum</span>.<span class="property">PENDING</span></span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">unknown</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="attr">reason</span>: <span class="built_in">unknown</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="attr">callbacks</span>: <span class="title class_">Array</span>&lt;handlerType&gt; = []</span><br><span class="line">    <span class="attr">errorHandlers</span>: <span class="title class_">Array</span>&lt;handlerType&gt; = []</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">executor: (resolve?: resolveType, reject?: resolveType) =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> reject = (<span class="attr">reason</span>: <span class="built_in">unknown</span>): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reason</span> = reason</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">REJECTED</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">errorHandlers</span></span><br><span class="line">                        .<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>(reason))</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//resolve只有resolvePromsie中能直接使用，其他地方均需通过resolvePromise</span></span><br><span class="line">        <span class="keyword">let</span> resolve = (<span class="attr">value</span>: <span class="built_in">unknown</span>): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">RESOLVED</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="comment">//不需要try-catch 因为fn中加了try-catch</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">callbacks</span></span><br><span class="line">                        .<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span> =&gt;</span> <span class="title function_">fn</span>(value))</span><br><span class="line">                &#125;, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">executor</span>(<span class="function">(<span class="params">value: <span class="built_in">unknown</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">//防止rejected之后还resolvePromise</span></span><br><span class="line">                <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                called = <span class="literal">true</span></span><br><span class="line">                <span class="comment">//reoslvePromise内部用了try-catch，这里可以不用try-catch</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(<span class="variable language_">this</span> <span class="keyword">as</span> <span class="title class_">MyPromise</span>, value, resolve, reject)</span><br><span class="line">            &#125;, <span class="function">(<span class="params">reason: <span class="built_in">unknown</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                called = <span class="literal">true</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">reject</span>(reason)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            <span class="title function_">reject</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">then</span>(<span class="params">onFulfilled?: <span class="built_in">unknown</span>, onRejected?: <span class="built_in">unknown</span></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(</span><br><span class="line">            <span class="function">(<span class="params">newResolve: resolveType, newReject: resolveType</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">fulfilledHandler</span>: handlerType</span><br><span class="line">                <span class="keyword">let</span> <span class="attr">rejectedHandler</span>: handlerType</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                    fulfilledHandler = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//这个try-catch为了捕获onfulfilled执行抛出的错误</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="title function_">newResolve</span>(<span class="title function_">onFulfilled</span>(value))</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            <span class="title function_">newReject</span>(e)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    fulfilledHandler = <span class="function">(<span class="params">value</span>) =&gt;</span><span class="title function_">newResolve</span>(value)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                    rejectedHandler = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//这个try-catch为了捕获onRejected执行抛出的错误</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="title function_">newResolve</span>(<span class="title function_">onRejected</span>(reason))</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                            <span class="title function_">newReject</span>(e)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    rejectedHandler = <span class="function">(<span class="params">reason</span>) =&gt;</span> <span class="title function_">newReject</span>(reason)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">RESOLVED</span>) &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">fulfilledHandler</span>(<span class="variable language_">this</span>.<span class="property">value</span>), <span class="number">0</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">REJECTED</span>) &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">rejectedHandler</span>(<span class="variable language_">this</span>.<span class="property">reason</span>), <span class="number">0</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler)</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">deferred</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">result</span>: &#123;</span><br><span class="line">            <span class="attr">promise</span>: <span class="title class_">MyPromise</span>,</span><br><span class="line">            <span class="attr">resolve</span>: resolveType,</span><br><span class="line">            <span class="attr">reject</span>: resolveType</span><br><span class="line">        &#125; = &#123;</span><br><span class="line">            <span class="attr">promise</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">resolve</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">reject</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        result.<span class="property">promise</span> = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            result.<span class="property">resolve</span> = resolve</span><br><span class="line">            result.<span class="property">reject</span> = reject</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">promisesAplusTests</span>(<span class="title class_">MyPromise</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="comment">// All done; output is in the console. Or check `err` for number of failures.</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="4-promise的静态方法"><a href="#4-promise的静态方法" class="headerlink" title="4 promise的静态方法"></a>4 promise的静态方法</h2><p>promise还有一些静态方法，相对于promise的实现是比较简单的</p>
<h3 id="4-1-有all、allSettled、race、reject、resolve、any-有些浏览器尚未支持"><a href="#4-1-有all、allSettled、race、reject、resolve、any-有些浏览器尚未支持" class="headerlink" title="4.1 有all、allSettled、race、reject、resolve、any(有些浏览器尚未支持)"></a>4.1 有all、allSettled、race、reject、resolve、any(有些浏览器尚未支持)</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="title function_">all</span>(<span class="attr">promiseList</span>: <span class="built_in">any</span>): <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//不捕获，有错误直接抛出</span></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">arr</span>: <span class="built_in">unknown</span>[] = []</span><br><span class="line">        <span class="comment">//可以取数组、string、map、set的长度</span></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">length</span>: <span class="built_in">number</span> = promiseList?.<span class="property">length</span> || promiseList?.<span class="property">size</span> || <span class="number">0</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">i</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line">        <span class="comment">//支持可迭代对象的处理</span></span><br><span class="line">        <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`<span class="subst">$&#123;promiseList&#125;</span> is not iterable (cannot read property Symbol(Symbol.iterator))`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这里不捕获错误，用于抛出</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> promise <span class="keyword">of</span> promiseList) &#123;</span><br><span class="line">            <span class="comment">//有可能不是promise，直接拿值</span></span><br><span class="line">            <span class="keyword">let</span> currentI = i++</span><br><span class="line">            <span class="title function_">resolvePromise</span>(</span><br><span class="line">                promise2,</span><br><span class="line">                promise,</span><br><span class="line">                <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">                    length--</span><br><span class="line">                    arr[currentI] = value</span><br><span class="line">                    <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(arr)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                reject</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">allSettled</span>(<span class="attr">promiseList</span>: <span class="built_in">any</span>): <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">arr</span>: <span class="built_in">unknown</span>[] = []</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">length</span>: <span class="built_in">number</span> = promiseList?.<span class="property">length</span> || promiseList?.<span class="property">size</span> || <span class="number">0</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">i</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line">        <span class="comment">//支持可迭代对象的处理</span></span><br><span class="line">        <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`<span class="subst">$&#123;promiseList&#125;</span> is not iterable (cannot read property Symbol(Symbol.iterator))`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> promise <span class="keyword">of</span> promiseList) &#123;</span><br><span class="line">            <span class="keyword">let</span> currentI = i++</span><br><span class="line">            <span class="title function_">resolvePromise</span>(</span><br><span class="line">                promise2,</span><br><span class="line">                promise,</span><br><span class="line">                <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">                    arr[currentI] = value</span><br><span class="line">                    length--</span><br><span class="line">                    <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(arr)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">                    arr[currentI] = reason</span><br><span class="line">                    length--</span><br><span class="line">                    <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(arr)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">race</span>(<span class="attr">promiseList</span>: <span class="built_in">any</span>): <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//可以取数组、string、map、set的长度</span></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">length</span>: <span class="built_in">number</span> = promiseList?.<span class="property">length</span> || promiseList?.<span class="property">size</span> || <span class="number">0</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">        <span class="comment">//支持可迭代对象的处理</span></span><br><span class="line">        <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`<span class="subst">$&#123;promiseList&#125;</span> is not iterable (cannot read property Symbol(Symbol.iterator))`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这里不捕获错误，用于抛出</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> promise <span class="keyword">of</span> promiseList) &#123;</span><br><span class="line">            <span class="comment">//有可能不是promise，直接拿值</span></span><br><span class="line">            <span class="title function_">resolvePromise</span>(promise2, promise, resolve, reject)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">reject</span>(<span class="attr">reason</span>: <span class="built_in">unknown</span>): <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(reason)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">resolve</span>(<span class="attr">value</span>: <span class="built_in">unknown</span>): <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//resolvePromise内部try-catch外部不需要</span></span><br><span class="line">        <span class="title function_">resolve</span>(value)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">any</span>(<span class="attr">promiseList</span>: <span class="built_in">any</span>): <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">length</span>: <span class="built_in">number</span> = promiseList?.<span class="property">length</span> || promiseList?.<span class="property">size</span> || <span class="number">0</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">        <span class="comment">//支持可迭代对象的处理</span></span><br><span class="line">        <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`<span class="subst">$&#123;promiseList&#125;</span> is not iterable (cannot read property Symbol(Symbol.iterator))`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> promise <span class="keyword">of</span> promiseList) &#123;</span><br><span class="line">            <span class="title function_">resolvePromise</span>(</span><br><span class="line">                promise2,</span><br><span class="line">                promise,</span><br><span class="line">                resolve,</span><br><span class="line">                <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    length--</span><br><span class="line">                    <span class="keyword">if</span> (length === <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;全失败了&#x27;</span>))</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> promise2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-小测试"><a href="#4-2-小测试" class="headerlink" title="4.2 小测试"></a>4.2 小测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>; <span class="keyword">var</span> <span class="title class_">StateEnum</span>; (<span class="keyword">function</span> (<span class="params">StateEnum</span>) &#123; <span class="title class_">StateEnum</span>[<span class="title class_">StateEnum</span>[<span class="string">&quot;PENDING&quot;</span>] = <span class="number">0</span>] = <span class="string">&quot;PENDING&quot;</span>; <span class="title class_">StateEnum</span>[<span class="title class_">StateEnum</span>[<span class="string">&quot;REJECTED&quot;</span>] = <span class="number">1</span>] = <span class="string">&quot;REJECTED&quot;</span>; <span class="title class_">StateEnum</span>[<span class="title class_">StateEnum</span>[<span class="string">&quot;RESOLVED&quot;</span>] = <span class="number">2</span>] = <span class="string">&quot;RESOLVED&quot;</span>; &#125;)(<span class="title class_">StateEnum</span> || (<span class="title class_">StateEnum</span> = &#123;&#125;)); <span class="keyword">var</span> getThen = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span> || (<span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp; value !== <span class="literal">null</span>)) &#123; <span class="keyword">var</span> then = value.<span class="property">then</span>; <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123; <span class="keyword">return</span> then; &#125; &#125; <span class="keyword">return</span> <span class="literal">null</span>; &#125;; <span class="keyword">var</span> resolvePromise = <span class="keyword">function</span> (<span class="params">promise, value, resolve, reject</span>) &#123; <span class="keyword">if</span> (value === promise) &#123; <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)); &#125; <span class="keyword">var</span> called = <span class="literal">false</span>; <span class="keyword">try</span> &#123; <span class="keyword">var</span> then = <span class="title function_">getThen</span>(value); <span class="keyword">if</span> (then) &#123; then.<span class="title function_">call</span>(value, <span class="keyword">function</span> (<span class="params">newValue</span>) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>; <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(promise, newValue, resolve, reject); &#125;, <span class="keyword">function</span> (<span class="params">e</span>) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>; <span class="keyword">return</span> <span class="title function_">reject</span>(e); &#125;); &#125; <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="title function_">resolve</span>(value); &#125; &#125; <span class="keyword">catch</span> (e) &#123; <span class="keyword">if</span> (called) <span class="keyword">return</span>; called = <span class="literal">true</span>; <span class="keyword">return</span> <span class="title function_">reject</span>(e); &#125; &#125;; <span class="keyword">var</span> <span class="title class_">MyPromise</span> = <span class="comment">/** <span class="doctag">@class</span> */</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">function</span> <span class="title function_">MyPromise</span>(<span class="params">executor</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>; <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>; <span class="variable language_">this</span>.<span class="property">callbacks</span> = []; <span class="variable language_">this</span>.<span class="property">errorHandlers</span> = []; <span class="keyword">var</span> reject = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>) &#123; _this.<span class="property">reason</span> = reason; _this.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">REJECTED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">errorHandlers</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(reason); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> resolve = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">PENDING</span>) &#123; _this.<span class="property">value</span> = value; _this.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">RESOLVED</span>; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; _this.<span class="property">callbacks</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">fn</span>) &#123; <span class="keyword">return</span> <span class="title function_">fn</span>(value); &#125;); &#125;, <span class="number">0</span>); &#125; &#125;; <span class="keyword">var</span> called = <span class="literal">false</span>; <span class="keyword">try</span> &#123; <span class="title function_">executor</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>; <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(_this, value, resolve, reject); &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>; <span class="keyword">return</span> <span class="title function_">reject</span>(reason); &#125;); &#125; <span class="keyword">catch</span> (e) &#123; <span class="keyword">if</span> (called) &#123; <span class="keyword">return</span>; &#125; called = <span class="literal">true</span>; <span class="title function_">reject</span>(e); &#125; &#125; <span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onFulfilled, onRejected</span>) &#123; <span class="keyword">var</span> _this = <span class="variable language_">this</span>; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">newResolve, newReject</span>) &#123; <span class="keyword">var</span> fulfilledHandler; <span class="keyword">var</span> rejectedHandler; <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onFulfilled</span>(value); <span class="title function_">resolvePromise</span>(promise2, newValue, newResolve, newReject); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; fulfilledHandler = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="title function_">resolvePromise</span>(promise2, value, newResolve, newReject); &#125;; &#125; <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">try</span> &#123; <span class="keyword">var</span> newValue = <span class="title function_">onRejected</span>(reason); <span class="title function_">resolvePromise</span>(promise2, newValue, newResolve, newReject); &#125; <span class="keyword">catch</span> (e) &#123; <span class="title function_">newReject</span>(e); &#125; &#125;; &#125; <span class="keyword">else</span> &#123; rejectedHandler = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="title function_">newReject</span>(reason); &#125;; &#125; <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">RESOLVED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="title function_">fulfilledHandler</span>(_this.<span class="property">value</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_this.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">REJECTED</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="title function_">rejectedHandler</span>(_this.<span class="property">reason</span>); &#125;, <span class="number">0</span>); &#125; <span class="keyword">else</span> &#123; _this.<span class="property">callbacks</span>.<span class="title function_">push</span>(fulfilledHandler); _this.<span class="property">errorHandlers</span>.<span class="title function_">push</span>(rejectedHandler); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="title class_">MyPromise</span>.<span class="property">all</span> = <span class="keyword">function</span> (<span class="params">promiseList</span>) &#123; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="keyword">var</span> arr = []; <span class="keyword">var</span> length = (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">length</span>) || (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">size</span>) || <span class="number">0</span>; <span class="keyword">var</span> i = <span class="number">0</span>; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(promiseList + <span class="string">&quot; is not iterable (cannot read property Symbol(Symbol.iterator))&quot;</span>); &#125; <span class="keyword">var</span> _loop_1 = <span class="keyword">function</span> (<span class="params">promise</span>) &#123; <span class="keyword">var</span> currentI = i++; <span class="title function_">resolvePromise</span>(promise2, promise, <span class="keyword">function</span> (<span class="params">value</span>) &#123; length--; arr[currentI] = value; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="title function_">resolve</span>(arr); &#125; &#125;, reject); &#125;; <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>, promiseList_1 = promiseList; _i &lt; promiseList_1.<span class="property">length</span>; _i++) &#123; <span class="keyword">var</span> promise = promiseList_1[_i]; <span class="title function_">_loop_1</span>(promise); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="title class_">MyPromise</span>.<span class="property">allSettled</span> = <span class="keyword">function</span> (<span class="params">promiseList</span>) &#123; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="keyword">var</span> arr = []; <span class="keyword">var</span> length = (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">length</span>) || (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">size</span>) || <span class="number">0</span>; <span class="keyword">var</span> i = <span class="number">0</span>; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(promiseList + <span class="string">&quot; is not iterable (cannot read property Symbol(Symbol.iterator))&quot;</span>); &#125; <span class="keyword">var</span> _loop_2 = <span class="keyword">function</span> (<span class="params">promise</span>) &#123; <span class="keyword">var</span> currentI = i++; <span class="title function_">resolvePromise</span>(promise2, promise, <span class="keyword">function</span> (<span class="params">value</span>) &#123; arr[currentI] = value; length--; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="title function_">resolve</span>(arr); &#125; &#125;, <span class="keyword">function</span> (<span class="params">reason</span>) &#123; arr[currentI] = reason; length--; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="title function_">resolve</span>(arr); &#125; &#125;); &#125;; <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>, promiseList_2 = promiseList; _i &lt; promiseList_2.<span class="property">length</span>; _i++) &#123; <span class="keyword">var</span> promise = promiseList_2[_i]; <span class="title function_">_loop_2</span>(promise); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="title class_">MyPromise</span>.<span class="property">race</span> = <span class="keyword">function</span> (<span class="params">promiseList</span>) &#123; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="keyword">var</span> length = (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">length</span>) || (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">size</span>) || <span class="number">0</span>; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(promiseList + <span class="string">&quot; is not iterable (cannot read property Symbol(Symbol.iterator))&quot;</span>); &#125; <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>, promiseList_3 = promiseList; _i &lt; promiseList_3.<span class="property">length</span>; _i++) &#123; <span class="keyword">var</span> promise = promiseList_3[_i]; <span class="title function_">resolvePromise</span>(promise2, promise, resolve, reject); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="title class_">MyPromise</span>.<span class="property">reject</span> = <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="title function_">reject</span>(reason); &#125;); &#125;; <span class="title class_">MyPromise</span>.<span class="property">resolve</span> = <span class="keyword">function</span> (<span class="params">value</span>) &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="title function_">resolve</span>(value); &#125;); &#125;; <span class="title class_">MyPromise</span>.<span class="property">any</span> = <span class="keyword">function</span> (<span class="params">promiseList</span>) &#123; <span class="keyword">var</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="keyword">var</span> length = (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">length</span>) || (promiseList === <span class="literal">null</span> || promiseList === <span class="keyword">void</span> <span class="number">0</span> ? <span class="keyword">void</span> <span class="number">0</span> : promiseList.<span class="property">size</span>) || <span class="number">0</span>; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(promiseList + <span class="string">&quot; is not iterable (cannot read property Symbol(Symbol.iterator))&quot;</span>); &#125; <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>, promiseList_4 = promiseList; _i &lt; promiseList_4.<span class="property">length</span>; _i++) &#123; <span class="keyword">var</span> promise = promiseList_4[_i]; <span class="title function_">resolvePromise</span>(promise2, promise, resolve, <span class="keyword">function</span> (<span class="params"></span>) &#123; length--; <span class="keyword">if</span> (length === <span class="number">0</span>) &#123; <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;全失败了&#x27;</span>)); &#125; &#125;); &#125; &#125;); <span class="keyword">return</span> promise2; &#125;; <span class="keyword">return</span> <span class="title class_">MyPromise</span>; &#125;());</span><br><span class="line"><span class="comment">/*debugger*/</span></span><br><span class="line"><span class="title class_">MyPromise</span>.<span class="title function_">all</span>(&#123;&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(res); &#125;);</span><br><span class="line"><span class="title class_">MyPromise</span>.<span class="title function_">all</span>(<span class="string">&#x27;123&#x27;</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(res); &#125;);</span><br><span class="line"><span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>)).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;resolve静态方法&#x27;</span>))</span><br><span class="line"><span class="title class_">MyPromise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>).<span class="title function_">then</span>(<span class="string">&#x27;&#x27;</span>,<span class="function"><span class="params">e</span>=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reject静态方法&#x27;</span>,e))</span><br><span class="line"><span class="keyword">var</span> arr = [</span><br><span class="line">    <span class="comment">/*非promise*/</span> <span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*失败promise*/</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123; <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="string">&#x27;inner settimeout reject&#x27;</span>); &#125;, <span class="number">1000</span>); &#125;)); &#125;),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*成功promise*/</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="string">&#x27;inner  promise&#x27;</span>); &#125;)); &#125;)); &#125;)); &#125;),]; <span class="keyword">var</span> keys = [<span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;allSettled&#x27;</span>, <span class="string">&#x27;race&#x27;</span>, <span class="string">&#x27;any&#x27;</span></span><br><span class="line">];</span><br><span class="line">keys.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="title class_">MyPromise</span>[key](arr).<span class="title function_">then</span>(</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">res</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(key + <span class="string">&quot;\u7684\u6210\u529F\u7ED3\u679C&quot;</span>, res); &#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">reason</span>) &#123; <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(key + <span class="string">&quot;\u7684\u5931\u8D25\u539F\u56E0&quot;</span>, reason); &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<p><img src="../images/promise/image-20210808174610443.png" alt="image-20210808174610443"></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/23/funciton-curring/" rel="prev" title="函数科里化">
      <i class="fa fa-chevron-left"></i> 函数科里化
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/14/exceldigit/" rel="next" title="将数字转换为excel的列名">
      将数字转换为excel的列名 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AEpromise-A-%E5%86%99%E8%87%AA%E5%B7%B1%E7%9A%84promise"><span class="nav-number">1.</span> <span class="nav-text">根据promise A+写自己的promise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-promise-a-%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">1.0.1.</span> <span class="nav-text">1 ) promise a+测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%B0%E5%BB%BApromise-js-%E6%94%BE%E5%85%A5%E4%BB%A5%E4%B8%8B%E5%86%85%E5%AE%B9"><span class="nav-number">1.0.2.</span> <span class="nav-text">2 ) 新建promise.js,放入以下内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B5%8B%E8%AF%95"><span class="nav-number">1.0.3.</span> <span class="nav-text">3 ) 测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%98%85%E8%AF%BB%E5%B9%B6%E7%90%86%E8%A7%A3promise%E6%A0%87%E5%87%86%EF%BC%9Ahttps-promisesaplus-com"><span class="nav-number">1.1.</span> <span class="nav-text">1 阅读并理解promise标准：https:&#x2F;&#x2F;promisesaplus.com&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-%E5%B8%AE%E5%8A%A9%E7%90%86%E8%A7%A3%E8%BF%99%E4%B8%AA%E6%A0%87%E5%87%86%E7%9A%84%E8%A7%A3%E9%87%8A"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 名词解释-帮助理解这个标准的解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%A6%81%E6%B1%82%E4%B8%8E%E9%A2%9D%E5%A4%96%E8%AF%B4%E6%98%8E%E5%9D%87%E6%98%AF%E7%94%A8%E6%9D%A5%E5%B8%AE%E5%8A%A9%E5%86%99promise%E7%9A%84%EF%BC%8C%E9%9C%80%E8%A6%81%E7%BB%93%E5%90%88%E4%BB%A3%E7%A0%81%E8%AF%B4%E6%98%8E"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 要求与额外说明均是用来帮助写promise的，需要结合代码说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%BC%80%E5%A7%8B%E6%89%8B%E5%86%99promise"><span class="nav-number">1.2.</span> <span class="nav-text">2 开始手写promise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-promise%E6%9C%89%E4%B8%89%E7%A7%8D%E7%8A%B6%E6%80%81%EF%BC%9Apending%E3%80%81rejected%E3%80%81fullfiled"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 promise有三种状态：pending、rejected、fullfiled</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-promise%E9%9C%80%E8%A6%81%E6%9C%89%E8%87%AA%E5%B7%B1%E7%9A%84state%E3%80%81value-%E3%80%81reason%E3%80%81callbacks%E3%80%81errorHandlers%E3%80%81then%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 promise需要有自己的state、value 、reason、callbacks、errorHandlers、then方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E4%BB%A3%E7%A0%81"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">2.2.1 代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E8%BD%AC%E8%AF%91%E5%90%8E%E4%BB%A3%E7%A0%81-%E5%B0%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">2.2.2 转译后代码+小测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">2.2.3 执行结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-then%E7%9A%84%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 then的链式调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-%E7%90%86%E8%A7%A3%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">2.3.1 理解链式调用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BB%8E%E8%B0%81%E5%BC%80%E5%A7%8B%EF%BC%8C%E5%86%9B%E8%AE%AD%E6%97%B6%EF%BC%8C%E6%95%99%E5%AE%98%E5%8F%AB%E5%B7%A6%E8%BE%B9%E6%88%96%E5%8F%B3%E8%BE%B9%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%BC%80%E5%A7%8B"><span class="nav-number">1.2.3.1.1.</span> <span class="nav-text">1) 什么时候从谁开始，军训时，教官叫左边或右边的第一个开始</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8-%E5%86%9B%E8%AE%AD%E6%97%B6%EF%BC%8C%E6%95%99%E5%AE%98%E9%80%9A%E7%9F%A5%E5%A4%A7%E5%AE%B6-%E6%8A%A5%E6%95%B0%E5%90%8E%E9%80%9A%E7%9F%A5%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%8A%A5%E6%95%B0"><span class="nav-number">1.2.3.1.2.</span> <span class="nav-text">2) 怎么调用 军训时，教官通知大家:报数后通知下一个报数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%81%9C%E6%AD%A2-%E5%86%9B%E8%AE%AD%E6%97%B6%EF%BC%8C%E6%89%80%E6%9C%89%E4%BA%BA%E9%83%BD%E6%8A%A5%E5%AE%8C%E6%95%B0%E4%BA%86%E8%87%AA%E5%8A%A8%E5%81%9C%E6%AD%A2"><span class="nav-number">1.2.3.1.3.</span> <span class="nav-text">3) 什么时候停止 军训时，所有人都报完数了自动停止</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8C%E5%87%BD%E6%95%B0-%E6%8A%A5%E6%95%B0%E5%B9%B6%E9%80%9A%E7%9F%A5%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%8A%A5%E6%95%B0"><span class="nav-number">1.2.3.1.4.</span> <span class="nav-text">1) 注册函数 报数并通知下一个报数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%8A%A5%E6%95%B0%E5%BC%80%E5%A7%8B-%E6%89%A7%E8%A1%8C%E4%B9%8B%E5%89%8D%E6%B3%A8%E5%86%8C%E5%A5%BD%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="nav-number">1.2.3.1.5.</span> <span class="nav-text">2) 第一个报数开始 执行之前注册好的程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E7%BB%93%E6%9D%9F-%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E4%BA%BA%E6%8A%A5%E5%AE%8C%E6%95%B0%EF%BC%8C%E6%8A%A5%E6%95%B0%E5%81%9C%E6%AD%A2"><span class="nav-number">1.2.3.1.6.</span> <span class="nav-text">3) 结束 最后一个人报完数，报数停止</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8C-%E9%80%9A%E8%BF%87then%E6%96%B9%E6%B3%95%E5%9C%A8%E4%B8%8A%E4%B8%80%E4%B8%AApromise%E7%9A%84callbacks%E4%B8%AD%E5%8A%A0%E5%85%A5%E8%87%AA%E5%B7%B1%E7%9A%84resolve%E6%96%B9%E6%B3%95-%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E9%80%9A%E7%9F%A5"><span class="nav-number">1.2.3.1.7.</span> <span class="nav-text">1)注册 通过then方法在上一个promise的callbacks中加入自己的resolve方法(可以用来通知)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%BC%80%E5%A7%8B-%E7%AC%AC%E4%B8%80%E4%B8%AAresolve%E6%88%96reject%E4%B9%8B%E5%90%8E"><span class="nav-number">1.2.3.1.8.</span> <span class="nav-text">2) 开始 第一个resolve或reject之后</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E7%BB%93%E6%9D%9F-callbacks%E3%80%81errorHandlers%E4%B8%AD%E6%B2%A1%E6%9C%89%E9%80%9A%E7%9F%A5%E5%87%BD%E6%95%B0%E5%B0%B1%E7%BB%93%E6%9D%9F%E4%BA%86"><span class="nav-number">1.2.3.1.9.</span> <span class="nav-text">3) 结束 callbacks、errorHandlers中没有通知函数就结束了</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8C-%E5%9C%A8%E4%B8%8A%E4%B8%80%E4%B8%AApromise%E7%9A%84then%E4%B8%AD%E5%8A%A0%E5%85%A5%E8%87%AA%E5%B7%B1%E7%9A%84resolve%E3%80%81reject-%E4%B8%80%E5%AE%9A%E6%9D%A1%E4%BB%B6%E4%B8%8B%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.3.1.10.</span> <span class="nav-text">1) 注册 在上一个promise的then中加入自己的resolve、reject,一定条件下调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%BC%80%E5%A7%8B%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%B0%83%E7%94%A8-%E7%AC%AC%E4%B8%80%E4%B8%AApromise%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E6%8E%A8%E5%85%A5%E6%89%A7%E8%A1%8C%E6%A0%88%E5%BC%80%E5%A7%8B%E6%89%A7%E8%A1%8C%E5%AE%83%E7%9A%84callbacks%E3%80%81errorHandlers"><span class="nav-number">1.2.3.1.11.</span> <span class="nav-text">2) 开始第一个调用 第一个promise异步任务推入执行栈开始执行它的callbacks、errorHandlers</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-then%E7%9A%84%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0onFulfilled%E3%80%81onRejected%E9%83%BD%E6%9C%89%E5%8F%AF%E8%83%BD%E4%B8%8D%E6%98%AF%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">2.3.2 then的两个参数onFulfilled、onRejected都有可能不是函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-%E8%BD%AC%E8%AF%91%E5%90%8E%E4%BB%A3%E7%A0%81-%E6%B5%8B%E8%AF%95"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">2.3.3 转译后代码 + 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">1.2.3.3.1.</span> <span class="nav-text">测试结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%A6%82%E6%9E%9Cresolve%E7%9A%84%E5%8F%82%E6%95%B0%E6%98%AFthenable%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C%E5%85%B6then%E6%96%B9%E6%B3%95%E6%8B%BF%E5%88%B0%E5%AE%83%E7%9A%84%E5%80%BC"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 如果resolve的参数是thenable，需要执行其then方法拿到它的值</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-%E5%88%A4%E6%96%AD%E5%85%B6%E6%98%AF%E5%90%A6%E4%B8%BAthenable"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">2.4.1 判断其是否为thenable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-resolve%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">2.4.2 resolve不能直接调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-resolvePromise"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">2.4.3 resolvePromise</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-5-resolvePromise%E7%9A%84%E6%8B%A6%E6%88%AA"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">2.4.5 resolvePromise的拦截</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-promise-a-%E6%A0%87%E5%87%86%E7%9A%84%E6%B5%8B%E8%AF%95-https-github-com-promises-aplus-promises-tests"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 promise a+标准的测试 https:&#x2F;&#x2F;github.com&#x2F;promises-aplus&#x2F;promises-tests</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-%E5%88%9D%E7%89%88%E6%B5%8B%E8%AF%95"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">2.5.1 初版测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-%E6%94%B9%E5%AE%8Cbug"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">2.5.2 改完bug</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%9C%80%E7%BB%88%E4%BB%A3%E7%A0%81"><span class="nav-number">1.3.</span> <span class="nav-text">3 最终代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-promise%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.</span> <span class="nav-text">4 promise的静态方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%9C%89all%E3%80%81allSettled%E3%80%81race%E3%80%81reject%E3%80%81resolve%E3%80%81any-%E6%9C%89%E4%BA%9B%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B0%9A%E6%9C%AA%E6%94%AF%E6%8C%81"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 有all、allSettled、race、reject、resolve、any(有些浏览器尚未支持)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%B0%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 小测试</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">fyg</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fyg</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
