---
url: /leading/webassembly/basic.md
---
# WASM 基础

## 什么是 WebAssembly？

WebAssembly (简称 WASM) 是一种低级字节码格式，专为在 Web 环境中高效执行而设计。它由 W3C 标准组织推动，旨在弥补 JavaScript 在性能密集型任务上的不足，同时保持与现有 Web 平台的兼容性。WASM 不是一门编程语言，而是一种编译目标，允许开发者使用 C/C++、Rust 等语言编写代码，并将其转换为可在浏览器中运行的紧凑二进制格式。

## 主要特点

### 高效性能

WASM 采用紧凑的二进制格式，加载和解析速度快于等效的 JavaScript 文本。其指令集设计贴近硬件，支持即时编译 (JIT) 和预编译，执行效率接近原生代码。例如，在数值计算或图形处理任务中，WASM 可显著提升性能。

示意图：

```
源代码 (C/Rust) -> 编译器 -> WASM 二进制 -> 浏览器 JIT 编译 -> 原生机器码执行
```

### 安全沙箱

WASM 运行在严格的沙箱环境中，无法直接访问系统资源 (如文件系统或网络)。所有内存访问均通过线性内存模型进行隔离，并通过导入/导出机制与外部交互，防止恶意代码破坏宿主环境。

示意图：

```
[ WASM 实例 ]
    |
    |--- 线性内存 (受限访问)
    |
    |--- 导入函数 (例如 JavaScript API)
    |
    |--- 导出函数 (供外部调用)
```

### 跨平台可移植

WASM 独立于特定硬件或操作系统，只需目标环境 (如浏览器、服务器) 具备 WASM 虚拟机即可运行。这使得同一份代码可部署在 Web、边缘计算或物联网设备中。

### 与 JavaScript 互操作

WASM 与 JavaScript 无缝集成，可通过 JavaScript API 加载和实例化模块，并双向调用函数。这允许渐进式迁移：性能关键部分用 WASM 实现，其余逻辑保留在 JavaScript 中。

示意图：

```
JavaScript 代码
    |
    |-- 调用 --> WASM 导出函数
    |
    |-- 传递数据 --> 共享内存
```

## 工作原理

### 编译与模块结构

源代码 (如 C++) 通过编译器 (如 Emscripten) 转换为。wasm 二进制文件。该文件包含模块定义，由以下部分组成：

* **类型段**：定义函数签名。
* **函数段**：包含代码逻辑。
* **内存段**：描述线性内存布局。
* **导入/导出段**：声明依赖项和公开接口。

示意图：

```
C++ 文件
    |
    emcc 编译
    |
WASM 模块结构：
    [类型段] [函数段] [内存段] [导入段] [导出段]
```

### 加载与执行

浏览器通过 JavaScript API 加载。wasm 文件，验证其安全性后实例化模块。实例化后，WASM 函数可通过 JavaScript 调用，并通过线性内存交换数据。

示意图：

```
浏览器
    |
    |--- 下载 .wasm 文件
    |
    |--- 验证模块完整性
    |
    |--- 实例化：创建内存和函数表
    |
    |--- 调用导出函数
```

### 内存管理

WASM 使用连续的线性内存空间，初始大小可配置，并可动态增长。JavaScript 可通过 `WebAssembly.Memory` 对象与之交互，实现高效数据共享 (如数组缓冲区)。

示意图：

```
线性内存布局：
[0x0000: 数据段]
[0x1000: 堆栈]
[0x2000: 动态分配区]
```

## 使用示例

以下是一个简单加法函数的实现流程，使用 C 代码编译为 WASM：

1. **编写 C 代码** (add.c)：

```c
int add(int a, int b) {
    return a + b;
}
```

2. **编译为 WASM**：

```bash
emcc add.c -O3 -o add.wasm
```

3. **在 JavaScript 中加载并调用**：

```javascript
WebAssembly.instantiateStreaming(fetch('add.wasm'))
  .then(obj => {
    console.log(obj.instance.exports.add(2, 3)); // 输出 5
  });
```

## 工具链与生态

* **编译器**：Emscripten (C/C++)、Rust WASM-pack (Rust)。
* **调试工具**：浏览器开发者工具支持 WASM 单步调试。
* **运行时**：除浏览器外，Node.js 和 WASM 专用运行时 (如 Wasmtime) 支持服务端执行。

## 优势与局限

### 优势

* **高性能**：适用于游戏、音视频处理等计算密集型场景。
* **语言多样性**：支持多语言开发，复用现有代码库。
* **标准化**：W3C 标准确保长期兼容性。

### 局限

* **DOM 访问限制**：需通过 JavaScript 胶水代码操作 DOM。
* **工具链复杂度**：需配置编译环境，调试体验待完善。
